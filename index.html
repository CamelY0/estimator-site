<!DOCTYPE html>

<html lang="en">
<head>
<!-- Error dashboard injected: shows first JS error details -->
<style>
.tag:empty, .pill:empty, .badge:empty, .chip:empty { display: none !important; }





body[data-active-group="cleanup"] .wrap .card[data-card-jobinfo] { display: none !important; }

  #js-error-banner {
    position: sticky; top: 0; z-index: 9999;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    font-size: 14px; line-height: 1.3;
    padding: 8px 12px; border-bottom: 1px solid #c00;
    background: #fff0f0; color: #900; display: none;
  }
  #js-error-banner.ok { background:#f0fff0; border-color:#0a0; color:#064; }
  #js-error-banner .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }

/* Cleanup tab: show only the Sections sidebar and Materials panel */
body[data-active-group="cleanup"] .wrap .panel { display: none !important; }
body[data-active-group="cleanup"] .wrap .panel:has(#sections-tablist),
body[data-active-group="cleanup"] .wrap .panel:has(#matTbody) { display: block !important; }
/* Hide Tax/Reimbursement card on Cleanup (presence of #taxPct input) */
body[data-active-group="cleanup"] .wrap .card:has(#taxPct) { display: none !important; }
/* Hide Crew & Time card on Cleanup: try common input IDs */
body[data-active-group="cleanup"] .wrap .card:has(#crewCount),
body[data-active-group="cleanup"] .wrap .card:has(#crewHours),
body[data-active-group="cleanup"] .wrap .card:has(#crewRate) { display: none !important; }


/* Cleanup: hide the Concrete tab in the Sections list */


/* Cleanup: hide the Job Info card */
body[data-active-group="cleanup"] .wrap .card:has(#job_date_header) { display: none !important; }


/* Cleanup: hide Quick Groups card */
body[data-active-group="cleanup"] .wrap .card:has(.groupbar) { display: none !important; }


/* Cleanup: hide the Concrete card */
body[data-active-group="cleanup"] .wrap .card:has(#ct_yards),
body[data-active-group="cleanup"] .wrap .card:has(#mv_yards) { display: none !important; }


/* Hide Waste/Disposal card on Cleanup and Veneer once tagged */
body[data-active-group="cleanup"] .wrap .card[data-card-waste],
body[data-active-group="veneer"]  .wrap .card[data-card-waste] { display: none !important; }


/* Crew tab: ensure the Crew & Time card is visible */
body[data-active-group="crew"] .wrap .card:has(#crewCount),
body[data-active-group="crew"] .wrap .card:has(#crewHours),
body[data-active-group="crew"] .wrap .card:has(#crewRate) { display: block !important; }


/* Crew tab: force-show the Crew & Time card; also markable via data-card-crew */
body[data-active-group="crew"] .wrap .card:has(#crewCount),
body[data-active-group="crew"] .wrap .card:has(#crewHours),
body[data-active-group="crew"] .wrap .card:has(#crewRate),
body[data-active-group="crew"] .wrap .card[data-card-crew] {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

</style>
<script 
(function(){
  if (window.__errdash) return; window.__errdash = true;
  function base(p){ try{ return (p||'').split('/').pop(); }catch(e){ return p; } }
  var banner = document.createElement('div');
  banner.id = 'js-error-banner';
  banner.setAttribute('role','alert');
  banner.textContent = '⏳ JS initializing…';
  document.addEventListener('DOMContentLoaded', function(){
    document.body.prepend(banner);
  });

  function show(msg, ok){
    banner.style.display = 'block';
    banner.className = ok ? 'ok' : '';
    banner.innerHTML = (ok ? '✅ ' : '❌ ') + msg;
  }

  // Window "error" catches runtime errors AND most parse errors in later scripts
  window.addEventListener('error', function(e){
    var fn = base(e.filename||'');
    var ln = (typeof e.lineno==='number' && e.lineno) ? (':'+e.lineno) : '';
    var msg = (e && e.message) ? e.message : 'Script error';
    show('JS not loaded <span class="mono">'+ fn + ln + '</span> ' + msg, false);
  }, true);

  // Unhandled rejected promises
  window.addEventListener('unhandledrejection', function(e){
    var r = e.reason;
    var t = (r && (r.stack||r.message)) ? (r.stack||r.message) : String(r);
    show('Unhandled promise rejection: <span class="mono">'+ t +'</span>', false);
  });

  // If we reach window load without errors, mark OK
  window.addEventListener('load', function(){
    // Don't overwrite an existing error
    if (banner.style.display !== 'block'){
      show('JS loaded', true);
    }
  });
})();
</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Turcotte Masonry Estimator</title>
<style>
  :root{ --bg:#0d1117; --card:#0f141b; --muted:#9fb4cc; --line:#1f2937;
    --accent:#4da3ff; --ok-bg:#062012; --ok-border:#224a30; --ok-text:#b7f7c1;
    --warn-bg:#201606; --warn-border:#5b3a0e; --warn:#ffd58a; }
  *{box-sizing:border-box}
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:#e6edf3; margin:0}
  .wrap{max-width:1140px; margin:0 auto; padding:16px 16px 120px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin:12px 0}
  .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
  label{font-size:13px; color:#b7c5d9}
  input, select{background:#0b1017; color:#e6edf3; border:1px solid var(--line); border-radius:10px; padding:8px 10px}
  input[type="number"]{width:120px}
  table{width:100%; border-collapse:collapse; font-size:14px; margin-top:8px}
  th,td{padding:8px 10px; border-bottom:1px dashed var(--line)}
  th{color:#99c2ff; text-align:left}
  .right{text-align:right}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#0a1015; border:1px solid var(--line); font-size:12px}
  .muted{color:var(--muted); font-size:12px}
  .status{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line)}
  .ok{background:var(--ok-bg); color:var(--ok-text); border-color:var(--ok-border)}
  .bad{background:#2a1313; color:#ffd2d2; border-color:#5a2a2a}
  .fade{opacity:.45; filter:grayscale(.2)}
  .warn{background:var(--warn-bg); border-color:var(--warn-border); color:var(--warn); padding:8px 10px; border-radius:10px; font-size:12px}
  .spacer{flex:1}
  button{background:var(--accent); color:#041425; border:0; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer}
  button.ghost{background:#0b1017; color:#d6e6ff; border:1px solid var(--line)}
  .sticky{position:fixed; left:0; right:0; bottom:0; z-index:10; background:rgba(4,8,12,.92); border-top:1px solid var(--line); backdrop-filter:saturate(140%) blur(6px);}
  .sticky-inner{max-width:1140px; margin:0 auto; padding:10px 16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .sticky .pill{background:#0b121a}
  .group{display:flex; gap:10px; align-items:center}
</style>
<style>
  /* Turcotte: small UI polish for Mohican mix selector */
  .mv-mix-wrap{display:inline-flex;align-items:center;gap:6px;margin-left:8px}
  .mv-mix-wrap select{min-width:260px}
  .mv-tag{display:inline-flex;align-items:center;gap:6px;background:#0a1015;border:1px solid #1f2937;border-radius:999px;padding:4px 8px;font-size:12px;color:#b7c5d9}
</style>
<style>
  html { scroll-behavior: smooth; } /* smooth scrolling */
  .groupbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .groupbar .tag { background:#0b121a; border:1px solid #1f2937; color:#c9d7ee; padding:6px 10px; border-radius:999px; cursor:pointer; font-size:12px;}
  .groupbar .tag[aria-pressed="true"] { background:#10334b; border-color:#2b6a8e; color:#e6f3ff; }
  .group-hidden { display:none !important; }
</style>
<style>
  /* A11Y Tabs upgrade */
  .groupbar { display: none !important; } /* retire old button bar */
  .a11y-tabs { display:flex; flex-direction:column; gap:8px; }
  .a11y-tabs [role="tablist"] { display:flex; flex-wrap:wrap; gap:6px; }
  .a11y-tabs [role="tab"] {
    appearance:none; border:1px solid #1f2937; background:#0b121a; color:#cfe2ff;
    padding:6px 12px; border-radius:999px; cursor:pointer; font-size:12px;
  }
  .a11y-tabs [role="tab"][aria-selected="true"] { background:#10334b; border-color:#2b6a8e; color:#fff; }
  .a11y-tabs [role="tab"]:focus { outline:2px solid #2b6a8e; outline-offset:2px; }
</style>
<style>
  /* Subcard bubbles for supplier sections */
  .subcard {
    background:#0a1015;
    border:1px solid #1f2937;
    border-radius:12px;
    padding:10px 12px;
    margin:10px 0 14px;
  }
</style>
<style>
  /* Dim non-relevant materials rows (safer than hiding) */
  #matTbody tr.dim { opacity: .45; }
</style>
<style id="stucco-hide-waste-css">
/* Hide the Waste / Disposal card when Stucco tab is active */
body[data-active-group="stucco"] .wrap > .card[data-card="waste"] { display: none !important; }
</style>
<style>
/* Fallback: hide non-stucco rows when Stucco tab active */
body[data-active-group="stucco"] #matTbody tr:not([data-cats*="stucco"]) { display: none !important; }
</style>
<style>
/* Hide rows that are NOT stone veneer nor bluestone when Stone Veneer tab is active */
body[data-active-group="veneer"] #matTbody tr:not([data-cats*="stone veneer"]):not([data-cats*="bluestone"]) { display: none !important; }
</style>
<style>#quickGroups,#quick-groups,.quick-groups,[data-section='quick-groups']{display:none!important;}</style>
<script>
// Unified section config: show items by cats OR if pinned
window.SECTION = {
  all:       { cats: null,                         pins: null },
  concrete:  { cats: ['concrete'],                 pins: new Set(['m6','m7','m10','mNH3','m2013','mTIL_DrivewayMix','mSO_KY_Bluegrass_Sod','mSO_TopSoil_Bulk','mNHM_Concrete_80lb','mLOW_ColdPatchAsphalt_50lb']) },
  masonry:   { cats: ['masonry'],                  pins: new Set([]) },
  pavers:    { cats: ['pavers'],                   pins: new Set([]) },
  bluestone: { cats: ['bluestone'],                pins: new Set([]) },
  veneer:    { cats: ['stone veneer','bluestone'], pins: new Set([]) },
  stucco:    { cats: ['stucco'],                   pins: new Set([]) }
  ,cleanup: { cats: ['cleanup'], pins: new Set(['mHDX_TerryTowels_20pk']) },
  chimney: { cats: null, pins: new Set([]) }};
</script>



<style id="stucco-helper-visibility">
/* Show the Stucco Helper card on Stucco and All tabs */
.card[data-card-stucco]{ display:none; }
body[data-active-group="stucco"] .wrap .card[data-card-stucco],
body[data-active-group="all"] .wrap .card[data-card-stucco]{ display:block !important; }
/* Fallback: if no data-active-group is present, do not hide the card */
body:not([data-active-group]) .wrap .card[data-card-stucco]{ display:block !important; }
</style>


<style id="stucco-dropdown-fix">
/* Ensure selects are clickable and visible */
#stu_finish_sel{
  position: relative;
  z-index: 10;
  pointer-events: auto;
  background:#0c0f14;
  border:1px solid var(--line);
  color:var(--ink);
  padding:8px 10px;
  border-radius:10px;
  min-width:260px;
  -webkit-appearance: menulist;
  appearance: auto;
}
</style>
<style>#stu_foam_sel{position:relative;z-index:10}</style>

<style id="per-card-bubble-v2">
/* Make each major group look like its own bubble */
.card{
  border-radius:16px !important;
  box-shadow: 0 10px 24px rgba(0,0,0,.28);
  margin:16px 0 !important;
}
.card > .row:first-child{
  border-bottom:1px dashed var(--line);
  padding-bottom:8px;
  margin-bottom:10px;
}
/* Make sticky show only GRAND (already simplified in HTML), keep it centered on small screens */
.sticky .pill{ display:inline-flex; }
.sticky .pill:not(#stickyGrandPill):not(#stickyStatusPill){ display:none !important; }
.sticky .group{ display:none !important; }
</style>


<style id="rings-safe-css">
/* Colored rings for cards that are not the nested Block Wall container */
.card[data-cat]{ position: relative; border-radius:16px; box-shadow: 0 6px 18px rgba(0,0,0,.2); }
.card[data-cat]::before{
  content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none;
  box-shadow: 0 0 0 2px var(--ring, rgba(255,255,255,0.06)) inset;
}
/* Do NOT draw a full ring for the Block Wall (masonry) card because the DOM nests other cards inside it. */
.card#blockWallCard{ border-left: 3px solid var(--ring, #3b82f6); }
.card#blockWallCard::before{ display:none !important; }
/* Header accent for Block Wall */
#blockWallCard > .row:first-child{ background: rgba(59,130,246,0.08); border-bottom:1px dashed var(--line); }
.card[data-cat="masonry"]{ --ring:#3b82f6; }     /* blue */
.card[data-cat="stucco"]{ --ring:#60a5fa; }      /* light blue */
.card[data-cat="concrete"]{ --ring:#9ca3af; }    /* gray */
.card[data-cat="materials"]{ --ring:#10b981; }   /* green */
.card[data-cat="crew"]{ --ring:#f59e0b; }        /* amber */
.card[data-cat="tax"]{ --ring:#a78bfa; }         /* violet */
.card[data-cat="fuel"]{ --ring:#f97316; }        /* orange */
.card[data-cat="waste"]{ --ring:#ef4444; }       /* red */
.card[data-cat="silica"]{ --ring:#14b8a6; }      /* teal */
.card[data-cat="tools"]{ --ring:#8b5cf6; }       /* purple */
.card[data-cat="totals"]{ --ring:#22d3ee; }      /* cyan */
</style>


<style id="bw-shell-css">
#bwShell{
  position: relative;
  border: 2px solid #3b82f6; /* blue */
  border-radius: 14px;
  padding: 10px;
  margin-top: 8px;
  background: rgba(59,130,246,0.04); /* faint tint so the boundary reads clearly */
}
#blockWallCard > .row:first-child{
  background: transparent; /* remove previous tint */
  border-bottom: none;      /* the shell has its own edge */
  margin-bottom: 0;
  padding-bottom: 0;
}
/* Keep other card rings intact (from rings-safe-css) */
</style>


<style id="materials-shell-css">
#materialsShell{
  position: relative;
  border: 2px solid #10b981; /* green */
  border-radius: 14px;
  padding: 10px;
  margin-top: 8px;
  background: rgba(16,185,129,0.05);
}
/* Clean up Materials header edge (shell handles boundary) */
#materialsCard > .row:first-child{
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}
</style>


<style id="materials-ring-off">
/* Turn off the older card ring for Materials so only the shell border remains */
#materialsCard::before { display:none !important; }
</style>


<style id="materials-border-off">
/* Remove the default 1px gray card border for Materials so only the green shell shows */
#materialsCard{ border: none !important; }
</style>


<style id="materials-flush-fix">
/* Make Materials green border flush with the card edges (like Crew) */
#materialsCard{ padding:0 !important; }
#materialsShell{ margin:0 !important; border-radius:16px; padding:14px !important; }
</style>


<style id="flush-borders-fix">
/* Delete the big blue border that wraps everything (card-level border-left) */
#blockWallCard{ border: none !important; padding: 0 !important; }
#blockWallCard::before{ display:none !important; } /* double safety */

/* Align smaller shells flush with the card edge */
#bwShell{ margin: 0 !important; border-radius:16px; padding:14px !important; }

/* Materials was already flush, but keep symmetry */
#materialsCard{ padding: 0 !important; border: none !important; }
#materialsCard::before{ display:none !important; }
#materialsShell{ margin: 0 !important; border-radius:16px; padding:14px !important; }
</style>


<style id="bubble-tints">
/* Soft fill tints to match each bubble's ring color */
/* Use card backgrounds for all except Block Wall & Materials (they use inner shells) */
#bwShell{ background: rgba(59,130,246,0.06) !important; }            /* masonry blue */
#materialsShell{ background: rgba(16,185,129,0.06) !important; }      /* materials green */

.card[data-cat="crew"]{ background: rgba(245,158,11,0.06) !important; }       /* amber */
.card[data-cat="tax"]{ background: rgba(167,139,250,0.06) !important; }       /* violet */
.card[data-cat="concrete"]{ background: rgba(156,163,175,0.06) !important; }  /* gray */
.card[data-cat="fuel"]{ background: rgba(249,115,22,0.06) !important; }       /* orange */
.card[data-cat="waste"]{ background: rgba(239,68,68,0.06) !important; }       /* red */
.card[data-cat="silica"]{ background: rgba(20,184,166,0.06) !important; }     /* teal */
.card[data-cat="tools"]{ background: rgba(139,92,246,0.06) !important; }      /* purple */
.card[data-cat="stucco"]{ background: rgba(96,165,250,0.06) !important; }     /* light blue */
.card[data-cat="totals"]{ background: rgba(34,211,238,0.06) !important; }     /* cyan */
</style>


<style id="concrete-shell-css">
/* Concrete bubble: dedicated shell so the entire Concrete section has its own ring and tint */
#concreteCard{ padding:0 !important; border:none !important; }
#concreteCard::before{ display:none !important; } /* avoid double ring */
#concreteShell{
  position: relative;
  border: 2px solid #9ca3af;   /* gray ring */
  border-radius: 16px;
  padding: 14px;
  margin: 0;                    /* flush with card edges */
  background: rgba(156,163,175,0.06); /* soft gray tint */
}
/* Remove header divider in Concrete; shell provides boundary */
#concreteCard > .row:first-child{
  border-bottom: none !important;
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}
</style>


<style id="sticky-split-align">.sticky-inner{ justify-content: space-between !important; }</style>


<style id="chimney-extra-css">
  /* Additional styles for Chimney Helper UI (kept minimal to avoid conflicts) */
  .section-box{
    border:1px solid #1f2937;
    border-radius:12px;
    padding:10px;
    background:#0a1015;
    margin:8px 0 10px;
  }
  .kpi{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border:1px solid #1f2937;
    border-radius:999px; background:#0a1015; font-size:12px;
  }
  /* Slightly reduce Brick Size dropdown width to prevent edge cut-off */
  #bpsf { box-sizing:border-box; width: calc(100% - 8px); }
  #chimneyCard .group { display:block !important; }

  /* Geometry: Side A/B horizontal layout within byBrick grid */
  #chimneyCard #byBrick{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 12px;
    align-items: end;
  }
  #chimneyCard #byBrick > label{ width: 100%; }

  /* Geometry: lay out 'By Inches' inputs horizontally */
  #chimneyCard #byInches{
    display: grid;
    grid-template-columns: repeat(5, minmax(160px, 1fr));
    gap: 12px;
    align-items: end;
  }
  #chimneyCard #byInches > label{ width: 100%; }

  /* Tighter spacing between Rebuild height (ft) and in */

  /* Extra-tighten spacing between Rebuild height (ft) and in */
  
  
  /* Keep the 'in' input compact so it doesn't push apart */

  /* Ultra-tight spacing between Rebuild height (ft) and in */

  /* Ultra-closer spacing between Rebuild height (ft) and in */

  /* Hyper-tight spacing between Rebuild height (ft) and in */

  /* Hyper-tight v2: nearly touching ft/in */
  
  
  

  /* Tighten spacing between Outside width (in) and Outside depth (in) */
  
  
  #chimneyCard #byInches #w_in,

  /* Moderate spacing between Outside width (in) and Outside depth (in) */
  #chimneyCard #byInches label:has(#w_in){ margin-right: -2px; }
  #chimneyCard #byInches label:has(#d_in){ margin-left: -36px; }
  #chimneyCard #byInches #w_in, 
  

  /* Smaller control for 'Outside width (in)' */
  #chimneyCard #byInches #w_in{ max-width: 64px; }

  /* Match compact width for 'Outside depth (in)' */
  #chimneyCard #byInches #d_in{ max-width: 64px; }

  /* Compact width for 'Rebuild height (ft)' */
  #chimneyCard #byInches #h_ft{ max-width: 64px; }

  /* Slightly increase space between Rebuild height (ft) and in */

  /* Slightly more space between Rebuild height (ft) and in */

  /* More space between Rebuild height (ft) and in */

  /* Extra spacing between Rebuild height (ft) and in */

  /* Tiny extra spacing between Rebuild height (ft) and in */

  /* Extra tiny bump: more space between Rebuild height (ft) and in */

  /* Slightly more space between Rebuild height (ft) and in */

  /* Micro-nudge: a bit more space between Rebuild height (ft) and in */

  /* Final nudge: more space + slightly larger 'in' box */
  #chimneyCard #byInches label:has(#h_ft){ margin-right: 16px; }
  #chimneyCard #byInches label:has(#h_in){ margin-left: -28px; }
  #chimneyCard #byInches #h_in{ max-width: 56px; }

</style>


<style id="chimney-helper-visibility">.wrap .card[data-card-chimney]{ display:none; }
  body[data-active-group="chimney"] .wrap .card[data-card-chimney],
  body[data-active-group="all"] .wrap .card[data-card-chimney]{ display:block !important; }
  /* Fallback: if no data-active-group is present, show the Chimney card */
  body:not([data-active-group]) .wrap .card[data-card-chimney]{ display:block !important; }
</style>
</head>
<body>
<div style="position:sticky; top:0; z-index:1000; background:inherit; padding:6px 12px; font:600 12px system-ui; color:#0a6c2f;">✅ JS loaded and running</div>


<div class="wrap">
<h2 style="margin:8px 0">Turcotte Masonry Estimator</h2>
<!-- BLOCK WALL HELPER CARD -->
<div class="card" id="blockWallCard" data-card="blockwall" data-cat="masonry">
<div id="bwShell" class="bw-shell">

  <div class="row">
    <h3 style="margin:0">Block Wall Helper</h3>
    <span class="spacer"></span>
    <div class="group">
      <label class="pill"><input type="checkbox" id="bw_include_end_bars" /> Include end bars</label>
      <label class="pill"><input type="checkbox" id="bw_use_20ft" checked /> Use 20' rebar lengths</label>
    </div>
  </div>
  
  <div class="row" style="margin-top:8px">
    <div class="group">
      <h4 style="margin:6px 0">CMU Type</h4>
      <label>Thickness (select one)
        <select id="bw_thickness">
          <option value="6">6&quot; (6x8x16)</option>
          <option value="8" selected>8&quot; (8x8x16)</option>
          <option value="10">10&quot; (10x8x16)</option>
          <option value="12">12&quot; (12x8x16)</option>
        </select>
      </label>
      <div class="pill">
        <label><input type="radio" name="bw_height" value="8" checked> Standard 8&quot; course</label>
      </div>
      <div class="pill">
        <label><input type="radio" name="bw_height" value="4"> Half‑High 4&quot; course</label>
      </div>
    
    </div>
    <div class="group">
      <h4 style="margin:6px 0">Grout & Rebar</h4>
      <label>Grout Pattern
        <select id="groutPattern">
          <option value="full" selected>Fully Grouted</option>
          <option value="16oc">Cells @ 16&quot; o.c.</option>
          <option value="24oc">Cells @ 24&quot; o.c.</option>
          <option value="32oc">Cells @ 32&quot; o.c.</option>
        </select>
      </label>
    
    <div class="group">
      <h4 style="margin:6px 0">Special Shapes (allowances)</h4>
      <label class="pill"><input type="checkbox" id="bw_open_end"> Use Open‑End units at reinforced cells</label>
      <label>Bond Beam courses (enter 0 if none)
        <input type="number" id="bw_bondbeam_courses" min="0" step="1" value="0">
      </label>
    </div>
  </div>

  <div class="row">
    <div class="group">
      <label>Wall Length — ft <input type="number" id="bw_len_ft" step="1" min="0" value="0"></label>
      <label>in <input type="number" id="bw_len_in" step="1" min="0" max="11" value="0"></label>
      <label>Wall Height — ft <input type="number" id="bw_h_ft" step="1" min="0" value="0"></label>
      <label>in <input type="number" id="bw_h_in" step="1" min="0" max="11" value="0"></label>
      <label>Waste % <input type="number" id="bw_waste" step="0.5" min="0" value="5"></label>
    </div>
  </div>
  <div class="row small muted">Assumptions: 8×8×16 CMU (nominal), 3/8&quot; joints, every third cell has a vertical #4 rebar, all cells filled with grout.</div>
  <div class="row">
    <div class="group">
      <label class="pill"><input type="checkbox" id="bw_round_up_blocks" checked> Round blocks up</label>
      <label class="pill"><input type="checkbox" id="bw_round_up_bars" checked> Round bars up</label>
      <label class="pill"><input type="checkbox" id="bw_round_up_bags" checked> Round bags up</label>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <h4>Quantities</h4>
      <div id="bw_results" class="small"></div>
    </div>
    <div class="col">
      <h4>Scope Lines</h4>
      <textarea id="bw_scope" rows="8" style="width:100%;font-family:monospace"></textarea>
      <button id="bw_copy" class="ghost">Copy to clipboard</button>
    </div>
  </div>
</div>
<style>
  /* Block Wall tab: no global hide; rely on applyGroup filtering */
</style>

<script>
(function(){

  // Helper: check a materials row's "Use" checkbox by id or item text and dispatch change
  function ensureMaterialChecked(id, textPattern){
    try{
      var tbody = document.getElementById('matTbody');
      if(!tbody) return false;
      var row = null;
      if(id){
        row = tbody.querySelector('tr[data-id="'+id+'"]');
      }
      if(!row && textPattern){
        var re = new RegExp(textPattern, 'i');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        row = rows.find(function(tr){ return re.test((tr.textContent||'').replace(/\s+/g,' ')); });
      }
      if(!row) return false;
      var cb = row.querySelector('.mat_use');
      if(!cb) return false;
      if(!cb.checked){
        cb.checked = true;
        cb.dispatchEvent(new Event('change', { bubbles:true, cancelable:true }));
      }
      return true;
    }catch(e){ return false; }
  }

  // Data tables (sources in References panel)
  // Units per square foot (face) by course height
  const UNITS_PER_SF = { "8": 1.125, "4": 2.25 };
// Bags per block (Spec Mix Type‑S), keyed by CMU thickness (inches)
const BLOCKS_PER_BAG_BY_THICKNESS = { "4": 20, "6": 15, "8": 15, "10": 12, "12": 10 };
 // 8x16 vs half-high 4x16

  // Grout yd^3 per 100 sf by thickness + pattern (Fairbanks/Knife River table)
  const GROUT_YD3_100 = {
    "6":   { full: 0.93, "16oc": 0.55, "24oc": 0.42, "32oc": 0.35 },
    "8":   { full: 1.12, "16oc": 0.65, "24oc": 0.50, "32oc": 0.43 },
    "10":  { full: 1.30, "16oc": 0.82, "24oc": 0.63, "32oc": 0.53 },
    "12":  { full: 1.73, "16oc": 1.01, "24oc": 0.76, "32oc": 0.64 }
  };

  // SPEC MIX Core Fill 80-lb bag yields (lower end / worst-case)
  // 6": 3.4 blocks, 6.8 cores | 8": 2.5, 5.0 | 10": 2.1, 4.2 | 12": 1.7, 3.4
  const SPEC_MIX_CORE_FILL_PER_BAG = {
    "6":  { blocks: 3.4, cores: 6.8 },
    "8":  { blocks: 2.5, cores: 5.0 },
    "10": { blocks: 2.1, cores: 4.2 },
    "12": { blocks: 1.7, cores: 3.4 }
  };

  function feetInToInches(ft, inch){ 
    var f = parseFloat(ft||0), i = parseFloat(inch||0);
    if (!isFinite(f)) f = 0; if (!isFinite(i)) i = 0;
    return f*12 + i;
  }
  function fmt(n, d){ return (Math.round(n*Math.pow(10,d))/Math.pow(10,d)).toFixed(d); }

  function courseHeightIn(){
    const hSel = document.querySelector('input[name="bw_height"]:checked');
    return (hSel && hSel.value === '4') ? 4 : 8;
  }

  function calc(){
    var L_in = feetInToInches(document.getElementById('bw_len_ft').value, document.getElementById('bw_len_in').value);
    var H_in = feetInToInches(document.getElementById('bw_h_ft').value, document.getElementById('bw_h_in').value);
    var wastePct = parseFloat(document.getElementById('bw_waste').value||0);
    if (!isFinite(wastePct)) wastePct = 0;
    var area_sf = (L_in/12) * (H_in/12);

    // CMU type
    var thickness = document.getElementById('bw_thickness').value; // '6','8','10','12'
    var heightKey = (courseHeightIn() === 4) ? "4" : "8";

    // Units per SF (face) per course height
    var unitsPerSf = UNITS_PER_SF[heightKey] || 1.125;

    // Blocks calc
    var blocks = area_sf * unitsPerSf;
    var blocks_waste = blocks * (1 + wastePct/100);
    if (document.getElementById('bw_round_up_blocks').checked){ blocks_waste = Math.ceil(blocks_waste); }

    
    
    

/*__BW_TO_MAT_MAPPING__*/
try{
  // Ensure materials table exists
  if (!document.querySelector('#matTbody tr') && typeof renderMaterials==='function'){ renderMaterials(); }
  var tbody = document.getElementById('matTbody');

  // Inputs/state from the Block Wall calculator
  var thicknessSel = document.getElementById('bw_thickness');
  var heightRadio  = document.querySelector('input[name="bw_height"]:checked');
  var htCourse     = heightRadio ? heightRadio.value : '8';

  // Area present?
  var hasArea = (typeof L_in==='number' && typeof H_in==='number' && L_in>0 && H_in>0);

  function findRows(rx){
    if(!tbody) return [];
    var rows = Array.from(tbody.querySelectorAll('tr'));
    rx = (rx instanceof RegExp) ? rx : new RegExp(String(rx), 'i');
    return rows.filter(function(tr){ return rx.test((tr.textContent||'')); });
  }
  function clearRow(tr){
    if(!tr) return;
    var q = tr.querySelector('.mat_qty'); if (q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
    var cb = tr.querySelector('.mat_use'); if (cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); }
  }
  function clearRows(list){ (list||[]).forEach(clearRow); }
  function setQty(tr, qty){
    if(!tr) return;
    var cb = tr.querySelector('.mat_use'); if (cb && !cb.checked){ cb.checked=true; cb.dispatchEvent(new Event('change',{bubbles:true})); }
    var q  = tr.querySelector('.mat_qty'); if (q){ q.value = String(qty||0); q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
  }

  if(!hasArea){
    if (tbody){
      // Clear CMU blocks (any size)
      clearRows(findRows(/hollow\s*concrete\s*block/i));
      // Clear core-fill grout (SPEC MIX Core Fill Grout 3k — 80 lb etc.)
      clearRows(findRows(/core\s*fill.*grout|masonry\s*grout/i));
      // Clear Durawall/joint reinforcement
      clearRows(findRows(/durawall|joint\s*reinforcement/i));
      // Clear rebar entries (any)
      clearRows(findRows(/\brebar\b/i));
      // Explicit ids (defensive): 12" CMU, SPEC MIX Core Fill Grout 3k (m8), #5 rebar 20' (mNH3)
      var ids = ['mNH1','m8','mNH3','mNH2'];
      ids.forEach(function(id){
        var tr = tbody.querySelector('tr[data-id="'+id+'"]');
        if (tr) clearRow(tr);
      });
    }
    return;
  }

  // With area present -> set the active size row quantities as before (12" only here)
  if (tbody && thicknessSel && thicknessSel.value==='12' && htCourse==='8'){
    var row = tbody.querySelector('tr[data-id="mNH1"]') || (findRows(/12"\s*hollow\s*concrete\s*block/i)[0]||null);
    if (row){
      var qty = (typeof blocks_waste==='number') ? blocks_waste : (Number(blocks_waste)||0);
      setQty(row, qty);
    }
  }
}catch(e){ /* keep calc resilient */ }
/*__/BW_TO_MAT_MAPPING__*/


    


// Course count (for openings/specials)
    var courses = Math.ceil(H_in / courseHeightIn());
    // === Durawall (joint reinforcement) calc for 12" walls ===
    // Default: every other course (16" o.c. when courses are 8" high)
    var DURAWALL_SPACING_COURSES = 2;
    var durawall_runs = (thickness === '12') ? Math.ceil(courses / DURAWALL_SPACING_COURSES) : 0;
    var durawall_lf_total = (L_in/12) * durawall_runs; // linear feet per run along length
    var durawall_10ft_pcs = Math.max(0, Math.ceil(durawall_lf_total / 10));


    // Rebar: based on 16" modules along length (approx columns)
    var columns = Math.max(1, Math.round(L_in / 16));
    var gpEl = document.getElementById('groutPattern');
    var pattern = gpEl ? gpEl.value : 'full';
    var includeEnds = document.getElementById('bw_include_end_bars').checked;
    var bars_every_third = Math.ceil(columns / 3); // default legacy calc
    // If user picked 16/24/32 o.c., honor the spacing exactly:
    var spacingIn = 24; // default for legacy
    if (pattern==='16oc') spacingIn = 16;
    else if (pattern==='24oc') spacingIn = 24;
    else if (pattern==='32oc') spacingIn = 32;
    var bars_spacing = Math.max(1, Math.floor(L_in / spacingIn)) + (includeEnds ? 2 : 0);
    var vert_bars = (pattern==='full') ? bars_every_third + (includeEnds ? 2 : 0) : bars_spacing;

    // Bar length per vertical: wall height + 12" top + 12" bottom (quick rule)
    var embed_each_in = 12;
    var bar_len_ft = (H_in + 2*embed_each_in) / 12;
    var use20 = document.getElementById('bw_use_20ft').checked;
    var stock = use20 ? 20 : 10;
    var bars_needed = vert_bars;
    if (bar_len_ft > stock) { bars_needed = vert_bars * 2; }
    var rebar_lf = vert_bars * bar_len_ft;
    // #5 rebar (5/8") comes in 20' sticks for Rob
    var rebar_sticks20 = (area_sf>0) ? Math.max(0, Math.ceil(rebar_lf / 20)) : 0;


    // Grout from table (thickness + pattern)
    var yd3_100 = (GROUT_YD3_100[thickness] && GROUT_YD3_100[thickness][pattern]) ? GROUT_YD3_100[thickness][pattern] : GROUT_YD3_100['8']['full'];
    var groutYd3 = area_sf * (yd3_100 / 100) * (1 + wastePct/100);
    var groutFt3 = groutYd3 * 27;

    // === SPEC MIX Core Fill 80-lb bag calc ===
    var sm = (typeof SPEC_MIX_CORE_FILL_PER_BAG!=='undefined') ? SPEC_MIX_CORE_FILL_PER_BAG[thickness] : null;
    var grout_bags = 0;
    if (sm){
      if (pattern==='full'){
        grout_bags = (blocks_waste>0 ? (blocks_waste / sm.blocks) : 0);
      } else {
        // Approx: one filled core per vertical bar per course for reinforced cells
        var cores_to_fill = Math.max(0, vert_bars) * Math.max(0, courses);
        grout_bags = (cores_to_fill>0 ? (cores_to_fill / sm.cores) : 0);
      }
      grout_bags = grout_bags * (1 + wastePct/100);
      if (document.getElementById('bw_round_up_bags') && document.getElementById('bw_round_up_bags').checked){
        grout_bags = Math.ceil(grout_bags);
      }
    }

    // Mortar (keep simple rule-of-thumb tied to units)
    // Mortar bags based on Spec Mix Type‑S blocks-per-bag by thickness
var bpb = (typeof BLOCKS_PER_BAG_BY_THICKNESS !== 'undefined' && BLOCKS_PER_BAG_BY_THICKNESS[thickness]) ? BLOCKS_PER_BAG_BY_THICKNESS[thickness] : 15;
var mortar_bags = blocks_waste / bpb;
var rUpEl = document.getElementById('bw_round_up_bags');
if (rUpEl && rUpEl.checked){ mortar_bags = Math.ceil(mortar_bags); }

// Specials
    var useOpenEnd = document.getElementById('bw_open_end').checked;
    var bondCourses = parseInt(document.getElementById('bw_bondbeam_courses').value || '0', 10);
    if (!isFinite(bondCourses) || bondCourses < 0) bondCourses = 0;
    // Open-end allowance: one per reinforced cell per course (approx.)
    var open_end_units = useOpenEnd ? (vert_bars * courses) : 0;
    // Bond beam units: approx columns count per course × bondCourses
    var bond_beam_units = bondCourses > 0 ? (columns * bondCourses) : 0;

    // Scope text
    var scope = [];
    scope.push('Build CMU wall ' + fmt(L_in/12,2) + ' LF × ' + fmt(H_in/12,2) + ' H ('+thickness+'x'+(courseHeightIn())+'x16 face).');
    scope.push('Furnish & lay ≈ ' + blocks_waste + ' units (' + fmt(unitsPerSf,3) + '/sf @ ' + courseHeightIn() + '\" course; includes ' + fmt(wastePct,1) + '% waste).');
    scope.push('Vertical #4 @ ' + (pattern==='full' ? '≈ every third cell' : (spacingIn + '\" o.c.')) + (includeEnds ? ' + end bars' : '') + ' — ' + vert_bars + ' bars @ ' + fmt(bar_len_ft,2) + ' ft ea (' + fmt(rebar_lf,1) + ' LF total).');
    scope.push('Grout (' + thickness + '\" wall, ' + (pattern==='full' ? 'fully grouted' : (spacingIn + '\" o.c.')) + '): ≈ ' + fmt(groutYd3,3) + ' yd³.');
    scope.push('Mortar ≈ ' + fmt(mortar_bags,2) + ' bags (Spec Mix Type-S, ~' + bpb + ' blocks/bag).');
    if (open_end_units>0) scope.push('Open‑End units allowance: ≈ ' + open_end_units + ' (at reinforced cells).');
    if (bond_beam_units>0) scope.push('Bond‑beam units allowance: ≈ ' + bond_beam_units + ' (spread across ' + bondCourses + ' course' + (bondCourses>1?'s':'') + ').');

    // === Sync SPEC MIX Core Fill bags to Materials ===
    try {
      var bagsToMat = sm ? Math.max(0, Math.ceil(grout_bags||0)) : 0;
      var tbody = document.getElementById('matTbody');
      if (tbody && !tbody.querySelector('tr') && typeof renderMaterials==='function') { renderMaterials(); }
      tbody = document.getElementById('matTbody');
      if (tbody) {
        // Prefer text match to be resilient to id changes
        var coreRow = Array.from(tbody.querySelectorAll('tr')).find(function(tr){ 
          return /SPEC\s*MIX.*Core\s*Fill.*80/i.test((tr.textContent||'')); 
        });
        if (!coreRow) {
          // Fallback to known id (m8) if present
          coreRow = tbody.querySelector('tr[data-id="m8"]');
        }
        if (bagsToMat > 0) {
          if (!coreRow && typeof ensureMaterialChecked==='function') {
            ensureMaterialChecked(null, 'SPEC\\s*MIX.*Core\\s*Fill.*80');
            coreRow = Array.from(tbody.querySelectorAll('tr')).find(function(tr){ 
              return /SPEC\s*MIX.*Core\s*Fill.*80/i.test((tr.textContent||'')); 
            });
          }
          if (coreRow && typeof matSetQtyAndUse==='function') {
            matSetQtyAndUse(coreRow, bagsToMat);
          } else if (coreRow) {
            var useCb = coreRow.querySelector('.mat_use');
            var qtyInp = coreRow.querySelector('.mat_qty');
            if (useCb && !useCb.checked) useCb.click();
            if (qtyInp) { qtyInp.value = bagsToMat; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          }
        } else if (coreRow) { 
          // Zero: uncheck & clear
          var useCb = coreRow.querySelector('.mat_use');
          var qtyInp = coreRow.querySelector('.mat_qty');
          if (qtyInp) { qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          if (useCb && useCb.checked) useCb.click();
        }
      }
    } catch(e) { /* non-fatal */ }

    // === Sync #5 rebar 20' sticks to Materials ===
    try {
      var sticksToMat = Math.max(0, rebar_sticks20||0);
      if (!(area_sf>0)) { sticksToMat = 0; }
      var tbody = document.getElementById('matTbody');
      if (tbody && !tbody.querySelector('tr') && typeof renderMaterials==='function') { renderMaterials(); }
      tbody = document.getElementById('matTbody');

      function getRebarRow(){
        if (!tbody) return null;
        var row = tbody.querySelector('tr[data-id="mNH3"]'); // exact known id
        if (!row){
          // try text match as fallback
          row = Array.from(tbody.querySelectorAll('tr')).find(function(tr){
            return /#\s*5\s*rebar.*20['’]/i.test((tr.textContent||''));
          });
        }
        return row;
      }

      var row = getRebarRow();
      if (!row && typeof renderMaterials==='function'){ renderMaterials(); row = getRebarRow(); }

      if (row){
        if (sticksToMat > 0){
          if (typeof matSetQtyAndUse === 'function') {
            matSetQtyAndUse(row, sticksToMat);
          } else {
            var useCb = row.querySelector('.mat_use');
            var qtyInp = row.querySelector('.mat_qty');
            if (useCb && !useCb.checked) useCb.click();
            if (qtyInp) { qtyInp.value = sticksToMat; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          }
        } else {
          var useCb = row.querySelector('.mat_use');
          var qtyInp = row.querySelector('.mat_qty');
          if (qtyInp) { qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          if (useCb && useCb.checked) useCb.click();
        }
      }
    } catch(e) { /* non-fatal */ }

    // === Sync 12" Durawall — 10' to Materials ===
    try {
      var pcsToMat = (thickness === '12') ? Math.max(0, durawall_10ft_pcs||0) : 0;
      
      // Force zero when no area
      if (!(area_sf>0) || !(L_in>0) || !(H_in>0)) pcsToMat = 0;
var tbody = document.getElementById('matTbody');
      if (tbody && !tbody.querySelector('tr') && typeof renderMaterials==='function') { renderMaterials(); }
      tbody = document.getElementById('matTbody');

      function getDurawallRow(){
        if (!tbody) return null;
        var row = tbody.querySelector('tr[data-id="mNH2"]'); // exact 12" Durawall — 10' id
        if (!row){
          row = Array.from(tbody.querySelectorAll('tr')).find(function(tr){
            return /12["”]\s*Durawall.*10['’]/i.test((tr.textContent||''));
          });
        }
        return row;
      }

      var row = getDurawallRow();
      if (!row && typeof renderMaterials==='function'){ renderMaterials(); row = getDurawallRow(); }

      if (row){
        if (pcsToMat > 0){
          if (typeof matSetQtyAndUse === 'function') {
            matSetQtyAndUse(row, pcsToMat);
          } else {
            var useCb = row.querySelector('.mat_use');
            var qtyInp = row.querySelector('.mat_qty');
            if (useCb && !useCb.checked) useCb.click();
            if (qtyInp) { qtyInp.value = pcsToMat; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          }
        } else {
          var useCb = row.querySelector('.mat_use');
          var qtyInp = row.querySelector('.mat_qty');
          if (qtyInp) { qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          if (useCb && useCb.checked) useCb.click();
        }
      }
    } catch(e) { /* non-fatal */ }

    document.getElementById('bw_scope').value = scope.join('\n');

    // Results panel
    var html = '';
    html += '<div><strong>Area:</strong> ' + fmt(area_sf,2) + ' sf</div>';
    html += '<div><strong>CMU Type:</strong> ' + thickness + 'x' + courseHeightIn() + 'x16</div>';
    html += '<div><strong>Blocks (calc):</strong> ' + fmt(blocks,2) + ' → <strong>Order:</strong> ' + blocks_waste + '</div>';
    html += '<div><strong>Vertical #4 bars:</strong> ' + vert_bars + ' @ ' + fmt(bar_len_ft,2) + ' ft (' + fmt(rebar_lf,1) + ' LF)</div>';
    html += '<div><strong>Grout (table):</strong> ' + fmt(groutFt3,2) + ' ft³ (' + fmt(groutYd3,3) + ' yd³) — ' + thickness + '\" / ' + (pattern==='full' ? 'Full' : (spacingIn + '\" o.c.')) + '</div>';
    html += '<div><strong>Grout Bags (SPEC MIX Core Fill 80 lb):</strong> ' + (sm ? ( (document.getElementById('bw_round_up_bags') && document.getElementById('bw_round_up_bags').checked) ? (grout_bags + ' bags') : (fmt(grout_bags,2) + ' bags') ) : '—') + '</div>';
    html += '<div><strong>Durawall 12&quot; — 10\' pieces:</strong> ' + durawall_10ft_pcs + ' pcs</div>';
    html += '<div><strong>Rebar #5 (20\') sticks:</strong> ' + rebar_sticks20 + ' pcs</div>';
    html += '<div><strong>Mortar:</strong> ~' + fmt(mortar_bags,2) + ' bags</div>';
    if (open_end_units>0) html += '<div><strong>Open‑End units:</strong> ' + open_end_units + '</div>';
    if (bond_beam_units>0) html += '<div><strong>Bond‑beam units:</strong> ' + bond_beam_units + ' (courses: ' + bondCourses + ')</div>';
    document.getElementById('bw_results').innerHTML = html;
  }

  function bind(){
    ['bw_len_ft','bw_len_in','bw_h_ft','bw_h_in','bw_waste',
     'bw_round_up_blocks','bw_round_up_bars','bw_round_up_bags',
     'bw_include_end_bars','bw_use_20ft','bw_thickness','bw_bondbeam_courses','groutPattern','bw_open_end']
      .forEach(function(id){ var el = document.getElementById(id); if(el){ el.addEventListener('input', calc); el.addEventListener('change', calc); }});
    document.querySelectorAll('input[name="bw_height"]').forEach(function(el){ el.addEventListener('change', calc); });
    var c = document.getElementById('bw_copy');
    if (c) c.addEventListener('click', function(){
      var ta = document.getElementById('bw_scope'); ta.select(); try{ document.execCommand('copy'); }catch(e){}
    });
    calc();

    // Re-run after Materials table renders/changes (debounced)
    try{
      const matBody = document.getElementById('matTbody');
      if(matBody){
        let __stucco_obs_timer = null;
        const onMatChange = () => {
          if(__stucco_obs_timer) cancelAnimationFrame(__stucco_obs_timer);
          __stucco_obs_timer = requestAnimationFrame(()=>{ __stucco_obs_timer=null; if(typeof window.stuccoCalc==='function') window.stuccoCalc(); });
        };
        const mo = new MutationObserver(onMatChange);
        mo.observe(matBody, {childList:true});
      }
    }catch(e){}
    
}
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
  else { bind(); }

  /*__BW_LISTENERS__*/
  try {
    var thick = document.getElementById('bw_thickness');
    if (thick) thick.addEventListener('change', function(){
      var r = document.querySelector('input[name="bw_height"]:checked');
      if (thick.value==='12' && (r ? r.value : '8')==='8'){
        if (!document.querySelector('#matTbody tr') && typeof renderMaterials==='function'){ renderMaterials(); }
        ensureMaterialChecked('mNH1', '12\"\s*hollow\s*concrete\s*block');
      }
    });
    document.querySelectorAll('input[name="bw_height"]').forEach(function(el){
      el.addEventListener('change', function(){
        var thickVal = document.getElementById('bw_thickness') ? document.getElementById('bw_thickness').value : '';
        if (thickVal==='12' && el.value==='8'){
          if (!document.querySelector('#matTbody tr') && typeof renderMaterials==='function'){ renderMaterials(); }
          ensureMaterialChecked('mNH1', '12\"\s*hollow\s*concrete\s*block');
        }
      });
    });
  } catch(e){}
  /*__/BW_LISTENERS__*/

})();
</script>


<div id="jsStatus" style="display:none"></div>
<!-- TAX -->

</div><!-- /bw-shell -->
<div class="card" id="taxCard" data-cat="tax">
<div class="row">
<h3 style="margin:0">Tax / Reimbursement (CT default 6.35%)</h3>
<span class="spacer"></span>
<div class="group">
<label>Rate % <input id="taxPct" step="0.01" type="number" value="6.35"/></label>
<label class="pill"><input checked="" id="tax_res" name="taxmode" type="radio"/> Residential — reimburse my material taxes</label>
<label class="pill"><input id="tax_com" name="taxmode" type="radio"/> Commercial — charge sales tax</label>
<button class="ghost" id="unlockTax">Manual override</button>
</div>
</div>
<div class="row small muted">Residential reimburses **Materials + Concrete + Disposal** by default. Commercial taxes all buckets by default. You can still override below.</div>
<div class="row" style="margin-top:6px">
<label class="pill"><input checked="" disabled="" id="tax_on_materials" type="checkbox"/> Materials</label>
<label class="pill"><input checked="" disabled="" id="tax_on_concrete" type="checkbox"/> Concrete</label>
<label class="pill"><input disabled="" id="tax_on_fuel" type="checkbox"/> Fuel</label>
<label class="pill"><input disabled="" id="tax_on_disposal" type="checkbox"/> Disposal</label>
<label class="pill"><input disabled="" id="tax_on_labor" type="checkbox"/> Labor</label>
<label class="pill"><input disabled="" id="tax_on_tools" type="checkbox"/> Tools</label>
<label class="pill"><input disabled="" id="tax_on_oh" type="checkbox"/> Overhead</label>
<label class="pill"><input disabled="" id="tax_on_profit" type="checkbox"/> Profit</label>
</div>
<div class="row small muted">CT rate is 6.35% with no local add-ons. Motor vehicle fuel is sales-tax-exempt. Use overrides as your policy requires.</div>
</div>
<!-- CREW -->
<div class="card" id="crewCard" data-cat="crew">
<div class="row">
<h3 style="margin:0">Crew &amp; Time</h3>
<span class="spacer"></span>
<button class="ghost" id="addWorkerBtn">+ Add Worker</button>
</div>
<div class="row" style="margin-bottom:6px">
<label class="pill"><input checked="" id="crewWideToggle" type="checkbox"/> Use CREW‑WIDE time</label>
<label class="pill"><input checked="" id="timeUnitsDays" type="checkbox"/> Time in Days (8 hr/day)</label>
<label>Crew‑wide time <input id="crewWideQty" placeholder="e.g., 1" step="1" type="number"/></label>  <label style="margin-left:.5rem">Crew <input id="crewManual" type="number" step="1" value="3" placeholder="3" style="width:5rem"></label>  <label style="margin-left:.5rem">Days <input id="daysManual" type="number" step="1" value="1" placeholder="1" style="width:5rem"></label>
</div>
<table>
<thead><tr><th>Use</th><th>Name</th><th>Role</th><th>Rate ($/hr)</th><th>Hours</th><th>Cost</th><th></th></tr></thead>
<tbody id="crewTbody"></tbody>
<tfoot><tr><td class="right" colspan="5">Crew Subtotal (excl. Company)</td><td class="right mono" id="crewSubtotal">$0.00</td><td></td></tr></tfoot>
</table>
<div class="muted small">Set role = <b>Company</b> to flow those hours into <b>Profit</b> (not Crew).</div>
</div>
<!-- MATERIALS -->
<div class="card" id="materialsCard" data-cat="materials">
<div id="materialsShell" class="materials-shell">

<div class="row">
<h3 style="margin:0">Materials</h3>
<span class="spacer"></span>
<button class="ghost" id="addMatBtn">+ Add Material</button>
</div>
<table>
<thead><tr><th>Use</th><th>Item</th><th>Supplier</th><th>Units</th><th>Unit Price</th><th>Qty</th><th>Ext.</th><th></th></tr></thead>
<tbody id="matTbody"></tbody>
<tfoot><tr><td class="right" colspan="6">Materials Subtotal</td><td class="right mono" id="matSubtotal">$0.00</td><td></td></tr></tfoot>
</table>

<!-- === Turcotte: Stucco Helper (Area‑based) — integrated, Stucco-tab only === -->

<!-- === Turcotte: Stucco Helper (Area‑based) — CLEAN REBUILD === -->

<!-- === Turcotte: Stucco Helper (Area-based) — v15 SAFE === -->
<!-- === Turcotte: Stucco Helper (Area-based) — v18 CLEAN === -->

</div><!-- /materials-shell -->
<div class="card" data-card-stucco id="stuccoCard" data-cat="stucco">
  <div class="row">
    <h3 style="margin:0">Stucco Helper (Area‑based)</h3>
    <span class="spacer"></span>
    <div class="group">
      <label class="pill"><input type="radio" name="stu_sys" id="stu_sys_eifs" value="eifs" checked> Synthetic EIFS</label>
      <label class="pill"><input type="radio" name="stu_sys" id="stu_sys_trad" value="trad"> Traditional</label>
    </div>
  </div>

  <div class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px">
    <label>Wall Area (sf) <input id="stu_area" type="number" step="1" min="0" placeholder="e.g., 550"></label>
    <label>Waste % <input id="stu_waste" type="number" step="0.5" min="0" value="10"></label>
    <label class="pill"><input type="checkbox" id="stu_round" checked> Round up quantities</label>
  </div>

  <div class="row" id="stu_finish_row" style="flex-wrap:wrap; gap:10px; margin-top:6px">
    <label>Finish Product
      <select id="stu_finish_sel" style="min-width:280px">
        <option value="parex_coarse">Parex DPR Sand Coarse — 5 gal</option>
        <option value="parex_fine">Parex DPR Sand Fine — 5 gal</option>
        <option value="parex_swirl">Parex DPR Swirl Fine — 5 gal</option>
        <option value="parex_smooth">Parex DPR Sand Smooth — 5 gal</option>
        <option value="mp_rolltex">MP Roll‑Tex Coating — 5 gal</option>
        <option value="specmix_s">SPEC MIX Type S — 80 lb</option>
      </select>
    </label>
    <label>Finish yield (sf per unit)
      <input id="stu_finish_yield" type="number" step="1" min="1" value="90">
    </label>
  </div>
  <div class="row" id="stu_finish_ctrls" style="flex-wrap:wrap; gap:10px; margin-top:6px">
    <label class="pill"><input type="checkbox" id="stu_finish_use_mat" checked> Use materials yield</label>
    <span id="stu_finish_yield_src" class="small muted"></span>
  </div>

  <!-- EIFS-only options -->
  <div id="stu_eifs_opts" class="subcard">
    <div class="row"><b>EIFS yields (fixed)</b><span class="muted small">Basecoat 55 sf/bag · Mesh 475 sf/roll · Finish per above</span></div>
    <div class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px">
      <label class="pill"><input type="checkbox" id="stu_use_foam"> Include foam</label>
      <label>Foam bundle (2'×4') 
        <select id="stu_foam_sel" style="min-width:320px">
          <option value="foam_2">EPS EIFS Foam — 2&quot; (2'×4', 9 sheets) per bundle</option>
          <option value="foam_1_5">EPS EIFS Foam — 1.5&quot; (2'×4', 13 sheets) per bundle</option>
          <option value="foam_1">EPS EIFS Foam — 1&quot; (2'×4', 18 sheets) per bundle</option>
          <option value="foam_0_75">EPS EIFS Foam — 3/4&quot; (2'×4', 30 sheets) per bundle</option>
        </select>
      </label>
      <span id="stu_foam_note" class="small muted"></span>
    </div>
  </div>

  <!-- Traditional-only options -->
  <div id="stu_trad_opts" class="subcard" style="display:none">
    <div class="row"><b>Traditional additives</b><span class="muted small">Enter optional LF/SF for accessories</span></div>
    <div class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px">
      <label>Netting — sf per roll/sheet <input id="stu_trad_net_sfb" type="number" step="1" min="0" placeholder="e.g., 400"></label>
      <label>Casing bead (LF) <input id="stu_trad_bead_lf" type="number" step="1" min="0" placeholder="optional"></label>
      <label>Wood lath strips (LF) <input id="stu_trad_lath_lf" type="number" step="1" min="0" placeholder="optional"></label>
    </div>
  </div>

  <div class="row" style="gap:18px">
    <div class="col">
      <h4>Quantities</h4>
      <div id="stu_results" class="small"></div>
      <details id="stu_diag" style="margin-top:8px">
        <summary>Diagnostics</summary>
        <pre id="stu_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
      </details>
    </div>
    <div class="col">
      <h4>Scope Lines</h4>
      <textarea id="stu_scope" rows="8" style="width:100%;font-family:monospace"></textarea>
      <button id="stu_copy" class="ghost">Copy to clipboard</button>
    </div>
  </div>
</div>

<!-- BEGIN: Chimney Helper (embedded) -->
<div class="card" data-card-chimney id="chimneyCard" data-cat="masonry">
  <div class="row">
    <h3 style="margin:0">Chimney Helper</h3>
    <span class="spacer"></span>
  </div>
  <div class="row">
    <div class="group" style="display:block; width:100%">

<div class="card" tight" id="optsCard">
    <div class="row">
      <div class="kpi">Mode</div>
      

      <label class="pill"><input type="radio" name="mode" id="mode_inches" checked> By inches</label>
      <label class="pill"><input type="radio" name="mode" id="mode_brick"> By brick count (per side)</label>
      <span class="spacer"></span>
      <label class="pill"><input type="checkbox" id="opt_round" checked> Round up quantities</label>
      <label class="pill"><input type="checkbox" id="opt_crown" checked> Include concrete crown</label>
      <label class="pill"><input type="checkbox" id="opt_flash" checked> Include flashing</label>
    <label class="pill"><input type="checkbox" id="no_cap"> Spark Arrestor</label>
</div>
  </div>

  <div class="card"" id="geomCard">
    <h2>Geometry</h2>
    <div class="row grid" id="byInches">
      <label>Outside width (in)
        <input type="number" id="w_in" min="0" step="1" value="0">
      </label>
      <label>Outside depth (in)
        <input type="number" id="d_in" min="0" step="1" value="0">
      </label>
      <label>Rebuild height (ft)
        <input type="number" id="h_ft" min="0" step="1" value="0">
      </label>
      <label>in
        <input type="number" id="h_in" min="0" max="11" step="1" value="0">
      </label>
      <label>Waste %
        <input type="number" id="waste" min="0" step="0.5" value="10">
      </label>
    </div>

    <div class="row grid" id="byBrick" style="display:none">
      <label>Side A — bricks per side (full‑brick eq.)
        <input type="number" id="brixA" min="0" step="1" value="0">
      </label>
      <label>Side B — bricks per side (full‑brick eq.)
        <input type="number" id="brixB" min="0" step="1" value="0">
      </label>
      <label>Brick preset
        <select id="brickPreset">
          <option value="mod" selected>Modular (7.625 × 2.25 actual)</option>
          <option value="util">Utility (11.625 × 2.25 actual)</option>
          <option value="custom">Custom</option>
        </select>
      </label>
      <label>Actual brick length (in)
        <input type="number" id="b_len" min="6" step="0.125" value="7.625">
      </label>
      <label>Actual brick height (in)
        <input type="number" id="b_hgt" min="1.5" step="0.125" value="2.25">
      </label>
      <label>Mortar joint (in)
        <input type="number" id="joint" min="0.25" max="0.5" step="0.125" value="0.375">
      </label>
      <label>Rebuild height (ft)
        <input type="number" id="h_ft_b" min="0" step="1" value="0">
      </label>
      <label>in
        <input type="number" id="h_in_b" min="0" max="11" step="1" value="0">
      </label>
      <label>Waste %
        <input type="number" id="waste_b" min="0" step="0.5" value="10">
      </label>
      <div class="muted">Tip: In running bond, halves on one face become fulls on the next. Total bricks per course ≈ <b>2×(A+B)</b>.</div>
    </div>
    <div class="muted" id="geomNote"></div>
  </div>

  <div class="card"" id="unitsCard">
    <h2>Units & Liners</h2>
    <div class="section-box"><div class="row grid">
      <label>Brick Size
        <select id="bpsf">
          <option value="7" selected>7 5/8&quot; × 3 5/8&quot; × 2 1/4&quot; ≈ 7</option>
          <option value="6">7 5/8&quot; × 2 3/4&quot; × 2 3/4&quot; ≈ 6</option>
          <option value="5.3">11 5/8&quot; × 3 5/8&quot; × 2 1/4&quot; ≈ 5.3</option>
        </select>
      </label>


      <label>Flue tile length (in)
        <input type="number" id="tile_len" min="12" step="1" value="24">
      </label>

      <label>Projection above crown (in)
        <input type="number" id="proj_in" min="0" step="0.5" value="2">
      </label>
<label>Flue tile size
        <select id="flue_size">
          <option value="8x8">8×8</option>
          <option value="8x12" selected>8×12</option>
          <option value="12x12">12×12</option>
          <option value="13x18">13×18</option>
        </select>
      </label>
<label class="pill" style="grid-column:1/-1; align-items:center">
        <input type="checkbox" id="auto_tiles" checked> Auto‑calculate flue tiles from height
      </label>

    </div>
  </div>

  <div class="card"" id="crownCard">
    <h2>Concrete Crown (if included)</h2>
    <div class="row grid">
      <label>Average thickness (in)
        <input type="number" id="crown_thk" min="1.5" step="0.25" value="4">
      </label>
      <label>Overhang each side (in)
        <input type="number" id="crown_oh" min="0" step="0.25" value="1.5">
      </label>
      <label>Flash height for copper (in) <span class="muted">(for sheet area est.)</span>
        <input type="number" id="flash_h" min="6" step="0.5" value="8">
      </label>
    </div>
  </div></div>

  <div class="card"" id="resultsCard">
    <div class="row">
      <h2 style="margin:0">Results</h2>
      <span class="spacer"></span>
      <button class="ghost" id="copyScope">Copy scope</button>
    </div>
    <div id="kpis" class="row" style="gap:8px; margin:6px 0 8px 0"></div>
    <div id="calcOut" class="muted"></div>
    <h3>Scope (copy‑ready)</h3>
    <textarea id="scope" placeholder="Scope lines will appear here…"></textarea>
  </div>

    </div>
  </div>
</div>
<!-- END: Chimney Helper (embedded) -->



<script>
(function(){
  const MATCH = {
    basecoat: /GREEN\s*MAKER.*Decoplast.*Premium.*Basecoat/i,
    mesh:     /Standard.*EIFS.*Fiberglass.*Mesh/i,
    foam:     /foam/i,
    parex_coarse:/Parex.*DPR.*Sand.*Coarse/i,
    parex_fine:/Parex.*DPR.*Sand.*Fine/i,
    parex_swirl:/Parex.*DPR.*Swirl.*Fine/i,
    parex_smooth:/Parex.*DPR.*Sand.*Smooth/i,
    mp_rolltex:/MP.*Roll[\-‑]?Tex.*5\s*gal/i,
    specmix_s:/Spec\s*Mix.*Type\s*-?S.*80\s*lb/i,
    netting:  /stucco\s*netting|galvanized.*netting/i,
    bead:     /stucco.*casing.*bead/i,
    lath:     /wood.*lath/i
  };
  const YIELD = { eifs_base:55, eifs_mesh:475 };

  const FINISH_EIFS = [
    { id:'parex_coarse', label:'Parex DPR Sand Coarse — 5 gal', regex:MATCH.parex_coarse, unit:'bucket', default_sf:90 },
    { id:'parex_fine',   label:'Parex DPR Sand Fine — 5 gal',   regex:MATCH.parex_fine,   unit:'bucket', default_sf:90 },
    { id:'parex_swirl',  label:'Parex DPR Swirl Fine — 5 gal',  regex:MATCH.parex_swirl,  unit:'bucket', default_sf:90 },
    { id:'parex_smooth', label:'Parex DPR Sand Smooth — 5 gal', regex:MATCH.parex_smooth, unit:'bucket', default_sf:90 },
    { id:'mp_rolltex',   label:'MP Roll‑Tex Coating — 5 gal',   regex:MATCH.mp_rolltex,   unit:'bucket', default_sf:90 }
  ];
  const FINISH_TRAD = [
    { id:'specmix_s', label:'SPEC MIX Type S — 80 lb', regex:MATCH.specmix_s, unit:'bag', default_sf:40 }
  ];
  const FOAM_BUNDLES = [
    { id:'foam_2',    label:'EPS EIFS Foam — 2\" (2\'×4\', 9 sheets) per bundle',    sheets:9,  w:2, h:4, regex:/EIFS.*Foam.*2\s*(\"|inch|in)\b/i },
    { id:'foam_1_5',  label:'EPS EIFS Foam — 1.5\" (2\'×4\', 13 sheets) per bundle', sheets:13, w:2, h:4, regex:/EIFS.*Foam.*1\.??5\s*(\"|inch|in)\b/i },
    { id:'foam_1',    label:'EPS EIFS Foam — 1\" (2\'×4\', 18 sheets) per bundle',   sheets:18, w:2, h:4, regex:/EIFS.*Foam.*1\s*(\"|inch|in)\b/i },
    { id:'foam_0_75', label:'EPS EIFS Foam — 3\/4\" (2\'×4\', 30 sheets) per bundle', sheets:30, w:2, h:4, regex:/(EIFS.*Foam.*3\/4\"|EIFS.*Foam.*0\.??75\s*(\"|inch|in)\b)/i }
  ];

  const $  = (s,c=document)=>c.querySelector(s);
  const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));
  const num = (v)=>{ const s=String(v??'').trim().replace(/[,$]/g,''); return s?parseFloat(s)||0:0; };
  const esc = (t)=>String(t).replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
  const roundRule = (n, up)=> up ? Math.ceil(n) : Math.round(n*100)/100;

  function matFindRow(regex){
    let rows = $$('#matTbody tr');
    if(!rows || rows.length===0){
      rows = Array.from(document.querySelectorAll('tr')).filter(r => r.querySelector('.mat_item, .mat_use, .mat_qty'));
    }
    for(const tr of rows){
      const name = (tr.querySelector('.mat_item')?.value || '').toLowerCase();
      const sup  = (tr.querySelector('.mat_sup')?.value  || '').toLowerCase();
      const txt  = (tr.textContent || '').toLowerCase();
      const hay  = name + ' ' + sup + ' ' + txt;
      try{ if(regex.test(hay)) return tr; }catch(e){}
    }
    return null;
  }
  function matSetQtyAndUse(tr, qty){
    if(!tr) return false;
    const useCb  = tr.querySelector('.mat_use');
    const qtyInp = tr.querySelector('.mat_qty');
    if(useCb && !useCb.checked){ useCb.click(); useCb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qtyInp){
      qtyInp.value = String(qty);
      qtyInp.dispatchEvent(new Event('input', {bubbles:true}));
      qtyInp.dispatchEvent(new Event('change',{bubbles:true}));
    }
    return true;
  }
  function matClear(tr){
    if(!tr) return;
    const useCb  = tr.querySelector('.mat_use');
    const qtyInp = tr.querySelector('.mat_qty');
    if(qtyInp){ qtyInp.value=''; qtyInp.dispatchEvent(new Event('input',{bubbles:true})); qtyInp.dispatchEvent(new Event('change',{bubbles:true})); }
    if(useCb && useCb.checked){ useCb.click(); useCb.dispatchEvent(new Event('change',{bubbles:true})); }
  }

  function parseSfFromText(s){
    if(!s) return 0;
    const m = String(s).match(/(\d+(?:\.\d+)?)\s*(?:sf|sq\s*[\.\-]?\s*ft|square\s*feet)/i);
    return m ? parseFloat(m[1]) : 0;
  }
  function getMaterialYield(regex){
    const tr = matFindRow(regex);
    if(!tr) return 0;
    const keys = ['data-sf','data-sfper','data-sf-per','data-coverage','data-cover','data-yield','data-sf_per_unit'];
    for(const k of keys){ const v = tr.getAttribute(k); if(v && !isNaN(parseFloat(v))) return parseFloat(v); }
    const t = tr.textContent || '';
    const n = parseSfFromText(t); if(n>0) return n;
    const cells = Array.from(tr.cells || []);
    for(const td of cells){ const n2 = parseSfFromText(td.textContent || ''); if(n2>0) return n2; }
    return 0;
  }

  const MAT_NAME_MAP = {
    basecoat: "GREEN MAKER Decoplast Premium Basecoat — 50 lb",
    parex_coarse: "Parex DPR Sand Coarse — 5 gal",
    parex_fine:   "Parex DPR Sand Fine — 5 gal",
    parex_swirl:  "Parex DPR Swirl Fine — 5 gal",
    parex_smooth: "Parex DPR Sand Smooth — 5 gal",
    mp_rolltex:   "MP Roll‑Tex Coating — 5 gal",
    specmix_s:    "SPEC MIX Type S — 80 lb",
    foam_2:       "EPS EIFS Foam — 2\" (2'×4', 9 sheets) per bundle",
    foam_1_5:     "EPS EIFS Foam — 1.5\" (2'×4', 13 sheets) per bundle",
    foam_1:       "EPS EIFS Foam — 1\" (2'×4', 18 sheets) per bundle",
    foam_0_75:    "EPS EIFS Foam — 3/4\" (2'×4', 30 sheets) per bundle"
  };
  function matFindByItemName(name){
    if(!name) return null;
    const rows = Array.from(document.querySelectorAll('tr')).filter(r => r.querySelector('.mat_item'));
    const target = name.toLowerCase().trim();
    for(const tr of rows){
      const v = (tr.querySelector('.mat_item')?.value || '').toLowerCase().trim();
      if(v === target) return tr;
    }
    return null;
  }
  function matGetRowByKey(key){
    const byName = MAT_NAME_MAP[key] ? matFindByItemName(MAT_NAME_MAP[key]) : null;
    if(byName) return byName;
    const rxMap = {
      basecoat: MATCH.basecoat,
      parex_coarse: MATCH.parex_coarse,
      parex_fine:   MATCH.parex_fine,
      parex_swirl:  MATCH.parex_swirl,
      parex_smooth: MATCH.parex_smooth,
      mp_rolltex:   MATCH.mp_rolltex,
      specmix_s:    MATCH.specmix_s,
      foam_2:       /2\s*(?:\"|inch|in)\b/i,
      foam_1_5:     /1\.??5\s*(?:\"|inch|in)\b/i,
      foam_1:       /1\s*(?:\"|inch|in)\b/i,
      foam_0_75:    /(3\/4\"|0\.??75\s*(?:\"|inch|in)\b)/i
    };
    const rx = rxMap[key];
    return rx ? matFindRow(rx) : null;
  }

  const FINISH_KEYS_EIFS = ['parex_coarse','parex_fine','parex_swirl','parex_smooth','mp_rolltex'];
  const FINISH_KEYS_TRAD = ['specmix_s'];
  const FOAM_KEYS        = ['foam_2','foam_1_5','foam_1','foam_0_75'];
  function matClearKeys(keys){ (keys||[]).forEach(k=>{ const tr = matGetRowByKey(k); if(tr) matClear(tr); }); }
  function matClearGroupExcept(keys, keepKey){ (keys||[]).forEach(k=>{ if(k!==keepKey){ const tr = matGetRowByKey(k); if(tr) matClear(tr); } }); }

  function getFinishChoice(){
    const isEIFS = $('#stu_sys_eifs')?.checked;
    const sel = $('#stu_finish_sel');
    const list = isEIFS ? FINISH_EIFS : FINISH_TRAD;
    return list.find(o=>o.id === (sel?.value||'')) || list[0];
  }
  function getFoamChoice(){
    const sel = $('#stu_foam_sel');
    const id = sel?.value || 'foam_2';
    return FOAM_BUNDLES.find(f=>f.id===id) || FOAM_BUNDLES[0];
  }
  function syncFinishYield(){
    const choice = getFinishChoice();
    const yEl = $('#stu_finish_yield');
    const useMat = $('#stu_finish_use_mat')?.checked;
    const src = $('#stu_finish_yield_src');
    let note = '';
    if(useMat){
      const y = getMaterialYield(choice.regex);
      if(y && yEl){ yEl.value = y; note = '(from Materials: '+y+' sf/unit)'; }
      else { note = '(Materials yield not found — using manual/default)'; }
    } else { note = '(manual)'; }
    if(src) src.textContent = note;
  }

  function stuccoCalc(){
    const area = num($('#stu_area')?.value);
    const wastePct = num($('#stu_waste')?.value);
    const roundUp  = !!$('#stu_round')?.checked;
    const isEIFS   = $('#stu_sys_eifs')?.checked;
    const areaEff = area * (1 + (wastePct/100));
    const res = { lines: [], html: [], debug: [] }



;

    if(!area || area <= 0){
      $('#stu_results').innerHTML = '<div class="muted">Enter an area in square feet to begin.</div>';
      $('#stu_scope').value = '';
      
      try{
        // Clear EIFS/Traditional stucco materials if area is cleared
        matClearKeys(['basecoat','mesh']);
        matClearKeys(FINISH_KEYS_EIFS);
        matClearKeys(FINISH_KEYS_TRAD);
        matClearKeys(FOAM_KEYS);
      }catch(e){}
      
      /* __STUCCO_ZERO_HARD_CLEAR__ */
      try{
        const tbody = document.getElementById('matTbody');
        if (tbody){
          // Explicit stucco SKUs to clear (EIFS basecoat, mesh, finishes, foam)
          ['m2002','m2003','m2004','m2005','m2006','m2007','m2008','m2009'].forEach(function(id){
            var tr = tbody.querySelector('tr[data-id="'+id+'"]');
            if (tr){
              var q = tr.querySelector('.mat_qty'); if(q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
              var cb = tr.querySelector('.mat_use'); if(cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); }
            }
          });
          // Fallback by regex match in case labels/ids change
          Array.from(tbody.querySelectorAll('tr')).forEach(function(tr){
            var t = (tr.textContent||'').toLowerCase();
            if(/standard.*eifs.*fiberglass.*mesh/.test(t) || /decoplast.*basecoat/.test(t) || /parex.*dpr/.test(t) || /\beifs.*foam|\bfoam\b/.test(t)){
              var q = tr.querySelector('.mat_qty'); if(q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
              var cb = tr.querySelector('.mat_use'); if(cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); }
            }
          });
        }
        // Force totals refresh so leftover prices drop immediately
        if (typeof window.updateAll === 'function') window.updateAll();
        else if (typeof window.totals === 'function') window.totals();
      }catch(e){}
      /* __/STUCCO_ZERO_HARD_CLEAR__ */

      return;
    }if(isEIFS){
      // Basecoat
      let base_bags = areaEff / YIELD.eifs_base;
      base_bags = roundRule(base_bags, roundUp);
      const base_tr = matGetRowByKey('basecoat');
      if(base_tr && base_bags>0) matSetQtyAndUse(base_tr, areaEff);
      res.html.push('<div><strong>Basecoat (Decoplast 50 lb):</strong> '+base_bags+' bags</div>');
      res.lines.push('EIFS basecoat (Decoplast Premium, 50 lb): ≈ '+base_bags+' bags ('+YIELD.eifs_base+' sf/bag).');
      res.debug.push('basecoat_bags='+base_bags);

      // Mesh
      let mesh_rolls = areaEff / YIELD.eifs_mesh;
      mesh_rolls = roundRule(mesh_rolls, roundUp);
      const mesh_tr = matFindRow(MATCH.mesh);
      if(mesh_tr && mesh_rolls>0) matSetQtyAndUse(mesh_tr, areaEff);
      res.html.push('<div><strong>EIFS Mesh (38&quot;×150&quot;):</strong> '+mesh_rolls+' rolls</div>');
      res.lines.push('Embed Standard EIFS fiberglass mesh: ≈ '+mesh_rolls+' rolls (38&quot;×150&quot;, '+YIELD.eifs_mesh+' sf/roll).');
      res.debug.push('mesh_rolls='+mesh_rolls);

      // Finish (clear other finishes first)
      matClearKeys(FINISH_KEYS_TRAD);
      const finChoice = getFinishChoice();
      const useMat = $('#stu_finish_use_mat')?.checked;
      const matYield = useMat ? getMaterialYield(finChoice.regex) : 0;
      const fin_sf = Math.max(1, matYield || num($('#stu_finish_yield')?.value) || finChoice.default_sf);
      let fin_units = areaEff / fin_sf; fin_units = roundRule(fin_units, roundUp);
      matClearGroupExcept(FINISH_KEYS_EIFS, finChoice.id);
      const fin_tr = matGetRowByKey(finChoice.id);
      if(fin_tr && fin_units>0) matSetQtyAndUse(fin_tr, areaEff);
      res.html.push('<div><strong>'+esc(finChoice.label)+':</strong> '+fin_units+' '+(finChoice.unit==='bag'?'bags':'buckets')+'</div>');
      res.lines.push('Finish ('+finChoice.label+'): ≈ '+fin_units+' '+(finChoice.unit==='bag'?'bags':'buckets')+' ('+fin_sf+' sf per unit).');
      res.debug.push('finish_units='+fin_units+', fin_sf='+fin_sf);

      // Foam
      if($('#stu_use_foam')?.checked){
        const foam = getFoamChoice();
        const perBoard = foam.w * foam.h; // 2x4 = 8 sf
        const perBundle = foam.sheets * perBoard;
        let bundles = areaEff / perBundle; bundles = roundRule(bundles, roundUp);
        const boards = bundles * foam.sheets;
        $('#stu_foam_note').textContent = '('+perBundle+' sf/bundle · '+foam.sheets+' boards/bundle)';
        res.html.push('<div><strong>Foam ('+esc(foam.label)+'):</strong> '+bundles+' bundles (~'+boards+' boards)</div>');
        res.lines.push('EIFS foam 2×4 ft sheets: ≈ '+bundles+' bundles (~'+boards+' boards).');
        matClearGroupExcept(FOAM_KEYS, foam.id);
        const foam_tr = matGetRowByKey(foam.id) || matFindRow(MATCH.foam);
        if(foam_tr){
          const text = (foam_tr.textContent||'').toLowerCase();
          const wantsBundles = /bundle/.test(text);
          matSetQtyAndUse(foam_tr, areaEff);
        }
        res.debug.push('foam_bundles='+bundles+', perBundle='+perBundle);
      } else {
        matClearKeys(FOAM_KEYS);
      }
    } else {
      // Traditional
      (function(){ try{
        const base_tr = matGetRowByKey('basecoat'); if(base_tr) matClear(base_tr);
        const mesh_tr = matFindRow(MATCH.mesh); if(mesh_tr) matClear(mesh_tr);
        matClearKeys(FINISH_KEYS_EIFS);
        matClearKeys(FOAM_KEYS);
      }catch(e){} })();

      const finChoice = getFinishChoice();
      const useMat = $('#stu_finish_use_mat')?.checked;
      const matYield = useMat ? getMaterialYield(finChoice.regex) : 0;
      const fin_sf = Math.max(1, matYield || num($('#stu_finish_yield')?.value) || finChoice.default_sf);
      let fin_units = areaEff / fin_sf; fin_units = roundRule(fin_units, roundUp);
      const trF = matGetRowByKey(finChoice.id);
      if(trF && fin_units>0) matSetQtyAndUse(trF, fin_units);
      res.html.push('<div><strong>'+esc(finChoice.label)+':</strong> '+fin_units+' '+(finChoice.unit==='bag'?'bags':'buckets')+'</div>');
      res.lines.push('Traditional finish ('+finChoice.label+'): ≈ '+fin_units+' '+(finChoice.unit==='bag'?'bags':'buckets')+' ('+fin_sf+' sf per unit).');

      const netS = num($('#stu_trad_net_sfb')?.value);
      if(netS>0){
        let nets = areaEff / netS; nets = roundRule(nets, roundUp);
        res.html.push('<div><strong>Stucco netting:</strong> '+nets+' rolls/sheets</div>');
        res.lines.push('Galvanized stucco netting: ≈ '+nets+' rolls/sheets ('+netS+' sf each).');
        const tr = matFindRow(MATCH.netting);
        if(tr && nets>0) matSetQtyAndUse(tr, nets);
      } else {
        res.html.push('<div>Stucco netting: <span class="muted">enter sf per roll/sheet</span></div>');
      }

      const bead = num($('#stu_trad_bead_lf')?.value);
      if(bead>0){
        res.html.push('<div><strong>Casing bead:</strong> '+bead+' LF</div>');
        res.lines.push('Galvanized stucco casing bead: ≈ '+bead+' LF.');
        const tr = matFindRow(MATCH.bead);
        if(tr) matSetQtyAndUse(tr, bead);
      }
      const lath = num($('#stu_trad_lath_lf')?.value);
      if(lath>0){
        res.html.push('<div><strong>Wood lath strips:</strong> '+lath+' LF</div>');
        res.lines.push('Wood lath strips: ≈ '+lath+' LF.');
        const tr = matFindRow(MATCH.lath);
        if(tr) matSetQtyAndUse(tr, lath);
      }
    }

    $('#stu_results').innerHTML = res.html.join('');
    const header = isEIFS ? 'Synthetic EIFS stucco — area '+area+' sf (+ '+wastePct+'% waste).'
                          : 'Traditional stucco — area '+area+' sf (+ '+wastePct+'% waste).';
    $('#stu_scope').value = [header].concat(res.lines).join('\n');
    const pre = $('#stu_diag_pre'); if(pre) pre.textContent = 'areaEff='+areaEff+'\n'+res.debug.join('\n');
  }
/* __STUCCO_BINDINGS__ */
try { window.stuccoCalc = stuccoCalc; } catch(e){}

document.addEventListener('DOMContentLoaded', function(){
  function bind(sel, ev){
    var el = document.querySelector(sel);
    if(!el) return;
    el.addEventListener(ev, function(){ try{ stuccoCalc(); }catch(e){} }, true);
  }
  // Core drivers
  bind('#stu_area','input');
  bind('#stu_waste','input');
  bind('#stu_round','change');
  bind('#stu_sys_eifs','change');
  bind('#stu_sys_trad','change');
  // Finishes + foam
  bind('#stu_finish_sel','change');
  bind('#stu_finish_yield','input');
  bind('#stu_finish_use_mat','change');
  bind('#stu_foam_sel','change');
  bind('#stu_use_foam','change');

  // Kick once on load
  try{ stuccoCalc(); }catch(e){}
});
/* __/STUCCO_BINDINGS__ */


  function bind(){
    ['stu_area','stu_waste','stu_round','stu_finish_yield','stu_trad_net_sfb','stu_trad_bead_lf','stu_trad_lath_lf']
      .forEach(id => { const el = document.getElementById(id); if(el){ el.addEventListener('input', stuccoCalc); el.addEventListener('change', stuccoCalc); }});

    document.querySelectorAll('#stuccoCard input[name=\"stu_sys\"]').forEach(el=> el.addEventListener('change', function(){
      const eifs = (this.value === 'eifs');
      $('#stu_eifs_opts').style.display = eifs ? '' : 'none';
      $('#stu_trad_opts').style.display = eifs ? 'none' : '';
      const sel = $('#stu_finish_sel');
      if(sel){
        sel.innerHTML = '';
        (eifs ? FINISH_EIFS : FINISH_TRAD).forEach(o=>{
          const op = document.createElement('option'); op.value=o.id; op.textContent=o.label; sel.appendChild(op);
        });
        $('#stu_finish_yield').value = (eifs ? FINISH_EIFS[0].default_sf : FINISH_TRAD[0].default_sf);
      }
      syncFinishYield();
      stuccoCalc();
    }));

    $('#stu_finish_sel')?.addEventListener('change', ()=>{ syncFinishYield(); stuccoCalc(); });
    $('#stu_finish_use_mat')?.addEventListener('change', ()=>{ syncFinishYield(); stuccoCalc(); });
    $('#stu_foam_sel')?.addEventListener('change', ()=>{ stuccoCalc(); });
    $('#stu_use_foam')?.addEventListener('change', ()=>{ stuccoCalc(); });

    const sel = $('#stu_finish_sel');
    if(sel && sel.options.length===0){ FINISH_EIFS.forEach(o=>{ const op=document.createElement('option'); op.value=o.id; op.textContent=o.label; sel.appendChild(op); }); }
    syncFinishYield();
    stuccoCalc();

    try{
      const matBody = document.getElementById('matTbody');
      if(matBody){
        let __stucco_obs_timer = null;
        const onMatChange = () => {
          if(__stucco_obs_timer) cancelAnimationFrame(__stucco_obs_timer);
          __stucco_obs_timer = requestAnimationFrame(()=>{ __stucco_obs_timer=null; if(typeof window.stuccoCalc==='function') window.stuccoCalc(); });
        };
        const mo = new MutationObserver(onMatChange);
        mo.observe(matBody, {childList:true, subtree:false});
      }
    }catch(e){}

    window.stuccoCalc = stuccoCalc;
    window.addEventListener('error', function(e){
      const pre = document.getElementById('stu_diag_pre');
      if(pre){ pre.textContent = (pre.textContent?pre.textContent+'\n':'') + 'JS Error: '+(e.message||e.error); }
    });
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
  else { bind(); }
})();
</script>



</div>
<!-- CONCRETE -->
<div class="card" id="concreteCard" data-cat="concrete">
<div id="concreteShell" class="concrete-shell">

<div class="row">
<h3 style="margin:0">Concrete</h3>
<!-- Turcotte: Concrete Yards Helper v1 (2025-09-02) -->
<div class="subcard" id="tm-concrete-yards-helper" style="border:1px dashed #ccc; padding:10px; margin:10px 0;">
  <div class="row" style="flex-wrap:wrap; gap:10px;">
    <b>Concrete Yards Calculator</b>
    <label>L (ft) <input type="number" id="tm_len_ft" step="0.1" placeholder="e.g., 11"></label>
    <label>W (ft) <input type="number" id="tm_wid_ft" step="0.1" placeholder="e.g., 11"></label>
    <label>H (in) <input type="number" id="tm_thk_in" step="0.25" placeholder="e.g., 6"></label>
    <label class="pill"><input type="checkbox" id="tm_waste_on" checked> +5% waste</label>
    <label>Round to <select id="tm_round"><option value="0.25">¼ yd</option><option value="0.5">½ yd</option><option value="1">1 yd</option><option value="0">exact</option></select></label>
    
  </div>
  <div class="row small muted" style="margin-top:6px;">
    Formula: L × W × (T in ÷ 12) ÷ 27 = yd³. (Adds optional 5% waste. Auto-fills supplier by rule: < 3 yd → Concrete Connections; ≥ 3 yd → Mohican Valley.) 30-bag cap: ≤ 30 bags stays as 80-lb bags; ≥ 31 bags routes to Concrete Connections.
  </div>
  <div class="row" style="gap:10px; margin-top:8px;">
    <div>Yards (computed): <span id="tm_yards_out" class="pill" style="min-width:80px; text-align:center;">—</span></div>
    <div>Selected source: <span id="tm_supplier_out" class="pill" style="min-width:160px; text-align:center;">—</span></div>
  </div>
  <div class="subcard" style="margin-top:8px;">
    <div class="row"><b>Bags Equivalent (approx.)</b><span class="spacer"></span><span class="muted small">Uses Quikrete/Sakrete published yields</span></div>
    <div id="tm_bags_rows" style="display:flex;flex-direction:column;gap:4px;margin-top:6px;"></div>
  </div>
</div>





<script>
(function(){
  const whenReady = (fn)=>{
    if (document.readyState === 'complete' || document.readyState === 'interactive'){
      setTimeout(fn, 0);
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  };

  whenReady(function(){
    const $ = (s, c=document)=>c.querySelector(s);
    const byId = id => document.getElementById(id);
    const num = v => {
      if (v===null || v===undefined) return 0;
      const s = String(v).trim().replace(/[,$]/g,'');
      if (!s) return 0;
      const n = parseFloat(s); return Number.isFinite(n)?n:0;
    };
    function roundTo(n, step){
      if (!step || step<=0) return n;
      return Math.round(n/step)*step;
    }
    function computeYards(L, W, T_in, wasteOn){
      let y = (L * W * (T_in/12)) / 27;
      if (wasteOn) y *= 1.05;
      return y;
    }

    // Bag math (80-lb)
    const BAG_YIELD_FT3_80 = 0.60; // industry published yield
    function bagCount80FromRawYards(yardsRaw){
      const cf = yardsRaw * 27;
      if (cf <= 0) return 0;
      const cnt = Math.ceil(cf / BAG_YIELD_FT3_80);
      return Math.max(1, cnt); // min 1 for any positive volume
    }

    // Materials helpers: find a row that looks like 80-lb concrete mix (Quikrete/Sakrete)
    function findConcreteBagRow(){
      const rows = Array.from(document.querySelectorAll('#matTbody tr'));
      for (const tr of rows){
        const t = (tr.textContent || '').toLowerCase();
        if (/(80\s*lb|80lb)/.test(t) && /(concrete|quikrete|sakrete)/.test(t)){
          return tr;
        }
      }
      return null;
    }
    function matSetQtyAndUse(tr, qty){
      if (!tr) return false;
      const useCb  = tr.querySelector('.mat_use');
      const qtyInp = tr.querySelector('.mat_qty');
      if (useCb && !useCb.checked){ useCb.click(); }
      if (qtyInp){
        qtyInp.value = qty;
        qtyInp.dispatchEvent(new Event('input', {bubbles:true}));
      }
      return true;
    }
    function matClearUse(tr){
      if (!tr) return;
      const useCb  = tr.querySelector('.mat_use');
      const qtyInp = tr.querySelector('.mat_qty');
      if (qtyInp){
        qtyInp.value = '';
        qtyInp.dispatchEvent(new Event('input', {bubbles:true}));
      }
      if (useCb && useCb.checked){ useCb.click(); }
    }

    // Yards targets
    let ctInput=null, mvInput=null, targetsReady=false;
    function tryFindTargets(){
      ctInput = byId('ct_yards');
      mvInput = byId('mv_yards');
      targetsReady = !!(ctInput && mvInput);
      return targetsReady;
    }
    const mo = new MutationObserver(()=>{
      if (!targetsReady && tryFindTargets()){
        recalc();
      }
    });
    mo.observe(document.documentElement || document.body, {childList:true, subtree:true});

    
    function applyRouting(yRaw, yRounded){
      // Manual override: if Rob types a bag count, sync that directly to Materials and skip yards routing
      const manualInp = byId('tm_bags_80_qty');
const manualQty = manualInp ? num(manualInp.value) : 0;
if (manualInp && manualQty > 0){
  if (manualQty <= 30) {
    if (ctInput) { ctInput.value = ''; ctInput.dispatchEvent(new Event('input', {bubbles:true})); }
    if (mvInput) { mvInput.value = ''; mvInput.dispatchEvent(new Event('input', {bubbles:true})); }
    const trMan = getOrCreateConcrete80Row();
    if (trMan) { matSetQtyAndUse(trMan, Math.floor(manualQty)); }
    const out0 = byId('tm_supplier_out'); if (out0) out0.textContent = `Bags (80-lb) — ${Math.floor(manualQty)} bags`;
    return;
  } else {
    // > 30 bags — clear manual entry and any existing 80-lb bag line; switch to yards routing
    manualInp.value = '';
    manualInp.dispatchEvent(new Event('input', {bubbles:true}));
    const trMan = getOrCreateConcrete80Row();
    if (trMan) { matClearUse(trMan); }
    // do not return; fall through to yards-based routing below
  }
}

      const out = byId('tm_supplier_out'); // now "source"
      const bagRow = findConcreteBagRow();
      const bagCount = bagCount80FromRawYards(yRaw);

      // Rule 1: If bags < 30 -> use bags pricing
      if (bagCount > 0 && bagCount <= 30){
        // Clear yard suppliers
        if (ctInput) { ctInput.value = ''; ctInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (mvInput) { mvInput.value = ''; mvInput.dispatchEvent(new Event('input', {bubbles:true})); }
        // Set bags
        const ok = matSetQtyAndUse(bagRow, bagCount);
        if (out) out.textContent = ok ? `Bags (80‑lb) — ${bagCount} bags` : 'Bags (80‑lb) — row not found';
        return;
      }

      // Otherwise: yards-based
      // Clear bag line if present
      matClearUse(bagRow);

      if (!targetsReady && !tryFindTargets()){
        if (out) out.textContent = 'Waiting for yard inputs…';
        return;
      }

      // Rule 2: Under 3 yards -> Concrete Connections
      // Rule 3: 3 yards or more -> Mohican Valley (last company)
      if (yRounded < 3){
        if (mvInput) { mvInput.value = ''; mvInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (ctInput) { ctInput.value = yRounded; ctInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (out) out.textContent = 'Concrete Connections';
      } else {
        if (ctInput) { ctInput.value = ''; ctInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (mvInput) { mvInput.value = yRounded; mvInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (out) out.textContent = 'Mohican Valley';
      }
    }

    function recalc(){
      const L = num(byId('tm_len_ft')?.value);
      const W = num(byId('tm_wid_ft')?.value);
      const T = num(byId('tm_thk_in')?.value);
      const waste = !!byId('tm_waste_on')?.checked;
      const step = parseFloat(byId('tm_round')?.value || '0.25');

      if (!L || !W || !T){
        const yOut = byId('tm_yards_out'); if (yOut) yOut.textContent = '—';
        const br = byId('tm_bags_rows'); if (br) br.innerHTML = '';
        if (byId('tm_supplier_out')) byId('tm_supplier_out').textContent = '—';
        const man = byId('tm_bags_80_qty');
if (man){
  man.value = '';
  man.dispatchEvent(new Event('input', {bubbles:true}));
}
// Also clear existing Materials row if present (without creating a new one)
try{
  const tr = (typeof findConcreteBagRowExact==='function') ? findConcreteBagRowExact() : null;
  if (tr){
    const q = tr.querySelector('.mat_qty'); if (q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); }
    const cb = tr.querySelector('.mat_use'); if (cb && cb.checked){ cb.click(); cb.dispatchEvent(new Event('change',{bubbles:true})); }
  }
}catch(e){}
try{
  // Clear manual 80‑lb bags (and thus Materials) if present
  const man = byId('tm_bags_80_qty');
  if (man){
    man.value = '';
    man.dispatchEvent(new Event('input', {bubbles:true}));
  }
  // Clear supplier yard inputs and trigger their own recalcs
  const ct = byId('ct_yards');
  if (ct){ ct.value = ''; ct.dispatchEvent(new Event('input', {bubbles:true})); }
  const mv = byId('mv_yards');
  if (mv){ mv.value = ''; mv.dispatchEvent(new Event('input', {bubbles:true})); }
  // Attempt a full totals refresh
  if (typeof window.updateAll === 'function') { window.updateAll(); }
  else if (typeof window.totals === 'function') { window.totals(); }
}catch(e){}

return;
      }

      // Compute raw and rounded yards
      const yRaw = computeYards(L, W, T, waste);
      const yRounded = Math.round(((step>0) ? roundTo(yRaw, step) : yRaw)*100)/100;

      // Display yards
      const yOut = byId('tm_yards_out');
      if (yOut) yOut.textContent = yRounded.toFixed(2);

      // Update bags display (from raw yards)
      const outB = byId('tm_bags_rows');
      if (outB) outB.style.display = 'none'; // hide the old computed box
      const cnt = bagCount80FromRawYards(yRaw);
      const man = byId('tm_bags_80_qty');
      if (man){
        // mirror computed → manual, but don't fight the user while typing
        if (document.activeElement !== man){
          man.value = (cnt > 0 ? String(cnt) : '');
          man.dispatchEvent(new Event('input', {bubbles:true}));
        }
      }

      // Route to source
      applyRouting(yRaw, yRounded);
    }

    // Wire events
    ['tm_len_ft','tm_wid_ft','tm_thk_in'].forEach(id=> byId(id)?.addEventListener('input', recalc));
    byId('tm_waste_on')?.addEventListener('change', recalc);
    byId('tm_round')?.addEventListener('change', recalc);

    // Init
    setTimeout(()=>{ tryFindTargets(); recalc(); }, 150);
    // === Manual 80‑lb bags → Materials sync (Turcotte) ===
    function findConcreteBagRowExact(){
      return document.querySelector('#matTbody tr[data-id="mNHM_Concrete_80lb"]') || findConcreteBagRow();
    }
    function ensureConcrete80Defaults(tr){
      if (!tr) return;
      const setVal = (sel,val)=>{ const el=tr.querySelector(sel); if(el){ el.value=val; el.dispatchEvent(new Event('input',{bubbles:true})); } };
      setVal('.mat_item','Concrete 80lb Bag');
      setVal('.mat_sup','New Haven Masonry');
      setVal('.mat_units','bag');
      setVal('.mat_price','6.36');
      const useCb = tr.querySelector('.mat_use'); if(useCb && !useCb.checked){ useCb.click(); useCb.dispatchEvent(new Event('change', {bubbles:true})); }
    }
    function getOrCreateConcrete80Row(){
      let tr = findConcreteBagRowExact();
      if (!tr) {
        const addBtn = document.getElementById('addMatBtn');
        if (addBtn) { addBtn.click(); }
        const rows = document.querySelectorAll('#matTbody tr');
        tr = rows[rows.length-1] || null;
      }
      if (tr) ensureConcrete80Defaults(tr);
      return tr;
    }
    function syncBagsToMaterials(){
      const inp = byId('tm_bags_80_qty'); if (!inp) return;
      const qty = Math.max(0, Math.floor(num(inp.value||0)));
      // Allow clearing to zero without forcing a material line
      const tr = (qty>0) ? getOrCreateConcrete80Row() : (typeof findConcreteBagRowExact==='function' ? findConcreteBagRowExact() : null);
      if (tr) {
        if (qty > 0) {
          matSetQtyAndUse(tr, qty);
        } else {
          // qty 0: clear qty and uncheck Use
          const qtyInp = tr.querySelector('.mat_qty');
          if (qtyInp){ qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input',{bubbles:true})); }
          const useCb = tr.querySelector('.mat_use'); if(useCb && useCb.checked){ useCb.click(); }
        }
      }
    }
    // Build manual input UI once (placed next to the computed "Bags Equivalent" area)
    (function makeManualBagsUI(){
      const _br = byId('tm_bags_rows'); if (_br) { _br.style.display = 'none'; }
      const rowsWrap = byId('tm_bags_rows');
      const container = rowsWrap && rowsWrap.parentElement;
      if (container && !byId('tm_bags_80_qty')) {
        const row = document.createElement('div');
        row.className = 'row';
        row.style.gap='8px';
        row.style.marginTop = '6px';
        row.innerHTML = '<div class="pill">80 lb bags</div><div>=</div>' +
                        '<input id="tm_bags_80_qty" type="number" step="1" min="0" placeholder="0" style="width:100px">' +
                        '<span class="muted small">(syncs “Concrete 80lb Bag” in Materials)</span>';
        container.appendChild(row);
        byId('tm_bags_80_qty').addEventListener('input', function(){ syncBagsToMaterials(); });
      }
    })();

  });
})();
</script>

<!-- /Turcotte helper -->

<span class="pill">Concrete Connections (≤ 3 yd/trip)</span>
<span class="pill">Mohican Valley (10‑yd trucks)</span>
<span class="spacer"></span>
</div>
<div class="subcard" style="border:1px dashed #ccc; padding:10px; margin:10px 0;">
<div class="row" style="margin-top:6px"><b>Concrete Connections — small loads</b></div>
<div class="row">
<label>Yards <input id="ct_yards" placeholder="0" step="0.25" type="number"/></label>
<label>Price/yd ($) <input id="ct_price" step="1" type="number" value="185"/></label>
<label>Delivery fee / trip ($) <input id="ct_delivery" step="1" type="number" value="285"/></label>
<span class="pill">Trips (auto): <span class="mono" id="ct_trips_read">0</span></span> <label class="pill"><input id="ct_out_of_area" type="checkbox"/> Out of Area (+$75)</label>
</div>
<div class="row">
<span class="pill">Material: <span class="mono" id="ct_mat">$0.00</span></span>
<span class="pill">Delivery: <span class="mono" id="ct_deliv">$0.00</span></span>
<span class="pill">CC Subtotal: <span class="mono" id="ct_sub">$0.00</span></span>
</div>
</div>
<div class="subcard" style="border:1px dashed #ccc; padding:10px; margin:10px 0;">
<div class="subcard">
<div class="row" style="margin-top:12px"><b>Mohican Valley — big trucks</b> <span class="muted">(enter quoted price/yd; 10‑yd trucks)</span></div>
<div class="row">
<label>Yards <input id="mv_yards" placeholder="0" step="0.5" type="number"/></label>
<label>Price/yd ($) <input id="mv_price" placeholder="0" step="1" type="number"/></label>
<label>Other/Manual Mohican fee ($) <input id="mv_short" placeholder="0" step="1" type="number"/></label>
<div class="row" style="margin-top:8px">
<label>Job date <input id="job_date" type="date"/></label>
<label>Winter service ($/yd) <input id="mv_winter" step="0.5" type="number" value="11"/></label>
<label class="pill"><input checked="" id="mv_winter_auto" type="checkbox"/> Auto winter by date (Nov 15–Apr 15)</label>
<label class="pill"><input id="mv_winter_on" type="checkbox"/> Apply winter now</label>
</div>
<div class="row">
<label>Truck capacity (yd) <input id="mv_cap" step="1" type="number" value="10"/></label>
<label>Min-load threshold (yd) <input id="mv_min" step="0.5" type="number" value="5"/></label>
<label>Short‑load fee ($/yd if load &lt; threshold) <input id="mv_short_per_yd" step="1" type="number" value="200"/></label>
<label>Fuel surcharge / load ($) <input id="mv_fuel" step="0.5" type="number" value="30"/></label>
<label>Environmental fee / load ($) <input id="mv_env" step="0.1" type="number" value="3.5"/></label>
</div>
<div class="row">
<label class="pill"><input id="mv_ex_38" type="checkbox"/> 1/2" Aggregate (+$/yd)</label>
<label>$/yd <input id="mv_ex_38_ppy" step="0.5" type="number" value="5"/></label>
</div>
<!-- DUP PUMP UI REMOVED (was here)
<div class="row">
  <label class="pill"><input id="pump_use" type="checkbox"> Use pump truck</label>
  <label>Size
    <select id="pump_size">
      <option value="32@290">32 m — $290/hr (4 hr min)</option>
      <option value="40@310">40 m — $310/hr (4 hr min)</option>
    </select>
  </label>
  <label>Hours <input id="pump_hours" type="number" step="0.5" placeholder="0"></label>
</div>
-->
<div class="row">
<span class="pill">Trucks (auto): <span class="mono" id="mv_trucks">0</span></span>
<span class="pill">Per‑load fees: <span class="mono" id="mv_loadfees">$0.00</span></span>
<span class="pill">Short‑load surcharges: <span class="mono" id="mv_shortfees">$0.00</span></span>
<span class="pill">Material: <span class="mono" id="mv_mat">$0.00</span></span>
<span class="pill">Extras: <span class="mono" id="mv_extras">$0.00</span></span>
<span class="pill">Pump: <span class="mono" id="mv_pump">$0.00</span></span>
</div>
<div class="row">
<span class="pill">MV Subtotal: <span class="mono" id="mv_sub">$0.00</span></span>
</div>
</div>
</div>
</div>
<!-- FUEL -->

</div><!-- /concrete-shell -->
<div class="card" id="fuelCard" data-cat="fuel">
<div class="row">
<h3 style="margin:0">Vehicle Fuel</h3>
<span class="pill">PPG = AAA CT peak Regular $4.984 (6/14/22)</span>
</div>
<div class="row">
<label>Price per gallon ($) <input id="fuel_ppg" step="0.001" type="number" value="4.984"/></label>
<label>Gallons for this job <input id="fuel_gal" placeholder="0" step="0.5" type="number"/></label>
</div>
<div class="row">
<span class="pill">Fuel Subtotal: <span class="mono" id="fuel_sub">$0.00</span></span>
</div>
</div>
<!-- WASTE -->
<div class="card" data-card-waste data-cat="waste">
<div class="row"><h3 style="margin:0">Waste / Disposal</h3><span class="spacer"></span><button class="ghost" id="wasteAdd">+ Add Disposal item</button><span class="muted">Modern Materials — Clean asphalt disposal</span></div>
<table>
<thead><tr><th>Use</th><th>Material</th><th>Facility</th><th>Units</th><th>Rate</th><th>Qty</th><th>Ext.</th><th></th></tr></thead>
<tbody id="wasteTbody"></tbody>
<tfoot><tr><td class="right" colspan="6">Disposal Subtotal</td><td class="right mono" id="wasteSubtotal">$0.00</td><td></td></tr></tfoot>
</table>
</div>
<!-- SILICA CONTROLS -->
<div class="card" id="silicaCard" data-cat="silica">
  <div class="row">
    <h3 style="margin:0">Silica Controls (OSHA 29 CFR 1926.1153 Table 1)</h3>
  </div>
  <div class="row small muted">
    Tuckpointing & handheld grinder controls. Use these toggles to add ECP notes and auto‑include DWV9402 HEPA fleece bags.
  </div>
  <div class="row" style="gap:1rem; flex-wrap:wrap">
    <label class="pill"><input type="checkbox" id="sil_task_tuck"> Tuckpointing (mortar removal)</label>
    <label class="pill"><input type="checkbox" id="sil_task_grind"> Handheld grinder (non‑mortar)</label>
    <label class="pill"><input type="checkbox" id="sil_enclosed"> Indoors / enclosed</label>
  </div>
  <div class="row" style="gap:.75rem; flex-wrap:wrap">
    <button class="ghost" id="sil_copy_notes" type="button">Copy ECP Notes</button>
    <textarea id="sil_ecp_notes" rows="6" style="width:100%" placeholder="Silica ECP notes will appear here when you toggle tasks."></textarea>
  </div>
</div>
<!-- TOOLS -->
<div class="card" id="toolsCard" data-cat="tools">
<div class="row"><h3 style="margin:0">Tools Depreciation Reserve</h3><span class="spacer"></span><button class="ghost" id="addToolBtn">+ Add Tool</button></div>
<table>
<thead><tr><th>Use</th><th>Tool</th><th>Replace Cost ($)</th><th>Lifetime (hrs)</th><th>Reserve frac (0–1)</th><th>Use (hrs)</th><th>Ext.</th><th></th></tr></thead>
<tbody id="toolTbody"></tbody>
<tfoot><tr><td class="right" colspan="6">Tools Reserve Subtotal</td><td class="right mono" id="toolSubtotal">$0.00</td><td></td></tr></tfoot>
</table>
</div>
<!-- TOTALS -->
<div class="card" id="totalsCard" data-cat="totals"><div class="row"><span class="pill">Directs (excl. Company): <span class="mono" id="directs">$0.00</span></span>
<span class="pill">Overhead: <span class="mono" id="ohAmt">$0.00</span></span>
<span class="pill">Profit (incl. Company): <span class="mono" id="profitAmt">$0.00</span></span>
<span class="pill"><span id="taxLabel">Tax Reimbursement</span>: <span class="mono" id="taxAmt2">$0.00</span></span>
<span class="pill" style="background:#153251; border-color:#2c5a8c; color:#d9ecff"> Total: <span class="mono" id="grand">$0.00</span></span>
<span class="spacer"></span>
<div class="group">
<label>OH % <input id="ohPct" step="1" type="number" value="0"/></label>
<label>Profit % <input id="profitPct" step="1" type="number" value="0"/></label>
</div>
</div>
<div class="muted small" style="margin-top:6px">
      Calc: Directs = Crew (excl. Co.) + Materials + Concrete + Fuel + Tools + Disposal. Overhead = Directs × OH%. Profit = Company + (Directs + Overhead) × Profit%. Total = Directs + Overhead + Profit + Tax/Reimb.
    </div>
</div>
<!-- sticky -->
<div class="sticky">
  <div class="sticky-inner">
    <span id="stickyGrandPill" class="pill" style="background:#153251; border-color:#2c5a8c; color:#d9ecff">Total: <span class="mono" id="stickyGrand">$0.00</span></span>
  </div>
</div>
<!-- hidden sticky spans to satisfy totals() updates -->
<div style="display:none">
  <span id="stickyCrew"></span>
  <span id="stickyCompanyToProfit"></span>
  <span id="stickyMat"></span>
  <span id="stickyConc"></span>
  <span id="stickyFuel"></span>
  <span id="stickyTools"></span>
  <span id="stickyWaste"></span>
  <span id="stickyOH"></span>
  <span id="stickyProfit"></span>
  <span id="stickyTax"></span>
  <span id="stickyTaxLabel"></span>
</div>

<div class="warn" id="err" style="display:none"></div>
</div>
<script>
(function(){
  const byId = id => document.getElementById(id);
  const fmt = n => '$' + (Number.isFinite(n)?n:0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const num = v => { if(v===null||v===undefined) return 0; const s=String(v).trim(); if(s==='') return 0; const n=parseFloat(s); return Number.isFinite(n)?n:0; };

  const jsStatus = byId('jsStatus'); jsStatus.textContent='✅ '; jsStatus.classList.remove('bad'); jsStatus.classList.add('ok');

  // ===== Crew =====
  let crew = [
    {id:'owner', name:'Owner (Rob)', role:'owner', rate:50, use:true, hrs:0},
    {id:'company', name:'Company (Overhead → Profit)', role:'company', rate:50, use:true, hrs:0},
    {id:'dave', name:'Uncle Dave (Foreman)', role:'foreman', rate:43.75, use:true, hrs:0},
    {id:'jorge', name:'Jorge (Mason)', role:'mason', rate:30, use:true, hrs:0},
    {id:'labor', name:'Laborer', role:'laborer', rate:25, use:true, hrs:0},
  ];
  // === Auto-rate mapping (role -> $/hr) ===
  const ROLE_RATES = { owner:50, company:50, foreman:43.75, mason:30, laborer:25 };

  let crewWideOn = true, crewDaysMode = true;
  const HOURS_PER_DAY = 8;

  function renderCrew(){
    const tb = byId('crewTbody'); tb.innerHTML='';
    crew.forEach(w=>{
      const tr = document.createElement('tr'); tr.dataset.id=w.id; tr.classList.toggle('fade', crewWideOn);
      tr.innerHTML = `
        <td><input type="checkbox" class="crew_use" ${w.use?'checked':''}></td>
        <td><input class="crew_name" value="${w.name}"></td>
        <td>
          <select class="crew_role">
            <option value="owner" ${w.role==='owner'?'selected':''}>Owner</option>
            <option value="company" ${w.role==='company'?'selected':''}>Company</option>
            <option value="foreman" ${w.role==='foreman'?'selected':''}>Foreman</option>
            <option value="mason" ${w.role==='mason'?'selected':''}>Mason</option>
            <option value="laborer" ${w.role==='laborer'?'selected':''}>Laborer</option>
            <option value="other" ${w.role==='other'?'selected':''}>Other</option>
          </select>
        </td>
        <td><input type="number" class="crew_rate" step="0.25" value="${w.rate}"></td>
        <td><input type="number" class="crew_hrs" step="1" placeholder="0" ${crewWideOn?'disabled':''} value="${crewWideOn?'':(w.hrs||'')}"></td>
        <td class="right mono crew_cost">$0.00</td>
        <td><button class="ghost crew_del">✕</button></td>`;
      tb.appendChild(tr);
    });
    bindCrewRowEvents(); updateAll();
  }
  function bindCrewRowEvents(){
    document.querySelectorAll('#crewTbody tr').forEach(tr=>{
      const id = tr.dataset.id; const idx = crew.findIndex(c=>c.id===id);
      tr.querySelector('.crew_use').addEventListener('change', e=>{ crew[idx].use=e.target.checked; updateAll(); });
      tr.querySelector('.crew_name').addEventListener('input', e=>{ crew[idx].name=e.target.value; });
      
      tr.querySelector('.crew_role').addEventListener('change', e=>{
        const newRole = e.target.value;
        crew[idx].role = newRole;
        // Auto-sync rate to role, if mapping exists
        if (Object.prototype.hasOwnProperty.call(ROLE_RATES, newRole)) {
          crew[idx].rate = ROLE_RATES[newRole];
          const rateInp = tr.querySelector('.crew_rate');
          if (rateInp) {
            rateInp.value = ROLE_RATES[newRole];
            // Fire input event so any downstream listeners recalc immediately
            rateInp.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }
        updateAll();
      });

      tr.querySelector('.crew_rate').addEventListener('input', e=>{ crew[idx].rate=num(e.target.value); updateAll(); });
      const hrs=tr.querySelector('.crew_hrs'); if(hrs){ hrs.addEventListener('input', e=>{ crew[idx].hrs=num(e.target.value); updateAll(); }); }
      tr.querySelector('.crew_del').addEventListener('click', ()=>{ crew.splice(idx,1); renderCrew(); });
    });
  }
  byId('addWorkerBtn').addEventListener('click', ()=>{ const id='w_'+Math.random().toString(36).slice(2,7); crew.push({id,name:'Worker',role:'mason',rate:30,use:true,hrs:0}); renderCrew(); });
  byId('crewWideToggle').addEventListener('change', ()=>{ crewWideOn = byId('crewWideToggle').checked; renderCrew(); });
  byId('timeUnitsDays').addEventListener('change', ()=>{ crewDaysMode = byId('timeUnitsDays').checked; updateAll(); });
  byId('crewWideQty').addEventListener('input', updateAll);

  function crewCalc(){
    const q = num(byId('crewWideQty').value);
    const baseHours = crewDaysMode ? q*HOURS_PER_DAY : q;
    let subtotalExclCompany=0, companyCost=0;
    document.querySelectorAll('#crewTbody tr').forEach(tr=>{
      const idx = crew.findIndex(c=>c.id===tr.dataset.id); const w = crew[idx];
      const hrs = crewWideOn ? (w.use ? baseHours : 0) : (w.use ? (w.hrs||0) : 0);
      const cost = w.use ? hrs * (w.rate||0) : 0;
      tr.querySelector('.crew_cost').textContent = fmt(cost);
      if(w.role==='company'){ companyCost+=cost; } else { subtotalExclCompany+=cost; }
    });
    byId('crewSubtotal').textContent = fmt(subtotalExclCompany);
    return {subtotalExclCompany, companyCost};
  }

  // ===== Materials =====
  
  
let materials = [
  {id:'mCT_DC_FLAT',   use:false, item:"Desert Creek Mosaic ThinStone — flats",   supplier:"Connecticut Stone", units:"sf",  price:11.87, qty:0, cats:["masonry","stone veneer"]},
  {id:'mCT_DC_CORNER', use:false, item:"Desert Creek Mosaic Corner ThinStone",    supplier:"Connecticut Stone", units:"lf",  price:17.57, qty:0, cats:["masonry","stone veneer"]},
  {id:'mCT_PMAVM',     use:false, item:"SPEC MIX Polymer-Modified Adhered Veneer Mortar — 80 lb (Gray)", supplier:"Connecticut Stone", units:"bag", price:21.75, qty:0, cats:["masonry","stone veneer","stucco"]},
  {id:'mLOW_S_TypeS60',use:false, item:"Sakrete Type S Mortar Mix — 60 lb",       supplier:"Lowe's",           units:"bag", price:8.28,  qty:0, cats:["masonry","stucco"]},
  {id:'mLOW_SV_50',    use:false, item:"Sakrete Stone Veneer Mortar — 50 lb",     supplier:"Lowe's",           units:"bag", price:9.88,  qty:0, cats:["masonry","stone veneer","stucco"]},
  {id:'mCOL_DWV9402',  use:false, item:"DeWALT Fleece Dust Bags (DWV9402) — 5-pack", supplier:"Colony Hardware", units:"pack",price:45.00, qty:0, cats:["stucco","masonry","concrete","tools"]},
  {id:'mHD_3M_8511', use:false, item:"3M 8511 N95 respirator — 1 pack", supplier:'Home Depot', units:'each', price:2.35, qty:0, cats:['tools','safety','masonry','stucco','concrete']},

  {id:'m1',  use:false, item:"8' Plastic paver edging",            supplier:'New Haven Masonry', units:'each',  price:12, qty:0, step:1,    roundUp:true, cats:['pavers']},
  {id:'m2',  use:false, item:"8' Aluminum paver edging",           supplier:'New Haven Masonry', units:'each',  price:18, qty:0, step:1,    roundUp:true, cats:['pavers']},
  {id:'m3',  use:false, item:"12\" paver spikes — 150/box",        supplier:'New Haven Masonry', units:'box',   price:72, qty:0, step:1,    roundUp:true, cats:["pavers"]},
  {id:'m4',  use:false, item:"SPEC MIX Type S — 80 lb",            supplier:'New Haven Masonry', units:'bag',   price:11, qty:0, cats:['stucco', 'masonry']},
  {id:'m5',  use:false, item:"SPEC MIX Stone Veneer — 80 lb",      supplier:'New Haven Masonry', units:'bag',   price:18, qty:0, cats:["masonry","stone veneer","bluestone"]},
  {id:'m6',  use:false, item:"Concrete wire mesh 5'×10'",          supplier:'New Haven Masonry', units:'sheet', price:11, qty:0, cats:["concrete"]},
  {id:'m7',  use:false, item:"6\"×10' expansion joint",            supplier:'New Haven Masonry', units:'each',  price:8,  qty:0, cats:["concrete"]},
  {id:'m8',  use:false, item:"SPEC MIX Core Fill Grout 3k — 80 lb",supplier:'Homer C. Godfrey', units:'bag',    price:11, qty:0, cats:["masonry"]},
  {id:'m10', use:false, item:"Bulk crushed rock 3/4\"",            supplier:'SiteOne',          units:'yard',  price:44, qty:0, step:0.25, roundUp:false, cats:['concrete', 'pavers']},
  {id:"mNH1", use:false, item:"12\" hollow concrete block", supplier:"New Haven Masonry", units:"each", price:4.8, qty:0, cats:["masonry"]},
  {id:"mNH2", use:false, item:"12\" Durawall — 10'", supplier:"New Haven Masonry", units:"each", price:7.85, qty:0, cats:["masonry"]},
  {id:"mNH3", use:false, item:"#5 rebar (5/8\") — 20'", supplier:"New Haven Masonry", units:"each", price:14.95, qty:0, cats:["masonry","concrete"]},
  {id:"mNH5", use:false, item:"QUIKRETE 5000 — 80 lb", supplier:"New Haven Masonry", units:"bag", price:8.95, qty:0, cats:["concrete", "masonry"]},
  {id:"mNH6", use:false, item:"5/8\" × 10\" anchor bolt set (bolt+nuts+washer)", supplier:"New Haven Masonry", units:"each", price:2.7, qty:0, cats:["concrete", "masonry"]},
  {id:"mNH7", use:false, item:"Bluestone 1\" — price per sf", supplier:"New Haven Masonry", units:"sf", price:10.95, qty:0, cats:["masonry","bluestone"]},
  {id:"mNH8", use:false, item:"Bluestone 1.5\" — price per sf", supplier:"New Haven Masonry", units:"sf", price:12.5, qty:0, cats:["masonry","bluestone"]},

  {id:'m2001',use:false,item:"Stucco Depot PRO BASE — 50 lb basecoat adhesive",supplier:'Stucco Depot',units:'bag',price:19.50,qty:0,step:10,roundUp:false,cats:["stucco"],coverageSqft:90},
  {id:'m2002',use:false,item:"Standard EIFS Fiberglass Mesh — 38\"×150' roll",supplier:'Stucco Depot',units:'roll',price:60,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:475},
  {id:'m2003',use:false,item:"Parex DPR Sand Coarse — 5 gal",supplier:'Parex',units:'pail',price:75,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:90},
  {id:'m2004',use:false,item:"Parex DPR Sand Fine — 5 gal",supplier:'Parex',units:'pail',price:75,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:150},
  {id:'m2005',use:false,item:"Parex DPR Swirl Fine — 5 gal",supplier:'Parex',units:'pail',price:75,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:120},
  {id:'m2006',use:false,item:"Parex DPR Sand Smooth — 5 gal",supplier:'Parex',units:'pail',price:75,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:280},
  {id:'m2007',use:false,item:"MP Roll‑Tex Coating — 5 gal",supplier:'MP Architectural Coatings',units:'pail',price:90,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:300},
  {id:'m2008',use:false,item:"GREEN MAKER Decoplast Premium Basecoat — 50 lb",supplier:'RMC Stucco Supply',units:'bag',price:31,qty:0,step:10,roundUp:false,cats:["stucco"],coverageSqft:55},
  {id:'m2009',use:false,item:"EPS EIFS Foam — 2\" (2'×4', 9 sheets) per bundle",supplier:'RMC Stucco Supply',units:'bundle',price:45,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:72},
  {id:'m2010',use:false,item:"EPS EIFS Foam — 1.5\" (2'×4', 13 sheets) per bundle",supplier:'Local EIFS supplier',units:'bundle',price:45,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:104},
  {id:'m2011',use:false,item:"EPS EIFS Foam — 1\" (2'×4', 18 sheets) per bundle",supplier:'Local EIFS supplier',units:'bundle',price:45,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:144},
  {id:'m2012',use:false,item:"EPS EIFS Foam — 3/4\" (2'×4', 30 sheets) per bundle",supplier:'Local EIFS supplier',units:'bundle',price:45,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:240},
  {id:'m2013',use:false,item:"Red Baron stucco masking tape — 2\" × 180' roll",supplier:'RMC Stucco Supply',units:'roll',price:7.50,qty:0,step:1,roundUp:true,cats:['stucco', 'concrete']},
  {id:'m2014',use:false,item:"Stucco knife",supplier:'Stucco Depot',units:'each',price:15,qty:0,step:1,roundUp:true,cats:["stucco"]},
  {id:'mCT_BBS_TREAD', use:false, item:"Bluestone Blue Select Tread", supplier:"Connecticut Stone", units:"sf", price:20.20, qty:0, cats:["masonry","stone veneer"]},
  {id:'mCT_HB_STRIP', use:false, item:"Hampton Blend Strip Cut Thinstone", supplier:"Connecticut Stone", units:"sf", price:8.00, qty:0, cats:["masonry","stone veneer"]},
  {id:'mCT_HB_STRIP_CORNER', use:false, item:"Hampton Blend Strip Cut Thinstone Corners", supplier:"Connecticut Stone", units:"lf", price:17.57, qty:0, cats:["masonry","stone veneer"]},
  {id:'mTIL_DrivewayMix', use:false, item:"Driveway Mix Asphalt", supplier:"Tilcon", units:"ton", price:108.10, qty:0, cats:["concrete"]},
  {id:'mBLS_DeepRiver34', use:false, item:"Deep River 3/4\" Stone", supplier:"Branford Landscape Supply", units:"yard", price:65.00, qty:0, cats:["pavers","concrete"]},
  {id:'mCOL_ScaffoldTag', use:false, item:"Scaffold Tag (All 3 Colors)", supplier:"Colony Hardware", units:"each", price:13.59, qty:0, cats:["tools"]},
  {id:'mCOL_ScaffoldTagHolder', use:false, item:"Scaffold Tag Holder", supplier:"Colony Hardware", units:"each", price:21.02, qty:0, cats:["tools"]},
  {id:'mSO_KY_Bluegrass_Sod', use:false, item:"Kentucky Bluegrass Sod", supplier:"SiteOne", units:"sf", price:0.85, qty:0, cats:["pavers"]},
  {id:'mSO_TopSoil_Bulk', use:false, item:"Top Soil Bulk", supplier:"SiteOne", units:"yard", price:45.00, qty:0, cats:["pavers"]},
  {id:'mNHM_Concrete_80lb', use:false, item:"Concrete 80lb Bag", supplier:"New Haven Masonry", units:"bag", price:6.36, qty:0, cats:["concrete"]},
  {id:'mLOW_ColdPatchAsphalt_50lb', use:false, item:"Cold Patch Asphalt 50 lb Bag", supplier:"Lowes", units:"bag", price:22.38, qty:0, cats:["concrete"]},
  {id:'mLOW_Sakrete_Play_Sand_50lb', use:false, item:"Sakrete Play Sand 50lb Bag", supplier:"Lowes", units:"bag", price:8.28, qty:0, cats:["pavers","concrete"]},
  { id:'mHDX_TerryTowels_20pk', item:"HDX TERRY TOWELS 20PK", units:'pack', price:12.98, supplier:'Home Depot', cats:['cleanup'] }
,
  { id:'mWindex32oz_308534', item:"Windex 32 oz Commercial Line Trigger Bottle Original Glass Cleaner", units:'bottle', supplier:'Home Depot', price:4.78, cats:['cleanup'] }
,
  { id:'mQuikreteBondingAdhesive_1gal_990201', item:"Quikrete 1 Gal. Concrete Bonding Adhesive", units:'gal', supplier:'Home Depot', price:20.84, cats:['masonry','stone veneer'] }
,
  { id:'mGripRite_3in_DrywallScrews_1lb_3CDWS1', item:"#8 x 3 in. #2 Phillips Bugle Head Coarse Thread Drywall Screws (1 lb Box)", units:'box (1 lb)', supplier:'Home Depot', price:7.06, cats:['concrete'] }
,
  { id:"mDewalt_Chalk_Red_8oz_DWHT47048L", item:"DEWALT 8 oz. Chalk Reel in Red (DWHT47048L)", units:"bottle (8 oz)", supplier:"Home Depot", price:3.47, cats:["masonry"] }
,
  { id:"mMilwaukee_SDSPlus_5_8x18in_4C_48_20_8306", item:"Milwaukee 5/8 in. x 18 in. 4-Cutter SDS-PLUS Carbide Drill Bit (48-20-8306)", units:"each", supplier:"Home Depot", price:37.77, cats:["concrete"] },
  {id:'mCOL_DT5_TP_4_5', use:false, item:'4 1/2" Tuckpoint Diamond Blade', supplier:'Colony Hardware', units:'each', price:54, qty:0, cats:['masonry','tools']}
];


  function renderMaterials(){
    // HTML-escape for attribute values to avoid breaking inputs when labels contain quotes (e.g., 6"×10')
    const esc = s => String(s).replaceAll('&','&amp;').replaceAll('"','&quot;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    const tb=byId('matTbody'); tb.innerHTML='';
    // Optional category filter: show only materials matching window.__matCats if defined
    var cats = (window.__matCats && Array.isArray(window.__matCats) && window.__matCats.length) ? window.__matCats : null;
    /* ROBUST TAB->CATS MAPPING */
    try{
      const t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
      const g = t ? t.getAttribute('data-group') : null;
      // Only force cats if a real group is active (not "all")
      if (g && g !== 'all') {
        // Known categories present in data: stucco, masonry, concrete, bluestone, stone veneer
        // Map group->cats focus; for Stucco we only want stucco
        if (g === 'stucco') cats = ['stucco'];
      }
    } catch(e){}
    // If Stucco tab is active, force a stucco-only category filter
    try{
      const activeTab = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
      const activeGroup = activeTab ? activeTab.getAttribute('data-group') : null;
      if(activeGroup==='stucco'){ cats = ['stucco']; }
    } catch(e){}
    

    materials.filter(m=> !cats || (m.cats && m.cats.some(c=>cats.includes(c)))).forEach(m=>{
      const tr=document.createElement('tr'); tr.dataset.id=m.id; tr.classList.toggle('fade', !m.use);
      tr.innerHTML = `
        <td><input type="checkbox" class="mat_use" ${m.use?'checked':''}></td>
        <td><input class="mat_item" value="${esc(m.item)}"></td>
        <td><input class="mat_sup" value="${esc(m.supplier)}"></td>
        <td><input class="mat_units" value="${esc(m.units)}"></td>
        <td><input type="number" class="mat_price" step="0.01" value="${m.price}"></td>
        <td><input type="number" class="mat_qty" step="${m.step||1}" placeholder="${m.coverageSqft?'Area (sf)':'0'}" value="${m.qty||''}"></td>
        <td class="right mono mat_ext">$0.00</td>
        <td><button class="ghost mat_del">✕</button></td>`;
      tr.setAttribute('data-cats', (m.cats||[]).join(','));
      tb.appendChild(tr);
    });
    bindMatEvents(); updateAll();
  }
  function bindMatEvents(){
    document.querySelectorAll('#matTbody tr').forEach(tr=>{
      const idx = materials.findIndex(x=>x.id===tr.dataset.id);
      tr.querySelector('.mat_use').addEventListener('change', e=>{ materials[idx].use=e.target.checked; tr.classList.toggle('fade', !materials[idx].use); updateAll(); });
      tr.querySelector('.mat_item').addEventListener('input', e=>{ materials[idx].item=e.target.value; });
      tr.querySelector('.mat_sup').addEventListener('input', e=>{ materials[idx].supplier=e.target.value; });
      tr.querySelector('.mat_units').addEventListener('input', e=>{ materials[idx].units=e.target.value; });
      tr.querySelector('.mat_price').addEventListener('input', e=>{ materials[idx].price=num(e.target.value); updateAll(); });
      tr.querySelector('.mat_qty').addEventListener('input', e=>{ const v=num(e.target.value); materials[idx].qty=v; if(v>0 && !materials[idx].use){ materials[idx].use=true; tr.querySelector('.mat_use').checked=true; tr.classList.remove('fade'); } updateAll(); });
      tr.querySelector('.mat_del').addEventListener('click', ()=>{ materials.splice(idx,1); renderMaterials(); });
    });
  }
  function materialsSubtotal(){
    let sub=0;
    document.querySelectorAll('#matTbody tr').forEach(tr=>{
      const idx = materials.findIndex(x=>x.id===tr.dataset.id); const m = materials[idx];
      const areaOrQty = num(m.qty);
      const price = num(m.price);
      let units = areaOrQty;
      if (m.coverageSqft && m.coverageSqft>0) {
        // Treat qty as AREA in square feet; buy whole units (ceil)
        units = Math.ceil((areaOrQty||0) / m.coverageSqft);
        // annotate UI for clarity
        const extCell = tr.querySelector('.mat_ext');
        if (extCell) extCell.setAttribute('title', `${units} ${m.units||'unit'}(s) @ ${fmt(price)} each (coverage ${m.coverageSqft} sf/${m.units||'unit'})`);
      } else if (m.roundUp) {
        units = Math.ceil(areaOrQty||0);
      }
      const ext = m.use ? price * (units||0) : 0;
      sub += ext; tr.querySelector('.mat_ext').textContent = fmt(ext);
    });
    byId('matSubtotal').textContent = fmt(sub); return sub;
  }

  // ===== Concrete =====
  function concreTecTS(){
    const y = num(byId('ct_yards').value);
    const p = num(byId('ct_price').value);
    const d = num(byId('ct_delivery').value);
    const trips = Math.ceil((y||0)/3);
    byId('ct_trips_read').textContent = isFinite(trips)?trips:0;
    const mat = y*p; const del = trips*d; const oof = (byId('ct_out_of_area') && byId('ct_out_of_area').checked) ? 75 : 0; const sub = mat+del+oof;
    byId('ct_mat').textContent = fmt(mat);
    byId('ct_deliv').textContent = fmt(del);
    byId('ct_sub').textContent = fmt(sub);
    return sub;
  }
  
function mohicanValley(){
    // Inputs
    const yRaw = num(byId('mv_yards').value);
    const totalY = (yRaw>0 && yRaw<2) ? 2 : yRaw;
    const price = num(byId('mv_price').value);
    const cap = Math.max(1, num(byId('mv_cap')?.value || 10));
    const minY = num(byId('mv_min')?.value || 5);
    const shortPerYd = num(byId('mv_short_per_yd')?.value || 200);
    const fuelPerLoad = num(byId('mv_fuel')?.value || 30);
    const envPerLoad  = num(byId('mv_env')?.value  || 3.5);
    const manualOther = num(byId('mv_short')?.value || 0); // legacy manual field

    // Winter logic
    const winterRate = num(byId('mv_winter')?.value || 0);
    let winterOn = !!(byId('mv_winter_on') && byId('mv_winter_on').checked);
    const auto = byId('mv_winter_auto')?.checked;
    const jd = byId('job_date')?.value;
    if(auto && jd){
      const d = new Date(jd+'T00:00:00');
      const mm = d.getMonth()+1, dd = d.getDate();
      // Nov 15 - Dec 31 OR Jan 1 - Apr 15
      winterOn = ( (mm>10 && (mm<12 || (mm===11 && dd>=15) || (mm===12))) || (mm<5 || (mm===4 && dd<=15)) );
      if(byId('mv_winter_on')) byId('mv_winter_on').checked = winterOn;
    }
    const winterPerYd = winterOn ? winterRate : 0;

    // Extras per-yd
    const ex_air = (byId('mv_ex_air')?.checked ? num(byId('mv_ex_air_ppy').value) : 0);
    const ex_38  = (byId('mv_ex_38')?.checked ? num(byId('mv_ex_38_ppy').value) : 0);
    const ex_fib = (byId('mv_ex_fiber')?.checked ? num(byId('mv_ex_fiber_ppy').value) : 0);
    const ex_col = (byId('mv_ex_color')?.checked ? num(byId('mv_ex_color_ppy').value) : 0);
    const extrasPerYd = ex_air + ex_38 + ex_fib + ex_col;

    // Trucking math
    const trucks = Math.ceil((totalY||0)/cap);
    let remaining = totalY, mvMat=0, shortFees=0, loadFees=0;
    for(let t=0; t<trucks; t++){
      const loadY = Math.min(cap, remaining);
      remaining -= loadY;
      mvMat += loadY * (price + winterPerYd + extrasPerYd);
      loadFees += fuelPerLoad + envPerLoad;
      if(loadY>0 && loadY < minY){ shortFees += loadY * shortPerYd; }
    }

    // Pump
    let pump=0;
    const pumpApply = !!(byId('mv_apply_pump') && byId('mv_apply_pump').checked);
    const pumpOn = byId('pump_use')?.checked;
    if(pumpOn){
      const val = (byId('pump_size')?.value || '32@290');
      const rate = val.includes('@') ? parseFloat(val.split('@')[1]) : 290;
      const hrsRaw = num(byId('pump_hours')?.value || 0);
      const hrs = Math.max(hrsRaw, 4); /// 4 hr minimum
      pump = rate * hrs;
    }


    // Time overage (6 min/yd allowed) — $300/hr if exceeded
    let timeOver = 0;
    const applyTime = !!(byId('mv_apply_time') && byId('mv_apply_time').checked);
    const avgDischarge = num(byId('mv_discharge')?.value || 0); // minutes per truck
    if(avgDischarge>0){
      const allowed = 6 * (totalY||0);               // minutes allowed
      const actual  = (trucks||0) * avgDischarge;    // minutes used
      if(actual > allowed){
        const overMin = actual - allowed;
        const overHrs = overMin / 60;
        timeOver = overHrs * 300; // $300/hr
      }
    }
    const extras = (totalY||0)*extrasPerYd; // separate display for clarity
    const sub = mvMat + shortFees + loadFees + (pumpApply ? pump : 0) + (applyTime ? timeOver : 0) + manualOther;

    // Display
    byId('mv_trucks') && (byId('mv_trucks').textContent = trucks||0);
    byId('mv_mat')    && (byId('mv_mat').textContent = fmt(mvMat));
    byId('mv_shortfees') && (byId('mv_shortfees').textContent = fmt(shortFees));
    byId('mv_loadfees')  && (byId('mv_loadfees').textContent  = fmt(loadFees));
    byId('mv_extras') && (byId('mv_extras').textContent = fmt(extras));
    byId('mv_pump')   && (byId('mv_pump').textContent   = fmt(pump));
    byId('mv_pump_fee') && (byId('mv_pump_fee').textContent = fmt(pump));
    byId('mv_time_overage') && (byId('mv_time_overage').textContent = fmt(timeOver));
    byId('mv_sub').textContent = fmt(sub);
    return sub;
  }

  // ===== Fuel =====
  function fuelSubtotal(){
    const ppg=num(byId('fuel_ppg').value), gal=num(byId('fuel_gal').value);
    const sub = ppg*gal; byId('fuel_sub').textContent = fmt(sub); return sub;
  }

  // ===== Waste =====
  let waste=[{id:'w1', use:false, item:'Clean asphalt (disposal)', facility:'Modern Materials', units:'ton', rate:9, qty:0}];
  function renderWaste(){
    const tb=byId('wasteTbody'); tb.innerHTML='';
    waste.forEach(w=>{
      const tr=document.createElement('tr'); tr.dataset.id=w.id; tr.classList.toggle('fade', !w.use);
      tr.innerHTML = `
        <td><input type="checkbox" class="w_use" ${w.use?'checked':''}></td>
        <td><input class="w_item" value="${w.item}"></td>
        <td><input class="w_fac" value="${w.facility}"></td>
        <td><input class="w_units" value="${w.units}"></td>
        <td><input type="number" class="w_rate" step="0.01" value="${w.rate}"></td>
        <td><input type="number" class="w_qty" step="0.25" placeholder="0" value="${w.qty||''}"></td>
        <td class="right mono w_ext">$0.00</td>
        <td><button class="ghost w_del">✕</button></td>`;
      tb.appendChild(tr);
    });
    bindWasteEvents(); updateAll();
  }
  function bindWasteEvents(){
    document.querySelectorAll('#wasteTbody tr').forEach(tr=>{
      const idx=waste.findIndex(x=>x.id===tr.dataset.id);
      tr.querySelector('.w_use').addEventListener('change', e=>{ waste[idx].use=e.target.checked; tr.classList.toggle('fade', !waste[idx].use); updateAll(); });
      tr.querySelector('.w_item').addEventListener('input', e=>{ waste[idx].item=e.target.value; });
      tr.querySelector('.w_fac').addEventListener('input', e=>{ waste[idx].facility=e.target.value; });
      tr.querySelector('.w_units').addEventListener('input', e=>{ waste[idx].units=e.target.value; });
      tr.querySelector('.w_rate').addEventListener('input', e=>{ waste[idx].rate=num(e.target.value); updateAll(); });
      tr.querySelector('.w_qty').addEventListener('input', e=>{ const v=num(e.target.value); waste[idx].qty=v; if(v>0 && !waste[idx].use){ waste[idx].use=true; tr.querySelector('.w_use').checked=true; tr.classList.remove('fade'); } updateAll(); });
    });
  }
  function wasteSubtotal(){
    let sub=0;
    document.querySelectorAll('#wasteTbody tr').forEach(tr=>{
      const idx=waste.findIndex(x=>x.id===tr.dataset.id); const w=waste[idx];
      const ext = w.use ? num(w.rate)*num(w.qty) : 0;
      sub += ext; tr.querySelector('.w_ext').textContent = fmt(ext);
    });
    byId('wasteSubtotal').textContent = fmt(sub); return sub;
  }

  // ===== Tools =====
  let tools=[
{id:'t1', use:false, name:'DEWALT 4400 PSI 4.0 GPM Pressure Washer (DXPW61377)', cost:949, life:475, frac:1.0, useHrs:0},
  {id:'t2', use:false, name:'Bosch 11335K 35-lb Breaker Hammer Kit (1-1/8" Hex)', cost:1099, life:550, frac:1.0, useHrs:0},
  {id:'t3', use:false, name:'STIHL TS 420 14\" Cut-Off Saw', cost:1399.99, life:700, frac:1.0, useHrs:0},
  {id:'t4', use:false, name:'Bosch 11255VSR Bulldog Xtreme 1" SDS-Plus Rotary Hammer', cost:219.00, life:110, frac:1.0, useHrs:0},
  {id:'t5', use:false, name:'Bosch 11316EVS SDS-max Demolition Hammer (14A, 12.4 ft-lb)', cost:729.00, life:365, frac:1.0, useHrs:0},
  {id:'t6', use:false, name:'Bosch RH540M 1-9/16" SDS-max Combination Rotary Hammer', cost:469.00, life:235, frac:1.0, useHrs:0},
  {id:'t7', use:false, name:'DEWALT 20V MAX XR Impact Driver (DCF860B) — Tool Only', cost:179.00, life:90, frac:1.0, useHrs:0},
  {id:'t8', use:false, name:'DEWALT FLEXVOLT 20V/60V MAX 12.0Ah Battery (DCB612)', cost:319.00, life:160, frac:1.0, useHrs:0},
  {id:'t9', use:false, name:'DEWALT 20V MAX XR Compact Reciprocating Saw (DCS367B) — Tool Only', cost:179.00, life:90, frac:1.0, useHrs:0},
  {id:'t10', use:false, name:'DEWALT Tuckpointing Grinder (DWE46202)', cost:420.99, life:210, frac:1.0, useHrs:0},
  {id:'t11', use:false, name:'DEWALT 8 Gallon HEPA/RRP Dust Extractor (DWV010)', cost:469.00, life:235, frac:1.0, useHrs:0}
];

  
  // Default Tools item tweaked: DEWALT DXPW61377 @ $949, life 475 hrs, frac 1.0 ⇒ ~$2.00/hour reserve

  // Added: Bosch 11335K breaker @ $1,099, life 550 hrs (≈$2.00/hr reserve)
// Added: STIHL TS 420 @ $1,399.99, life 700 hrs (≈$2.00/hr reserve)
// Added: Bosch 11255VSR @ $219.00, life 110 hrs (≈$2.00/hr reserve)
// Added: Bosch 11316EVS @ $729.00, life 365 hrs (≈$2.00/hr reserve)
// Added: Bosch RH540M @ $469.00, life 235 hrs (≈$2.00/hr reserve)
// Added: DEWALT DCF860B @ $179.00, life 90 hrs (≈$2.00/hr reserve). Tool-only; battery/charger sold separately.
// Added: DEWALT DCB612 @ $319.00, life 160 hrs (≈$2.00/hr reserve). Battery-pack depreciation only.
// Added: DEWALT DCS367B @ $179.00, life 90 hrs (≈$2.00/hr reserve). Tool-only; blades & batteries separate.
// Added: DEWALT DWE46202 @ $420.99, life 211 hrs (≈$2.00/hr reserve). Includes tuckpoint shroud & blade per kit.
// Added: DEWALT DWV010 @ $469.00, life 235 hrs (≈$2.00/hr reserve). HEPA/RRP dust extractor.
function renderTools(){
    const tb=byId('toolTbody'); tb.innerHTML='';
    tools.forEach(t=>{
      const tr=document.createElement('tr'); tr.dataset.id=t.id; tr.classList.toggle('fade', !t.use);
      tr.innerHTML = `
        <td><input type="checkbox" class="t_use" ${t.use?'checked':''}></td>
        <td><input class="t_name" value="${t.name}"></td>
        <td><input type="number" class="t_cost" step="1" value="${t.cost}"></td>
        <td><input type="number" class="t_life" step="100" value="${t.life}"></td>
        <td><input type="number" class="t_frac" step="0.05" value="${t.frac}"></td>
        <td><input type="number" class="t_usehrs" step="1" placeholder="0" value="${t.useHrs||''}"></td>
        <td class="right mono t_ext">$0.00</td>
        <td><button class="ghost t_del">✕</button></td>`;
      tb.appendChild(tr);
    });
    bindToolEvents(); updateAll();
  }
  function bindToolEvents(){
    document.querySelectorAll('#toolTbody tr').forEach(tr=>{
      const idx=tools.findIndex(x=>x.id===tr.dataset.id);
      tr.querySelector('.t_use').addEventListener('change', e=>{ tools[idx].use=e.target.checked; tr.classList.toggle('fade', !tools[idx].use); updateAll(); });
      tr.querySelector('.t_name').addEventListener('input', e=>{ tools[idx].name=e.target.value; });
      tr.querySelector('.t_cost').addEventListener('input', e=>{ tools[idx].cost=num(e.target.value); updateAll(); });
      tr.querySelector('.t_life').addEventListener('input', e=>{ tools[idx].life=Math.max(1,num(e.target.value)); updateAll(); });
      tr.querySelector('.t_frac').addEventListener('input', e=>{ tools[idx].frac=num(e.target.value); updateAll(); });
      tr.querySelector('.t_usehrs').addEventListener('input', e=>{ const v=num(e.target.value); tools[idx].useHrs=v; if(v>0 && !tools[idx].use){ tools[idx].use=true; tr.querySelector('.t_use').checked=true; tr.classList.remove('fade'); } updateAll(); });
      const del=tr.querySelector('.t_del'); if(del){ del.addEventListener('click', ()=>{ tools.splice(idx,1); renderTools(); }); }
    });
  }

  // ===== Assemblies (same as v0.13) omitted for brevity =====

  // ===== OH / Profit / Tax =====
  byId('ohPct').addEventListener('input', updateAll);
  byId('profitPct').addEventListener('input', updateAll);
  byId('taxPct').addEventListener('input', updateAll); // NEW

  const taxBoxes=['tax_on_materials','tax_on_concrete','tax_on_fuel','tax_on_disposal','tax_on_labor','tax_on_tools','tax_on_oh','tax_on_profit'];
  function setTaxLabels(res){ byId('taxLabel').textContent = res ? 'Tax Reimbursement' : 'Customer Sales Tax'; byId('stickyTaxLabel').textContent = res ? 'Reimb.' : 'Tax'; }
  function setTaxMode(res){ setTaxLabels(res); if(res){ byId('tax_on_materials').checked=true; byId('tax_on_concrete').checked=true; byId('tax_on_disposal').checked=true; byId('tax_on_fuel').checked=false; byId('tax_on_disposal').checked=false; byId('tax_on_labor').checked=false; byId('tax_on_tools').checked=false; byId('tax_on_oh').checked=false; byId('tax_on_profit').checked=false;
    } else { taxBoxes.forEach(id=>byId(id).checked=true); }
    taxBoxes.forEach(id=>byId(id).disabled=true);
    updateAll();
  }
  byId('tax_res').addEventListener('change', ()=>setTaxMode(true));
  byId('tax_com').addEventListener('change', ()=>setTaxMode(false));
  byId('unlockTax').addEventListener('click', ()=>{ taxBoxes.forEach(id=>byId(id).disabled=false); });

  // ===== Totals =====
  function ohProfit(directs, companyCost){
    const ohPct = num(byId('ohPct').value)/100;
    const profitPct = num(byId('profitPct').value)/100;
    const oh = directs*ohPct;
    const profit = companyCost + (directs+oh)*profitPct;
    return {oh, profit};
  }
  function customerTaxBase(parts){
    let base=0;
    if(byId('tax_on_materials').checked) base+=parts.mat;
    if(byId('tax_on_concrete').checked) base+=parts.conc;
    if(byId('tax_on_fuel').checked) base+=parts.fuel;
    if(byId('tax_on_disposal').checked) base+=parts.waste;
    if(byId('tax_on_labor').checked) base+=parts.crew;
    if(byId('tax_on_tools').checked) base+=parts.tools;
    if(byId('tax_on_oh').checked) base+=parts.oh;
    if(byId('tax_on_profit').checked) base+=parts.profit;
    return base;
  }
  function totals(){
    try{
      const {subtotalExclCompany, companyCost} = crewCalc();
      const matsub = materialsSubtotal();
      const cc = concreTecTS();
      const mv = mohicanValley();
      const concTotal = cc + mv;
      const fuel = fuelSubtotal();
      const toolsSub = toolsSubtotal();
      const wasteSub = wasteSubtotal();
      const directs = subtotalExclCompany + matsub + concTotal + fuel + toolsSub + wasteSub;
      const {oh, profit} = ohProfit(directs, companyCost);
      const taxPct = num(byId('taxPct').value)/100;
      const taxBase = customerTaxBase({mat:matsub, conc:concTotal, fuel, waste:wasteSub, crew:subtotalExclCompany, tools:toolsSub, oh, profit});
      const tax = taxBase * taxPct;
      const grand = directs + oh + profit + tax;

      byId('directs').textContent = fmt(directs);
      byId('ohAmt').textContent = fmt(oh);
      byId('profitAmt').textContent = fmt(profit);
      byId('taxAmt2').textContent = fmt(tax);
      byId('grand').textContent = fmt(grand);

      byId('stickyCrew').textContent = fmt(subtotalExclCompany);
      byId('stickyCompanyToProfit').textContent = fmt(companyCost);
      byId('stickyMat').textContent = fmt(matsub);
      byId('stickyConc').textContent = fmt(concTotal);
      byId('stickyFuel').textContent = fmt(fuel);
      byId('stickyTools').textContent = fmt(toolsSub);
      byId('stickyWaste').textContent = fmt(wasteSub);
      byId('stickyOH').textContent = fmt(oh);
      byId('stickyProfit').textContent = fmt(profit);
      byId('stickyTax').textContent = fmt(tax);
      byId('stickyGrand').textContent = fmt(grand);
    }catch(e){ const err=byId('err'); err.style.display='block'; err.textContent=e.message; console.error(e); }
  }
  function updateAll(){ totals(); }
  // --- Turcotte PUMP→GRAND patch (v14+): expose functions + delegated listeners ---
  try {
    window.updateAll = updateAll;
    window.totals = totals;
    window.mohicanValley = mohicanValley;
  } catch (e) { console && console.warn && console.warn('Export patch warn:', e); }

  // When pump-related controls (inserted later) change, force a full recalc so GRAND updates.
  (function(){
    const pumpIds = new Set(['pump_use','pump_size','pump_hours','mv_apply_pump','mv_apply_time','mv_discharge']);
    document.addEventListener('input', (ev) => { if (pumpIds.has(ev.target && ev.target.id)) { try{ updateAll(); } catch(e){} } }, true);
    document.addEventListener('change', (ev) => { if (pumpIds.has(ev.target && ev.target.id)) { try{ updateAll(); } catch(e){} } }, true);
  })();
  // --- end patch ---


  // Wire up missing listeners — THIS FIX
  ['ct_yards','ct_price','ct_delivery','mv_yards','mv_price','mv_short','mv_ex_38','mv_ex_38_ppy','pump_use','pump_size','pump_hours','mv_apply_pump','mv_discharge','mv_apply_time','fuel_ppg','fuel_gal','taxPct','job_date','ct_out_of_area']
    .forEach(id=>{ const el=byId(id); if(el) el.addEventListener('input', updateAll); });

  // Waste & Tools renders
  function toolsSubtotal(){ let sub=0; document.querySelectorAll('#toolTbody tr').forEach(tr=>{ const idx=tools.findIndex(x=>x.id===tr.dataset.id); const t=tools[idx]; const ext = t.use ? (num(t.cost)*num(t.frac)/Math.max(1,num(t.life))) * num(t.useHrs) : 0; sub+=ext; tr.querySelector('.t_ext').textContent = fmt(ext); }); byId('toolSubtotal').textContent = fmt(sub); return sub; }

  // Reset
  function resetBlank(){
    byId('taxPct').value = 6.35; byId('tax_res').checked = true; byId('tax_com').checked = false; setTaxMode(true);
    crewWideOn = true; byId('crewWideToggle').checked = true; crewDaysMode = true; byId('timeUnitsDays').checked = true; byId('crewWideQty').value='';
    crew.forEach(w=>{ w.use=true; w.hrs=0; }); renderCrew();
    materials.forEach(m=>{ m.use=false; m.qty=0; }); renderMaterials();
    byId('ct_yards').value=''; byId('ct_trips_read').textContent='0';
    byId('fuel_gal').value='';
    waste.forEach(w=>{ w.use=false; w.qty=0; }); renderWaste();
    tools.forEach(t=>{ t.use=false; t.useHrs=0; }); renderTools();
    byId('ohPct').value=0; byId('profitPct').value=0; totals();
  }
  document.getElementById('addToolBtn').addEventListener('click', ()=>{ const id='t_'+Math.random().toString(36).slice(2,7); tools.push({id, use:true, name:'Tool', cost:0, life:100000, frac:0.8, useHrs:0}); renderTools(); });
  document.getElementById('resetBtn') && document.getElementById('resetBtn').addEventListener('click', resetBlank);

  // Initial render
  renderCrew(); renderMaterials(); renderWaste(); renderTools(); setTaxMode(true); totals();
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var jd = document.getElementById('job_date');
  if(jd && !jd.value){
    const today = new Date();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    jd.value = today.getFullYear() + '-' + mm + '-' + dd;
    // Trigger initial auto-winter calc
    jd.dispatchEvent(new Event('input', {bubbles:true}));
  }
});
</script>
<!-- Turcotte patch v14+: Mohican PSI mix selector and mv_price default -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function ready(fn){ if(document.readyState!=='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var priceInput = $('mv_price') || document.querySelector('input#mv_price');
    if(!priceInput){ return; } // layout unknown; bail quietly

    // Build selector
    var mixes=[
      {psi:3000, label:'3000 PSI (3/4")', price:161},
      {psi:3500, label:'3500 PSI (3/4")', price:166},
      {psi:4000, label:'4000 PSI (3/4")', price:171},
      {psi:4500, label:'4500 PSI (3/4")', price:176},
    ];
    var wrap=document.createElement('span'); wrap.className='mv-mix-wrap';
    var tag=document.createElement('span'); tag.className='mv-tag'; tag.textContent='MV Mix';
    var sel=document.createElement('select'); sel.id='mv_mix_sel';
    mixes.forEach(function(m){
      var o=document.createElement('option');
      o.value=String(m.price);
      o.textContent=m.label+' — $'+m.price.toFixed(2)+'/yd';
      sel.appendChild(o);
    });
    var manualChk=document.createElement('input'); manualChk.type='checkbox'; manualChk.id='mv_manual_override';
    var manualLbl=document.createElement('span'); manualLbl.textContent='Manual price';
    wrap.appendChild(tag); wrap.appendChild(sel); wrap.appendChild(manualChk); wrap.appendChild(manualLbl);

    // Insert after price input
    priceInput.parentNode.insertBefore(wrap, priceInput.nextSibling);

    // Init: if blank or <=0, set to 3000 PSI
    var current=parseFloat((priceInput.value||'').trim());
    if(!isFinite(current) || current<=0){ current = mixes[0].price; priceInput.value = String(current); }
    // Select the matching option
    var found = mixes.find(function(m){ return Math.abs(m.price - current) < 0.001; });
    sel.value = String(found ? found.price : mixes[0].price);

    function fireInput(el){ try{ el.dispatchEvent(new Event('input',{bubbles:true})); } catch(e){} }
    // Keep price in sync unless Manual is checked
    sel.addEventListener('change', function(){
      if(!manualChk.checked){ priceInput.value=this.value; fireInput(priceInput); }
    });
    priceInput.addEventListener('input', function(){ manualChk.checked=true; });

    // Also, if user unchecks manual, snap back to selected
    manualChk.addEventListener('change', function(){ if(!this.checked){ priceInput.value=sel.value; fireInput(priceInput);} });
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var price = document.getElementById('mv_price');
  var manual = document.getElementById('mv_manual_override');
  if (!price || !manual) return;
  function sync() {
    price.style.display = manual.checked ? 'inline-block' : 'none';
  }
  sync();
  manual.addEventListener('change', sync);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var yards = document.getElementById('mv_yards');
  if (!yards) return;
  // Create banner once
  var warn = document.getElementById('mv_min_batch_warn');
  if (!warn) {
    warn = document.createElement('div');
    warn.id = 'mv_min_batch_warn';
    warn.textContent = 'Mohican minimum allowable batch size is 2 yd (consider CC for very small loads).';
    warn.style.cssText = 'display:none;margin-top:6px;background:#2a1313;color:#ffd2d2;border:1px solid #5a2a2a;border-radius:10px;padding:6px 10px;font-size:12px';
    var mvSub = document.getElementById('mv_sub');
    if (mvSub && mvSub.parentNode && mvSub.parentNode.parentNode) {
      mvSub.parentNode.parentNode.parentNode.appendChild(warn);
    } else {
      document.body.appendChild(warn);
    }
  }
  function toggle(){
    var v = parseFloat(yards.value || '0');
    warn.style.display = (v>0 && v<2) ? 'block' : 'none';
  }
  yards.addEventListener('input', toggle);
  toggle();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const wrap = document.querySelector('.wrap');
  if(!wrap) return;
  // Build Job Info card at top
  \1
  card.setAttribute('data-card-jobinfo','1');
  card.innerHTML = `<div class="row">
    <h3 style="margin:0">Job Info</h3>
    <span class="spacer"></span>
    <label>Job date <input id="job_date_header" type="date"></label>
  </div>`;
  wrap.insertBefore(card, wrap.firstChild);

  // If there is an existing #job_date in Concrete section, move its value; else create canonical #job_date
  let old = document.getElementById('job_date');
  const headerInput = document.getElementById('job_date_header');

  function setToday(el){
    const today = new Date();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    el.value = today.getFullYear() + '-' + mm + '-' + dd;
  }

  if(old){
    // Bring over value
    headerInput.value = old.value || '';
  }
  if(!headerInput.value){
    setToday(headerInput);
  }

  // Create a single canonical #job_date that all logic uses (rename/mirror header to #job_date)
  // Approach: if an element with id=job_date exists, reuse it (hidden), else create one.
  let canonical = document.getElementById('job_date');
  if(!canonical){
    canonical = document.createElement('input');
    canonical.type = 'date';
    canonical.id = 'job_date';
    canonical.style.display = 'none';
    document.body.appendChild(canonical);
  }
  // Sync header -> canonical
  function syncToCanonical(){
    canonical.value = headerInput.value;
    canonical.dispatchEvent(new Event('input', {bubbles:true}));
    canonical.dispatchEvent(new Event('change', {bubbles:true}));
  }
  headerInput.addEventListener('input', syncToCanonical);
  headerInput.addEventListener('change', syncToCanonical);
  // Initial sync
  syncToCanonical();

  // Hide the old job_date control if present
  if(old){
    old.closest('label') ? old.closest('label').style.setProperty('display','none') : old.style.setProperty('display','none');
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Find the Mohican subtotal pill row (mv_sub exists)
  var mvSub = document.getElementById('mv_sub');
  if(!mvSub) return;
  var row = mvSub.closest('.row');
  var host = row && row.parentElement ? row.parentElement : null;
  if(!host) return;

  // Build UI rows if not already present
  if(!document.getElementById('mv_overage_row')){
    var r1 = document.createElement('div');
    r1.className = 'row';
    r1.id = 'mv_overage_row';
    r1.innerHTML = `
      <label>Avg discharge time per truck (min) <input id="mv_discharge" type="number" step="1" placeholder="e.g., 45"></label>
      <span class="pill">Time Overage: <span id="mv_time_overage" class="mono">$0.00</span></span>
      <label class="pill"><input id="mv_apply_time" type="checkbox" checked> Apply to Mohican fees</label>
    `;
    host.insertBefore(r1, row);
  }

  if(!document.getElementById('mv_pump_row')){
    var r2 = document.createElement('div');
    r2.className = 'row';
    r2.id = 'mv_pump_row';
    r2.innerHTML = `
      <label class="pill"><input id="pump_use" type="checkbox"> Use pump truck</label>
      <label>Size
        <select id="pump_size">
          <option value="32@290">32 m — $290/hr (4 hr min)</option>
          <option value="40@310">40 m — $310/hr (4 hr min)</option>
        </select>
      </label>
      <label>Hours <input id="pump_hours" type="number" step="0.5" placeholder="0"></label>
      <span class="pill">Pump Fee: <span id="mv_pump_fee" class="mono">$0.00</span></span>
      <label class="pill"><input id="mv_apply_pump" type="checkbox" checked> Apply to Mohican fees</label>
    `;
    host.insertBefore(r2, row);
    // Wire pump controls to recalc
    ['pump_use','pump_size','pump_hours','mv_apply_pump'].forEach(function(id){
      var el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', function(){
        if (window.mohicanValley) try{ mohicanValley(); } catch(e){}
        if (window.totals) try{ totals(); } catch(e){}
        if (window.updateAll) updateAll();
      });
      el.addEventListener('change', function(){
        if (window.mohicanValley) try{ mohicanValley(); } catch(e){}
        if (window.totals) try{ totals(); } catch(e){}
        if (window.updateAll) updateAll();
      });
    });
    
  }

  // Helper
  function num(v){ if(v===null||v===undefined) return 0; const s=String(v).trim(); if(s==='') return 0; const n=parseFloat(s); return Number.isFinite(n)?n:0; }
  function fmt(n){ return '$' + (Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function byId(id){ return document.getElementById(id); }

  function trucksCalc(){
    var totalY = num(byId('mv_yards')?.value || 0);
    var cap = Math.max(1, num(byId('mv_cap')?.value || 10));
    return Math.ceil((totalY||0)/cap);
  }
  function allowedMinutes(){
    var totalY = num(byId('mv_yards')?.value || 0);
    return (totalY||0) * 6; // 6 min/yd total across all trucks
  }
  function timeOverage(){
    var t = trucksCalc();
    var avg = num(byId('mv_discharge')?.value || 0);
    if(t<=0 || avg<=0) return 0;
    var actual = avg * t;
    var overMin = Math.max(0, actual - allowedMinutes());
    return (overMin/60) * 300; // $300/hr
  }
  function pumpFee(){
    if(!byId('pump_use')?.checked) return 0;
    var val = byId('pump_size')?.value || '32@290';
    var rate = val.includes('@') ? parseFloat(val.split('@')[1]) : 290;
    var hrs = Math.max( num(byId('pump_hours')?.value || 0), 4 ); // 4 hr min
    return rate * hrs;
  }
  function updateExtrasIntoManual(){
    var total = 0;
    if(byId('mv_apply_time')?.checked) total += timeOverage();
    if(byId('mv_apply_pump')?.checked) total += pumpFee();
    var dst = byId('mv_short'); // existing manual Mohican field (already included by calc)
    if(!dst) return;
    // Only auto-write if user hasn't touched it recently; use an "auto" flag
    var lock = byId('mv_short_manual_lock');
    if(lock && lock.checked) return;
    if (typeof updateAll==='function'){ try{ updateAll(); } catch(e){} }}

  // Add a small "Auto calc" toggle near mv_short if possible
  var mvShort = byId('mv_short');
  if(mvShort && !byId('mv_short_manual_lock')){
    var lbl = mvShort.closest('label');
    var holder = lbl ? lbl.parentElement : mvShort.parentElement;
    var auto = document.createElement('label');
    auto.className = 'pill';
    auto.style.marginLeft = '8px';
    auto.innerHTML = `<input id="mv_short_manual_lock" type="checkbox"> Manual override for Mohican fees`;
    holder && holder.appendChild(auto);
    mvShort.addEventListener('input', function(){ byId('mv_short_manual_lock').checked = true; });
  }

  // Wire events
  ['mv_discharge','mv_yards','mv_cap','pump_use','pump_size','pump_hours','mv_apply_time','mv_apply_pump','mv_short_manual_lock']
    .forEach(function(id){ var el = byId(id); if(el){ el.addEventListener('input', function(){ byId('mv_time_overage').textContent = fmt(timeOverage()); byId('mv_pump_fee').textContent = fmt(pumpFee()); updateExtrasIntoManual(); }); el.addEventListener('change', function(){ byId('mv_time_overage').textContent = fmt(timeOverage()); byId('mv_pump_fee').textContent = fmt(pumpFee()); updateExtrasIntoManual(); }); }});

  // Initial paint
  byId('mv_time_overage').textContent = fmt(timeOverage());
  byId('mv_pump_fee').textContent = fmt(pumpFee());
  updateExtrasIntoManual();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var taxRes = document.getElementById('tax_res');
  var taxDisposal = document.getElementById('tax_on_disposal');
  function enforce(){
    if(!taxRes || !taxDisposal) return;
    if(taxRes.checked){
      taxDisposal.checked = true;
      if (!taxDisposal.disabled) { /* leave disabled state as-is */ }
      if (typeof updateAll==='function'){ try{ updateAll(); } catch(e){} }
    }
  }
  if(taxRes){
    taxRes.addEventListener('change', enforce);
    // Initial enforce
    enforce();
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var pumpUse = document.getElementById('pump_use');
  var pumpHours = document.getElementById('pump_hours');
  function ensureMinHours(){
    if (!pumpUse || !pumpHours) return;
    if (pumpUse.checked){
      var v = parseFloat(pumpHours.value||'0')||0;
      if (v <= 0){ pumpHours.value = '4'; }
    }
  }
  if (pumpUse){
    pumpUse.addEventListener('change', function(){ ensureMinHours(); });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const wrap = document.querySelector('.wrap');
  if(!wrap) return;

  // Try to place below the Job Info card (if exists); else at top.
  const jobCard = Array.from(document.querySelectorAll('.card')).find(c => c.textContent.includes('Job Info'));
  /* removed Quick Groups placeholder card */

  } else {
    wrap.insertBefore(holder, wrap.firstChild);
  }

  // Define simple group rules by card heading text to avoid touching any calc code.
  // "Concrete" group shows cards with headings containing "Concrete", "Materials", or "Waste / Disposal".
  function headingText(card){
    const h = card.querySelector('h3,h2,h4');
    return (h ? h.textContent : '').toLowerCase();
  }
  function isCardForGroup(card, group){
  const h = headingText(card);
  if(group==='all') return true;
  if(group==='concrete') return /(concrete|materials|waste|disposal)/i.test(h);
  if(group==='masonry' || group==='pavers' || group==='bluestone' || group==='veneer' || group==='stucco') return /materials/i.test(h);
  if(group==='disposal') return /(waste|disposal)/i.test(h);
  if(group==='crew') return /(crew|time|overhead|profit)/i.test(h);
  if(group==='blockwall') return /(block\s*wall)/i.test(h);
  if(group==='fuel') return /(fuel|vehicle|gas)/i.test(h);
  return true;
}


    

  const cards = Array.from(document.querySelectorAll('.wrap > .card'));

  function applyGroup(group){
  try{
    if(group==='masonry') window.__matCats=['masonry'];
    else if(group==='pavers') window.__matCats=['pavers'];
    else if(group==='bluestone') window.__matCats=['bluestone'];
    else if(group==='veneer') window.__matCats=['stone veneer'];
    else if(group==='stucco') window.__matCats=['stucco'];
    else if(group==='blockwall') window.__matCats=['masonry','concrete'];
    else window.__matCats=null;
    if(typeof renderMaterials==='function') renderMaterials();
  } catch(e){}
const cards = Array.from(document.querySelectorAll('.wrap > .card'));
  // Filter
  cards.forEach(card => {
    if(card.contains(holder)) return; // do not hide the group card itself
    // Keep Materials card visible; its rows are filtered elsewhere
    if(card.querySelector('#matTbody')){ card.classList.remove('group-hidden'); return; }
    if(isCardForGroup(card, group)) card.classList.remove('group-hidden');
    else card.classList.add('group-hidden');
  });
  // Scroll to first visible card after the group bar.
const first = cards.find(c => !c.contains(holder) && !c.classList.contains('group-hidden'));
    if(first){
      first.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }

  holder.querySelectorAll('.tag').forEach(btn => {
    btn.addEventListener('click', () => applyGroup(btn.dataset.group));
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  function clampToMin(el){
    var min = (el.getAttribute('min')!==null) ? parseFloat(el.getAttribute('min')) : 0;
    if(!isFinite(min)) min = 0;
    var v = parseFloat(el.value || '0');
    if(!isFinite(v)) return;
    if(v < min){
      el.value = String(min);
      try { el.dispatchEvent(new Event('input',{bubbles:true})); } catch(e){}
      try { el.dispatchEvent(new Event('change',{bubbles:true})); } catch(e){}
    }
  }
  document.querySelectorAll('input[type="number"]:not([data-allow-negative])').forEach(function(el){
    if(!el.hasAttribute('min')) el.setAttribute('min','0');
    el.addEventListener('input', function(){ clampToMin(el); });
    el.addEventListener('change', function(){ clampToMin(el); });
    // Initial clamp for any prefilled negatives (just in case)
    clampToMin(el);
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const wrap = document.querySelector('.wrap');
  if(!wrap) return;

  // Ensure the main content is a tabpanel
  wrap.id = wrap.id || 'main_content_wrap';
  wrap.setAttribute('role','tabpanel');
  wrap.setAttribute('tabindex','0'); // allow focus into panel
  // active tab will update aria-labelledby to itself
  wrap.setAttribute('aria-labelledby','tab-all');

  // Build the tabs card
  const tabsCard = document.createElement('div');
  tabsCard.className = 'card a11y-tabs';
  tabsCard.innerHTML = `
    <div class="row">
      <h3 id="sections-label" style="margin:0">Sections</h3>
    </div>
    <div class="row">
      <div id="sections-tablist" role="tablist" aria-labelledby="sections-label">
        <button role="tab" id="tab-all" aria-selected="true" aria-controls="main_content_wrap" tabindex="0" data-group="all">All</button>
<button role="tab" id="tab-cleanup" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="cleanup">Cleanup</button>

        <button role="tab" id="tab-concrete" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="concrete">Concrete</button>
        <button role="tab" id="tab-masonry" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="masonry">Masonry</button>
<button role="tab" id="tab-blockwall" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="blockwall">Block Wall</button>
  <button role="tab" id="tab-veneer" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="veneer">Stone Veneer</button>
        <button role="tab" id="tab-pavers" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="pavers">Pavers</button>
<button role="tab" id="tab-stucco" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="stucco">Stucco</button>

        <button role="tab" id="tab-disposal" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="disposal">Waste / Disposal</button>
        <button role="tab" id="tab-crew" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="crew">Crew &amp; Time</button>
        <button role="tab" id="tab-fuel" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="fuel">Fuel</button>
      </div>
    </div>
  `;

  // Put tabs before the wrap container
  wrap.parentNode.insertBefore(tabsCard, wrap);

  // Helper for filter logic (same as the old, but scoped here)
  function headingText(card){
    const h = card.querySelector('h3,h2,h4'); 
    return (h ? h.textContent : '').toLowerCase();
  }
  function isCardForGroup(card, group){
  const h = headingText(card);
  if(group==='all') return true;
  if(group==='concrete') return /(concrete|materials|waste|disposal)/i.test(h);
  if(group==='masonry' || group==='pavers' || group==='bluestone' || group==='veneer' || group==='stucco') return /materials/i.test(h);
  if(group==='disposal') return /(waste|disposal)/i.test(h);
  if(group==='crew') return /(crew|time|overhead|profit)/i.test(h);
  if(group==='blockwall') return /(block\s*wall)/i.test(h);
  if(group==='fuel') return /(fuel|vehicle|gas)/i.test(h);
  return true;
}


    

  const cards = Array.from(document.querySelectorAll('.wrap > .card'));

  function applyGroup(group){
  try{
    if(group==='masonry') window.__matCats=['masonry'];
    else if(group==='pavers') window.__matCats=['pavers'];
    else if(group==='bluestone') window.__matCats=['bluestone'];
    else if(group==='veneer') window.__matCats=['stone veneer'];
    else if(group==='stucco') window.__matCats=['stucco'];
    else if(group==='blockwall') window.__matCats=['masonry','concrete'];
    else window.__matCats=null;
    if(typeof renderMaterials==='function') renderMaterials();
  } catch(e){}
cards.forEach(card => {
      if(card.querySelector('#matTbody')){ card.classList.remove('group-hidden'); return;
}
      if(isCardForGroup(card, group)) card.classList.remove('group-hidden');
      else card.classList.add('group-hidden');
    });
  }

  // Tabs behavior: manual activation (APG pattern)
  const tablist = document.getElementById('sections-tablist');
  const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));

  function setActiveTab(newTab){
    tabs.forEach(tab => {
      const selected = (tab === newTab);
      tab.setAttribute('aria-selected', String(selected));
      tab.tabIndex = selected ? 0 : -1;
    });
    // Filter content
    const group = newTab.getAttribute('data-group');
    applyGroup(group);
    // Update label reference for the panel
    wrap.setAttribute('aria-labelledby', newTab.id);
  }

  // Click = activate
  tabs.forEach(tab => {
    tab.addEventListener('click', () => { setActiveTab(tab); tab.focus(); });
  });

  // Keyboard roving tabindex + manual activation
  tablist.addEventListener('keydown', (e) => {
    const currentIndex = tabs.findIndex(t => t === document.activeElement);
    if(currentIndex === -1) return;
    let nextIndex = currentIndex;
    switch(e.key){
      case 'ArrowRight':
      case 'ArrowDown':
        nextIndex = (currentIndex + 1) % tabs.length; 
        e.preventDefault(); tabs[nextIndex].focus(); break;
      case 'ArrowLeft':
      case 'ArrowUp':
        nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
        e.preventDefault(); tabs[nextIndex].focus(); break;
      case 'Home':
        e.preventDefault(); tabs[0].focus(); break;
      case 'End':
        e.preventDefault(); tabs[tabs.length - 1].focus(); break;
      case 'Enter':
      case ' ':
        e.preventDefault(); setActiveTab(document.activeElement); break;
    }
  });

  // Initial apply
  applyGroup('all');
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  /* 1) Insert a clean spacer between the two concrete suppliers */
  (function(){
    const heading = Array.from(document.querySelectorAll('.card h3, .card h4, label'))
      .find(el => /Mohican\s+Valley/i.test(el.textContent||''));
    if (heading && heading.closest('.row')){
      const row = document.createElement('div');
      row.className = 'row';
      const hr = document.createElement('hr');
      hr.style.cssText = 'border:0;border-top:1px dashed #334155;margin:12px 0 16px;opacity:.9';
      row.appendChild(hr);
      heading.closest('.row').insertAdjacentElement('beforebegin', row);
    }
  })();

  /* 2) Make "+ Add Material" work: append to materials[], re-render, and focus new row */
  (function(){
    var btn = document.getElementById('addMatBtn');
    if (!btn) return;
    btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
        if (typeof renderMaterials === 'function') renderMaterials();
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (!rows.length) return;
          var last = rows[rows.length - 1];
          var input = last.querySelector('.mat_item');
          if (input) input.focus();
        }, 0);
      }catch(e){
        console.error('Add Material failed', e);
      }
});
        if (typeof renderMaterials === 'function') renderMaterials();
        // Focus the newly added item's name field
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (!rows.length) return;
          var last = rows[rows.length - 1];
          var input = last.querySelector('.mat_item');
          if (input) input.focus();
        }, 0);
      } catch(e){ console.error('Add Material failed', e); }
    });
  })();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('addMatBtn');
  if(!btn) return;

  function getMaterialsRef(){
    try { return (typeof materials !== 'undefined') ? materials : (window.materials||null); }
    catch(e){ return window.materials || null; }
  }

  btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
      if (typeof renderMaterials === 'function') { renderMaterials(); }
      setTimeout(function(){
        var rows = document.querySelectorAll('#matTbody tr');
        if (rows.length){
          var last = rows[rows.length-1];
          var input = last.querySelector('.mat_item');
          if (input) input.focus();
        }
      }, 0);
      if (typeof updateAll === 'function') { updateAll(); }
      return;
    }
    // Fallback: append a DOM-only row (in case data structure is unavailable)
    var tb = document.getElementById('matTbody'); if(!tb) return;
    var tr = document.createElement('tr');
    tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                   '<td><input class="mat_item" placeholder="Item"></td>' +
                   '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                   '<td><input class="mat_units" value="each"></td>' +
                   '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                   '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                   '<td class="right mono mat_ext">$0.00</td>' +
                   '<td><button class="ghost mat_del">✕</button></td>';
    tb.appendChild(tr);
    tr.querySelectorAll('input').forEach(function(el){
      el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
    });
    setTimeout(function(){ tr.querySelector('.mat_item') && tr.querySelector('.mat_item').focus(); }, 0);
    if (typeof updateAll === 'function') { updateAll(); }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var tablist = document.getElementById('sections-tablist');
  var tbody = document.getElementById('matTbody');
  if(!tbody) return;
  
  var SECTION = {
    all:       { cats: null,                   pins: null },
    concrete:  { cats: ['concrete'],           pins: new Set(['m6','m7','m10','mNH3','m2013','mTIL_DrivewayMix','mSO_KY_Bluegrass_Sod','mSO_TopSoil_Bulk','mNHM_Concrete_80lb','mLOW_ColdPatchAsphalt_50lb']) },
    masonry:   { cats: ['masonry'],            pins: new Set(['m4','m8','m9','m11']) },
    pavers:    { cats: ['pavers'],             pins: new Set(['m1','m2','m3']) },
    bluestone: { cats: ['bluestone'],          pins: new Set([]) },
    veneer:    { cats: ['stone veneer','bluestone'], pins: new Set([]) },
    stucco:    { cats: ['stucco'],             pins: new Set([]) }
  };
  function currentGroup(){
    var active = tablist && tablist.querySelector('[role="tab"][aria-selected="true"]');
    return active ? (active.getAttribute('data-group')||'all') : 'all';
  }
  function applyDim(){
    var g = currentGroup();
    var allow = (SECTION[g]||{}).pins || null;
    tbody.querySelectorAll('tr').forEach(function(tr){
      var id = tr.dataset.id || '';
      var dim = ((allow && id && !allow.has(id)));
      tr.classList.toggle('dim', dim);
    });
  }
  if (tablist){
    tablist.addEventListener('click', function(){ setTimeout(applyDim, 0); });
    tablist.addEventListener('keydown', function(e){
      if(e.key==='Enter' || e.key===' ') setTimeout(applyDim, 0);
    });
  }
  // Re-apply after Materials re-render/add
  var mo = new MutationObserver(function(){ applyDim(); });
  mo.observe(tbody, {childList:true});
  applyDim();
});
</script>
<script>
(function(){
  function ready(cb){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded', cb, {once:true});} else { cb(); } }
  ready(function(){
    try{
      var tablist = document.getElementById('sections-tablist');
      var tbody = document.getElementById('matTbody');
      if(!tbody) return;

      // Map *existing* tabs to materials row IDs (dataset.id set by renderMaterials)
      // m1: 8' Plastic paver edging
      // m2: 8' Aluminum paver edging
      // m3: 12" paver spikes — 150/box
      // m4: SPEC MIX Type S — 80 lb
      // m5: SPEC MIX Stone Veneer — 80 lb   (kept visible in all tabs since no 'Veneer' tab yet)
      // m6: Bulk crushed rock 3/4"
      // m7: Concrete wire mesh 5'×10'
      // m8: SPEC MIX Core Fill Grout 3k — 80 lb
      // m9: 12" hollow concrete block
      // m10: 6"×10' expansion joint
      /* legacy groups removed */

      function activeGroup(){
      var tablist = document.getElementById('sections-tablist');
      var active = tablist && tablist.querySelector('[role="tab"][aria-selected="true"]');
      var g = active ? (active.getAttribute('data-group')||'all') : 'all';
      if(!(window.SECTION && Object.prototype.hasOwnProperty.call(SECTION, g))) g = 'all';
      return g;
    }

      function applyHide(){
        var g = activeGroup();
        var allow = (SECTION[g]||{}).pins || null;
        tbody.querySelectorAll('tr').forEach(function(tr){
          var id = tr.dataset.id || '';
          var show = (!allow) || !id || allow.has(id); // unknown/new rows always show
          tr.style.display = show ? '' : 'none';
        });
      }

      if (tablist){
        tablist.addEventListener('click', function(){ setTimeout(applyHide, 0); });
        tablist.addEventListener('keydown', function(e){
          if(e.key==='Enter' || e.key===' ') setTimeout(applyHide, 0);
        });
      }

      // Re-apply when materials re-render or rows added
      var mo = new MutationObserver(function(){ applyHide(); });
      mo.observe(tbody, {childList:true});

      // Initial pass
      applyHide();
    }catch(e){
      console.warn('Row-hide filter disabled:', e);
    }
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var mvY = document.getElementById('mv_yards');
  if(mvY){
    mvY.setAttribute('min','0');
    mvY.setAttribute('step','0.5'); // allow halves if needed
    function clamp2(){
      var v = parseFloat(mvY.value||'0');
      if (v>0 && v<2) { mvY.value = 2; }
      if (v<0 || isNaN(v)) { mvY.value = 0; }
      if (typeof updateAll === 'function') updateAll();
    }
    mvY.addEventListener('change', clamp2);
    mvY.addEventListener('blur', clamp2);
    mvY.addEventListener('input', function(){ /* don't force during typing */ });
  }
});
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  try{
    if(!window.USD){ window.USD = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD', maximumFractionDigits:2}); }
    if(!window.$$){ window.$$ = function(n){ return window.USD.format((Number(n)||0)); }; }
    if(typeof window.fmt === 'function'){ window.fmt = function(n){ return window.$$((Number(n)||0)); }; }
  }catch(e){ console.warn('currency formatter patch:', e); }
});
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  try{
    if(typeof window.updateAll === 'function' && !window.__updateAllWrapped){
      const raw = window.updateAll;
      let raf = 0;
      window.updateAll = function(){
        if(raf) return;
        raf = requestAnimationFrame(function(){ raf = 0; try{ raw(); }catch(e){ console.warn('updateAll error', e); } });
      };
      window.__updateAllWrapped = true;
    }
  }catch(e){ console.warn('updateAll raf patch:', e); }
});
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  try{
    if(typeof window.updateAll === 'function' && !window.__updateAllPost){
      var raw = window.updateAll;
      window.updateAll = (function(orig){
        return function(){
          return orig.apply(this, arguments), (function(){ try{ if(window.totals) totals(); } catch(e){} })();
        };
      })(raw);
      window.__updateAllPost = true;
    }
  }catch(e){ console.warn('updateAll posthook error', e); }
});
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  function recalcMV(){
    try{ if(window.mohicanValley) mohicanValley(); } catch(e){}
    try{ if(window.totals) totals(); } catch(e){}
    try{ if(window.updateAll) updateAll(); } catch(e){}
  }
  ['input','change'].forEach(function(type){
    document.addEventListener(type, function(e){
      var id = e.target && e.target.id || '';
      if(/^mv_/.test(id) || /^pump_/.test(id)){
        recalcMV();
      }
    }, true); // capture to catch dynamically inserted controls
  });
});
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  function needsTotals(id){
    return /^mv_/.test(id) || /^pump_/.test(id) || /^fuel_/.test(id);
  }
  function recalc(){
    try{ if(window.totals) totals(); } catch(e){}
  }
  ['input','change'].forEach(function(type){
    document.addEventListener(type, function(e){
      if(!e || !e.target) return;
      var id = e.target.id || '';
      if(needsTotals(id)) recalc();
    }, true); // capture phase to catch dynamic inserts
  });
});
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  function recalc(){
    try{ updateAll(); } catch(e){}
  }
  ['input','change'].forEach(function(type){
    document.addEventListener(type, function(e){
      var id = e && e.target && e.target.id || '';
      if(/^mv_/.test(id) || /^pump_/.test(id) || /^fuel_/.test(id)){
        recalc();
      }
    }, true);
  });
});
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  var use = document.getElementById('pump_use');
  var ap  = document.getElementById('mv_apply_pump');
  if(use && ap){
    function sync(){ ap.checked = !!use.checked; try{ updateAll(); } catch(e){} }
    use.addEventListener('input', sync);
    use.addEventListener('change', sync);
  }
});
</script>
<!-- Global live-totals delegate: keeps every input/select/checkbox in sync -->
<script 
document.addEventListener('DOMContentLoaded', function(){
  function recalc(){ try{ if (typeof updateAll==='function') updateAll(); } catch(e){} }
  // Recalc on any input/change across the app (capture = catches dynamic rows too)
  document.addEventListener('input',  function(e){
    try{
      var t = e && e.target;
      if(!t) return;
      // Auto-check a nearby "Use" checkbox if a numeric qty > 0 is entered (materials/waste rows)
      if(t.matches && t.matches('input[type="number"]')){
        var v = parseFloat(t.value);
        if(!isNaN(v) && v>0){
          var row = t.closest && (t.closest('tr') || t.closest('.row') || t.parentElement);
          if(row){
            var chk = row.querySelector && row.querySelector('input[type="checkbox"]');
            if(chk && !chk.checked){ chk.checked = true; }
          }
        }
      }
    }catch(err){}
    recalc();
  }, true);
  document.addEventListener('change', function(){ recalc(); }, true);
});
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  function setCats(c){ window.__matCats = c; if (typeof renderMaterials==='function') renderMaterials(); }
  function pick(group){
    if(group==='bluestone') setCats(['bluestone','masonry','stone veneer']);
    else if(group==='veneer') setCats(['stone veneer','masonry','bluestone']);
    else setCats(null);
    var h3s = Array.from(document.querySelectorAll('.card h3'));
    var matCard = h3s.find(h=>/Materials/i.test(h.textContent));
    if(matCard){ matCard.scrollIntoView({behavior:'smooth', block:'start'}); }
  }
  document.querySelectorAll('.groupbar .tag[data-group="bluestone"]').forEach(btn=>{
    btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
  });
  document.querySelectorAll('.groupbar .tag[data-group="veneer"]').forEach(btn=>{
    btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
  });
});
</script>
<script 
(function(){
  if (window.__autoCovSq) return; window.__autoCovSq = true;
  function markSqCoverage(){
    try{
      (window.materials||[]).forEach(function(m){
        var u = (m && m.units ? String(m.units).toLowerCase() : '').trim();
        var norm = u.replace(/\s+/g,'');
        // If units look like square feet (sf, sq ft, sqft, square foot/feet, ft²), and no explicit coverage set, default to 1 sf/unit
        if (!m.coverageSqft && (
            norm.startsWith('sf') ||
            norm.startsWith('sqft') ||
            norm.startsWith('sqft.') ||
            norm.startsWith('sqft2') ||
            norm.startsWith('sq') ||
            norm.includes('squarefoot') ||
            norm.includes('squarefeet') ||
            norm==='ft²' || norm==='ft2'
        )){
          m.coverageSqft = 1;
        }
      });
    }catch(e){/* no-op */}
  }
  document.addEventListener('DOMContentLoaded', function(){
    markSqCoverage();
    // Re-render so Area (sf) placeholder appears for these items, then recompute totals
    try{ if (typeof renderMaterials==='function') renderMaterials(); } catch(e){}
    try{ if (typeof updateAll==='function') updateAll(); } catch(e){}
  });
})();
</script>
<script 
(function(){
  if (window.__stuccoHardFilter) return; window.__stuccoHardFilter = true;
  function hardHideWasteForStucco(group){
    try{
      if(group!=='stucco') return;
      // Make sure materials are filtered to Stucco
      window.__matCats = ['stucco'];
      if (typeof renderMaterials==='function') renderMaterials();
      // Hide Waste / Disposal card explicitly
      document.querySelectorAll('.wrap > .card').forEach(function(card){
        var h = (card.querySelector('h3')||{}).textContent||'';
        if (/waste\s*\/\s*disposal/i.test(h)) card.classList.add('group-hidden');
      });
    }catch(e){/* no-op */}
  }
  // Monkey-patch setActiveTab to run our hard filter after applyGroup
  const tablist = document.getElementById('sections-tablist');
  if (!tablist) return;
  const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
  // Find existing setActiveTab in window scope (bound in closure); re-bind click handlers instead
  tabs.forEach(function(tab){
    tab.addEventListener('click', function(){
      const group = tab.getAttribute('data-group');
      // run shortly after built-in handler
      setTimeout(function(){ hardHideWasteForStucco(group); }, 0);
    });
  });
  // Also run on load in case Stucco is initially selected
  document.addEventListener('DOMContentLoaded', function(){
    const selected = tablist.querySelector('[role="tab"][aria-selected="true"]');
    if (selected) hardHideWasteForStucco(selected.getAttribute('data-group'));
  });
})();
</script>
<script 
// Minimal, robust: label the Waste/Disposal card, track active tab, and let CSS do the hiding.
(function(){
  if (window.__stuccoHideWasteApplied) return; window.__stuccoHideWasteApplied = true;

  function labelCards(){
    try{
      document.querySelectorAll('.wrap > .card').forEach(function(card){
        var h = (card.querySelector('h3')||{}).textContent||'';
        if (/^\s*Waste\s*\/\s*Disposal\s*$/i.test(h)) card.dataset.card = 'waste';
      });
    }catch(e){/* no-op */}
  }

  function readActiveGroup(){
    var tablist = document.getElementById('sections-tablist');
    if (!tablist) return null;
    var sel = tablist.querySelector('[role="tab"][aria-selected="true"]');
    return sel ? sel.getAttribute('data-group') : null;
  }

  function updateBodyData(){
    try{
      var g = readActiveGroup();
      if (g) document.body.dataset.activeGroup = g;
    }catch(e){/* no-op */}
  }

  function setupListeners(){
    var tablist = document.getElementById('sections-tablist');
    if (!tablist) return;
    // Click handler ensures body dataset stays in sync
    tablist.addEventListener('click', function(ev){
      var t = ev.target.closest('[role="tab"]');
      if (!t) return;
      // allow original handler to run first (which toggles aria-selected)
      setTimeout(updateBodyData, 0);
    });

    // Keyboard handler (Enter/Space activation) — mirror approach
    tablist.addEventListener('keydown', function(ev){
      if (ev.key==='Enter' || ev.key===' ') {
        setTimeout(updateBodyData, 0);
      }
    });

    // As a fallback, observe aria-selected changes with MutationObserver
    try{
      var obs = new MutationObserver(function(){
        updateBodyData();
      });
      obs.observe(tablist, { subtree:true, attributes:true, attributeFilter:['aria-selected'] });
    }catch(e){/* MutationObserver support assumed modern; ignore if blocked */}
  }

  function init(){
    labelCards();
    setupListeners();
    // Run once on load
    updateBodyData();
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  } else {
    init();
  }
})();
</script>
<!-- FIX: Ensure Materials re-filters when the Stucco tab is active; also sync data-active-group for CSS -->
<script 
(function(){
  var TABLIST_SEL = '#sections-tablist';
  var lastClickedGroup = null;

  function getGroupFromAria(){
    var t = document.querySelector(TABLIST_SEL+' [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || null) : null;
  }
  function getGroupFromActiveClass(){
    var t = document.querySelector(TABLIST_SEL+' .active,[data-active="true"]');
    return t ? (t.getAttribute('data-group') || null) : null;
  }
  function computeActiveGroup(){
    return getGroupFromAria() || lastClickedGroup || getGroupFromActiveClass() || 'all';
  }
  function setActiveGroup(g){
    document.body.dataset.activeGroup = g || 'all';
    // Clear forced filter for non-stucco; only force for Stucco
    window.__matCats = (g === 'stucco') ? ['stucco'] : null;
    if (typeof renderMaterials === 'function') renderMaterials();
    if (typeof updateAll === 'function') updateAll();
  }
  function onTabsMutation(){
    setActiveGroup(computeActiveGroup());
  }
  function onPossibleTabClick(ev){
    var btn = ev.target.closest(TABLIST_SEL+' [role="tab"], '+TABLIST_SEL+' [data-group]');
    if (btn){
      lastClickedGroup = btn.getAttribute('data-group') || null;
      // Defer to let aria-selected update if their code sets it
      setTimeout(onTabsMutation, 0);
    }
  }

  document.addEventListener('click', onPossibleTabClick, true);
  document.addEventListener('keydown', function(ev){
    if ((ev.key === 'Enter' || ev.key === ' ') && document.activeElement && document.activeElement.matches(TABLIST_SEL+' [role="tab"]')){
      lastClickedGroup = document.activeElement.getAttribute('data-group') || null;
      setTimeout(onTabsMutation, 0);
    }
  }, true);

  // MutationObserver for aria-selected changes
  var list = document.querySelector(TABLIST_SEL);
  if (list){
    var mo = new MutationObserver(onTabsMutation);
    mo.observe(list, { subtree:true, attributes:true, attributeFilter:['aria-selected'] });
  }

  // Initial sync
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ setActiveGroup(computeActiveGroup()); }, {once:true});
  } else {
    setActiveGroup(computeActiveGroup());
  }
})();
</script>
<script 
document.addEventListener('DOMContentLoaded', function(){
  var o = document.getElementById('ct_out_of_area');
  if(o){ o.checked = false; try{ updateAll(); } catch(e){} }
}, true);
</script>

<script 
(function(){
  function findOwnerRow(){
    var tr = document.querySelector("#crewTbody tr[data-id='owner']");
    if (tr) return tr;
    // Fallback: try to find a row whose name cell includes Owner or Rob
    var rows = document.querySelectorAll("#crewTbody tr");
    for (var i=0;i<rows.length;i++){
      var nameEl = rows[i].querySelector(".crew_name, .name, input[type='text']");
      var name = nameEl ? (nameEl.value || nameEl.textContent || "") : "";
      if (/owner/i.test(name) || /rob/i.test(name)) return rows[i];
    }
    return null;
  }
  function syncOwnerRate(tr){
    try{
      if(!tr) return;
      var roleSel = tr.querySelector(".crew_role");
      var rateInp = tr.querySelector(".crew_rate");
      if(!roleSel || !rateInp) return;
      var role = String(roleSel.value||"").toLowerCase();
      var rate = null;
      if (role === "owner") rate = 50;
      else if (role === "laborer") rate = 25;
      if (rate != null){
        rateInp.value = String(rate);
        // Update model if present
        if (window.crew && Array.isArray(window.crew)){
          var idx = crew.findIndex(function(c){ return c && c.id === (tr.dataset && tr.dataset.id); });
          if (idx >= 0 && crew[idx]){
            crew[idx].rate = rate*1;
            crew[idx].role = role;
          }
        }
        if (typeof updateAll === "function") { try{ updateAll(); } catch(e){} }
      }
    }catch(e){/* noop */}
  }
  function attach(){
    var tr = findOwnerRow();
    if(!tr) return false;
    var roleSel = tr.querySelector(".crew_role");
    if(!roleSel) return false;
    if(!roleSel.__robAutorate){
      roleSel.addEventListener("change", function(){ syncOwnerRate(tr); }, true);
      roleSel.__robAutorate = true;
    }
    // Enforce once on attach (handles initial state)
    syncOwnerRate(tr);
    return true;
  }
  // Try on DOM ready, and a few retries in case UI renders late
  function onReady(fn){ if(document.readyState!=="loading") fn(); else document.addEventListener("DOMContentLoaded", fn, {once:true}); }
  onReady(function(){
    var ok = attach();
    var tries = 0;
    var t = setInterval(function(){
      if (ok || tries>10){ clearInterval(t); return; }
      ok = attach(); tries++;
    }, 200);
  });
})();
</script>

<script 
// Default hourly rates by role (extend/adjust here if needed)
const TM_DEFAULT_RATES = {
  owner: 50,
  company: 50,
  foreman: 43.75,
  mason: 30,
  laborer: 25,
  other: 30
};

(function(){
  function getRows(){
    return Array.from(document.querySelectorAll("#crewTbody tr"));
  }
  function getRole(tr){
    var sel = tr && tr.querySelector(".crew_role");
    return String(sel && sel.value || "").toLowerCase();
  }
  function setRate(tr, val){
    var inp = tr && tr.querySelector(".crew_rate");
    if(!inp) return;
    inp.value = String(val);
    // update backing model if present
    try{
      if(window.crew && Array.isArray(window.crew)){
        var id = tr.dataset && tr.dataset.id;
        var idx = crew.findIndex(c=>c && c.id===id);
        if(idx>=0 && crew[idx]){
          crew[idx].rate = Number(val)||0;
        }
      }
    } catch(e){}
  }
  function isOwnerRow(tr){
    if(!tr) return false;
    if(tr.dataset && tr.dataset.id === "owner") return true;
    try{
      var nameEl = tr.querySelector(".crew_name, .name, input[type='text']");
      var name = nameEl ? (nameEl.value || nameEl.textContent || "") : "";
      return /\bowner\b/i.test(name) || /\brob\b/i.test(name);
    }catch(e){ return false; }
  }
  function currentRate(tr){
    var inp = tr && tr.querySelector(".crew_rate");
    return inp ? Number(inp.value||0) : 0;
  }
  function anyDefaultValue(val){
    return Object.values(TM_DEFAULT_RATES).some(v => Math.abs((Number(val)||0) - v) < 1e-9);
  }
  function markManual(tr){
    if(!tr) return;
    tr.dataset.manualRate = "true";
    try{
      if(window.crew && Array.isArray(window.crew)){
        var id = tr.dataset && tr.dataset.id;
        var idx = crew.findIndex(c=>c && c.id===id);
        if(idx>=0 && crew[idx]) crew[idx].manualRate = true;
      }
    } catch(e){}
  }
  function applyDefaultForRow(tr){
    if(!tr) return;
    var role = getRole(tr);
    var def = TM_DEFAULT_RATES[role];
    if(def==null) return;
    var isOwner = isOwnerRow(tr);
    var manual = tr.dataset.manualRate === "true";
    var cur = currentRate(tr);
    // Rule: always enforce defaults for the Owner row on role change.
    // For other rows: set default if user hasn't manually overridden OR current equals some other default (i.e., still baseline).
    if(isOwner || !manual || anyDefaultValue(cur)){
      setRate(tr, def);
      // If we just applied a default due to role change, keep manual flag as-is (do not set).
      try{ if(typeof updateAll==="function") updateAll(); } catch(e){}
    }
  }
  function bindRow(tr){
    if(!tr || tr.__tmBound) return;
    var roleSel = tr.querySelector(".crew_role");
    var rateInp = tr.querySelector(".crew_rate");
    if(roleSel){
      roleSel.addEventListener("change", function(){
        applyDefaultForRow(tr);
      }, true);
    }
    if(rateInp){
      rateInp.addEventListener("input", function(){
        markManual(tr);
      }, true);
    }
    tr.__tmBound = true;
  }
  function attachAll(){
    getRows().forEach(bindRow);
    // On first attach, enforce Owner row mapping once (in case initial load has wrong value)
    try{
      var ownerRow = getRows().find(isOwnerRow);
      if(ownerRow){
        var def = TM_DEFAULT_RATES[getRole(ownerRow)];
        if(def!=null && currentRate(ownerRow)!==def){
          setRate(ownerRow, def);
          if(typeof updateAll==="function") updateAll();
        }
      }
    } catch(e){}
  }
  function onReady(fn){ if(document.readyState!=="loading") fn(); else document.addEventListener("DOMContentLoaded", fn, {once:true}); }
  onReady(function(){
    // Initial attach
    attachAll();
    // Retry a few times in case crew table renders late
    var tries = 0, t = setInterval(function(){
      attachAll();
      if(++tries>10) clearInterval(t);
    }, 250);
    // Also re-attach after any global updateAll if available
    try{
      if(typeof window.updateAll === "function" && !window.updateAll.__tmWrapped){
        var _u = window.updateAll;
        window.updateAll = function(){ var r = _u.apply(this, arguments); try{ attachAll(); } catch(e){} return r; };
        window.updateAll.__tmWrapped = true;
      }
    } catch(e){}
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  function updatePanels(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var panels = document.querySelectorAll('.wrap .panel');
    panels.forEach(function(p){
      var hasMat = !!p.querySelector('#matTbody');
      var hasTabs = !!p.querySelector('#sections-tablist');
      p.style.display = isCleanup ? ((hasMat||hasTabs)?'':'none') : '';
    });
    function hideCardBy(sel){
      var el = document.querySelector(sel);
      if (!el) return;
      var card = el.closest('.card');
      if (card) card.style.display = isCleanup ? 'none' : '';
    }
    hideCardBy('#taxPct');
    hideCardBy('#crewCount'); hideCardBy('#crewHours'); hideCardBy('#crewRate');
    if (isCleanup){
      var headers = document.querySelectorAll('.wrap .card h2, .wrap .card h3, .wrap .card .card-title');
      headers.forEach(function(h){
        var t = (h.textContent||'').toLowerCase();
        if (t.includes('crew') && t.includes('time')){
          var c = h.closest('.card'); if (c) c.style.display = 'none';
        }
      });
    }
  }
  var tablist = document.getElementById('sections-tablist');
  if (tablist){
    tablist.addEventListener('click', function(){ setTimeout(updatePanels, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(updatePanels, 0); });
  }
  var mo = new MutationObserver(updatePanels);
  mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  updatePanels();
});
</script>


<script>
(function(){
  function hideJobInfoOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var el = document.getElementById('job_date_header');
    if (!el) return; // job info card not created yet
    var card = el.closest('.card');
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideJobInfoOnCleanup();
    // run again after Job Info builder runs; and when active-group changes
    setTimeout(hideJobInfoOnCleanup, 100);
    var mo = new MutationObserver(hideJobInfoOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>


<script>
(function(){
  function hideQuickGroupsOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var gb = document.querySelector('.wrap .card .groupbar');
    if (!gb) return;
    var card = gb.closest('.card');
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideQuickGroupsOnCleanup();
    var mo = new MutationObserver(hideQuickGroupsOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>


<script>
(function(){
  // Remove the Concrete tab from the Sections list when Cleanup is active; restore it otherwise.
  var removedConcreteBtn = null; /* disabled */
  function toggleConcreteInCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var tablist = document.getElementById('sections-tablist');
    if (!tablist) return;
    var concreteBtn = tablist.querySelector('[role="tab"][data-group="concrete"]');
    if (isCleanup){
      if (concreteBtn){
        // cache and remove
        removedConcreteBtn = concreteBtn;
        concreteBtn.parentNode/* .removeChild(concreteBtn) -- disabled */;
      }
    } else {
      // restore if missing and we have a cached copy
      var exists = tablist.querySelector('[role="tab"][data-group="concrete"]');
      if (!exists && removedConcreteBtn){
        // Insert back to its original general position: before Masonry if present; else append at start
        var masonryBtn = tablist.querySelector('[role="tab"][data-group="masonry"]');
        if (masonryBtn && masonryBtn.parentNode){
          masonryBtn.parentNode.insertBefore(removedConcreteBtn, masonryBtn);
        } else {
          tablist.insertBefore(removedConcreteBtn, tablist.firstChild);
        }
        removedConcreteBtn = null;
      }
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    toggleConcreteInCleanup();
    var mo = new MutationObserver(toggleConcreteInCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>


<script>
(function(){
  function hideVehicleFuelOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var card = null;
    // Try to locate by common IDs inside the card
    var probeIds = ['vehicle_fuel','vehicleFuel','fuelCost','fuelQty','vehFuel','fuel_cost'];
    for (var i=0;i<probeIds.length && !card;i++){
      var el = document.getElementById(probeIds[i]);
      if (el){ card = el.closest('.card'); }
    }
    // Fallback: find a card whose header contains "Vehicle Fuel"
    if (!card){
      var headers = document.querySelectorAll('.wrap .card h2, .wrap .card h3, .wrap .card .card-title');
      headers.forEach(function(h){
        var t = (h.textContent||'').toLowerCase();
        if (!card && t.includes('vehicle') && t.includes('fuel')){
          var c = h.closest('.card'); if (c) card = c;
        }
      });
    }
    if (card){ card.style.display = isCleanup ? 'none' : ''; }
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideVehicleFuelOnCleanup();
    var mo = new MutationObserver(hideVehicleFuelOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>


<script>
(function(){
  function hideWasteDisposalOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var card = null;
    var ids = ["wasteCost", "wasteQty", "disposalCost", "disposalQty", "dumpsterCost", "dumpsterQty", "waste_fee", "disposal_fee", "dump_fee", "dumpster", "wasteDisposal", "waste_disposal"];
    for (var i=0;i<ids.length && !card;i++){
      var el = document.getElementById(ids[i]);
      if (el) card = el.closest('.card');
    }
    if (!card){
      var headers = document.querySelectorAll('.wrap .card h2, .wrap .card h3, .wrap .card .card-title');
      headers.forEach(function(h){
        var t = (h.textContent||'').toLowerCase();
        if (!card && t.includes('waste') && t.includes('disposal')){
          var c = h.closest('.card'); if (c) card = c;
        }
      });
    }
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideWasteDisposalOnCleanup();
    var mo = new MutationObserver(hideWasteDisposalOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>


<script>
(function(){
  function hideToolsDeprOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var card = null;
    var ids = ["toolsDepreciation", "toolDepreciation", "depreciationReserve", "toolsReserve", "deprReserve", "tools_depreciation", "tool_depreciation", "depreciation_reserve", "tools_reserve", "deprRate", "deprCost", "deprAmount", "toolsDepr", "deprReservePct"];
    for (var i=0;i<ids.length && !card;i++){ 
      var el = document.getElementById(ids[i]); 
      if (el) card = el.closest('.card'); 
    }
    if (!card){ 
      var headers = document.querySelectorAll('.wrap .card h2, .wrap .card h3, .wrap .card .card-title');
      headers.forEach(function(h){ 
        var t = (h.textContent||'').toLowerCase();
        if (!card && t.includes('tools') && (t.includes('depreciation') || t.includes('depreciation reserve'))){
          var c = h.closest('.card'); if (c) card = c; 
        }
      });
    }
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  document.addEventListener('DOMContentLoaded', function(){ 
    hideToolsDeprOnCleanup();
    var mo = new MutationObserver(hideToolsDeprOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>


<script>
(function(){
  function hideTotalsOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var cards = document.querySelectorAll('.wrap .card');
    var needles = ['directs','overhead','profit','tax reimbursement','grand'];
    cards.forEach(function(card){
      var t = (card.textContent || '').toLowerCase();
      var isTotals = needles.every(function(k){ return t.includes(k); });
      if (isTotals){
        card.style.display = isCleanup ? 'none' : '';
      }
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideTotalsOnCleanup();
    // run again if DOM mutates or tab changes
    var mo = new MutationObserver(hideTotalsOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    // also observe main content area for dynamic build
    var main = document.querySelector('.wrap') || document.body;
    var mo2 = new MutationObserver(function(){ hideTotalsOnCleanup(); });
    mo2.observe(main, { childList:true, subtree:true });
  });
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  function hideConcreteOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var el = document.getElementById('ct_yards') || document.getElementById('mv_yards');
    if (!el) return;
    var card = el.closest('.card');
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  hideConcreteOnCleanup();
  var mo = new MutationObserver(hideConcreteOnCleanup);
  mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
});
</script>


<script>
(function(){
  function hideWasteDisposalOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var cards = document.querySelectorAll('.wrap .card');
    cards.forEach(function(card){
      var txt = (card.textContent || '').toLowerCase();
      // Header-focused match (stricter)
      var header = card.querySelector('h1,h2,h3,.card-title');
      var htxt = header ? (header.textContent||'').toLowerCase() : '';
      var headerLooksRight = (htxt.includes('waste') && (htxt.includes('disposal') || htxt.includes('dump') || htxt.includes('dumpster')));
      // Content token match (more tolerant)
      var tokens = ['waste','disposal','dump','dumpster'];
      var tokenHits = tokens.filter(t => txt.includes(t)).length;
      var looksLikeWaste = headerLooksRight || tokenHits >= 2;
      if (looksLikeWaste){
        card.style.display = isCleanup ? 'none' : '';
      }
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideWasteDisposalOnCleanup();
    // re-run when tab changes or DOM mutates
    var mo = new MutationObserver(hideWasteDisposalOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    var main = document.querySelector('.wrap') || document.body;
    var mo2 = new MutationObserver(function(){ hideWasteDisposalOnCleanup(); });
    mo2.observe(main, { childList:true, subtree:true });
  });
})();
</script>


<script>
(function(){
  // Robust, sticky hide for "Waste / Disposal" while Cleanup is active.
  function findWasteCard(){
    // Try common IDs first
    var ids = ['waste','disposal','dumpster','wasteCost','disposalCost','dumpsterCost','wasteDisposal','waste_disposal'];
    for (var i=0;i<ids.length;i++){
      var el = document.getElementById(ids[i]);
      if (el){ var card = el.closest('.card'); if (card) return card; }
    }
    // Fallback: header text contains tokens
    var tokens = ['waste','disposal','dump','dumpster'];
    var cards = document.querySelectorAll('.wrap .card');
    for (var j=0;j<cards.length;j++){
      var c = cards[j];
      var hdr = c.querySelector('h1,h2,h3,.card-title');
      var htxt = hdr ? (hdr.textContent||'').toLowerCase() : '';
      var txt  = (c.textContent||'').toLowerCase();
      var tokenHits = tokens.filter(t => txt.includes(t)).length;
      if ((htxt.includes('waste') && (htxt.includes('disposal') || htxt.includes('dump') || htxt.includes('dumpster'))) || tokenHits >= 2){
        return c;
      }
    }
    return null;
  }
  function hideWasteIfCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var card = findWasteCard();
    if (!card) return;
    card.style.display = isCleanup ? 'none' : '';
  }
  function scheduleHideWaste(){
    // Run now, then again on the next animation frame and a short timeout
    try { hideWasteIfCleanup(); } catch(e){}
    if (window.requestAnimationFrame){
      requestAnimationFrame(function(){ try { hideWasteIfCleanup(); } catch(e){} });
    }
    setTimeout(function(){ try { hideWasteIfCleanup(); } catch(e){} }, 30);
    setTimeout(function(){ try { hideWasteIfCleanup(); } catch(e){} }, 120);
  }

  document.addEventListener('DOMContentLoaded', function(){
    scheduleHideWaste();
    // Re-run when Cleanup is toggled or DOM is rebuilt
    var bodyObs = new MutationObserver(scheduleHideWaste);
    bodyObs.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    // Observe the main content region for rebuilds (cards added/removed)
    var main = document.querySelector('.wrap') || document.body;
    var treeObs = new MutationObserver(function(muts){
      // Only bother if we're currently in Cleanup
      if (document.body.getAttribute('data-active-group') === 'cleanup'){
        scheduleHideWaste();
      }
    });
    treeObs.observe(main, { childList:true, subtree:true });

    // Also hook the sections tablist interactions
    var tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', function(){ scheduleHideWaste(); }, true);
      tabs.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' ') scheduleHideWaste();
      }, true);
    }
  });
})();
</script>


<script>
(function(){
  // Also hide "Waste / Disposal" for the Stone Veneer tab (active group 'veneer').
  const HIDE_GROUPS = new Set(['cleanup','veneer']);
  function findWasteCard_v2(){
    // IDs first
    var ids = ['waste','disposal','dumpster','wasteCost','disposalCost','dumpsterCost','wasteDisposal','waste_disposal'];
    for (var i=0;i<ids.length;i++){
      var el = document.getElementById(ids[i]);
      if (el){ var card = el.closest('.card'); if (card) return card; }
    }
    // Fallback by header/text tokens
    var tokens = ['waste','disposal','dump','dumpster'];
    var cards = document.querySelectorAll('.wrap .card');
    for (var j=0;j<cards.length;j++){
      var c = cards[j];
      var hdr = c.querySelector('h1,h2,h3,.card-title');
      var htxt = hdr ? (hdr.textContent||'').toLowerCase() : '';
      var txt  = (c.textContent||'').toLowerCase();
      var tokenHits = tokens.filter(t => txt.includes(t)).length;
      if ((htxt.includes('waste') && (htxt.includes('disposal') || htxt.includes('dump') || htxt.includes('dumpster'))) || tokenHits >= 2){
        return c;
      }
    }
    return null;
  }
  function hideWasteIfInGroups(){
    var grp = document.body.getAttribute('data-active-group');
    var isHide = HIDE_GROUPS.has(grp);
    var card = findWasteCard_v2();
    if (!card) return;
    card.style.display = isHide ? 'none' : '';
  }
  function schedule(){
    try { hideWasteIfInGroups(); } catch(e){}
    if (window.requestAnimationFrame){
      requestAnimationFrame(function(){ try { hideWasteIfInGroups(); } catch(e){} });
    }
    setTimeout(function(){ try { hideWasteIfInGroups(); } catch(e){} }, 30);
    setTimeout(function(){ try { hideWasteIfInGroups(); } catch(e){} }, 120);
  }
  document.addEventListener('DOMContentLoaded', function(){
    schedule();
    var bodyObs = new MutationObserver(schedule);
    bodyObs.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    var main = document.querySelector('.wrap') || document.body;
    var treeObs = new MutationObserver(function(){
      if (HIDE_GROUPS.has(document.body.getAttribute('data-active-group'))) schedule();
    });
    treeObs.observe(main, { childList:true, subtree:true });
    var tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', schedule, true);
      tabs.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' ') schedule();
      }, true);
    }
  });
})();
</script>


<script>
(function(){
  const HIDE_GROUPS = new Set(['cleanup','veneer']);
  const TOKENS = ['waste','disposal','dump','dumpster'];

  function markWasteCards(root){
    root = root || document;
    const cards = root.querySelectorAll('.wrap .card');
    cards.forEach((c)=>{
      if (c.hasAttribute('data-card-waste')) return; // already marked
      const hdr = c.querySelector('h1,h2,h3,.card-title');
      const htxt = (hdr ? hdr.textContent : '').toLowerCase();
      const txt  = (c.textContent || '').toLowerCase();
      const tokenHits = TOKENS.filter(t => txt.includes(t)).length;
      const headerLooksRight = (htxt.includes('waste') && (htxt.includes('disposal') || htxt.includes('dump') || htxt.includes('dumpster')));
      if (headerLooksRight || tokenHits >= 2){
        c.setAttribute('data-card-waste','1');
      }
    });
  }

  function applyWasteHide(){
    const grp = document.body.getAttribute('data-active-group');
    const shouldHide = HIDE_GROUPS.has(grp);
    document.querySelectorAll('.wrap .card[data-card-waste]').forEach((c)=>{
      c.style.display = shouldHide ? 'none' : '';
    });
  }

  function schedule(){
    try { markWasteCards(); applyWasteHide(); } catch(e){}
    if (window.requestAnimationFrame){
      requestAnimationFrame(()=>{ try { markWasteCards(); applyWasteHide(); } catch(e){} });
    }
    setTimeout(()=>{ try { markWasteCards(); applyWasteHide(); } catch(e){} }, 30);
    setTimeout(()=>{ try { markWasteCards(); applyWasteHide(); } catch(e){} }, 120);
  }

  document.addEventListener('DOMContentLoaded', function(){
    schedule();
    const main = document.querySelector('.wrap') || document.body;
    // Observe subtree changes (cards rebuilt) and re-tag/re-hide
    const treeObs = new MutationObserver((muts)=>{
      let needs = false;
      for (const m of muts){
        if (m.addedNodes && m.addedNodes.length){
          needs = true; break;
        }
      }
      if (needs) schedule();
    });
    treeObs.observe(main, { childList:true, subtree:true });

    // Observe tab (active-group) changes
    const attrObs = new MutationObserver(schedule);
    attrObs.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });

    // Run on tab clicks/keys as well
    const tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', schedule, true);
      tabs.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') schedule(); }, true);
    }
  });
})();
</script>


<script>
(function(){
  function forceShowCrewOnCrewTab(){
    var grp = document.body.getAttribute('data-active-group');
    var isCrewTab = (grp === 'crew');
    var ids = ['crewCount','crewHours','crewRate'];
    var card = null;
    for (var i=0;i<ids.length && !card;i++){
      var el = document.getElementById(ids[i]);
      if (el) card = el.closest('.card');
    }
    if (card){
      card.style.display = isCrewTab ? '' : card.style.display;
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    forceShowCrewOnCrewTab();
    var mo = new MutationObserver(forceShowCrewOnCrewTab);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    var tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', forceShowCrewOnCrewTab, true);
      tabs.addEventListener('keydown', function(e){ if (e.key==='Enter' || e.key===' ') forceShowCrewOnCrewTab(); }, true);
    }
  });
})();
</script>


<script>
(function(){
  // Make the Crew & Time card resilient to tab hops and DOM rebuilds.
  const CREW_IDS = ['crewCount','crewHours','crewRate'];

  function findCrewCard(){
    // Prefer known inputs
    for (const id of CREW_IDS){
      const el = document.getElementById(id);
      if (el){
        const card = el.closest('.card');
        if (card) return card;
      }
    }
    // Fallback by header text
    const cards = document.querySelectorAll('.wrap .card');
    for (const c of cards){
      const hdr = c.querySelector('h1,h2,h3,.card-title');
      const t = (hdr ? hdr.textContent : c.textContent || '').toLowerCase();
      if (t.includes('crew') && t.includes('time')) return c;
    }
    return null;
  }

  function ensureCrewCardVisible(){
    const grp = document.body.getAttribute('data-active-group');
    const isCrewTab = (grp === 'crew');
    const card = findCrewCard();
    if (!card) return;

    // Mark it for CSS overrides too
    card.setAttribute('data-card-crew','1');

    if (isCrewTab){
      // Remove inline and attribute-based hides on card and ancestors
      const chain = [card, card.parentElement, card.parentElement && card.parentElement.parentElement].filter(Boolean);
      for (const el of chain){
        if (!el) continue;
        // Clear inline display/visibility/opacity
        if (el.style){
          el.style.removeProperty('display');
          el.style.removeProperty('visibility');
          el.style.removeProperty('opacity');
        }
        // Remove 'hidden' attribute if present
        if (el.hasAttribute && el.hasAttribute('hidden')) el.removeAttribute('hidden');
      }
    }
  }

  function scheduleCrewFix(){
    try { ensureCrewCardVisible(); } catch(e){}
    if (window.requestAnimationFrame){
      requestAnimationFrame(()=>{ try { ensureCrewCardVisible(); } catch(e){} });
    }
    setTimeout(()=>{ try { ensureCrewCardVisible(); } catch(e){} }, 30);
    setTimeout(()=>{ try { ensureCrewCardVisible(); } catch(e){} }, 120);
  }

  document.addEventListener('DOMContentLoaded', function(){
    scheduleCrewFix();
    // Watch for active-group changes and subtree rebuilds
    const attrObs = new MutationObserver(scheduleCrewFix);
    attrObs.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    const main = document.querySelector('.wrap') || document.body;
    const treeObs = new MutationObserver(()=>{
      if (document.body.getAttribute('data-active-group') === 'crew'){
        scheduleCrewFix();
      }
    });
    treeObs.observe(main, { childList:true, subtree:true });

    // Also respond to tab interactions
    const tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', scheduleCrewFix, true);
      tabs.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') scheduleCrewFix(); }, true);
    }
  });
})();
</script>


<script>
// === Silica Controls logic (clean version) ===
(function(){
  function byId(id){ return document.getElementById(id); }

  // --- Helpers ---
  function ensureDWVInModel(){
    if(!byId('sil_task_tuck') || !byId('sil_task_tuck').checked) return;
    if(!Array.isArray(window.materials)) return;
    var bag = materials.find(function(m){ return m.id==='mCOL_DWV9402'; });
    if(!bag) return;
    bag.use = true;
    if(!(Number(bag.qty)>0)) bag.qty = 1;
  }
  function ensureDWVInUI(){
    var row = document.querySelector('#matTbody tr[data-id="mCOL_DWV9402"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qty = row.querySelector('.mat_qty');
    if(cb && !cb.checked){ cb.checked = true; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qty && (Number(qty.value)||0) <= 0){
      qty.value = '1';
      qty.dispatchEvent(new Event('input', {bubbles:true}));
      qty.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }
  function removeDWVFromModel(){
    if(!Array.isArray(window.materials)) return;
    var bag = materials.find(function(m){ return m.id==='mCOL_DWV9402'; });
    if(!bag) return;
    bag.use = false; bag.qty = 0;
  }
  function removeDWVFromUI(){
    var row = document.querySelector('#matTbody tr[data-id="mCOL_DWV9402"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qty = row.querySelector('.mat_qty');
    if(cb && cb.checked){ cb.checked = false; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qty && (Number(qty.value)||0) > 0){
      qty.value = '0';
      qty.dispatchEvent(new Event('input', {bubbles:true}));
      qty.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }

  function ensureBladeInModel(){
    if(!byId('sil_task_grind') || !byId('sil_task_grind').checked) return;
    if(!Array.isArray(window.materials)) return;
    var blade = materials.find(function(m){ return m.id==='mCOL_DT5_TP_4_5'; });
    if(!blade) return;
    blade.use = true;
    if(!(Number(blade.qty)>0)) blade.qty = 1;
  }
  function ensureBladeInUI(){
    var row = document.querySelector('#matTbody tr[data-id="mCOL_DT5_TP_4_5"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qty = row.querySelector('.mat_qty');
    if(cb && !cb.checked){ cb.checked = true; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qty && (Number(qty.value)||0) <= 0){
      qty.value = '1';
      qty.dispatchEvent(new Event('input', {bubbles:true}));
      qty.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }
  function removeBladeFromModel(){
    if(!Array.isArray(window.materials)) return;
    var blade = materials.find(function(m){ return m.id==='mCOL_DT5_TP_4_5'; });
    if(!blade) return;
    blade.use = false; blade.qty = 0;
  }
  function removeBladeFromUI(){
    var row = document.querySelector('#matTbody tr[data-id="mCOL_DT5_TP_4_5"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qty = row.querySelector('.mat_qty');
    if(cb && cb.checked){ cb.checked = false; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qty && (Number(qty.value)||0) > 0){
      qty.value = '0';
      qty.dispatchEvent(new Event('input', {bubbles:true}));
      qty.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }

  // Tools Depreciation toggles
  function ensureDWV010InModel(){ if(byId('sil_task_tuck') && byId('sil_task_tuck').checked && Array.isArray(window.tools)){ var t=tools.find(function(x){return x.id==='t11';}); if(t) t.use=true; } }
  function ensureDWV010InUI(){ var r=document.querySelector('#toolTbody tr[data-id="t11"]'); if(!r) return; var cb=r.querySelector('.t_use'); if(cb && !cb.checked){ cb.checked=true; cb.dispatchEvent(new Event('change',{bubbles:true})); } r.classList.remove('fade'); }
  function removeDWV010FromModel(){ if(Array.isArray(window.tools)){ var t=tools.find(function(x){return x.id==='t11';}); if(t) t.use=false; } }
  function removeDWV010FromUI(){ var r=document.querySelector('#toolTbody tr[data-id="t11"]'); if(!r) return; var cb=r.querySelector('.t_use'); if(cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); } r.classList.add('fade'); }

  function ensureDWE46202InModel(){ if(byId('sil_task_grind') && byId('sil_task_grind').checked && Array.isArray(window.tools)){ var t=tools.find(function(x){return x.id==='t10';}); if(t) t.use=true; } }
  function ensureDWE46202InUI(){ var r=document.querySelector('#toolTbody tr[data-id="t10"]'); if(!r) return; var cb=r.querySelector('.t_use'); if(cb && !cb.checked){ cb.checked=true; cb.dispatchEvent(new Event('change',{bubbles:true})); } r.classList.remove('fade'); }
  function removeDWE46202FromModel(){ if(Array.isArray(window.tools)){ var t=tools.find(function(x){return x.id==='t10';}); if(t) t.use=false; } }
  function removeDWE46202FromUI(){ var r=document.querySelector('#toolTbody tr[data-id="t10"]'); if(!r) return; var cb=r.querySelector('.t_use'); if(cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); } r.classList.add('fade'); }

  // Masks (3M 8511)
  function silicaAnyOn(){ var t=byId('sil_task_tuck'), g=byId('sil_task_grind'); return !!((t&&t.checked)||(g&&g.checked)); }
  function calcMaskQty(){
    if(!silicaAnyOn()) return 0;
    var HOURS = (typeof HOURS_PER_DAY!=='undefined' && HOURS_PER_DAY) ? HOURS_PER_DAY : 8;
    var daysMode = (typeof crewDaysMode!=='undefined') ? crewDaysMode : !!(byId('timeUnitsDays') && byId('timeUnitsDays').checked);
    var crewWide = (typeof crewWideOn!=='undefined') ? crewWideOn : !!(byId('crewWideToggle') && byId('crewWideToggle').checked);
    var qEl = byId('crewWideQty'); var q = Number(qEl && qEl.value || 0) || 0;
    var used = Array.isArray(window.crew) ? crew.filter(function(w){ return w && w.use && w.role!=='company' && w.role!=='owner'; }) : [];
    if(crewWide){
      var hours = daysMode ? q*HOURS : q;
      var days = Math.ceil((Number(hours)||0)/HOURS);
      return (used.length||0) * (days||0);
    }else{
      var total=0;
      used.forEach(function(w){ var hours=Number(w.hrs)||0; var days=Math.ceil(hours/HOURS); total+=days; });
      return total;
    }
  }
  function ensureMaskInModel(){
    try{
      if(typeof materials==='undefined') return;
      var m = materials.find(function(x){ return x.id==='mHD_3M_8511'; });
      if(!m) return;
      var qty = calcMaskQty();
      if(!(qty>0)) qty = 1; // default to 1 like bags/blade
      m.use = true;
      m.qty = qty;
    }catch(e){}
  }
  function ensureMaskInUI(){
    try{
      var row = document.querySelector('#matTbody tr[data-id="mHD_3M_8511"]');
      if(!row) return;
      var cb = row.querySelector('.mat_use');
      var qtyEl = row.querySelector('.mat_qty');
      var qty = calcMaskQty();
      if(!(qty>0)) qty = 1; // default to 1 like bags/blade
      if(cb && !cb.checked){ cb.checked = true; try{ cb.dispatchEvent(new Event('change', {bubbles:true})); }catch(e){} }
      if(qtyEl){
        qtyEl.value = String(qty);
        try{ qtyEl.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
        try{ qtyEl.dispatchEvent(new Event('change', {bubbles:true})); }catch(e){}
      }
    }catch(e){}
  }
  function removeMaskFromModel(){
    if(!Array.isArray(window.materials)) return;
    var m = materials.find(function(x){ return x.id==='mHD_3M_8511'; });
    if(!m) return;
    m.use = false; m.qty = 0;
  }
  function removeMaskFromUI(){
    var row = document.querySelector('#matTbody tr[data-id="mHD_3M_8511"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qtyEl = row.querySelector('.mat_qty');
    if(cb && cb.checked){ cb.checked = false; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qtyEl && (Number(qtyEl.value)||0) > 0){
      qtyEl.value = '0';
      qtyEl.dispatchEvent(new Event('input', {bubbles:true}));
      qtyEl.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }

  function applySilicaLinks(){
    var tuckOn = byId('sil_task_tuck') && byId('sil_task_tuck').checked;
    var grindOn = byId('sil_task_grind') && byId('sil_task_grind').checked;

    // Model
    if(tuckOn){ ensureDWVInModel(); ensureDWV010InModel(); } else { removeDWVFromModel(); removeDWV010FromModel(); }
    if(grindOn){ ensureBladeInModel(); ensureDWE46202InModel(); } else { removeBladeFromModel(); removeDWE46202FromModel(); }
    if(!tuckOn && !grindOn){ removeMaskFromModel(); } else { ensureMaskInModel(); }

    if(typeof renderMaterials==='function'){ renderMaterials(); }
    requestAnimationFrame(function(){
      if(tuckOn){ ensureDWVInUI(); ensureDWV010InUI(); } else { removeDWVFromUI(); removeDWV010FromUI(); }
      if(grindOn){ ensureBladeInUI(); ensureDWE46202InUI(); } else { removeBladeFromUI(); removeDWE46202FromUI(); }
      if(!tuckOn && !grindOn){ removeMaskFromUI(); } else { ensureMaskInUI(); }
      if(typeof totals==='function'){ totals(); }
    });
  }

  // Listeners
  document.addEventListener('change', function(ev){
    var id = ev && ev.target && ev.target.id;
    if(id==='sil_task_tuck' || id==='sil_task_grind' || id==='crewWideToggle' || id==='timeUnitsDays'){ applySilicaLinks(); }
  }, true);
  document.addEventListener('input', function(ev){
    if(ev.target && (ev.target.closest && ev.target.closest('#crewTbody'))) applySilicaLinks();
    if(ev.target && ev.target.id==='crewWideQty') applySilicaLinks();
  }, true);

  // Initial
  applySilicaLinks();
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('wasteAdd');
  if(!btn) return;
  btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
      if (typeof renderWaste === 'function') renderWaste();
      else if (typeof updateAll === 'function') updateAll();
    }catch(e){ console.warn(e); }
  });
});
</script><script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    var tbody = document.getElementById('matTbody');
    var tablist = document.getElementById('sections-tablist');
    if(!tbody || !tablist) return;
    /* legacy groups removed */
    function activeGroup(){
      var tablist = document.getElementById('sections-tablist');
      var active = tablist && tablist.querySelector('[role="tab"][aria-selected="true"]');
      var g = active ? (active.getAttribute('data-group')||'all') : 'all';
      if(!(window.SECTION && Object.prototype.hasOwnProperty.call(SECTION, g))) g = 'all';
      return g;
    }
    
    function applyMaterialsFilter(){
      var g = activeGroup();
      var cfg = SECTION[g] || {};
      var cats = cfg.cats || null;
      var pins = cfg.pins || null;
      tbody.querySelectorAll('tr').forEach(function(tr){
        var id = tr.dataset.id || '';
        var rowCats = (tr.getAttribute('data-cats')||'').split(',').map(function(s){return s.trim();});
        var matchCats = !cats || rowCats.some(function(c){ return cats.indexOf(c) !== -1; });
        var matchPins = !!(pins && pins.has(id));
        tr.style.display = (matchCats || matchPins) ? '' : 'none';
      });
    }
    tablist.addEventListener('click', function(){ setTimeout(applyMaterialsFilter, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(applyMaterialsFilter,0); });
    new MutationObserver(function(){ applyMaterialsFilter(); }).observe(tbody, {childList:true});
    applyMaterialsFilter();
  }catch(e){ console.warn('materials filter disabled:', e); }
});
</script><script>
// Hide Waste / Disposal ONLY when Concrete tab is active (safe, no math touched)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findWasteCard(){
    var cards = Array.from(document.querySelectorAll('.wrap > .card'));
    return cards.find(function(card){
      var h3 = card.querySelector('h3');
      return h3 && /waste\s*\/\s*disposal/i.test(h3.textContent);
    });
  }
  function enforceConcreteHidesWaste(){
    try{
      var g = activeGroup();
      var waste = findWasteCard();
      if(!waste) return;
      if(g === 'concrete'){
        waste.classList.add('group-hidden');
        waste.style.display = 'none';
      }else{
        waste.classList.remove('group-hidden');
        waste.style.display = '';
      }
    }catch(e){ console.warn('concrete->hide waste patch:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceConcreteHidesWaste, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceConcreteHidesWaste,0); });
  }
  // run once on load
  enforceConcreteHidesWaste();
});
</script><script>
// Hide Waste / Disposal when Crew & Time tab is active (safe, isolated)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findWasteCard(){
    var cards = Array.from(document.querySelectorAll('.wrap > .card'));
    return cards.find(function(card){
      var h3 = card.querySelector('h3');
      return h3 && /waste\s*\/\s*disposal/i.test(h3.textContent);
    });
  }
  function enforceCrewHidesWaste(){
    try{
      var g = activeGroup();
      var waste = findWasteCard();
      if(!waste) return;
      if(g === 'crew'){
        waste.classList.add('group-hidden');
        waste.style.display = 'none';
      }else{
        // do not change visibility for other groups here—other patches handle them
        if(g !== 'concrete'){ waste.classList.remove('group-hidden'); waste.style.display = ''; }
      }
    }catch(e){ console.warn('crew->hide waste patch:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceCrewHidesWaste, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceCrewHidesWaste,0); });
  }
  enforceCrewHidesWaste();
});
</script><script>
// Central controller: hide Waste / Disposal on Concrete, Crew & Time, and Masonry tabs only
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findWasteCard(){
    var cards = Array.from(document.querySelectorAll('.wrap > .card'));
    return cards.find(function(card){
      var h3 = card.querySelector('h3');
      return h3 && /waste\s*\/\s*disposal/i.test(h3.textContent);
    });
  }
  function enforceWasteVisibility(){
    try{
      var g = activeGroup();
      var waste = findWasteCard();
      if(!waste) return;
      var hideOn = new Set(['concrete','crew','masonry','pavers','fuel']);
      if(hideOn.has(g)){
        waste.classList.add('group-hidden');
        waste.style.display = 'none';
      }else{
        waste.classList.remove('group-hidden');
        waste.style.display = '';
      }
    }catch(e){ console.warn('waste visibility controller:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceWasteVisibility, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceWasteVisibility,0); });
  }
  // run on load
  enforceWasteVisibility();
});
</script><script>
// ID: fuel-hide-materials-v1 — Hide Materials only on the Fuel tab (safe & isolated)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findMaterialsCard(){
    var t = document.querySelector('.wrap > .card #matTbody');
    return t ? t.closest('.card') : null;
  }
  function enforceMaterialsOnFuel(){
    try{
      var g = activeGroup();
      var mat = findMaterialsCard();
      if(!mat) return;
      if(g === 'fuel'){
        mat.classList.add('group-hidden');
        mat.style.display = 'none';
      }else{
        mat.classList.remove('group-hidden');
        mat.style.display = '';
      }
    }catch(e){ console.warn('materials visibility on fuel tab:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceMaterialsOnFuel, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceMaterialsOnFuel,0); });
  }
  enforceMaterialsOnFuel();
});
</script><script>
// ID: waste-hide-materials-v1 — Hide Materials ONLY on the Waste / Disposal tab (safe & isolated)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findMaterialsCard(){
    var t = document.querySelector('.wrap > .card #matTbody');
    return t ? t.closest('.card') : null;
  }
  function enforceMaterialsOnWaste(){
    try{
      var g = activeGroup();
      var mat = findMaterialsCard();
      if(!mat) return;
      if(g === 'waste' || g === 'disposal'){
        mat.classList.add('group-hidden');
        mat.style.display = 'none';
      }else{
        mat.classList.remove('group-hidden');
        mat.style.display = '';
      }
    }catch(e){ console.warn('materials visibility on waste tab:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceMaterialsOnWaste, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceMaterialsOnWaste,0); });
  }
  enforceMaterialsOnWaste();
});
</script><script>
// ID: crew-hide-materials-v1 — Hide Materials ONLY on the Crew & Time tab (safe & isolated)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findMaterialsCard(){
    var t = document.querySelector('.wrap > .card #matTbody');
    return t ? t.closest('.card') : null;
  }
  function enforceMaterialsOnCrew(){
    try{
      var g = activeGroup();
      var mat = findMaterialsCard();
      if(!mat) return;
      if(g === 'crew'){
        mat.classList.add('group-hidden');
        mat.style.display = 'none';
      }else{
        mat.classList.remove('group-hidden');
        mat.style.display = '';
      }
    }catch(e){ console.warn('materials visibility on crew tab:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceMaterialsOnCrew, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceMaterialsOnCrew,0); });
  }
  enforceMaterialsOnCrew();
});
</script><script 
// Ensures Materials is hidden on Waste / Disposal, Crew & Time, and Fuel tabs
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findMaterialsCard(){
    var t = document.querySelector('.wrap > .card #matTbody');
    return t ? t.closest('.card') : null;
  }
  function applyOnce(){
    try {
      var g = activeGroup();
      var mat = findMaterialsCard();
      if(!mat) return;
      var hideOn = new Set(['waste','disposal','crew','fuel']);
      if(hideOn.has(g)){
        mat.classList.add('group-hidden');
        mat.style.display = 'none';
      } else {
        mat.classList.remove('group-hidden');
        mat.style.display = '';
      }
    } catch(e){ console.warn('materials-hide-master error', e); }
  }
  function enforce(){
    // run a few times to win over any other late scripts
    applyOnce();
    setTimeout(applyOnce, 10);
    setTimeout(applyOnce, 60);
    requestAnimationFrame(applyOnce);
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforce, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforce,0); });
  }
  enforce();
});
</script><script 
document.addEventListener('DOMContentLoaded', function(){
  function recalcPump(){
    try{ if(window.mohicanValley) mohicanValley(); } catch(e){}
    try{ if(window.totals) totals(); } catch(e){}
    try{ if(window.updateAll) updateAll(); } catch(e){}
  }
  // Capture phase to catch dynamically inserted controls too
  ['change','input'].forEach(function(type){
    document.addEventListener(type, function(e){
      var id = e.target && e.target.id;
      if(id==='pump_use' || id==='pump_size' || id==='pump_hours' || id==='mv_apply_pump'){
        recalcPump();
      }
    }, true);
  });
});
</script>

<script>
// Manual Crew & Days boxes: store simple numbers you type (no auto-counting)
(function(){
  function bindPersist(id, key, defVal){
    var el = document.getElementById(id);
    if(!el) return;
    try{
      var saved = sessionStorage.getItem(key);
      if(saved !== null && saved !== ''){
        el.value = saved;
      }else if(!el.value){
        el.value = String(defVal);
      }
    }catch(e){
      if(!el.value) el.value = String(defVal);
    }
    el.addEventListener('input', function(){
      try{ sessionStorage.setItem(key, el.value || ''); }catch(e){}
    }, false);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      bindPersist('crewManual','tm_manual_crew',3);
      bindPersist('daysManual','tm_manual_days',1);
    }, {once:true});
  } else {
    bindPersist('crewManual','tm_manual_crew',3);
    bindPersist('daysManual','tm_manual_days',1);
  }
})();
</script>


<script>
// === Turcotte: Crew × Days → 3M 8511 Qty (only when silica tasks are checked) ===
(function(){
  function byId(id){ return document.getElementById(id); }
  function silicaOn(){
    var t = byId('sil_task_tuck'), g = byId('sil_task_grind');
    return !!((t && t.checked) || (g && g.checked));
  }
  function getCrew(){ var v = Number(byId('crewManual')?.value || 0); return Math.max(0, Math.floor(v)); }
  function getDays(){ var v = Number(byId('daysManual')?.value || 0); return Math.max(0, Math.floor(v)); }

  function set8511Qty(qty){
    // Ensure materials are rendered (in case silica auto-add just ran)
    try{ if(typeof renderMaterials==='function') renderMaterials(); }catch(e){}
    var row = document.querySelector('#matTbody tr[data-id="mHD_3M_8511"]');
    if(!row){ return; } // bail if row truly doesn't exist
    var useEl = row.querySelector('.mat_use');
    if(useEl && !useEl.checked){ try{ useEl.checked = true; useEl.dispatchEvent(new Event('change',{bubbles:true})); }catch(e){} }
    var qtyEl = row.querySelector('.mat_qty');
    if(!qtyEl) return;
    qtyEl.value = String(qty);
    try{ qtyEl.setAttribute('title','Auto: Crew('+getCrew()+') × Days('+getDays()+') = '+qty); }catch(e){}
    try{ qtyEl.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
    try{ qtyEl.dispatchEvent(new Event('change', {bubbles:true})); }catch(e){}
    try{ if(typeof totals==='function') totals(); }catch(e){}
  }

  function updateMaskQty(){
    if(!silicaOn()) return; // only act when silica tasks are checked
    var crew = getCrew(), days = getDays();
    var qty = (crew||0) * (days||0);
    if(qty>0){
      // two rAF ticks to let silica auto-add finish, then set
      requestAnimationFrame(function(){ requestAnimationFrame(function(){ set8511Qty(qty); }); });
    }
  }

  // Wire events
  ['crewManual','daysManual','sil_task_tuck','sil_task_grind'].forEach(function(id){
    var el = byId(id);
    if(!el) return;
    var ev = (id==='crewManual' || id==='daysManual') ? 'input' : 'change';
    el.addEventListener(ev, updateMaskQty, false);
  });

  // Initial pass in case silica already on
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', updateMaskQty, {once:true});
  } else {
    updateMaskQty();
  }
})();
</script>


<script>
// Seed common Block Wall materials if missing (id check-safe)
(function(){
  try{
    if(!Array.isArray(materials)) return;
    const addIfMissing = (row)=>{
      if(!materials.some(m=>m.id===row.id)) materials.push(row);
    };
    // Core CMU sizes
    addIfMissing({id:'bw_cmu6_std', use:false, item:'CMU 6x8x16 (Std)', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu8_std', use:false, item:'CMU 8x8x16 (Std)', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu10_std',use:false, item:'CMU 10x8x16 (Std)', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu12_std',use:false, item:'CMU 12x8x16 (Std)', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    // Specials
    addIfMissing({id:'bw_cmu8_open', use:false, item:'CMU 8x8x16 Open-End', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu8_bond', use:false, item:'CMU 8x8x16 Bond Beam', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu4_half', use:false, item:'CMU 4x8x16 Half-High', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    // Brick cap option
    addIfMissing({id:'bw_brick_mod', use:false, item:'Brick (Modular) — cap/soldier', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    // Mortar & grout
    addIfMissing({id:'bw_specmix_s_80', use:false, item:'SPEC MIX Type S — 80 lb', supplier:'', units:'bag', price:0, qty:0, cats:['masonry','stucco']});
    addIfMissing({id:'bw_grout_fine_80', use:false, item:'Core-Fill Grout Fine — 80 lb', supplier:'QUIKRETE', units:'bag', price:0, qty:0, cats:['masonry']});
    addIfMissing({id:'bw_grout_coarse_80', use:false, item:'Core-Fill Grout Coarse — 80 lb', supplier:'QUIKRETE', units:'bag', price:0, qty:0, cats:['masonry']});
    // Reinforcement & ties
    addIfMissing({id:'bw_durawall_9x10', use:false, item:'Dur-O-Wall 9" — 10\' (joint reinforcement)', supplier:'', units:'each', price:0, qty:0, cats:['masonry']});
    addIfMissing({id:'bw_wall_ties', use:false, item:'Wall ties (box)', supplier:'', units:'box', price:0, qty:0, cats:['masonry']});
    addIfMissing({id:'bw_rebar4_20', use:false, item:'#4 rebar — 20\'', supplier:'', units:'each', price:0, qty:0, cats:['masonry','concrete']});
    addIfMissing({id:'bw_rebar5_20', use:false, item:'#5 rebar — 20\'', supplier:'', units:'each', price:0, qty:0, cats:['masonry','concrete']});
    // Concrete for footing
    addIfMissing({id:'bw_conc_yd', use:false, item:'Concrete (footing) — yd³', supplier:'', units:'yd³', price:0, qty:0, step:0.1, cats:['concrete']});
    // Cleanouts & misc
    addIfMissing({id:'bw_cleanout', use:false, item:'Cleanout ties/plugs (allowance)', supplier:'', units:'each', price:0, qty:0, cats:['masonry']});
    // Re-render to show newly seeded rows if Materials card is visible
    if(typeof renderMaterials==='function') renderMaterials();
  }catch(e){}
})();
</script>



<script id="__tm_hide_jobinfo_cleanup__">
(function(){
  function markQuickGroups(){
    // Tag likely Quick Groups containers so CSS can hide them reliably
    var tags = [];
    // 1) .groupbar containers
    document.querySelectorAll('.groupbar').forEach(function(el){ if (!el.hasAttribute('>



<script id="__tm_qg_shell_cleanup__">
document.addEventListener('DOMContentLoaded', function(){
  function killEmptyShells(){
    var selectors = [
      '.groupbar',
      '[data-quick-groups]',
      '.row',
      '.chip,.pill,.badge,.tag'
    ];
    var toCheck = [];
    selectors.forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){ toCheck.push(el); });
    });
    toCheck.forEach(function(el){
      try {
        if (el.querySelector('button, input, select, textarea, a, [role="button"], [role="tab"], [role="toolbar"]')) return;
        var txt = (el.textContent || '').replace(/\s+/g,'').trim();
        if (txt.length === 0) {
          if (el.children.length <= 1) {
            el.remove();
          }
        }
      } catch(e){}
    });
  }
  killEmptyShells();
  setTimeout(killEmptyShells, 250);
  var mo = new MutationObserver(function(){ killEmptyShells(); });
  mo.observe(document.body, { childList:true, subtree:true });
});
</script>


<script id="__tm_kill_empty_pills_strict__">
(function(){
  function isEmptyText(s){
    if (!s) return true;
    // Normalize whitespace including NBSP \u00A0 and zero-width
    s = s.replace(/[\s\u00A0\u200B\u200C\u200D\uFEFF]+/g,'').trim();
    return s.length === 0;
  }
  function killEmptyPills(){
    var selectors = [
      '.tag', '.pill', '.badge', '.chip',
      '[class*=" tag"]', '[class*="pill"]', '[class*="badge"]', '[class*="chip"]',
      '[class*="Group"]', '[class*="group"]'
    ];
    var seen = new Set();
    selectors.forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){
        if (seen.has(el)) return;
        var txt = (el.innerText||'') + (el.getAttribute('aria-label')||'');
        if (isEmptyText(txt)){
          var role = (el.getAttribute('role')||'').toLowerCase();
          if (role && (role==='tab' || role==='button' || role==='toolbar')) return;
          if (el.querySelector('button,input,select,textarea,a,[role="button"],[role="tab"],[role="toolbar"]')) return;
          el.remove();
          seen.add(el);
          var p = el.parentElement;
          if (p && isEmptyText(p.innerText) && p.children.length === 0){
            p.remove();
          }
        }
      });
    });
  }
  function boot(){
    killEmptyPills();
    setTimeout(killEmptyPills, 300);
    setTimeout(killEmptyPills, 1200);
    var mo = new MutationObserver(function(){ killEmptyPills(); });
    mo.observe(document.body, { childList:true, subtree:true });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>


<script id="__tm_kill_top_empty_bubble__">
(function(){
  function isControl(el){
    return !!el.querySelector('button,input,select,textarea,a,[role="button"],[role="tab"],[role="toolbar"]');
  }
  function emptyish(s){
    if (!s) return true;
    s = s.replace(/[\s\u00A0\u200B\u200C\u200D\uFEFF]+/g,'').trim();
    return s.length === 0;
  }
  function looksLikeBubble(el){
    if (!el || !el.classList) return false;
    var cls = Array.from(el.classList).join(' ').toLowerCase();
    // Typical "bubble" wrappers we use
    var hit = /(row|pill|chip|badge|tag|groupbar|bubble)/.test(cls);
    // Also check attributes
    if (!hit){
      var role = (el.getAttribute('role')||'').toLowerCase();
      if (role === 'toolbar' || role === 'tablist') hit = true;
    }
    return hit;
  }
  function killTopEmptyBubble(){
    var wrap = document.querySelector('.wrap');
    if (!wrap) return;
    // Find the main title (first H1/H2/H3)
    var title = wrap.querySelector('h1, h2, h3');
    if (!title) return;
    // Walk previous siblings from the title upward and remove empty bubble-like elements
    var node = title.previousElementSibling;
    var removed = false;
    while (node){
      if (looksLikeBubble(node)){
        var txt = node.textContent || '';
        if (emptyish(txt) && !isControl(node)){
          var prev = node.previousElementSibling;
          node.remove();
          node = prev;
          removed = true;
          continue;
        }
      }
      // Stop once we hit a non-bubble element
      break;
    }
    return removed;
  }
  function boot(){
    killTopEmptyBubble();
    // After layout stabilization
    setTimeout(killTopEmptyBubble, 200);
    setTimeout(killTopEmptyBubble, 800);
    // Watch for future DOM mutations
    var mo = new MutationObserver(function(){ killTopEmptyBubble(); });
    mo.observe(document.body, { childList:true, subtree:true });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  function reevaluate(){ try{ if(typeof window.stuccoCalc==='function') window.stuccoCalc(); else if(typeof calc==='function') calc(); } catch(e){} }
  document.getElementById('stu_finish_sel')?.addEventListener('change', reevaluate);
  document.getElementById('stu_finish_yield')?.addEventListener('input', function(){ const cb=document.getElementById('stu_finish_use_mat'); if(cb) cb.checked=false; reevaluate(); });
  document.getElementById('stu_finish_use_mat')?.addEventListener('change', reevaluate);
  document.getElementById('stu_foam_sel')?.addEventListener('change', reevaluate);
  reevaluate();
});
</script>


<script id="move-status-into-sticky">
(function(){
  function q(sel,root){ return (root||document).querySelector(sel); }
  var stickyInner = q('.sticky-inner');
  if(!stickyInner) return;
  // Find the top-of-body banner (sticky header div)
  var topBanner = document.body.querySelector(':scope > div[style*="position:sticky"][style*="top:0"]');
  if(!topBanner) return;
  // Clean inline styles and retag
  topBanner.removeAttribute('style');
  topBanner.id = 'stickyStatusPill';
  topBanner.className = 'pill ok'; // keep the green "ok" styling
  topBanner.style.fontSize = '12px';
  topBanner.style.opacity = '0.95';
  // Insert as first child => left edge (space-between pushes GRAND to right)
  stickyInner.insertBefore(topBanner, stickyInner.firstChild);
})();
</script>




<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const num = (v)=>{ const n = parseFloat(v); return isFinite(n)?n:0; };
  const feetIn = (ft,inches)=> num(ft)*12 + num(inches);
  const fmt = (n, d=2)=> (Math.round(n*Math.pow(10,d))/Math.pow(10,d)).toFixed(d);

  function getMode(){ return $('#mode_brick').checked ? 'brick' : 'inch'; }
  function wastePct(){ return getMode()==='inch' ? num($('#waste').value) : num($('#waste_b').value); }
  function heightIn(){ 
    if (getMode()==='inch') return feetIn($('#h_ft').value, $('#h_in').value);
    return feetIn($('#h_ft_b').value, $('#h_in_b').value);
  }

  function dimsFromBrick(){
    const A = Math.max(1, num($('#brixA').value));
    const B = Math.max(1, num($('#brixB').value));
    const len = num($('#b_len').value);
    const joint = num($('#joint').value);
    const nominal = len + joint;
    const width = A * nominal;
    const depth = B * nominal;
    return {width, depth, perCourse: 2*(A+B), courseH: (num($('#b_hgt').value) + joint)};
  }

  function dimsFromInches(){
    return {width: num($('#w_in').value), depth: num($('#d_in').value), perCourse: null, courseH: (2.25+0.375)};
  }

  function tilesPerFlue(){
    const auto = $('#auto_tiles').checked;
    const hIn = heightIn();
    const crown = $('#opt_crown').checked ? num($('#crown_thk').value) : 0;
    let proj = Math.max(0, num($('#proj_in').value));
    if ($('#no_cap').checked && proj < 4){ proj = 4; $('#proj_in').value = 4; }
    let tileLen = num($('#tile_len').value);
    if (auto){ tileLen = Math.max(12, tileLen||24); }
    const required = hIn + crown + proj;
    const per = tileLen>0 ? Math.ceil(required / tileLen) : 0;
    return {per, tileLen, proj, required};
  }

  function calc(){
    const mode = getMode();
    let width, depth, perCourse, courseH;
    if (mode==='brick'){
      const d = dimsFromBrick();
      width=d.width; depth=d.depth; perCourse=d.perCourse; courseH=d.courseH;
      $('#geomNote').textContent = 'Derived from brick count: width ≈ '+fmt(width,2)+'", depth ≈ '+fmt(depth,2)+'".';
    } else {
      const d = dimsFromInches();
      width=d.width; depth=d.depth; perCourse=d.perCourse; courseH=d.courseH;
      $('#geomNote').textContent = '';
    }

    const hIn = heightIn();
    const waste = wastePct()/100;

    // Courses & face area
    const courses = courseH>0 ? Math.ceil(hIn / courseH) : 0;
    const facePerimIn = 2*(width+depth);
    const faceAreaSF = (facePerimIn/12) * (hIn/12);

    // Brick count
    let bricks = 0;
    if (mode==='brick'){ bricks = perCourse * courses; }
    else { bricks = faceAreaSF * parseFloat($('#bpsf').value); }
    const bricksFinal = Math.ceil(bricks * (1 + waste));

    // Mortar bags (Type S 80 lb) based on ~37 modular brick per bag
    const mortarFinal = Math.ceil(bricksFinal / 37);

    // Flue tiles (total to purchase, includes #flues and waste)
    const {per: perFlue, tileLen, proj, required} = tilesPerFlue();
    const flues = 1;
    const flueTotal = Math.ceil(perFlue * flues * (1+waste));

    // Crown concrete volume & bags (80 lb ~0.60 ft³)
    let crownVolFt3 = 0, crownBags = 0;
    if ($('#opt_crown').checked){
      const oh = Math.max(0, num($('#crown_oh').value));
      const thk = Math.max(0, num($('#crown_thk').value));
      const planW = width + 2*oh;
      const planD = depth + 2*oh;
      crownVolFt3 = (planW/12) * (planD/12) * (thk/12);
      crownBags = Math.ceil(crownVolFt3 / 0.60);
    }

    // Flashing LF & copper sheet area
    let flashLF = 0, copperSF = 0;
    if ($('#opt_flash').checked){
      flashLF = (2*(width+depth))/12;
      const flashH = Math.max(0, num($('#flash_h').value));
      copperSF = ( (2*(width+depth)) * flashH ) / 144;
    }

    const cricketRequired = (width > 30);

    // KPI pills (single flue number)
    const k = $('#kpis'); k.innerHTML = '';
    const makePill = (txt)=>{ const s=document.createElement('div'); s.className='kpi'; s.textContent=txt; k.appendChild(s); };
    makePill('Bricks: ' + bricksFinal);
    makePill('Mortar 80‑lb bags: ' + mortarFinal);
    makePill('flue: ' + flueTotal);
    if ($('#opt_crown').checked) makePill('Crown 80‑lb bags: ' + crownBags);
    if ($('#opt_flash').checked) { makePill('Flashing LF: ' + flashLF.toFixed(1)); makePill('Copper est. ft²: ' + copperSF.toFixed(1)); }
    makePill('Courses: ' + courses);
    makePill('Chimney width: ' + width.toFixed(1) + ' in');
    makePill(cricketRequired ? 'Cricket required by code' : 'Cricket not required');

    // Calc details
    $('#calcOut').innerHTML =
      '<div><b>Face area</b>: '+faceAreaSF.toFixed(2)+' sf</div>' +
      '<div><b>Perimeter</b>: '+(facePerimIn/12).toFixed(2)+' lf</div>' +
      '<div><b>Required flue height (in)</b>: '+required.toFixed(1)+' (rebuild '+hIn.toFixed(1)+' + crown '+( $('#opt_crown').checked ? num($('#crown_thk').value).toFixed(1) : 0 )+' + projection '+(Math.max(0, num($('#proj_in').value))).toFixed(1)+')</div>';

    // Scope text
    const flueLabel = $('#flue_size').value;
    const scope = [];
    scope.push('Rebuild chimney above roofline to ~' + (hIn/12).toFixed(2) + ' ft (running bond).');
    scope.push('Furnish & lay ≈ ' + bricksFinal + ' modular brick (includes ' + (waste*100).toFixed(1) + '% waste).');
    scope.push('Mortar: ≈ ' + mortarFinal + ' bags (80‑lb Type S).');
    if (flueTotal>0) scope.push('Flue liners: ' + flueTotal + ' pcs @ ' + flueLabel + ' × ' + num($('#tile_len').value).toFixed(0) + '" total (includes waste).');
    if ($('#opt_crown').checked) scope.push('Cast concrete crown, avg ' + num($('#crown_thk').value).toFixed(1) + '", with bond break at flue.');
    if ($('#opt_flash').checked) scope.push('Step & counter‑flash with 16‑oz copper (~' + flashLF.toFixed(1) + ' LF).');
    if (cricketRequired) scope.push('Provide & flash a metal cricket (chimney width > 30").');
    $('#scope').value = scope.join('\n');
  }

  function bind(){
    // Toggle modes
    $('#mode_inches').addEventListener('change', ()=>{
      $('#byInches').style.display = 'grid';
      $('#byBrick').style.display = 'none';
      calc();
    });
    $('#mode_brick').addEventListener('change', ()=>{
      $('#byInches').style.display = 'none';
      $('#byBrick').style.display = 'grid';
      calc();
    });

    // Brick preset
    $('#brickPreset') && $('#brickPreset').addEventListener('change', (e)=>{
      const v = e.target.value;
      if (v==='mod'){ $('#b_len').value = 7.625; $('#b_hgt').value = 2.25; }
      else if (v==='util'){ $('#b_len').value = 11.625; $('#b_hgt').value = 2.25; }
      document.getElementById('b_len').disabled = (v!=='custom');
      document.getElementById('b_hgt').disabled = (v!=='custom');
      calc();
    });

    // Auto tiles & cap toggle
    $('#auto_tiles').addEventListener('change', calc);
    $('#no_cap').addEventListener('change', calc);
    $('#proj_in').addEventListener('input', calc);

    // Global listeners
    document.querySelectorAll('input,select,textarea').forEach(el=>{
      el.addEventListener('input', calc);
      el.addEventListener('change', calc);
    });

    // Copy scope
    $('#copyScope').addEventListener('click', ()=>{
      const ta = $('#scope'); ta.select(); document.execCommand('copy');
    });

    // Reset
    $('#resetBtn').addEventListener('click', ()=>{
      document.querySelectorAll('input[type="number"]').forEach(i=>i.value = i.id.includes('waste') ? 10 : 0);
      $('#mode_inches').checked = true;
      $('#mode_inches').dispatchEvent(new Event('change'));
      $('#opt_round').checked = true;
      $('#opt_crown').checked = true;
      $('#opt_flash').checked = true;
      $('#bpsf').value = '7';
      $('#auto_tiles').checked = true;
      $('#tile_len').value = 24;
      $('#proj_in').value = 2;
      $('#no_cap').checked = false;
      $('#flue_size').value = '8x12';
      $('#crown_thk').value = 4;
      $('#crown_oh').value = 1.5;
      $('#flash_h').value = 8;
      calc();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    calc();
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
  else { bind(); }
})();
</script>
</body>
</html>