<!DOCTYPE html>

<html lang="en">
<head>
<!-- Error dashboard injected: shows first JS error details -->
<style>
.tag:empty, .pill:empty, .badge:empty, .chip:empty { display: none !important; }





body[data-active-group="cleanup"] .wrap .card[data-card-jobinfo] { display: none !important; }

  #js-error-banner {
    position: sticky; top: 0; z-index: 9999;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    font-size: 14px; line-height: 1.3;
    padding: 8px 12px; border-bottom: 1px solid #c00;
    background: #fff0f0; color: #900; display: none;
  }
  #js-error-banner.ok { background:#f0fff0; border-color:#0a0; color:#064; }
  #js-error-banner .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }

/* Cleanup tab: show only the Sections sidebar and Materials panel */
body[data-active-group="cleanup"] .wrap .panel { display: none !important; }
body[data-active-group="cleanup"] .wrap .panel:has(#sections-tablist),
body[data-active-group="cleanup"] .wrap .panel:has(#matTbody) { display: block !important; }
/* Hide Tax/Reimbursement card on Cleanup (presence of #taxPct input) */
body[data-active-group="cleanup"] .wrap .card:has(#taxPct) { display: none !important; }
/* Hide Crew & Time card on Cleanup: try common input IDs */
body[data-active-group="cleanup"] .wrap .card:has(#crewCount),
body[data-active-group="cleanup"] .wrap .card:has(#crewHours),
body[data-active-group="cleanup"] .wrap .card:has(#crewRate) { display: none !important; }


/* Cleanup: hide the Concrete tab in the Sections list */


/* Cleanup: hide the Job Info card */
body[data-active-group="cleanup"] .wrap .card:has(#job_date_header) { display: none !important; }


/* Cleanup: hide Quick Groups card */
body[data-active-group="cleanup"] .wrap .card:has(.groupbar) { display: none !important; }


/* Cleanup: hide the Concrete card */
body[data-active-group="cleanup"] .wrap .card:has(#ct_yards),
body[data-active-group="cleanup"] .wrap .card:has(#mv_yards) { display: none !important; }


/* Hide Waste/Disposal card on Cleanup and Veneer once tagged */
body[data-active-group="cleanup"] .wrap .card[data-card-waste],
body[data-active-group="veneer"]  .wrap .card[data-card-waste] { display: none !important; }


/* Crew tab: ensure the Crew & Time card is visible */
body[data-active-group="crew"] .wrap .card:has(#crewCount),
body[data-active-group="crew"] .wrap .card:has(#crewHours),
body[data-active-group="crew"] .wrap .card:has(#crewRate) { display: block !important; }


/* Crew tab: force-show the Crew & Time card; also markable via data-card-crew */
body[data-active-group="crew"] .wrap .card:has(#crewCount),
body[data-active-group="crew"] .wrap .card:has(#crewHours),
body[data-active-group="crew"] .wrap .card:has(#crewRate),
body[data-active-group="crew"] .wrap .card[data-card-crew] {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

</style>
<script "error"="" &&="" '="" '';="" ')="" ').pop();="" 'ok'="" 'script="" '✅="" '❌="" (':'+e.lineno)="" (function(){="" (p||'').split('="" (window.__errdash)="" +="" :="" ;="" <span="" ?="" and="" banner="document.createElement('div');" banner.classname="ok" banner.id="js-error-banner" banner.innerhtml="(ok" banner.setattribute('role','alert');="" banner.style.display="block" banner.textcontent="⏳ JS initializing…" base(p){="" catches="" class="mono" document.addeventlistener('domcontentloaded',="" document.body.prepend(banner);="" e.lineno="number" e.lineno)="" e.message="" e.message)="" error';="" errors="" fn="base(e.filename||'');" function="" function(){="" function(e){="" if="" in="" later="" ln="(typeof" loaded="" most="" msg="(e" msg;="" not="" ok){="" p;="" parse="" return="" return;="" runtime="" scripts="" show('js="" show(msg,="" try{="" var="" window="" window.__errdash="true;" window.addeventlistener('error',="" }="" });="" }catch(e){="">'+ fn + ln + '</span> ' + msg, false);
  }, true);

  // Unhandled rejected promises
  window.addEventListener('unhandledrejection', function(e){
    var r = e.reason;
    var t = (r && (r.stack||r.message)) ? (r.stack||r.message) : String(r);
    show('Unhandled promise rejection: <span class="mono">'+ t +'</span>', false);
  });

  // If we reach window load without errors, mark OK
  window.addEventListener('load', function(){
    // Don't overwrite an existing error
    if (banner.style.display !== 'block'){
      show('JS loaded', true);
    }
  });
})();
</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Turcotte Masonry Estimator</title>
<style>
  :root{ --bg:#0d1117; --card:#0f141b; --muted:#9fb4cc; --line:#1f2937;
    --accent:#4da3ff; --ok-bg:#062012; --ok-border:#224a30; --ok-text:#b7f7c1;
    --warn-bg:#201606; --warn-border:#5b3a0e; --warn:#ffd58a; }
  *{box-sizing:border-box}
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:#e6edf3; margin:0}
  .wrap{max-width:1140px; margin:0 auto; padding:16px 16px 120px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin:12px 0}
  .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
  label{font-size:13px; color:#b7c5d9}
  input, select{background:#0b1017; color:#e6edf3; border:1px solid var(--line); border-radius:10px; padding:8px 10px}
  input[type="number"]{width:120px}
  table{width:100%; border-collapse:collapse; font-size:14px; margin-top:8px}
  th,td{padding:8px 10px; border-bottom:1px dashed var(--line)}
  th{color:#99c2ff; text-align:left}
  .right{text-align:right}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#0a1015; border:1px solid var(--line); font-size:12px}
  .muted{color:var(--muted); font-size:12px}
  .status{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line)}
  .ok{background:var(--ok-bg); color:var(--ok-text); border-color:var(--ok-border)}
  .bad{background:#2a1313; color:#ffd2d2; border-color:#5a2a2a}
  .fade{opacity:.45; filter:grayscale(.2)}
  .warn{background:var(--warn-bg); border-color:var(--warn-border); color:var(--warn); padding:8px 10px; border-radius:10px; font-size:12px}
  .spacer{flex:1}
  button{background:var(--accent); color:#041425; border:0; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer}
  button.ghost{background:#0b1017; color:#d6e6ff; border:1px solid var(--line)}
  .sticky{position:fixed; left:0; right:0; bottom:0; z-index:10; background:rgba(4,8,12,.92); border-top:1px solid var(--line); backdrop-filter:saturate(140%) blur(6px);}
  .sticky-inner{max-width:1140px; margin:0 auto; padding:10px 16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .sticky .pill{background:#0b121a}
  .group{display:flex; gap:10px; align-items:center}
</style>
<style>
  /* Turcotte: small UI polish for Mohican mix selector */
  .mv-mix-wrap{display:inline-flex;align-items:center;gap:6px;margin-left:8px}
  .mv-mix-wrap select{min-width:260px}
  .mv-tag{display:inline-flex;align-items:center;gap:6px;background:#0a1015;border:1px solid #1f2937;border-radius:999px;padding:4px 8px;font-size:12px;color:#b7c5d9}
</style>
<style>
  html { scroll-behavior: smooth; } /* smooth scrolling */
  .groupbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .groupbar .tag { background:#0b121a; border:1px solid #1f2937; color:#c9d7ee; padding:6px 10px; border-radius:999px; cursor:pointer; font-size:12px;}
  .groupbar .tag[aria-pressed="true"] { background:#10334b; border-color:#2b6a8e; color:#e6f3ff; }
  .group-hidden { display:none !important; }
</style>
<style>
  /* A11Y Tabs upgrade */
  .groupbar { display: none !important; } /* retire old button bar */
  .a11y-tabs { display:flex; flex-direction:column; gap:8px; }
  .a11y-tabs [role="tablist"] { display:flex; flex-wrap:wrap; gap:6px; }
  .a11y-tabs [role="tab"] {
    appearance:none; border:1px solid #1f2937; background:#0b121a; color:#cfe2ff;
    padding:6px 12px; border-radius:999px; cursor:pointer; font-size:12px;
  }
  .a11y-tabs [role="tab"][aria-selected="true"] { background:#10334b; border-color:#2b6a8e; color:#fff; }
  .a11y-tabs [role="tab"]:focus { outline:2px solid #2b6a8e; outline-offset:2px; }
</style>
<style>
  /* Subcard bubbles for supplier sections */
  .subcard {
    background:#0a1015;
    border:1px solid #1f2937;
    border-radius:12px;
    padding:10px 12px;
    margin:10px 0 14px;
  }
</style>
<style>
  /* Dim non-relevant materials rows (safer than hiding) */
  #matTbody tr.dim { opacity: .45; }
</style>
<style id="stucco-hide-waste-css">
/* Hide the Waste / Disposal card when Stucco tab is active */
body[data-active-group="stucco"] .wrap > .card[data-card="waste"] { display: none !important; }
</style>
<style>
/* Fallback: hide non-stucco rows when Stucco tab active */
body[data-active-group="stucco"] #matTbody tr:not([data-cats*="stucco"]) { display: none !important; }
</style>
<style>
/* Hide rows that are NOT stone veneer nor bluestone when Stone Veneer tab is active */
body[data-active-group="veneer"] #matTbody tr:not([data-cats*="stone veneer"]):not([data-cats*="bluestone"]) { display: none !important; }
</style>
<style>#quickGroups,#quick-groups,.quick-groups,[data-section='quick-groups']{display:none!important;}</style>
<script>
// Unified section config: show items by cats OR if pinned
window.SECTION = {
  all:       { cats: null,                         pins: null },
  concrete:  { cats: ['concrete'],                 pins: new Set(['m6','m7','m10','mNH3','m2013','mTIL_DrivewayMix','mSO_KY_Bluegrass_Sod','mSO_TopSoil_Bulk','mNHM_Concrete_80lb','mLOW_ColdPatchAsphalt_50lb']) },
  masonry:   { cats: ['masonry'],                  pins: new Set([]) },
  pavers:    { cats: ['pavers'],                   pins: new Set([]) },
  bluestone: { cats: ['bluestone'],                pins: new Set([]) },
  veneer:    { cats: ['stone veneer','bluestone'], pins: new Set([]) },
  stucco:    { cats: ['stucco'],                   pins: new Set([]) }
  ,cleanup: { cats: ['cleanup'], pins: new Set(['mHDX_TerryTowels_20pk']) },
  chimney: { cats: null, pins: new Set([]) }};
</script>
<style id="stucco-helper-visibility">
/* Show the Stucco Helper card on Stucco and All tabs */
.card[data-card-stucco]{ display:none; }
body[data-active-group="stucco"] .wrap .card[data-card-stucco],
body[data-active-group="all"] .wrap .card[data-card-stucco]{ display:block !important; }
/* Fallback: if no data-active-group is present, do not hide the card */
body:not([data-active-group]) .wrap .card[data-card-stucco]{ display:block !important; }
</style>
<style id="stucco-dropdown-fix">
/* Ensure selects are clickable and visible */
#stu_finish_sel{
  position: relative;
  z-index: 10;
  pointer-events: auto;
  background:#0c0f14;
  border:1px solid var(--line);
  color:var(--ink);
  padding:8px 10px;
  border-radius:10px;
  min-width:260px;
  -webkit-appearance: menulist;
  appearance: auto;
}
</style>
<style>#stu_foam_sel{position:relative;z-index:10}</style>
<style id="per-card-bubble-v2">
/* Make each major group look like its own bubble */
.card{
  border-radius:16px !important;
  box-shadow: 0 10px 24px rgba(0,0,0,.28);
  margin:16px 0 !important;
}
.card > .row:first-child{
  border-bottom:1px dashed var(--line);
  padding-bottom:8px;
  margin-bottom:10px;
}
/* Make sticky show only GRAND (already simplified in HTML), keep it centered on small screens */
.sticky .pill{ display:inline-flex; }
.sticky .pill:not(#stickyGrandPill):not(#stickyStatusPill){ display:none !important; }
.sticky .group{ display:none !important; }
</style>
<style id="rings-safe-css">
/* Colored rings for cards that are not the nested Block Wall container */
.card[data-cat]{ position: relative; border-radius:16px; box-shadow: 0 6px 18px rgba(0,0,0,.2); }
.card[data-cat]::before{
  content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none;
  box-shadow: 0 0 0 2px var(--ring, rgba(255,255,255,0.06)) inset;
}
/* Do NOT draw a full ring for the Block Wall (masonry) card because the DOM nests other cards inside it. */
.card#blockWallCard{ border-left: 3px solid var(--ring, #3b82f6); }
.card#blockWallCard::before{ display:none !important; }
/* Header accent for Block Wall */
#blockWallCard > .row:first-child{ background: rgba(59,130,246,0.08); border-bottom:1px dashed var(--line); }
.card[data-cat="masonry"]{ --ring:#3b82f6; }     /* blue */
.card[data-cat="stucco"]{ --ring:#60a5fa; }      /* light blue */
.card[data-cat="concrete"]{ --ring:#9ca3af; }    /* gray */
.card[data-cat="materials"]{ --ring:#10b981; }   /* green */
.card[data-cat="crew"]{ --ring:#f59e0b; }        /* amber */
.card[data-cat="tax"]{ --ring:#a78bfa; }         /* violet */
.card[data-cat="fuel"]{ --ring:#f97316; }        /* orange */
.card[data-cat="waste"]{ --ring:#ef4444; }       /* red */
.card[data-cat="silica"]{ --ring:#14b8a6; }      /* teal */
.card[data-cat="tools"]{ --ring:#8b5cf6; }       /* purple */
.card[data-cat="totals"]{ --ring:#22d3ee; }      /* cyan */
</style>
<style id="bw-shell-css">
#bwShell{
  position: relative;
  border: 2px solid #3b82f6; /* blue */
  border-radius: 14px;
  padding: 10px;
  margin-top: 8px;
  background: rgba(59,130,246,0.04); /* faint tint so the boundary reads clearly */
}
#blockWallCard > .row:first-child{
  background: transparent; /* remove previous tint */
  border-bottom: none;      /* the shell has its own edge */
  margin-bottom: 0;
  padding-bottom: 0;
}
/* Keep other card rings intact (from rings-safe-css) */
</style>
<style id="materials-shell-css">
#materialsShell{
  position: relative;
  border: 2px solid #10b981; /* green */
  border-radius: 14px;
  padding: 10px;
  margin-top: 8px;
  background: rgba(16,185,129,0.05);
}
/* Clean up Materials header edge (shell handles boundary) */
#materialsCard > .row:first-child{
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}
</style>
<style id="materials-ring-off">
/* Turn off the older card ring for Materials so only the shell border remains */
#materialsCard::before { display:none !important; }
</style>
<style id="materials-border-off">
/* Remove the default 1px gray card border for Materials so only the green shell shows */
#materialsCard{ border: none !important; }
</style>
<style id="materials-flush-fix">
/* Make Materials green border flush with the card edges (like Crew) */
#materialsCard{ padding:0 !important; }
#materialsShell{ margin:0 !important; border-radius:16px; padding:14px !important; }
</style>
<style id="flush-borders-fix">
/* Delete the big blue border that wraps everything (card-level border-left) */
#blockWallCard{ border: none !important; padding: 0 !important; }
#blockWallCard::before{ display:none !important; } /* double safety */

/* Align smaller shells flush with the card edge */
#bwShell{ margin: 0 !important; border-radius:16px; padding:14px !important; }

/* Materials was already flush, but keep symmetry */
#materialsCard{ padding: 0 !important; border: none !important; }
#materialsCard::before{ display:none !important; }
#materialsShell{ margin: 0 !important; border-radius:16px; padding:14px !important; }
</style>
<style id="bubble-tints">
/* Soft fill tints to match each bubble's ring color */
/* Use card backgrounds for all except Block Wall & Materials (they use inner shells) */
#bwShell{ background: rgba(59,130,246,0.06) !important; }            /* masonry blue */
#materialsShell{ background: rgba(16,185,129,0.06) !important; }      /* materials green */

.card[data-cat="crew"]{ background: rgba(245,158,11,0.06) !important; }       /* amber */
.card[data-cat="tax"]{ background: rgba(167,139,250,0.06) !important; }       /* violet */
.card[data-cat="concrete"]{ background: rgba(156,163,175,0.06) !important; }  /* gray */
.card[data-cat="fuel"]{ background: rgba(249,115,22,0.06) !important; }       /* orange */
.card[data-cat="waste"]{ background: rgba(239,68,68,0.06) !important; }       /* red */
.card[data-cat="silica"]{ background: rgba(20,184,166,0.06) !important; }     /* teal */
.card[data-cat="tools"]{ background: rgba(139,92,246,0.06) !important; }      /* purple */
.card[data-cat="stucco"]{ background: rgba(96,165,250,0.06) !important; }     /* light blue */
.card[data-cat="totals"]{ background: rgba(34,211,238,0.06) !important; }     /* cyan */
</style>
<style id="concrete-shell-css">
/* Concrete bubble: dedicated shell so the entire Concrete section has its own ring and tint */
#concreteCard{ padding:0 !important; border:none !important; }
#concreteCard::before{ display:none !important; } /* avoid double ring */
#concreteShell{
  position: relative;
  border: 2px solid #9ca3af;   /* gray ring */
  border-radius: 16px;
  padding: 14px;
  margin: 0;                    /* flush with card edges */
  background: rgba(156,163,175,0.06); /* soft gray tint */
}
/* Remove header divider in Concrete; shell provides boundary */
#concreteCard > .row:first-child{
  border-bottom: none !important;
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}
</style>
<style id="sticky-split-align">.sticky-inner{ justify-content: space-between !important; }</style>
<style id="chimney-extra-css">
  /* Additional styles for Chimney Helper UI (kept minimal to avoid conflicts) */
  .section-box{
    border:1px solid #1f2937;
    border-radius:12px;
    padding:10px;
    background:#0a1015;
    margin:8px 0 10px;
  }
  .kpi{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border:1px solid #1f2937;
    border-radius:999px; background:#0a1015; font-size:12px;
  }
  /* Slightly reduce Brick Size dropdown width to prevent edge cut-off */
  #bpsf { box-sizing:border-box; width: calc(100% - 8px); }
  #chimneyCard .group { display:block !important; }

  /* Geometry: Side A/B horizontal layout within byBrick grid */
  #chimneyCard #byBrick{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 12px;
    align-items: end;
  }
  #chimneyCard #byBrick > label{ width: 100%; }

  /* Geometry: lay out 'By Inches' inputs horizontally */
  #chimneyCard #byInches{
    display: grid;
    grid-template-columns: repeat(5, minmax(160px, 1fr));
    gap: 12px;
    align-items: end;
  }
  #chimneyCard #byInches > label{ width: 100%; }

  /* Tighter spacing between Rebuild height (ft) and in */

  /* Extra-tighten spacing between Rebuild height (ft) and in */
  
  
  /* Keep the 'in' input compact so it doesn't push apart */

  /* Ultra-tight spacing between Rebuild height (ft) and in */

  /* Ultra-closer spacing between Rebuild height (ft) and in */

  /* Hyper-tight spacing between Rebuild height (ft) and in */

  /* Hyper-tight v2: nearly touching ft/in */
  
  
  

  /* Tighten spacing between Outside width (in) and Outside depth (in) */
  
  
  #chimneyCard #byInches #w_in,

  /* Moderate spacing between Outside width (in) and Outside depth (in) */
  #chimneyCard #byInches label:has(#w_in){ margin-right: -2px; }
  #chimneyCard #byInches label:has(#d_in){ margin-left: -36px; }
  #chimneyCard #byInches #w_in, 
  

  /* Smaller control for 'Outside width (in)' */
  #chimneyCard #byInches #w_in{ max-width: 64px; }

  /* Match compact width for 'Outside depth (in)' */
  #chimneyCard #byInches #d_in{ max-width: 64px; }

  /* Compact width for 'Rebuild height (ft)' */
  #chimneyCard #byInches #h_ft{ max-width: 64px; }

  /* Slightly increase space between Rebuild height (ft) and in */

  /* Slightly more space between Rebuild height (ft) and in */

  /* More space between Rebuild height (ft) and in */

  /* Extra spacing between Rebuild height (ft) and in */

  /* Tiny extra spacing between Rebuild height (ft) and in */

  /* Extra tiny bump: more space between Rebuild height (ft) and in */

  /* Slightly more space between Rebuild height (ft) and in */

  /* Micro-nudge: a bit more space between Rebuild height (ft) and in */

  /* Final nudge: more space + slightly larger 'in' box */
  #chimneyCard #byInches label:has(#h_ft){ margin-right: 16px; }
  #chimneyCard #byInches label:has(#h_in){ margin-left: -28px; }
  #chimneyCard #byInches #h_in{ max-width: 56px; }

</style>
<style id="chimney-helper-visibility">.wrap .card[data-card-chimney]{ display:none; }
  body[data-active-group="chimney"] .wrap .card[data-card-chimney],
  body[data-active-group="all"] .wrap .card[data-card-chimney]{ display:block !important; }
  /* Fallback: if no data-active-group is present, show the Chimney card */
  body:not([data-active-group]) .wrap .card[data-card-chimney]{ display:block !important; }
</style>

<style id="tm-sections-button-boost">
  /* Larger, high-contrast pill button */
  #tm-quicknav-toggle{
    display:inline-flex; align-items:center; gap:8px;
    background:#4da3ff; color:#041425;
    border:0; border-radius:9999px;
    padding:10px 16px; font-weight:800; letter-spacing:.2px;
    box-shadow: 0 6px 18px rgba(77,163,255,.35);
  }
  #tm-quicknav-toggle:hover{ box-shadow: 0 8px 24px rgba(77,163,255,.45); transform: translateY(-1px); }
  #tm-quicknav-toggle:active{ transform: translateY(0); box-shadow: 0 6px 18px rgba(77,163,255,.35); }
  #tm-quicknav-toggle:focus{ outline:2px solid rgba(77,163,255,.8); outline-offset:2px; }

  /* Add a chevron indicator that rotates when open */
  #tm-quicknav-toggle::after{
    content:''; width:8px; height:8px; border-right:2px solid currentColor; border-bottom:2px solid currentColor;
    transform: rotate(-45deg); display:inline-block; margin-left:2px;
  }
  #tm-quicknav-toggle[aria-expanded="true"]::after{ transform: rotate(45deg); }

  /* Gentle pulse highlight on first load */
  @keyframes tmSecPulse { 0%{ box-shadow: 0 0 0 0 rgba(77,163,255,.55); }
                          70%{ box-shadow: 0 0 0 10px rgba(77,163,255,0); }
                          100%{ box-shadow: 0 0 0 0 rgba(77,163,255,0); } }
  #tm-quicknav-toggle.attn{ animation: tmSecPulse 1.8s ease-out 2; }
  @media (prefers-reduced-motion: reduce){
    #tm-quicknav-toggle.attn{ animation: none; }
  }
</style>


<style>

#tm-tray {
  position: absolute; /* pinned to page top-right; scrolls away with content */
  top: 10px;
  right: 10px;
  z-index: 10;
  font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
#tm-tray .card{
  display: flex;
  gap: 6px;
  align-items: center;
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
  background: #ffffff;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
}
#tm-tray button{
  font-size: 12px;
  line-height: 1;
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  background: #f8fafc;
  cursor: pointer;
}
#tm-tray button.ghost{
  background: #ffffff;
  border-color: #e2e8f0;
}
#tm-tray button:hover{
  filter: brightness(0.97);
}
#tm-tray input[type="file"]{ display:none; }

</style>

<style>

/* --- High-contrast tray buttons (WCAG AA) --- */
#tm-tray .card{
  display: flex;
  gap: 6px;
  align-items: center;
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
  background: #ffffff;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
}
#tm-tray button{
  font-size: 13px;
  font-weight: 600;
  line-height: 1;
  padding: 7px 12px;
  border-radius: 8px;
  cursor: pointer;
}
/* Primary (Save) – dark on light for 4.5:1+ contrast */


/* Ghost buttons – outline, dark text on white for 4.5:1+ contrast */
#tm-tray button.ghost{
  background: #ffffff;
  color: #0f172a;         /* dark text */
  border: 1.5px solid #0f172a;
}
#tm-tray button.ghost:hover{
  background: #f8fafc;
}
/* Clear focus ring for keyboard users */
#tm-tray button:focus-visible{
  outline: 2px solid #0ea5e9;   /* sky-500 */
  outline-offset: 2px;
}

</style>

<style>

/* --- Ensure Save is highly readable --- */



</style>

<style>

/* --- Turcotte tray: uniform white buttons on black background --- */
#tm-tray{
  position: absolute !important;
  top: 4px !important;
  right: 68px !important;
  z-index: 12 !important;
  font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
#tm-tray .card{
  display: flex;
  gap: 6px;
  align-items: center;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid #111 !important;
  background: #000 !important;       /* black background */
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
}
#tm-tray button{
  font-size: 13px !important;
  font-weight: 600 !important;
  line-height: 1 !important;
  padding: 8px 12px !important;
  border-radius: 10px !important;
  border: 2px solid #0f172a !important;  /* dark outline for definition */
  background: #fff !important;           /* white button */
  color: #0f172a !important;             /* dark text */
  cursor: pointer !important;
}
/* Make all buttons identical: remove 'ghost' differences */
#tm-tray button.ghost{ 
  background: #fff !important;
  color: #0f172a !important;
  border: 2px solid #0f172a !important;
}
/* Hover + active states for clarity on black tray */
#tm-tray button:hover{ 
  background: #f8fafc !important;
}
#tm-tray button:active{ 
  background: #eef2f7 !important;
}
/* Keyboard focus: 2px focus ring at 3:1+ contrast on both black and white */
#tm-tray button:focus-visible{
  outline: 2px solid #0ea5e9 !important;  /* sky-500 */
  outline-offset: 2px !important;
}
/* Hide the file input control */
#tm-tray input[type="file"]{ display:none !important; }

</style>

<style>
/* Sections button: transparent background, keep all other styling */
#tm-quicknav-toggle{
  background: rgba(255,255,255,0.50) !important;
  color: #4da3ff !important;                 /* keep the accent color readable on dark bg */
  box-shadow: none !important;               /* remove blue glow from fill */
  border: 2px solid rgba(77,163,255,.85) !important; /* subtle outline for clarity */
}
#tm-quicknav-toggle:hover,
#tm-quicknav-toggle:active{
  background: rgba(255,255,255,0.75) !important;
  box-shadow: none !important;
}
</style>

<style>
/* Sections button: force black text across possible selectors */
#tm-quicknav-toggle,
#tm-sections-button-boost,
#tm-sections-button-boost-js,
button[aria-label="Sections"]{
  color: #000000 !important;
  text-shadow: none !important;
}
</style>

<style>
/* Sections button: gentle outer glow */
#tm-quicknav-toggle,
#tm-sections-button-boost,
#tm-sections-button-boost-js,
button[aria-label="Sections"]{
  /* keep the 50% translucent white background and black text from prior build */
  background: rgba(255,255,255,0.50) !important;
  color: #000000 !important;
  border: 1.5px solid rgba(0,0,0,0.55) !important;
  border-radius: 10px !important;
  /* layered glow: subtle ring + soft blue halo + drop shadow */
  box-shadow:
    0 0 0 1px rgba(255,255,255,0.35),
    0 0 22px rgba(77,163,255,0.45),
    0 6px 16px rgba(0,0,0,0.25) !important;
  /* optional: shape-aware shadow; complements box-shadow on rounded corners */
  filter: drop-shadow(0 4px 12px rgba(77,163,255,0.30));
  backdrop-filter: blur(2px);
  transition: box-shadow .2s ease, background-color .15s ease, transform .12s ease;
}
#tm-quicknav-toggle:hover,
#tm-sections-button-boost:hover,
#tm-sections-button-boost-js:hover,
button[aria-label="Sections"]:hover{
  background: rgba(255,255,255,0.66) !important;
  box-shadow:
    0 0 0 1px rgba(255,255,255,0.45),
    0 0 28px rgba(77,163,255,0.60),
    0 8px 18px rgba(0,0,0,0.30) !important;
}
</style>

<style>
/* Remove blue border/halo; keep semi‑transparent bg + black text */
#tm-quicknav-toggle,
#tm-sections-button-boost,
#tm-sections-button-boost-js,
button[aria-label="Sections"]{
  /* keep existing base */
  background: rgba(255,255,255,0.50) !important;
  color: #000 !important;
  border: 1.5px solid rgba(0,0,0,0.55) !important;   /* neutral border */
  /* neutral glow/shadow (no blue tint) */
  box-shadow:
    0 0 0 1px rgba(255,255,255,0.35),
    0 0 22px rgba(255,255,255,0.35),
    0 6px 16px rgba(0,0,0,0.25) !important;
  filter: drop-shadow(0 4px 12px rgba(0,0,0,0.25));   /* neutral drop shadow */
}
#tm-quicknav-toggle:hover,
#tm-sections-button-boost:hover,
#tm-sections-button-boost-js:hover,
button[aria-label="Sections"]:hover{
  background: rgba(255,255,255,0.66) !important;
  box-shadow:
    0 0 0 1px rgba(255,255,255,0.45),
    0 0 28px rgba(255,255,255,0.45),
    0 8px 18px rgba(0,0,0,0.30) !important;
}
</style>

<style>
/* Sections button: remove border entirely; keep background & glow */
#tm-quicknav-toggle,
#tm-sections-button-boost,
#tm-sections-button-boost-js,
button[aria-label="Sections"]{
  border: none !important;
}
/* Optional: keep a clear focus ring for keyboard users */
#tm-quicknav-toggle:focus-visible,
#tm-sections-button-boost:focus-visible,
#tm-sections-button-boost-js:focus-visible,
button[aria-label="Sections"]:focus-visible{
  outline: 2px solid #0ea5e9;
  outline-offset: 2px;
}
</style>

<style id="mobile-enhancements">
/* --- Mobile-first polish (≤ 840px) --- */
:root{
  /* gentle type scaling with clamp */
  --fs-body: clamp(14px, 2.5vw, 16px);
  --fs-small: clamp(12px, 2.2vw, 14px);
}
@media (max-width: 840px){
  html, body { font-size: var(--fs-body); }
  .wrap{ max-width: 100%; padding: 12px 12px 160px; }
  .row{ display:flex; flex-direction: column; align-items: stretch; gap: 10px; }
  .group{ flex-wrap: wrap; gap: 8px; }
  .card{ margin: 12px 0 !important; padding: 12px !important; border-radius: 14px !important; }
  h2, h3, h4 { margin: 4px 0 8px; line-height: 1.2; }
  label{ width: 100%; display: block; font-size: var(--fs-small); }
  input, select, textarea{
    width: 100%; max-width: 100%;
    font-size: 16px;              /* prevents iOS zoom-on-focus */
  }
  input[type="number"]{ width: 100% !important; }
  /* Pills/buttons: bigger touch targets */
  .pill{ width: 100%; justify-content: flex-start; padding: 10px 12px; }
  button{ width: 100%; padding: 12px 14px; font-size: 16px; }
  /* Make tab bars & long button rows scrollable horizontally */
  .a11y-tabs [role="tablist"]{ overflow-x: auto; white-space: nowrap; padding-bottom: 4px; }
  /* Tables: allow horizontal scroll when needed */
  table{ display:block; overflow-x:auto; white-space: nowrap; font-size: var(--fs-small); }
  th, td{ padding: 8px 8px; }
  /* Keep bottom sticky from covering content */
  .sticky{ bottom: 0; }
  .sticky-inner{ flex-direction: column; align-items: stretch; gap: 8px; }
  /* Hide heavy debug UI on phones */
  #js-error-banner, #bw_diag, details[open]#bw_diag { display: none !important; }
  /* Reposition tray so it doesn't collide with headers */
  #tm-tray{ position: fixed !important; top: 12px !important; right: 12px !important; }
  #tm-tray .card{ padding: 6px 8px; }
  /* Prevent oversized selects from forcing page width */
  select{ min-width: 0 !important; }
}
/* Improve accessibility on touch devices */
@media (pointer: coarse){
  .pill input[type="checkbox"], .pill input[type="radio"]{ transform: scale(1.15); margin-right: 6px; }
  button:focus-visible, a:focus-visible, select:focus-visible, input:focus-visible{
    outline: 2px solid #0ea5e9; outline-offset: 2px;
  }
}
</style>

</head>
<body>
<div style="position:sticky; top:0; z-index:1000; background:inherit; padding:6px 12px; font:600 12px system-ui; color:#0a6c2f;">✅ JS loaded and running</div>
<div class="wrap">
<h2 style="margin:8px 0">Turcotte Masonry Estimator</h2>
<!-- BLOCK WALL HELPER CARD -->
<div class="card" data-card="blockwall" data-cat="masonry" id="blockWallCard">
<div class="bw-shell" id="bwShell">
<div class="row">
<h3 style="margin:0">Block Wall Helper</h3>
<span class="spacer"></span>
<div class="group">
<label class="pill"><input checked="" id="bw_include_end_bars" type="checkbox"/> Include end bars</label>
<label class="pill"><input checked="" id="bw_use_20ft" type="checkbox"/> Use 20' rebar lengths</label>
</div>
</div>
<div class="row" style="margin-top:8px">
<div class="group">
<h4 style="margin:6px 0">CMU Type</h4>
<label>Thickness (select one)
        <select id="bw_thickness">
<option value="6">6" (6x8x16)</option>
<option selected="" value="8">8" (8x8x16)</option>
<option value="10">10" (10x8x16)</option>
<option value="12">12" (12x8x16)</option>
</select>
</label>
<div class="pill">
<label><input checked="" name="bw_height" type="radio" value="8"/> Standard 8" course</label>
</div>
<div class="pill">
<label><input name="bw_height" type="radio" value="4"/> Half‑High 4" course</label>
</div>
</div>
<div class="group">
<h4 style="margin:6px 0">Grout &amp; Rebar</h4>
<label>Grout Pattern
        <select id="groutPattern">
<option selected="" value="full">Fully Grouted</option>
<option value="16oc">Cells @ 16" o.c.</option>
<option value="24oc">Cells @ 24" o.c.</option>
<option value="32oc">Cells @ 32" o.c.</option>
</select>
</label>
<div class="group">
<h4 style="margin:6px 0">Special Shapes (allowances)</h4>
<label>Bond Beam courses (enter 0 if none)
        <input id="bw_bondbeam_courses" min="0" step="1" type="number" value="0"/>
</label>
</div>
</div>
<div class="row">
<div class="group">
<label>Wall Length — ft <input id="bw_len_ft" min="0" step="1" type="number" value="0"/></label>
<label>in <input id="bw_len_in" max="11" min="0" step="1" type="number" value="0"/></label>
<label>Wall Height — ft <input id="bw_h_ft" min="0" step="1" type="number" value="0"/></label>
<label>in <input id="bw_h_in" max="11" min="0" step="1" type="number" value="0"/></label>
<label>Waste % <input id="bw_waste" min="0" step="0.5" type="number" value="5"/></label>
</div>
</div>
<div class="row small muted">Assumptions: 8×8×16 CMU (nominal), 3/8" joints, every third cell has a vertical # 5 rebar, all cells filled with grout.</div>
<div class="row">
<div class="group">
<label class="pill"><input checked="" id="bw_round_up_blocks" type="checkbox"/> Round blocks up</label>
<label class="pill"><input checked="" id="bw_round_up_bars" type="checkbox"/> Round bars up</label>
<label class="pill"><input checked="" id="bw_round_up_bags" type="checkbox"/> Round bags up</label>
</div>
</div>
<div class="row">
<div class="col">
<h4>Quantities</h4>
<div class="small" id="bw_results"></div>
<details id="bw_diag" style="margin-top:8px"><summary>Diagnostics</summary>
<pre id="bw_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
<div class="col">
<h4>Scope Lines</h4>
<textarea id="bw_scope" rows="8" style="width:100%;font-family:monospace"></textarea>
<button class="ghost" id="bw_copy">Copy to clipboard</button>
</div>
</div>
</div>
<style>
  /* Block Wall tab: no global hide; rely on applyGroup filtering */
</style>
<script>
(function(){

  // Helper: check a materials row's "Use" checkbox by id or item text and dispatch change
  function ensureMaterialChecked(id, textPattern){
    try{
      var tbody = document.getElementById('matTbody');
      if(!tbody) return false;
      var row = null;
      if(id){
        row = tbody.querySelector('tr[data-id="'+id+'"]');
      }
      if(!row && textPattern){
        var re = new RegExp(textPattern, 'i');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        row = rows.find(function(tr){ return re.test((tr.textContent||'').replace(/\s+/g,' ')); });
      }
      if(!row) return false;
      var cb = row.querySelector('.mat_use');
      if(!cb) return false;
      if(!cb.checked){
        cb.checked = true;
        cb.dispatchEvent(new Event('change', { bubbles:true, cancelable:true }));
      }
      return true;
    }catch(e){ return false; }
  }

  // Data tables (sources in References panel)
  // Units per square foot (face) by course height
  const UNITS_PER_SF = { "8": 1.125, "4": 2.25 };
// Bags per block (Spec Mix Type‑S), keyed by CMU thickness (inches)
const BLOCKS_PER_BAG_BY_THICKNESS = { "4": 20, "6": 15, "8": 15, "10": 12, "12": 10 };
 // 8x16 vs half-high 4x16

  // Grout yd^3 per 100 sf by thickness + pattern (Fairbanks/Knife River table)
  const GROUT_YD3_100 = {
    "6":   { full: 0.93, "16oc": 0.55, "24oc": 0.42, "32oc": 0.35 },
    "8":   { full: 1.12, "16oc": 0.65, "24oc": 0.50, "32oc": 0.43 },
    "10":  { full: 1.30, "16oc": 0.82, "24oc": 0.63, "32oc": 0.53 },
    "12":  { full: 1.73, "16oc": 1.01, "24oc": 0.76, "32oc": 0.64 }
  };

  // SPEC MIX Core Fill 80-lb bag yields (lower end / worst-case)
  // 6": 3.4 blocks, 6.8 cores | 8": 2.5, 5.0 | 10": 2.1, 4.2 | 12": 1.7, 3.4
  const SPEC_MIX_CORE_FILL_PER_BAG = {
    "6":  { blocks: 3.4, cores: 6.8 },
    "8":  { blocks: 2.5, cores: 5.0 },
    "10": { blocks: 2.1, cores: 4.2 },
    "12": { blocks: 1.7, cores: 3.4 }
  };

  function feetInToInches(ft, inch){ 
    var f = parseFloat(ft||0), i = parseFloat(inch||0);
    if (!isFinite(f)) f = 0; if (!isFinite(i)) i = 0;
    return f*12 + i;
  }
  function fmt(n, d){ return (Math.round(n*Math.pow(10,d))/Math.pow(10,d)).toFixed(d); }

  function courseHeightIn(){
    const hSel = document.querySelector('input[name="bw_height"]:checked');
    return (hSel && hSel.value === '4') ? 4 : 8;
  }

  function calc(){
    var L_in = feetInToInches(document.getElementById('bw_len_ft').value, document.getElementById('bw_len_in').value);
    var H_in = feetInToInches(document.getElementById('bw_h_ft').value, document.getElementById('bw_h_in').value);
    var wastePct = parseFloat(document.getElementById('bw_waste').value||0);
    if (!isFinite(wastePct)) wastePct = 0;
    var area_sf = (L_in/12) * (H_in/12);

    // CMU type
    var thickness = document.getElementById('bw_thickness').value; // '6','8','10','12'
    var heightKey = (courseHeightIn() === 4) ? "4" : "8";

    // Units per SF (face) per course height
    var unitsPerSf = UNITS_PER_SF[heightKey] || 1.125;
    // Diagnostics (early) — show inputs even before area is present
    try{
      var pre0 = document.getElementById('bw_diag_pre');
      if (pre0){
        var D=[];
        function f(n){ try{ return (typeof n==='number'&&isFinite(n))?n.toFixed(2):String(n);}catch(_){return String(n);} }
        var heightRadio = document.querySelector('input[name="bw_height"]:checked');
        var htCourse = heightRadio ? heightRadio.value : '8';
        D.push('len_in='+f(L_in));
        D.push('hgt_in='+f(H_in));
        D.push('hasArea='+String((L_in>0&&H_in>0)));
        D.push('thickness_in='+String(thickness));
        D.push('course_in='+String(htCourse));
        D.push('waste_pct='+f(wastePct));
        pre0.textContent = D.join('\\n');
      }
    }catch(_){}


    // Blocks calc
    var blocks = area_sf * unitsPerSf;
    var blocks_waste = blocks * (1 + wastePct/100);
    if (document.getElementById('bw_round_up_blocks').checked){ blocks_waste = Math.ceil(blocks_waste); }

    
    
    

/*__BW_TO_MAT_MAPPING__*/
try{
  // Ensure materials table exists
  if (!document.querySelector('#matTbody tr') && typeof renderMaterials==='function'){ renderMaterials(); }
  var tbody = document.getElementById('matTbody');

  // Inputs/state from the Block Wall calculator
  var thicknessSel = document.getElementById('bw_thickness');
  var heightRadio  = document.querySelector('input[name="bw_height"]:checked');
  var htCourse     = heightRadio ? heightRadio.value : '8';

  // Area present?
  var hasArea = (typeof L_in==='number' && typeof H_in==='number' && L_in>0 && H_in>0);

  function findRows(rx){
    if(!tbody) return [];
    var rows = Array.from(tbody.querySelectorAll('tr'));
    rx = (rx instanceof RegExp) ? rx : new RegExp(String(rx), 'i');
    return rows.filter(function(tr){ return rx.test((tr.textContent||'')); });
  }
  function clearRow(tr){
    if(!tr) return;
    var q = tr.querySelector('.mat_qty'); if (q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
    var cb = tr.querySelector('.mat_use'); if (cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); }
  }
  function clearRows(list){ (list||[]).forEach(clearRow); }
  function setQty(tr, qty){
    if(!tr) return;
    var cb = tr.querySelector('.mat_use'); if (cb && !cb.checked){ cb.checked=true; cb.dispatchEvent(new Event('change',{bubbles:true})); }
    var q  = tr.querySelector('.mat_qty'); if (q){ q.value = String(qty||0); q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
  }

  if(!hasArea){
    if (tbody){
      // Clear CMU blocks (any size)
      clearRows(findRows(/hollow\s*concrete\s*block/i));
      // Clear core-fill grout (SPEC MIX Core Fill Grout 3k — 80 lb etc.)
      clearRows(findRows(/core\s*fill.*grout|masonry\s*grout/i));
      // Clear Durawall/joint reinforcement
      clearRows(findRows(/durawall|joint\s*reinforcement/i));
      // Clear rebar entries (any)
      clearRows(findRows(/\brebar\b/i));
      // Explicit ids (defensive): 12" CMU, SPEC MIX Core Fill Grout 3k (m8), #5 rebar 20' (mNH3)
      var ids = ['mNH1','m8','mNH3','mNH2'];
      ids.forEach(function(id){
        var tr = tbody.querySelector('tr[data-id="'+id+'"]');
        if (tr) clearRow(tr);
      });
    }
    return;
  }

  // With area present -> set the active size row quantities as before (12" only here)
  if (tbody && thicknessSel && thicknessSel.value==='12' && htCourse==='8'){
    var row = tbody.querySelector('tr[data-id="mNH1"]') || (findRows(/12"\s*hollow\s*concrete\s*block/i)[0]||null);
    if (row){
      var qty = (typeof blocks_waste==='number') ? blocks_waste : (Number(blocks_waste)||0);
      setQty(row, qty);
    }
  }
}catch(e){ /* keep calc resilient */ }

  // Ensure bond-beam courses input triggers totals
  (function(){
    function bindBB(){ try{ var el = document.getElementById('bw_bondbeam_courses'); if (el){ el.addEventListener('input', updateAll); el.addEventListener('change', updateAll);} }catch(e){} }
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', bindBB); } else { bindBB(); }
  })();
/*__/BW_TO_MAT_MAPPING__*/


    


// Course count (for openings/specials)
    var courses = Math.ceil(H_in / courseHeightIn());
    // === Durawall (joint reinforcement) calc — all wall thicknesses ===
    // Default: every other course (approx 16" o.c. when courses are 8" high)
    var DURAWALL_SPACING_COURSES = 2;
    var durawall_runs = Math.ceil(courses / DURAWALL_SPACING_COURSES);
    var durawall_lf_total = (L_in/12) * durawall_runs; // linear feet per run along length
    var durawall_10ft_pcs = Math.max(0, Math.ceil(durawall_lf_total / 10));


    // Rebar: based on 16" modules along length (approx columns)
    var columns = Math.max(1, Math.round(L_in / 16));
    var gpEl = document.getElementById('groutPattern');
    var pattern = gpEl ? gpEl.value : 'full';
    var includeEnds = document.getElementById('bw_include_end_bars').checked;
    var bars_every_third = Math.ceil(columns / 3); // default legacy calc
    // If user picked 16/24/32 o.c., honor the spacing exactly:
    var spacingIn = 24; // default for legacy
    if (pattern==='16oc') spacingIn = 16;
    else if (pattern==='24oc') spacingIn = 24;
    else if (pattern==='32oc') spacingIn = 32;
    var bars_spacing = Math.max(1, Math.floor(L_in / spacingIn)) + (includeEnds ? 2 : 0);
    var vert_bars = (pattern==='full') ? bars_every_third + (includeEnds ? 2 : 0) : bars_spacing;

    // Bar length per vertical: wall height + 12" top + 12" bottom (quick rule)
    var embed_each_in = 12;
    var bar_len_ft = (H_in + 2*embed_each_in) / 12;
    var use20 = document.getElementById('bw_use_20ft').checked;
    var stock = use20 ? 20 : 10;
    var bars_needed = vert_bars;
    if (bar_len_ft > stock) { bars_needed = vert_bars * 2; }
    var rebar_lf = vert_bars * bar_len_ft;
    // #5 rebar (5/8") comes in 20' sticks for Rob
    var rebar_sticks20 = (area_sf>0) ? Math.max(0, Math.ceil(rebar_lf / 20)) : 0;


    
    // === Bond beam horizontals (safe patch) ===
    try {
      var bb_courses = Math.max(0, (typeof bondCourses!=='undefined' ? bondCourses : parseInt(document.getElementById('bw_bondbeam_courses')?.value||'0',10))||0);
      if (bb_courses > 0) {
        var L_ft = (typeof L_in!=='undefined' ? (L_in/12) : 0);
        var horiz_bar_len_ft = L_ft + 2; // 12" embed each end
        var horiz_bars_total = bb_courses * 2;
        var horiz_lf = horiz_bars_total * horiz_bar_len_ft;
        rebar_lf += horiz_lf;
        rebar_sticks20 = (area_sf>0) ? Math.max(0, Math.ceil(rebar_lf / 20)) : 0;
      }
    } catch(e) { /* non-fatal */ }
// Grout from table (thickness + pattern)
    var yd3_100 = (GROUT_YD3_100[thickness] && GROUT_YD3_100[thickness][pattern]) ? GROUT_YD3_100[thickness][pattern] : GROUT_YD3_100['8']['full'];
    var groutYd3 = area_sf * (yd3_100 / 100) * (1 + wastePct/100);
    var groutFt3 = groutYd3 * 27;

    // === SPEC MIX Core Fill 80-lb bag calc ===
    var sm = (typeof SPEC_MIX_CORE_FILL_PER_BAG!=='undefined') ? SPEC_MIX_CORE_FILL_PER_BAG[thickness] : null;
    var grout_bags = 0;
    if (sm){
      if (pattern==='full'){
        grout_bags = (blocks_waste>0 ? (blocks_waste / sm.blocks) : 0);
      } else {
        // Approx: one filled core per vertical bar per course for reinforced cells
        var cores_to_fill = Math.max(0, vert_bars) * Math.max(0, courses);
        grout_bags = (cores_to_fill>0 ? (cores_to_fill / sm.cores) : 0);
      }
      // Add bond-beam extra grout bags in any pattern (full or reinforced cells)
      try {
        var cols = (typeof columns!=='undefined') ? columns : 0;
        var bb_courses2 = Math.max(0, (typeof bondCourses!=='undefined' ? bondCourses : parseInt(document.getElementById('bw_bondbeam_courses')?.value||'0',10))||0);
        var bb_extra_cores = Math.max(0, cols) * Math.max(0, bb_courses2);
        var bb_extra_bags = (bb_extra_cores>0 && sm && sm.cores>0) ? (bb_extra_cores / sm.cores) : 0;
        grout_bags += bb_extra_bags;
      } catch(e) { /* non-fatal */ }
      grout_bags = grout_bags * (1 + wastePct/100);
      if (document.getElementById('bw_round_up_bags') && document.getElementById('bw_round_up_bags').checked){
        grout_bags = Math.ceil(grout_bags);
      }
    }

    // Mortar (keep simple rule-of-thumb tied to units)
    // Mortar bags based on Spec Mix Type‑S blocks-per-bag by thickness
var bpb = (typeof BLOCKS_PER_BAG_BY_THICKNESS !== 'undefined' && BLOCKS_PER_BAG_BY_THICKNESS[thickness]) ? BLOCKS_PER_BAG_BY_THICKNESS[thickness] : 15;
var mortar_bags = blocks_waste / bpb;
var rUpEl = document.getElementById('bw_round_up_bags');
if (rUpEl && rUpEl.checked){ mortar_bags = Math.ceil(mortar_bags); }

// Specials
    var oeEl = document.getElementById('bw_open_end'); var useOpenEnd = oeEl ? oeEl.checked : false;
    var bondCourses = parseInt(document.getElementById('bw_bondbeam_courses').value || '0', 10);
    if (!isFinite(bondCourses) || bondCourses < 0) bondCourses = 0;
    // Open-end allowance: one per reinforced cell per course (approx.)
    var open_end_units = useOpenEnd ? (vert_bars * courses) : 0;
    // Bond beam units: approx columns count per course × bondCourses
    var bond_beam_units = bondCourses > 0 ? (columns * bondCourses) : 0;

    // Scope text
    var scope = [];
    scope.push('Build CMU wall ' + fmt(L_in/12,2) + ' LF × ' + fmt(H_in/12,2) + ' H ('+thickness+'x'+(courseHeightIn())+'x16 face).');
    scope.push('Furnish & lay ≈ ' + blocks_waste + ' units (' + fmt(unitsPerSf,3) + '/sf @ ' + courseHeightIn() + '\" course; includes ' + fmt(wastePct,1) + '% waste).');
    scope.push('Vertical #4 @ ' + (pattern==='full' ? '≈ every third cell' : (spacingIn + '\" o.c.')) + (includeEnds ? ' + end bars' : '') + ' — ' + vert_bars + ' bars @ ' + fmt(bar_len_ft,2) + ' ft ea (' + fmt(rebar_lf,1) + ' LF total).');
    scope.push('Grout (' + thickness + '\" wall, ' + (pattern==='full' ? 'fully grouted' : (spacingIn + '\" o.c.')) + '): ≈ ' + fmt(groutYd3,3) + ' yd³.');
    scope.push('Mortar ≈ ' + fmt(mortar_bags,2) + ' bags (Spec Mix Type-S, ~' + bpb + ' blocks/bag).');
    if (open_end_units>0) scope.push('Open‑End units allowance: ≈ ' + open_end_units + ' (at reinforced cells).');
    if (bond_beam_units>0) scope.push('Bond‑beam units allowance: ≈ ' + bond_beam_units + ' (spread across ' + bondCourses + ' course' + (bondCourses>1?'s':'') + ').');

    // === Sync SPEC MIX Core Fill bags to Materials ===
    try {
      var bagsToMat = sm ? Math.max(0, Math.ceil(grout_bags||0)) : 0;
      var tbody = document.getElementById('matTbody');
      if (tbody && !tbody.querySelector('tr') && typeof renderMaterials==='function') { renderMaterials(); }
      tbody = document.getElementById('matTbody');
      if (tbody) {
        // Prefer text match to be resilient to id changes
        var coreRow = Array.from(tbody.querySelectorAll('tr')).find(function(tr){ 
          return /SPEC\s*MIX.*Core\s*Fill.*80/i.test((tr.textContent||'')); 
        });
        if (!coreRow) {
          // Fallback to known id (m8) if present
          coreRow = tbody.querySelector('tr[data-id="m8"]');
        }
        if (bagsToMat > 0) {
          if (!coreRow && typeof ensureMaterialChecked==='function') {
            ensureMaterialChecked(null, 'SPEC\\s*MIX.*Core\\s*Fill.*80');
            coreRow = Array.from(tbody.querySelectorAll('tr')).find(function(tr){ 
              return /SPEC\s*MIX.*Core\s*Fill.*80/i.test((tr.textContent||'')); 
            });
          }
          if (coreRow && typeof matSetQtyAndUse==='function') {
            matSetQtyAndUse(coreRow, bagsToMat);
          } else if (coreRow) {
            var useCb = coreRow.querySelector('.mat_use');
            var qtyInp = coreRow.querySelector('.mat_qty');
            if (useCb && !useCb.checked) useCb.click();
            if (qtyInp) { qtyInp.value = bagsToMat; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          }
        } else if (coreRow) { 
          // Zero: uncheck & clear
          var useCb = coreRow.querySelector('.mat_use');
          var qtyInp = coreRow.querySelector('.mat_qty');
          if (qtyInp) { qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          if (useCb && useCb.checked) useCb.click();
        }
      }
    } catch(e) { /* non-fatal */ }

    // === Sync #5 rebar 20' sticks to Materials ===
    try {
      var sticksToMat = Math.max(0, rebar_sticks20||0);
      if (!(area_sf>0)) { sticksToMat = 0; }
      var tbody = document.getElementById('matTbody');
      if (tbody && !tbody.querySelector('tr') && typeof renderMaterials==='function') { renderMaterials(); }
      tbody = document.getElementById('matTbody');

      function getRebarRow(){
        if (!tbody) return null;
        var row = tbody.querySelector('tr[data-id="mNH3"]'); // exact known id
        if (!row){
          // try text match as fallback
          row = Array.from(tbody.querySelectorAll('tr')).find(function(tr){
            return /#\s*5\s*rebar.*20['’]/i.test((tr.textContent||''));
          });
        }
        return row;
      }

      var row = getRebarRow();
      if (!row && typeof renderMaterials==='function'){ renderMaterials(); row = getRebarRow(); }

      if (row){
        if (sticksToMat > 0){
          if (typeof matSetQtyAndUse === 'function') {
            matSetQtyAndUse(row, sticksToMat);
          } else {
            var useCb = row.querySelector('.mat_use');
            var qtyInp = row.querySelector('.mat_qty');
            if (useCb && !useCb.checked) useCb.click();
            if (qtyInp) { qtyInp.value = sticksToMat; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          }
        } else {
          var useCb = row.querySelector('.mat_use');
          var qtyInp = row.querySelector('.mat_qty');
          if (qtyInp) { qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          if (useCb && useCb.checked) useCb.click();
        }
      }
    } catch(e) { /* non-fatal */ }

    
    // === Sync Mortar (SPEC MIX Type S — 80 lb) to Materials ===
    try {
      var mortarToMat = Math.max(0, (rUpEl && rUpEl.checked) ? Math.ceil(mortar_bags||0) : (typeof mortar_bags==='number' ? mortar_bags : 0));
      var tbody = document.getElementById('matTbody');
      if (tbody && !tbody.querySelector('tr') && typeof renderMaterials==='function') { renderMaterials(); }
      tbody = document.getElementById('matTbody');
      if (tbody){
        var mortarRow = tbody.querySelector('tr[data-id="m4"]') || Array.from(tbody.querySelectorAll('tr')).find(function(tr){
          return /SPEC\s*MIX.*Type\s*S.*80/i.test((tr.textContent||''));
        });
        if (!mortarRow){
          mortarRow = Array.from(tbody.querySelectorAll('tr')).find(function(tr){
            return /Type\s*S.*SPEC/i.test((tr.textContent||''));
          });
        }
        if (mortarToMat > 0 && mortarRow){
          if (typeof matSetQtyAndUse === 'function') {
            matSetQtyAndUse(mortarRow, mortarToMat);
          } else {
            var useCb = mortarRow.querySelector('.mat_use');
            var qtyInp = mortarRow.querySelector('.mat_qty');
            if (useCb && !useCb.checked) useCb.click();
            if (qtyInp){ qtyInp.value = mortarToMat; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          }
        } else if (mortarRow){
          var useCb = mortarRow.querySelector('.mat_use');
          var qtyInp = mortarRow.querySelector('.mat_qty');
          if (qtyInp){ qtyInp.value=''; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          if (useCb && useCb.checked) useCb.click();
        }
      }
    } catch(e) { /* non-fatal */ }
// === Sync 12" Durawall — 10' to Materials ===
    try {
      var pcsToMat = Math.max(0, durawall_10ft_pcs||0);
      
      // Force zero when no area
      if (!(area_sf>0) || !(L_in>0) || !(H_in>0)) pcsToMat = 0;
var tbody = document.getElementById('matTbody');

      // Clear any Durawall rows first so old sizes don't stick
      try {
        if (tbody) {
          var allDW = Array.from(tbody.querySelectorAll('tr')).filter(function(tr){
            return /Durawall.*10['’]/i.test((tr.textContent||''));
          });
          allDW.forEach(function(tr){
            var useCb = tr.querySelector('.mat_use');
            var qtyInp = tr.querySelector('.mat_qty');
            if (qtyInp) { qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
            if (useCb && useCb.checked) { useCb.click(); }
          });
        }
      } catch(_e) {}

      if (tbody && !tbody.querySelector('tr') && typeof renderMaterials==='function') { renderMaterials(); }
      tbody = document.getElementById('matTbody');

      function getDurawallRow(){
        // Explicit ID mapping by thickness
        var idMap = { '6':'mDW6', '8':'mDW8', '10':'mDW10', '12':'mNH2' };
        var idTry = idMap[String(thickness)];
        if (idTry) {
          var r0 = tbody.querySelector('tr[data-id="'+idTry+'"]');
          if (r0) return r0;
        }
        if (!tbody) return null;
        // Try thickness-specific first (e.g., 8" Durawall — 10')
        try {
          var rxStr = String(thickness) + '["”]\\s*Durawall.*10[\'’]';
          var rx = new RegExp(rxStr, 'i');
          var row = Array.from(tbody.querySelectorAll('tr')).find(function(tr){
            return rx.test((tr.textContent||''));
          });
          if (row) return row;
        } catch(e) {}
        // Fallback to known id, then any generic Durawall — 10'
        var row2 = tbody.querySelector('tr[data-id="mNH2"]');
        if (row2) return row2;
        return Array.from(tbody.querySelectorAll('tr')).find(function(tr){
          return /Durawall.*10['’]/i.test((tr.textContent||''));
        }) || null;
      }

      var row = getDurawallRow();
      if (!row && typeof renderMaterials==='function'){ renderMaterials(); row = getDurawallRow(); }

      if (row){
        if (pcsToMat > 0){
          if (typeof matSetQtyAndUse === 'function') {
            matSetQtyAndUse(row, pcsToMat);
          } else {
            var useCb = row.querySelector('.mat_use');
            var qtyInp = row.querySelector('.mat_qty');
            if (useCb && !useCb.checked) useCb.click();
            if (qtyInp) { qtyInp.value = pcsToMat; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          }
        } else {
          var useCb = row.querySelector('.mat_use');
          var qtyInp = row.querySelector('.mat_qty');
          if (qtyInp) { qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input', {bubbles:true})); }
          if (useCb && useCb.checked) useCb.click();
        }
      }
    } catch(e) { /* non-fatal */ }

    document.getElementById('bw_scope').value = scope.join('\n');

    // Results panel
    var html = '';
    html += '<div><strong>Area:</strong> ' + fmt(area_sf,2) + ' sf</div>';
    html += '<div><strong>CMU Type:</strong> ' + thickness + 'x' + courseHeightIn() + 'x16</div>';
    html += '<div><strong>Blocks (calc):</strong> ' + fmt(blocks,2) + ' → <strong>Order:</strong> ' + blocks_waste + '</div>';
    html += '<div><strong>Vertical #4 bars:</strong> ' + vert_bars + ' @ ' + fmt(bar_len_ft,2) + ' ft (' + fmt(rebar_lf,1) + ' LF)</div>';
    html += '<div><strong>Grout (table):</strong> ' + fmt(groutFt3,2) + ' ft³ (' + fmt(groutYd3,3) + ' yd³) — ' + thickness + '\" / ' + (pattern==='full' ? 'Full' : (spacingIn + '\" o.c.')) + '</div>';
    html += '<div><strong>Grout Bags (SPEC MIX Core Fill 80 lb):</strong> ' + (sm ? ( (document.getElementById('bw_round_up_bags') && document.getElementById('bw_round_up_bags').checked) ? (grout_bags + ' bags') : (fmt(grout_bags,2) + ' bags') ) : '—') + '</div>';
    html += '<div><strong>Durawall — 10\' pieces:</strong> ' + durawall_10ft_pcs + ' pcs</div>';
    html += '<div><strong>Rebar #5 (20\') sticks:</strong> ' + rebar_sticks20 + ' pcs</div>';
    html += '<div><strong>Mortar:</strong> ~' + fmt(mortar_bags,2) + ' bags</div>';
    if (open_end_units>0) html += '<div><strong>Open‑End units:</strong> ' + open_end_units + '</div>';
    if (bond_beam_units>0) html += '<div><strong>Bond‑beam units:</strong> ' + bond_beam_units + ' (courses: ' + bondCourses + ')</div>';
    document.getElementById('bw_results').innerHTML = html;
    try{
      var pre = document.getElementById('bw_diag_pre');
      if (pre){
        var dbg = [];
        dbg.push('area_sf='+fmt(area_sf,2));
        dbg.push('unitsPerSf='+unitsPerSf);
        dbg.push('blocks='+fmt(blocks,2)+' → order='+blocks_waste);
        dbg.push('vert_bars='+vert_bars+' @ '+fmt(bar_len_ft,2)+' ft ('+fmt(rebar_lf,1)+' LF)');
        dbg.push('groutFt3='+fmt(groutFt3,2)+' ('+fmt(groutYd3,3)+' yd³)');
        dbg.push('bond_beam_units='+bond_beam_units+', courses='+bondCourses);
        pre.textContent = dbg.join('\n');
      }
    }catch(e){}
  }

  function bind(){
    ['bw_len_ft','bw_len_in','bw_h_ft','bw_h_in','bw_waste',
     'bw_round_up_blocks','bw_round_up_bars','bw_round_up_bags',
     'bw_include_end_bars','bw_use_20ft','bw_thickness','bw_bondbeam_courses','groutPattern','bw_open_end']
      .forEach(function(id){ var el = document.getElementById(id); if(el){ el.addEventListener('input', calc); el.addEventListener('change', calc); }});
    document.querySelectorAll('input[name="bw_height"]').forEach(function(el){ el.addEventListener('change', calc); });
    var c = document.getElementById('bw_copy');
    if (c) c.addEventListener('click', function(){
      var ta = document.getElementById('bw_scope'); ta.select(); try{ document.execCommand('copy'); }catch(e){}
    });
    calc();

    // Re-run after Materials table renders/changes (debounced)
    try{
      const matBody = document.getElementById('matTbody');
      if(matBody){
        let __stucco_obs_timer = null;
        const onMatChange = () => {
          if(__stucco_obs_timer) cancelAnimationFrame(__stucco_obs_timer);
          __stucco_obs_timer = requestAnimationFrame(()=>{ __stucco_obs_timer=null; if(typeof window.stuccoCalc==='function') window.stuccoCalc(); });
        };
        const mo = new MutationObserver(onMatChange);
        mo.observe(matBody, {childList:true});
      }
    }catch(e){}
    
}
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
  else { bind(); }

  /*__BW_LISTENERS__*/
  try {
    var thick = document.getElementById('bw_thickness');
    if (thick) thick.addEventListener('change', function(){
      var r = document.querySelector('input[name="bw_height"]:checked');
      if (thick.value==='12' && (r ? r.value : '8')==='8'){
        if (!document.querySelector('#matTbody tr') && typeof renderMaterials==='function'){ renderMaterials(); }
        ensureMaterialChecked('mNH1', '12\"\s*hollow\s*concrete\s*block');
      }
    });
    document.querySelectorAll('input[name="bw_height"]').forEach(function(el){
      el.addEventListener('change', function(){
        var thickVal = document.getElementById('bw_thickness') ? document.getElementById('bw_thickness').value : '';
        if (thickVal==='12' && el.value==='8'){
          if (!document.querySelector('#matTbody tr') && typeof renderMaterials==='function'){ renderMaterials(); }
          ensureMaterialChecked('mNH1', '12\"\s*hollow\s*concrete\s*block');
        }
      });
    });
  } catch(e){}
  /*__/BW_LISTENERS__*/

})();
</script>
<div id="jsStatus" style="display:none"></div>
<!-- TAX -->
</div><!-- /bw-shell -->
<div class="card" data-cat="tax" id="taxCard">
<div class="row">
<h3 style="margin:0">Tax / Reimbursement (CT default 6.35%)</h3>
<span class="spacer"></span>
<div class="group">
<label>Rate % <input id="taxPct" step="0.01" type="number" value="6.35"/></label>
<label class="pill"><input checked="" id="tax_res" name="taxmode" type="radio"/> Residential — reimburse my material taxes</label>
<label class="pill"><input id="tax_com" name="taxmode" type="radio"/> Commercial — charge sales tax</label>
<button class="ghost" id="unlockTax">Manual override</button>
</div>
</div>
<div class="row small muted">Residential reimburses **Materials + Concrete + Disposal** by default. Commercial taxes all buckets by default. You can still override below.</div>
<div class="row" style="margin-top:6px">
<label class="pill"><input checked="" disabled="" id="tax_on_materials" type="checkbox"/> Materials</label>
<label class="pill"><input checked="" disabled="" id="tax_on_concrete" type="checkbox"/> Concrete</label>
<label class="pill"><input disabled="" id="tax_on_fuel" type="checkbox"/> Fuel</label>
<label class="pill"><input disabled="" id="tax_on_disposal" type="checkbox"/> Disposal</label>
<label class="pill"><input disabled="" id="tax_on_labor" type="checkbox"/> Labor</label>
<label class="pill"><input disabled="" id="tax_on_tools" type="checkbox"/> Tools</label>
<label class="pill"><input disabled="" id="tax_on_oh" type="checkbox"/> Overhead</label>
<label class="pill"><input disabled="" id="tax_on_profit" type="checkbox"/> Profit</label>
</div>
<div class="row small muted">CT rate is 6.35% with no local add-ons. Motor vehicle fuel is sales-tax-exempt. Use overrides as your policy requires.</div>
</div>
<!-- CREW -->
<div class="card" data-cat="crew" id="crewCard">
<div class="row">
<h3 style="margin:0">Crew &amp; Time</h3>
<span class="spacer"></span>
<button class="ghost" id="addWorkerBtn">+ Add Worker</button>
</div>
<div class="row" style="margin-bottom:6px">
<label class="pill"><input checked="" id="crewWideToggle" type="checkbox"/> Use CREW‑WIDE time</label>
<label class="pill"><input checked="" id="timeUnitsDays" type="checkbox"/> Time in Days (8 hr/day)</label>
<label>Crew‑wide time <input id="crewWideQty" placeholder="e.g., 1" step="1" type="number"/></label> <label style="margin-left:.5rem">Crew <input id="crewManual" placeholder="3" step="1" style="width:5rem" type="number" value="3"/></label> <label style="margin-left:.5rem">Days <input id="daysManual" placeholder="1" step="1" style="width:5rem" type="number" value="1"/></label>
</div>
<table>
<thead><tr><th>Use</th><th>Name</th><th>Role</th><th>Rate ($/hr)</th><th>Hours</th><th>Cost</th><th></th></tr></thead>
<tbody id="crewTbody"></tbody>
<tfoot><tr><td class="right" colspan="5">Crew Subtotal (excl. Company)</td><td class="right mono" id="crewSubtotal">$0.00</td><td></td></tr></tfoot>
</table>
<details id="crew_diag" style="margin-top:8px"><summary>Diagnostics</summary>
<pre id="crew_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
<div class="muted small">Set role = <b>Company</b> to flow those hours into <b>Profit</b> (not Crew).</div>
</div>
<!-- MATERIALS -->
<div class="card" data-cat="materials" id="materialsCard">
<div class="materials-shell" id="materialsShell">
<div class="row">
<h3 style="margin:0">Materials</h3>
<span class="spacer"></span>
<button class="ghost" id="addMatBtn">+ Add Material</button>
</div>
<table>
<thead><tr><th>Use</th><th>Item</th><th>Supplier</th><th>Units</th><th>Unit Price</th><th>Qty</th><th>Ext.</th><th></th></tr></thead>
<tbody id="matTbody"></tbody>
<tfoot><tr><td class="right" colspan="6">Materials Subtotal</td><td class="right mono" id="matSubtotal">$0.00</td><td></td></tr></tfoot>
</table>
<details id="mat_diag" style="margin-top:8px"><summary>Diagnostics</summary>
<pre id="mat_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
<!-- === Turcotte: Stucco Helper (Area‑based) — integrated, Stucco-tab only === -->
<!-- === Turcotte: Stucco Helper (Area‑based) — CLEAN REBUILD === -->
<!-- === Turcotte: Stucco Helper (Area-based) — v15 SAFE === -->
<!-- === Turcotte: Stucco Helper (Area-based) — v18 CLEAN === -->
</div><!-- /materials-shell -->
<div class="card" data-card-stucco="" data-cat="stucco" id="stuccoCard">
<div class="row">
<h3 style="margin:0">Stucco Helper (Area‑based)</h3>
<span class="spacer"></span>
<div class="group">
<label class="pill"><input checked="" id="stu_sys_eifs" name="stu_sys" type="radio" value="eifs"/> Synthetic EIFS</label>
<label class="pill"><input id="stu_sys_trad" name="stu_sys" type="radio" value="trad"/> Traditional</label>
</div>
</div>
<div class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px">
<label>Wall Area (sf) <input id="stu_area" min="0" placeholder="e.g., 550" step="1" type="number"/></label>
<label>Waste % <input id="stu_waste" min="0" step="0.5" type="number" value="10"/></label>
<label class="pill"><input checked="" id="stu_round" type="checkbox"/> Round up quantities</label>
</div>
<div class="row" id="stu_finish_row" style="flex-wrap:wrap; gap:10px; margin-top:6px">
<label>Finish Product
      <select id="stu_finish_sel" style="min-width:280px">
<option value="parex_coarse">Parex DPR Sand Coarse — 5 gal</option>
<option value="parex_fine">Parex DPR Sand Fine — 5 gal</option>
<option value="parex_swirl">Parex DPR Swirl Fine — 5 gal</option>
<option value="parex_smooth">Parex DPR Sand Smooth — 5 gal</option>
<option value="mp_rolltex">MP Roll‑Tex Coating — 5 gal</option>
<option value="specmix_s">SPEC MIX Type S — 80 lb</option>
</select>
</label>
<label>Finish yield (sf per unit)
      <input id="stu_finish_yield" min="1" step="1" type="number" value="90"/>
</label>
</div>
<div class="row" id="stu_finish_ctrls" style="flex-wrap:wrap; gap:10px; margin-top:6px">
<label class="pill"><input checked="" id="stu_finish_use_mat" type="checkbox"/> Use materials yield</label>
</div>
<!-- EIFS-only options -->
<div class="subcard" id="stu_eifs_opts">
<div class="row"><b>EIFS yields (fixed)</b><span class="muted small">Basecoat 55 sf/bag · Mesh 475 sf/roll · Finish per above</span></div>
<div class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px">
<label class="pill"><input id="stu_use_foam" onchange="try{window.stuccoCalc&amp;&amp;stuccoCalc()}catch(e){}" oninput="try{window.stuccoCalc&amp;&amp;stuccoCalc()}catch(e){}" type="checkbox"/> Include foam</label>
<label>Foam bundle (2'×4') 
        <select id="stu_foam_sel" onchange="try{window.stuccoCalc&amp;&amp;stuccoCalc()}catch(e){}" oninput="try{window.stuccoCalc&amp;&amp;stuccoCalc()}catch(e){}" style="min-width:320px">
<span class="text-xs text-gray-500 ml-2" id="stu_foam_note"></span>
<option value="foam_2">EPS EIFS Foam — 2" (2'×4', 9 sheets) per bundle</option>
<option value="foam_1_5">EPS EIFS Foam — 1.5" (2'×4', 13 sheets) per bundle</option>
<option value="foam_1">EPS EIFS Foam — 1" (2'×4', 18 sheets) per bundle</option>
<option value="foam_0_75">EPS EIFS Foam — 3/4" (2'×4', 30 sheets) per bundle</option>
</select>
</label>
</div>
</div>
<!-- Traditional-only options -->
<div class="subcard" id="stu_trad_opts" style="display:none">
<div class="row"><b>Traditional additives</b><span class="muted small">Enter optional LF/SF for accessories</span></div>
<div class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px">
<label>Netting — sf per roll/sheet <input id="stu_trad_net_sfb" min="0" placeholder="e.g., 400" step="1" type="number"/></label>
<label>Casing bead (LF) <input id="stu_trad_bead_lf" min="0" placeholder="optional" step="1" type="number"/></label>
<label>Wood lath strips (LF) <input id="stu_trad_lath_lf" min="0" placeholder="optional" step="1" type="number"/></label>
</div>
</div>
<div class="row" style="gap:18px">
<div class="col">
<h4>Quantities</h4>
<div class="small" id="stu_results"></div>
<details id="stu_diag" style="margin-top:8px">
<summary>Diagnostics</summary>
<pre id="stu_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
<div class="col">
<h4>Scope Lines</h4>
<textarea id="stu_scope" rows="8" style="width:100%;font-family:monospace"></textarea>
<button class="ghost" id="stu_copy">Copy to clipboard</button>
</div>
</div>
</div>
<!-- BEGIN: Chimney Helper (embedded) -->
<div class="card" data-card-chimney="" data-cat="masonry" id="chimneyCard">
<div class="row">
<h3 style="margin:0">Chimney Helper</h3>
<span class="spacer"></span>
</div>
<div class="row">
<div class="group" style="display:block; width:100%">
<div class="card" id="optsCard" tight"="">
<div class="row">
<div class="kpi">Mode</div>
<label class="pill"><input checked="" id="mode_inches" name="mode" type="radio"/> By inches</label>
<label class="pill"><input id="mode_brick" name="mode" type="radio"/> By brick count (per side)</label>
<span class="spacer"></span>
<label class="pill"><input checked="" id="opt_round" type="checkbox"/> Round up quantities</label>
<label class="pill"><input checked="" id="opt_crown" type="checkbox"/> Include concrete crown</label>
<label class="pill"><input checked="" id="opt_flash" type="checkbox"/> Include flashing</label>
<label class="pill"><input id="no_cap" type="checkbox"/> Spark Arrestor</label>
</div>
</div>
<div "="" class="card" id="geomCard">
<h2>Geometry</h2>
<div class="row grid" id="byInches">
<label>Outside width (in)
        <input id="w_in" min="0" step="1" type="number" value="0"/>
</label>
<label>Outside depth (in)
        <input id="d_in" min="0" step="1" type="number" value="0"/>
</label>
<label>Rebuild height (ft)
        <input id="h_ft" min="0" step="1" type="number" value="0"/>
</label>
<label>in
        <input id="h_in" max="11" min="0" step="1" type="number" value="0"/>
</label>
<label>Waste %
        <input id="waste" min="0" step="0.5" type="number" value="10"/>
</label>
</div>
<div class="row grid" id="byBrick" style="display:none">
<label>Side A — bricks per side (full‑brick eq.)
        <input id="brixA" min="0" step="1" type="number" value="0"/>
</label>
<label>Side B — bricks per side (full‑brick eq.)
        <input id="brixB" min="0" step="1" type="number" value="0"/>
</label>
<label>Brick preset
        <select id="brickPreset">
<option selected="" value="mod">Modular (7.625 × 2.25 actual)</option>
<option value="util">Utility (11.625 × 2.25 actual)</option>
<option value="custom">Custom</option>
</select>
</label>
<label>Actual brick length (in)
        <input id="b_len" min="6" step="0.125" type="number" value="7.625"/>
</label>
<label>Actual brick height (in)
        <input id="b_hgt" min="1.5" step="0.125" type="number" value="2.25"/>
</label>
<label>Mortar joint (in)
        <input id="joint" max="0.5" min="0.25" step="0.125" type="number" value="0.375"/>
</label>
<label>Rebuild height (ft)
        <input id="h_ft_b" min="0" step="1" type="number" value="0"/>
</label>
<label>in
        <input id="h_in_b" max="11" min="0" step="1" type="number" value="0"/>
</label>
<label>Waste %
        <input id="waste_b" min="0" step="0.5" type="number" value="10"/>
</label>
<div class="muted">Tip: In running bond, halves on one face become fulls on the next. Total bricks per course ≈ <b>2×(A+B)</b>.</div>
</div>
<div class="muted" id="geomNote"></div>
</div>
<div "="" class="card" id="unitsCard">
<h2>Units &amp; Liners</h2>
<div class="section-box"><div class="row grid">
<label>Brick Size
        <select id="bpsf">
<option selected="" value="7">7 5/8" × 3 5/8" × 2 1/4" ≈ 7</option>
<option value="6">7 5/8" × 2 3/4" × 2 3/4" ≈ 6</option>
<option value="5.3">11 5/8" × 3 5/8" × 2 1/4" ≈ 5.3</option>
</select>
</label>
<label>Flue tile length (in)
        <input id="tile_len" min="12" step="1" type="number" value="24"/>
</label>
<label>Projection above crown (in)
        <input id="proj_in" min="0" step="0.5" type="number" value="2"/>
</label>
<label>Flue tile size
        <select id="flue_size">
<option value="8x8">8×8</option>
<option selected="" value="8x12">8×12</option>
<option value="12x12">12×12</option>
<option value="13x18">13×18</option>
</select>
</label>
<label class="pill" style="grid-column:1/-1; align-items:center">
<input checked="" id="auto_tiles" type="checkbox"/> Auto‑calculate flue tiles from height
      </label>
</div>
</div>
<div "="" class="card" id="crownCard">
<h2>Concrete Crown (if included)</h2>
<div class="row grid">
<label>Average thickness (in)
        <input id="crown_thk" min="1.5" step="0.25" type="number" value="4"/>
</label>
<label>Overhang each side (in)
        <input id="crown_oh" min="0" step="0.25" type="number" value="1.5"/>
</label>
<label>Flash height for copper (in) <span class="muted">(for sheet area est.)</span>
<input id="flash_h" min="6" step="0.5" type="number" value="8"/>
</label>
</div>
</div></div>
<div "="" class="card" id="resultsCard">
<div class="row">
<h2 style="margin:0">Results</h2>
<span class="spacer"></span>
<button class="ghost" id="copyScope">Copy scope</button>
</div>
<div class="row" id="kpis" style="gap:8px; margin:6px 0 8px 0"></div>
<div class="muted" id="calcOut"></div>
<h3>Scope (copy‑ready)</h3>
<textarea id="scope" placeholder="Scope lines will appear here…"></textarea>
</div>
</div>
</div>
<details id="chim_diag" style="margin-top:8px"><summary>Diagnostics</summary>
<pre id="chim_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
<script id="chimney_mode_helper_fix">
(function(){
  function $(s,c){return (c||document).querySelector(s);}
  function applyMode(){
    var byI = $('#byInches'), byB = $('#byBrick');
    var rb = $('#mode_brick');
    if(!byI || !byB || !rb) return;
    var brickMode = !!rb.checked;
    byI.style.display = brickMode ? 'none':'grid';
    byB.style.display = brickMode ? 'grid':'none';
    try{ if (typeof calc==='function') calc(); }catch(_){}
  }
  function bind(){
    var r1=$('#mode_inches'), r2=$('#mode_brick');
    if(r1){ r1.addEventListener('change', applyMode); r1.addEventListener('input', applyMode); }
    if(r2){ r2.addEventListener('change', applyMode); r2.addEventListener('input', applyMode); }
    // Label clicks
    var card = document.getElementById('chimneyCard');
    if(card){
      card.addEventListener('click', function(e){
        var t=e.target;
        if(t && (t.matches('label')||t.closest('label')) && (card.contains($('#mode_inches'))||card.contains($('#mode_brick')))){
          setTimeout(applyMode,0);
        }
      });
    }
    applyMode();
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true}); else bind();
})();
</script>
</div>
<!-- END: Chimney Helper (embedded) -->
<script>
(function(){
  const MATCH = {
    basecoat: /GREEN\s*MAKER.*Decoplast.*Premium.*Basecoat/i,
    mesh:     /Standard.*EIFS.*Fiberglass.*Mesh/i,
    foam:     /foam/i,
    parex_coarse:/Parex.*DPR.*Sand.*Coarse/i,
    parex_fine:/Parex.*DPR.*Sand.*Fine/i,
    parex_swirl:/Parex.*DPR.*Swirl.*Fine/i,
    parex_smooth:/Parex.*DPR.*Sand.*Smooth/i,
    mp_rolltex:/MP.*Roll[\-‑]?Tex.*5\s*gal/i,
    specmix_s:/Spec\s*Mix.*Type\s*-?S.*80\s*lb/i,
    netting:  /stucco\s*netting|galvanized.*netting/i,
    bead:     /stucco.*casing.*bead/i,
    lath:     /wood.*lath/i
  };
  const YIELD = { eifs_base:55, eifs_mesh:475 };

  const FINISH_EIFS = [
    { id:'parex_coarse', label:'Parex DPR Sand Coarse — 5 gal', regex:MATCH.parex_coarse, unit:'bucket', default_sf:80 },
    { id:'parex_fine',   label:'Parex DPR Sand Fine — 5 gal',   regex:MATCH.parex_fine,   unit:'bucket', default_sf:130 },
    { id:'parex_swirl',  label:'Parex DPR Swirl Fine — 5 gal',  regex:MATCH.parex_swirl,  unit:'bucket', default_sf:120 },
    { id:'parex_smooth', label:'Parex DPR Sand Smooth — 5 gal', regex:MATCH.parex_smooth, unit:'bucket', default_sf:160 },
    { id:'mp_rolltex',   label:'MP Roll‑Tex Coating — 5 gal',   regex:MATCH.mp_rolltex,   unit:'bucket', default_sf:150 }
  ];
  const FINISH_TRAD = [
    { id:'specmix_s', label:'SPEC MIX Type S — 80 lb', regex:MATCH.specmix_s, unit:'bag', default_sf:40 }
  ];
  const FOAM_BUNDLES = [
    { id:'foam_2',    label:'EPS EIFS Foam — 2\" (2\'×4\', 9 sheets) per bundle',    sheets:9,  w:2, h:4, regex:/EIFS.*Foam.*2\s*(\"|inch|in)\b/i },
    { id:'foam_1_5',  label:'EPS EIFS Foam — 1.5\" (2\'×4\', 13 sheets) per bundle', sheets:13, w:2, h:4, regex:/EIFS.*Foam.*1\.??5\s*(\"|inch|in)\b/i },
    { id:'foam_1',    label:'EPS EIFS Foam — 1\" (2\'×4\', 18 sheets) per bundle',   sheets:18, w:2, h:4, regex:/EIFS.*Foam.*1\s*(\"|inch|in)\b/i },
    { id:'foam_0_75', label:'EPS EIFS Foam — 3\/4\" (2\'×4\', 30 sheets) per bundle', sheets:30, w:2, h:4, regex:/(EIFS.*Foam.*3\/4\"|EIFS.*Foam.*0\.??75\s*(\"|inch|in)\b)/i }
  ];

  const $  = (s,c=document)=>c.querySelector(s);
  const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));
  const num = (v)=>{ const s=String(v??'').trim().replace(/[,$]/g,''); return s?parseFloat(s)||0:0; };
  const esc = (t)=>String(t).replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
  const roundRule = (n, up)=> up ? Math.ceil(n) : Math.round(n*100)/100;

  function matFindRow(regex){
    let rows = $$('#matTbody tr');
    if(!rows || rows.length===0){
      rows = Array.from(document.querySelectorAll('tr')).filter(r => r.querySelector('.mat_item, .mat_use, .mat_qty'));
    }
    for(const tr of rows){
      const name = (tr.querySelector('.mat_item')?.value || '').toLowerCase();
      const sup  = (tr.querySelector('.mat_sup')?.value  || '').toLowerCase();
      const txt  = (tr.textContent || '').toLowerCase();
      const hay  = name + ' ' + sup + ' ' + txt;
      try{ if(regex.test(hay)) return tr; }catch(e){}
    }
    return null;
  }
  function matSetQtyAndUse(tr, qty){
    if(!tr) return false;
    const useCb  = tr.querySelector('.mat_use');
    const qtyInp = tr.querySelector('.mat_qty');
    if(useCb && !useCb.checked){ useCb.click(); useCb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qtyInp){
      qtyInp.value = String(qty);
      qtyInp.dispatchEvent(new Event('input', {bubbles:true}));
      qtyInp.dispatchEvent(new Event('change',{bubbles:true}));
    }
    return true;
  }
  function matClear(tr){
    if(!tr) return;
    const useCb  = tr.querySelector('.mat_use');
    const qtyInp = tr.querySelector('.mat_qty');
    if(qtyInp){ qtyInp.value=''; qtyInp.dispatchEvent(new Event('input',{bubbles:true})); qtyInp.dispatchEvent(new Event('change',{bubbles:true})); }
    if(useCb && useCb.checked){ useCb.click(); useCb.dispatchEvent(new Event('change',{bubbles:true})); }
  }

  function parseSfFromText(s){
    if(!s) return 0;
    const m = String(s).match(/(\d+(?:\.\d+)?)\s*(?:sf|sq\s*[\.\-]?\s*ft|square\s*feet)/i);
    return m ? parseFloat(m[1]) : 0;
  }
  function getMaterialYield(regex){
    const tr = matFindRow(regex);
    if(!tr) return 0;
    const keys = ['data-sf','data-sfper','data-sf-per','data-coverage','data-cover','data-yield','data-sf_per_unit'];
    for(const k of keys){ const v = tr.getAttribute(k); if(v && !isNaN(parseFloat(v))) return parseFloat(v); }
    const t = tr.textContent || '';
    const n = parseSfFromText(t); if(n>0) return n;
    const cells = Array.from(tr.cells || []);
    for(const td of cells){ const n2 = parseSfFromText(td.textContent || ''); if(n2>0) return n2; }
    // Fallback: look into in-memory materials[] for coverageSqft
    try{
      if (typeof materials !== 'undefined' && Array.isArray(materials) && materials.length) {
        // Try by regex against materials.item
        const rx = regex;
        const row = materials.find(m => { try { return rx && rx.test(String(m.item||'')); } catch(e){ return false; } });
        if(row && row.coverageSqft && !isNaN(parseFloat(row.coverageSqft))) return parseFloat(row.coverageSqft);
      }
    } catch(e){ /* ignore */ }
    return 0;
  }

  const MAT_NAME_MAP = {
    basecoat: "GREEN MAKER Decoplast Premium Basecoat — 50 lb",
    parex_coarse: "Parex DPR Sand Coarse — 5 gal",
    parex_fine:   "Parex DPR Sand Fine — 5 gal",
    parex_swirl:  "Parex DPR Swirl Fine — 5 gal",
    parex_smooth: "Parex DPR Sand Smooth — 5 gal",
    mp_rolltex:   "MP Roll‑Tex Coating — 5 gal",
    specmix_s:    "SPEC MIX Type S — 80 lb",
    foam_2:       "EPS EIFS Foam — 2\" (2'×4', 9 sheets) per bundle",
    foam_1_5:     "EPS EIFS Foam — 1.5\" (2'×4', 13 sheets) per bundle",
    foam_1:       "EPS EIFS Foam — 1\" (2'×4', 18 sheets) per bundle",
    foam_0_75:    "EPS EIFS Foam — 3/4\" (2'×4', 30 sheets) per bundle"
  };
  function matFindByItemName(name){
    if(!name) return null;
    const rows = Array.from(document.querySelectorAll('tr')).filter(r => r.querySelector('.mat_item'));
    const target = name.toLowerCase().trim();
    for(const tr of rows){
      const v = (tr.querySelector('.mat_item')?.value || '').toLowerCase().trim();
      if(v === target) return tr;
    }
    return null;
  }
  function matGetRowByKey(key){
    const byName = MAT_NAME_MAP[key] ? matFindByItemName(MAT_NAME_MAP[key]) : null;
    if(byName) return byName;
    const rxMap = {
      basecoat: MATCH.basecoat,
      parex_coarse: MATCH.parex_coarse,
      parex_fine:   MATCH.parex_fine,
      parex_swirl:  MATCH.parex_swirl,
      parex_smooth: MATCH.parex_smooth,
      mp_rolltex:   MATCH.mp_rolltex,
      specmix_s:    MATCH.specmix_s,
      foam_2:       /2\s*(?:\"|inch|in)\b/i,
      foam_1_5:     /1\.??5\s*(?:\"|inch|in)\b/i,
      foam_1:       /1\s*(?:\"|inch|in)\b/i,
      foam_0_75:    /(3\/4\"|0\.??75\s*(?:\"|inch|in)\b)/i
    };
    const rx = rxMap[key];
    return rx ? matFindRow(rx) : null;
  }

  const FINISH_KEYS_EIFS = ['parex_coarse','parex_fine','parex_swirl','parex_smooth','mp_rolltex'];
  const FINISH_KEYS_TRAD = ['specmix_s'];
  const FOAM_KEYS        = ['foam_2','foam_1_5','foam_1','foam_0_75'];
  function matClearKeys(keys){ (keys||[]).forEach(k=>{ const tr = matGetRowByKey(k); if(tr) matClear(tr); }); }
  function matClearGroupExcept(keys, keepKey){ (keys||[]).forEach(k=>{ if(k!==keepKey){ const tr = matGetRowByKey(k); if(tr) matClear(tr); } }); }

  function getFinishChoice(){
    const isEIFS = $('#stu_sys_eifs')?.checked;
    const sel = $('#stu_finish_sel');
    const list = isEIFS ? FINISH_EIFS : FINISH_TRAD;
    return list.find(o=>o.id === (sel?.value||'')) || list[0];
  }
  function getFoamChoice(){
    const sel = $('#stu_foam_sel');
    const id = sel?.value || 'foam_2';
    return FOAM_BUNDLES.find(f=>f.id===id) || FOAM_BUNDLES[0];
  }
  function syncFinishYield(){
    const choice = getFinishChoice();
    const yEl = $('#stu_finish_yield');
    const useMat = $('#stu_finish_use_mat')?.checked;
    const src = $('#stu_finish_yield_src');
    let note = '';
    if(useMat){
      const y = getMaterialYield(choice.regex);
      if(y && yEl){ yEl.value = y; note = '(from Materials: '+y+' sf/unit)'; }
      else { note = '(Materials yield not found — using manual/default)'; }
    } else { note = '(manual)'; }
    if(src) src.textContent = note;
  }

  function stuccoCalc(){
    const area = num($('#stu_area')?.value);
    const wastePct = num($('#stu_waste')?.value);
    const roundUp  = !!$('#stu_round')?.checked;
    const isEIFS   = $('#stu_sys_eifs')?.checked;
    const areaEff = area * (1 + (wastePct/100));
    const res = { lines: [], html: [], debug: [] }



;

    if(!area || area <= 0){
      $('#stu_results').innerHTML = '<div class="muted">Enter an area in square feet to begin.</div>';
      $('#stu_scope').value = '';
      
      try{
        // Clear EIFS/Traditional stucco materials if area is cleared
        matClearKeys(['basecoat','mesh']);
        matClearKeys(FINISH_KEYS_EIFS);
        matClearKeys(FINISH_KEYS_TRAD);
        matClearKeys(FOAM_KEYS);
      }catch(e){}
      
      /* __STUCCO_ZERO_HARD_CLEAR__ */
      try{
        const tbody = document.getElementById('matTbody');
        if (tbody){
          // Explicit stucco SKUs to clear (EIFS basecoat, mesh, finishes, foam)
          ['m2002','m2003','m2004','m2005','m2006','m2007','m2008','m2009'].forEach(function(id){
            var tr = tbody.querySelector('tr[data-id="'+id+'"]');
            if (tr){
              var q = tr.querySelector('.mat_qty'); if(q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
              var cb = tr.querySelector('.mat_use'); if(cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); }
            }
          });
          // Fallback by regex match in case labels/ids change
          Array.from(tbody.querySelectorAll('tr')).forEach(function(tr){
            var t = (tr.textContent||'').toLowerCase();
            if(/standard.*eifs.*fiberglass.*mesh/.test(t) || /decoplast.*basecoat/.test(t) || /parex.*dpr/.test(t) || /\beifs.*foam|\bfoam\b/.test(t)){
              var q = tr.querySelector('.mat_qty'); if(q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
              var cb = tr.querySelector('.mat_use'); if(cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); }
            }
          });
        }
        // Force totals refresh so leftover prices drop immediately
        if (typeof window.updateAll === 'function') window.updateAll();
        else if (typeof window.totals === 'function') window.totals();
      }catch(e){}
      /* __/STUCCO_ZERO_HARD_CLEAR__ */

      return;
    }if(isEIFS){
      // Basecoat
      let base_bags = areaEff / YIELD.eifs_base;
      base_bags = roundRule(base_bags, roundUp);
      const base_tr = matGetRowByKey('basecoat');
      if(base_tr && base_bags>0) matSetQtyAndUse(base_tr, areaEff);
      res.html.push('<div><strong>Basecoat (Decoplast 50 lb):</strong> '+base_bags+' bags</div>');
      res.lines.push('EIFS basecoat (Decoplast Premium, 50 lb): ≈ '+base_bags+' bags ('+YIELD.eifs_base+' sf/bag).');
      res.debug.push('basecoat_bags='+base_bags);

      // Mesh
      let mesh_rolls = areaEff / YIELD.eifs_mesh;
      mesh_rolls = roundRule(mesh_rolls, roundUp);
      const mesh_tr = matFindRow(MATCH.mesh);
      if(mesh_tr && mesh_rolls>0) matSetQtyAndUse(mesh_tr, areaEff);
      res.html.push('<div><strong>EIFS Mesh (38&quot;×150&quot;):</strong> '+mesh_rolls+' rolls</div>');
      res.lines.push('Embed Standard EIFS fiberglass mesh: ≈ '+mesh_rolls+' rolls (38&quot;×150&quot;, '+YIELD.eifs_mesh+' sf/roll).');
      res.debug.push('mesh_rolls='+mesh_rolls);

      // Finish (clear other finishes first)
      matClearKeys(FINISH_KEYS_TRAD);
      const finChoice = getFinishChoice();
      const useMat = $('#stu_finish_use_mat')?.checked;
      const matYield = useMat ? getMaterialYield(finChoice.regex) : 0;
      const fin_sf = Math.max(1, matYield || num($('#stu_finish_yield')?.value) || finChoice.default_sf);
      let fin_units = areaEff / fin_sf; fin_units = roundRule(fin_units, roundUp);
      matClearGroupExcept(FINISH_KEYS_EIFS, finChoice.id);
      const fin_tr = matGetRowByKey(finChoice.id);
      if(fin_tr && fin_units>0) matSetQtyAndUse(fin_tr, areaEff);
      res.html.push('<div><strong>'+esc(finChoice.label)+':</strong> '+fin_units+' '+(finChoice.unit==='bag'?'bags':'buckets')+'</div>');
      res.lines.push('Finish ('+finChoice.label+'): ≈ '+fin_units+' '+(finChoice.unit==='bag'?'bags':'buckets')+' ('+fin_sf+' sf per unit).');
      res.debug.push('finish_units='+fin_units+', fin_sf='+fin_sf);

      // Foam
      var __cb=document.getElementById('stu_use_foam'); if(__cb && __cb.checked){
        const foam = getFoamChoice();
        const perBoard = foam.w * foam.h; // 2x4 = 8 sf
        const perBundle = foam.sheets * perBoard;
        let bundles = Math.ceil(areaEff / perBundle);
        const boards = bundles * foam.sheets;
        var __fn=document.getElementById('stu_foam_note'); if(__fn){ __fn.textContent = '('+perBundle+' sf/bundle · '+foam.sheets+' boards/bundle)'; }
        res.html.push('<div><strong>Foam ('+esc(foam.label)+'):</strong> '+bundles+' bundles (~'+boards+' boards)</div>');
        res.lines.push('EIFS foam 2×4 ft sheets: ≈ '+bundles+' bundles (~'+boards+' boards).');
        matClearGroupExcept(FOAM_KEYS, foam.id);
        const foam_tr = matGetRowByKey(foam.id) || matFindRow(MATCH.foam);
        if(foam_tr){
          const text = (foam_tr.textContent||'').toLowerCase();
          const wantsBundles = /bundle/.test(text);
          matSetQtyAndUse(foam_tr, areaEff);
        }
        res.debug.push('foam_bundles='+bundles+', perBundle='+perBundle);
      } else {
        matClearKeys(FOAM_KEYS);
      }
    } else {
      // Traditional
      (function(){ try{
        const base_tr = matGetRowByKey('basecoat'); if(base_tr) matClear(base_tr);
        const mesh_tr = matFindRow(MATCH.mesh); if(mesh_tr) matClear(mesh_tr);
        matClearKeys(FINISH_KEYS_EIFS);
        matClearKeys(FOAM_KEYS);
      }catch(e){} })();

      const finChoice = getFinishChoice();
      const useMat = $('#stu_finish_use_mat')?.checked;
      const matYield = useMat ? getMaterialYield(finChoice.regex) : 0;
      const fin_sf = Math.max(1, matYield || num($('#stu_finish_yield')?.value) || finChoice.default_sf);
      let fin_units = areaEff / fin_sf; fin_units = roundRule(fin_units, roundUp);
      const trF = matGetRowByKey(finChoice.id);
      if(trF && fin_units>0) matSetQtyAndUse(trF, fin_units);
      res.html.push('<div><strong>'+esc(finChoice.label)+':</strong> '+fin_units+' '+(finChoice.unit==='bag'?'bags':'buckets')+'</div>');
      res.lines.push('Traditional finish ('+finChoice.label+'): ≈ '+fin_units+' '+(finChoice.unit==='bag'?'bags':'buckets')+' ('+fin_sf+' sf per unit).');

      const netS = num($('#stu_trad_net_sfb')?.value);
      if(netS>0){
        let nets = areaEff / netS; nets = roundRule(nets, roundUp);
        res.html.push('<div><strong>Stucco netting:</strong> '+nets+' rolls/sheets</div>');
        res.lines.push('Galvanized stucco netting: ≈ '+nets+' rolls/sheets ('+netS+' sf each).');
        const tr = matFindRow(MATCH.netting);
        if(tr && nets>0) matSetQtyAndUse(tr, nets);
      } else {
        res.html.push('<div>Stucco netting: <span class="muted">enter sf per roll/sheet</span></div>');
      }

      const bead = num($('#stu_trad_bead_lf')?.value);
      if(bead>0){
        res.html.push('<div><strong>Casing bead:</strong> '+bead+' LF</div>');
        res.lines.push('Galvanized stucco casing bead: ≈ '+bead+' LF.');
        const tr = matFindRow(MATCH.bead);
        if(tr) matSetQtyAndUse(tr, bead);
      }
      const lath = num($('#stu_trad_lath_lf')?.value);
      if(lath>0){
        res.html.push('<div><strong>Wood lath strips:</strong> '+lath+' LF</div>');
        res.lines.push('Wood lath strips: ≈ '+lath+' LF.');
        const tr = matFindRow(MATCH.lath);
        if(tr) matSetQtyAndUse(tr, lath);
      }
    }

    $('#stu_results').innerHTML = res.html.join('');
    const header = isEIFS ? 'Synthetic EIFS stucco — area '+area+' sf (+ '+wastePct+'% waste).'
                          : 'Traditional stucco — area '+area+' sf (+ '+wastePct+'% waste).';
    $('#stu_scope').value = [header].concat(res.lines).join('\n');
    const pre = $('#stu_diag_pre'); if(pre) pre.textContent = 'areaEff='+areaEff+'\n'+res.debug.join('\n');
  }
/* __STUCCO_BINDINGS__ */
try { window.stuccoCalc = stuccoCalc; } catch(e){}

document.addEventListener('DOMContentLoaded', function(){
  function bind(sel, ev){
    var el = document.querySelector(sel);
    if(!el) return;
    el.addEventListener(ev, function(){ try{ stuccoCalc(); }catch(e){} }, true);
  }
  // Core drivers
  bind('#stu_area','input');
  bind('#stu_waste','input');
  bind('#stu_round','change');
  bind('#stu_sys_eifs','change');
  bind('#stu_sys_trad','change');
  // Finishes + foam
  bind('#stu_finish_sel','change');
  bind('#stu_finish_yield','input');
  bind('#stu_finish_use_mat','change');
  bind('#stu_foam_sel','change');
  bind('#stu_use_foam','change');

  // Kick once on load
  try{ stuccoCalc(); }catch(e){}
});
/* __/STUCCO_BINDINGS__ */


  function bind(){
    ['stu_area','stu_waste','stu_round','stu_finish_yield','stu_trad_net_sfb','stu_trad_bead_lf','stu_trad_lath_lf']
      .forEach(id => { const el = document.getElementById(id); if(el){ el.addEventListener('input', stuccoCalc); el.addEventListener('change', stuccoCalc); }});

    document.querySelectorAll('#stuccoCard input[name=\"stu_sys\"]').forEach(el=> el.addEventListener('change', function(){
      const eifs = (this.value === 'eifs');
      $('#stu_eifs_opts').style.display = eifs ? '' : 'none';
      $('#stu_trad_opts').style.display = eifs ? 'none' : '';
      const sel = $('#stu_finish_sel');
      if(sel){
        sel.innerHTML = '';
        (eifs ? FINISH_EIFS : FINISH_TRAD).forEach(o=>{
          const op = document.createElement('option'); op.value=o.id; op.textContent=o.label; sel.appendChild(op);
        });
        $('#stu_finish_yield').value = (eifs ? FINISH_EIFS[0].default_sf : FINISH_TRAD[0].default_sf);
      }
      syncFinishYield();
      stuccoCalc();
    }));

    $('#stu_finish_sel')?.addEventListener('change', ()=>{ syncFinishYield(); stuccoCalc(); });
    $('#stu_finish_use_mat')?.addEventListener('change', ()=>{ syncFinishYield(); stuccoCalc(); });
    $('#stu_foam_sel')?.addEventListener('change', ()=>{ stuccoCalc(); });
    $('#stu_use_foam')?.addEventListener('change', ()=>{ stuccoCalc(); });

    const sel = $('#stu_finish_sel');
    if(sel && sel.options.length===0){ FINISH_EIFS.forEach(o=>{ const op=document.createElement('option'); op.value=o.id; op.textContent=o.label; sel.appendChild(op); }); }
    syncFinishYield();
    stuccoCalc();

    try{
      const matBody = document.getElementById('matTbody');
      if(matBody){
        let __stucco_obs_timer = null;
        const onMatChange = () => {
          if(__stucco_obs_timer) cancelAnimationFrame(__stucco_obs_timer);
          __stucco_obs_timer = requestAnimationFrame(()=>{ __stucco_obs_timer=null; if(typeof window.stuccoCalc==='function') window.stuccoCalc(); });
        };
        const mo = new MutationObserver(onMatChange);
        mo.observe(matBody, {childList:true, subtree:false});
      }
    }catch(e){}

    window.stuccoCalc = stuccoCalc;
    window.addEventListener('error', function(e){
      const pre = document.getElementById('stu_diag_pre');
      if(pre){ pre.textContent = (pre.textContent?pre.textContent+'\n':'') + 'JS Error: '+(e.message||e.error); }
    });
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
  else { bind(); }
})();
</script>
</div>
<!-- CONCRETE -->
<div class="card" data-cat="concrete" id="concreteCard">
<div class="concrete-shell" id="concreteShell">
<div class="row">
<h3 style="margin:0">Concrete</h3>
<!-- Turcotte: Concrete Yards Helper v1 (2025-09-02) -->
<div class="subcard" id="tm-concrete-yards-helper" style="border:1px dashed #ccc; padding:10px; margin:10px 0;">
<div class="row" style="flex-wrap:wrap; gap:10px;">
<b>Concrete Yards Calculator</b>
<label>L (ft) <input id="tm_len_ft" placeholder="e.g., 11" step="0.1" type="number"/></label>
<label>W (ft) <input id="tm_wid_ft" placeholder="e.g., 11" step="0.1" type="number"/></label>
<label>H (in) <input id="tm_thk_in" placeholder="e.g., 6" step="0.25" type="number"/></label>
<label class="pill"><input checked="" id="tm_waste_on" type="checkbox"/> +5% waste</label>
<label>Round to <select id="tm_round"><option value="0.25">¼ yd</option><option value="0.5">½ yd</option><option value="1">1 yd</option><option value="0">exact</option></select></label>
</div>
<div class="row small muted" style="margin-top:6px;">
    Formula: L × W × (T in ÷ 12) ÷ 27 = yd³. (Adds optional 5% waste. Auto-fills supplier by rule: &lt; 3 yd → Concrete Connections; ≥ 3 yd → Mohican Valley.) 30-bag cap: ≤ 30 bags stays as 80-lb bags; ≥ 31 bags routes to Concrete Connections.
  </div>
<div class="row" style="gap:10px; margin-top:8px;">
<div>Yards (computed): <span class="pill" id="tm_yards_out" style="min-width:80px; text-align:center;">—</span></div>
<div>Selected source: <span class="pill" id="tm_supplier_out" style="min-width:160px; text-align:center;">—</span></div>
</div>
<div class="subcard" style="margin-top:8px;">
<div class="row"><b>Bags Equivalent (approx.)</b><span class="spacer"></span><span class="muted small">Uses Quikrete/Sakrete published yields</span></div>
<div id="tm_bags_rows" style="display:flex;flex-direction:column;gap:4px;margin-top:6px;"></div>
</div>
<div class="row" style="margin-top:8px;">
<details id="concrete_diag">
<summary>Diagnostics</summary>
<pre id="concrete_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
</div>
<script>
(function(){
  const whenReady = (fn)=>{
    if (document.readyState === 'complete' || document.readyState === 'interactive'){
      setTimeout(fn, 0);
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  };

  whenReady(function(){
    const $ = (s, c=document)=>c.querySelector(s);
    const byId = id => document.getElementById(id);
    const num = v => {
      if (v===null || v===undefined) return 0;
      const s = String(v).trim().replace(/[,$]/g,'');
      if (!s) return 0;
      const n = parseFloat(s); return Number.isFinite(n)?n:0;
    };
    function roundTo(n, step){
      if (!step || step<=0) return n;
      return Math.round(n/step)*step;
    }
    function computeYards(L, W, T_in, wasteOn){
      let y = (L * W * (T_in/12)) / 27;
      if (wasteOn) y *= 1.05;
      return y;
    }

    // Bag math (80-lb)
    const BAG_YIELD_FT3_80 = 0.60; // industry published yield
    function bagCount80FromRawYards(yardsRaw){
      const cf = yardsRaw * 27;
      if (cf <= 0) return 0;
      const cnt = Math.ceil(cf / BAG_YIELD_FT3_80);
      return Math.max(1, cnt); // min 1 for any positive volume
    }

    // Materials helpers: find a row that looks like 80-lb concrete mix (Quikrete/Sakrete)
    function findConcreteBagRow(){
      const rows = Array.from(document.querySelectorAll('#matTbody tr'));
      for (const tr of rows){
        const t = (tr.textContent || '').toLowerCase();
        if (/(80\s*lb|80lb)/.test(t) && /(concrete|quikrete|sakrete)/.test(t)){
          return tr;
        }
      }
      return null;
    }
    function matSetQtyAndUse(tr, qty){
      if (!tr) return false;
      const useCb  = tr.querySelector('.mat_use');
      const qtyInp = tr.querySelector('.mat_qty');
      if (useCb && !useCb.checked){ useCb.click(); }
      if (qtyInp){
        qtyInp.value = qty;
        qtyInp.dispatchEvent(new Event('input', {bubbles:true}));
      }
      return true;
    }
    function matClearUse(tr){
      if (!tr) return;
      const useCb  = tr.querySelector('.mat_use');
      const qtyInp = tr.querySelector('.mat_qty');
      if (qtyInp){
        qtyInp.value = '';
        qtyInp.dispatchEvent(new Event('input', {bubbles:true}));
      }
      if (useCb && useCb.checked){ useCb.click(); }
    }

    // Yards targets
    let ctInput=null, mvInput=null, targetsReady=false;
    function tryFindTargets(){
      ctInput = byId('ct_yards');
      mvInput = byId('mv_yards');
      targetsReady = !!(ctInput && mvInput);
      return targetsReady;
    }
    const mo = new MutationObserver(()=>{
      if (!targetsReady && tryFindTargets()){
        recalc();
      }
    });
    mo.observe(document.documentElement || document.body, {childList:true, subtree:true});

    
    function applyRouting(yRaw, yRounded){
      // Manual override: if Rob types a bag count, sync that directly to Materials and skip yards routing
      const manualInp = byId('tm_bags_80_qty');
const manualQty = manualInp ? num(manualInp.value) : 0;
if (manualInp && manualQty > 0){
  if (manualQty <= 30) {
    if (ctInput) { ctInput.value = ''; ctInput.dispatchEvent(new Event('input', {bubbles:true})); }
    if (mvInput) { mvInput.value = ''; mvInput.dispatchEvent(new Event('input', {bubbles:true})); }
    const trMan = getOrCreateConcrete80Row();
    if (trMan) { matSetQtyAndUse(trMan, Math.floor(manualQty)); }
    const out0 = byId('tm_supplier_out'); if (out0) out0.textContent = `Bags (80-lb) — ${Math.floor(manualQty)} bags`;
    return;
  } else {
    // > 30 bags — clear manual entry and any existing 80-lb bag line; switch to yards routing
    manualInp.value = '';
    manualInp.dispatchEvent(new Event('input', {bubbles:true}));
    const trMan = getOrCreateConcrete80Row();
    if (trMan) { matClearUse(trMan); }
    // do not return; fall through to yards-based routing below
  }
}

      const out = byId('tm_supplier_out'); // now "source"
      const bagRow = findConcreteBagRow();
      const bagCount = bagCount80FromRawYards(yRaw);

      // Rule 1: If bags < 30 -> use bags pricing
      if (bagCount > 0 && bagCount <= 30){
        // Clear yard suppliers
        if (ctInput) { ctInput.value = ''; ctInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (mvInput) { mvInput.value = ''; mvInput.dispatchEvent(new Event('input', {bubbles:true})); }
        // Set bags
        const ok = matSetQtyAndUse(bagRow, bagCount);
        if (out) out.textContent = ok ? `Bags (80‑lb) — ${bagCount} bags` : 'Bags (80‑lb) — row not found';
        return;
      }

      // Otherwise: yards-based
      // Clear bag line if present
      matClearUse(bagRow);

      if (!targetsReady && !tryFindTargets()){
        if (out) out.textContent = 'Waiting for yard inputs…';
        return;
      }

      // Rule 2: Under 3 yards -> Concrete Connections
      // Rule 3: 3 yards or more -> Mohican Valley (last company)
      if (yRounded < 3){
        if (mvInput) { mvInput.value = ''; mvInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (ctInput) { ctInput.value = yRounded; ctInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (out) out.textContent = 'Concrete Connections';
      } else {
        if (ctInput) { ctInput.value = ''; ctInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (mvInput) { mvInput.value = yRounded; mvInput.dispatchEvent(new Event('input', {bubbles:true})); }
        if (out) out.textContent = 'Mohican Valley';
      }
    }

    function recalc(){
      const L = num(byId('tm_len_ft')?.value);
      const W = num(byId('tm_wid_ft')?.value);
      const T = num(byId('tm_thk_in')?.value);
      const waste = !!byId('tm_waste_on')?.checked;
      const step = parseFloat(byId('tm_round')?.value || '0.25');

      if (!L || !W || !T){
        const yOut = byId('tm_yards_out'); if (yOut) yOut.textContent = '—';
        const br = byId('tm_bags_rows'); if (br) br.innerHTML = '';
        if (byId('tm_supplier_out')) byId('tm_supplier_out').textContent = '—';
        const man = byId('tm_bags_80_qty');
if (man){
  man.value = '';
  man.dispatchEvent(new Event('input', {bubbles:true}));
}
// Also clear existing Materials row if present (without creating a new one)
try{
  const tr = (typeof findConcreteBagRowExact==='function') ? findConcreteBagRowExact() : null;
  if (tr){
    const q = tr.querySelector('.mat_qty'); if (q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); }
    const cb = tr.querySelector('.mat_use'); if (cb && cb.checked){ cb.click(); cb.dispatchEvent(new Event('change',{bubbles:true})); }
  }
}catch(e){}
try{
  // Clear manual 80‑lb bags (and thus Materials) if present
  const man = byId('tm_bags_80_qty');
  if (man){
    man.value = '';
    man.dispatchEvent(new Event('input', {bubbles:true}));
  }
  // Clear supplier yard inputs and trigger their own recalcs
  const ct = byId('ct_yards');
  if (ct){ ct.value = ''; ct.dispatchEvent(new Event('input', {bubbles:true})); }
  const mv = byId('mv_yards');
  if (mv){ mv.value = ''; mv.dispatchEvent(new Event('input', {bubbles:true})); }
  // Attempt a full totals refresh
  if (typeof window.updateAll === 'function') { window.updateAll(); }
  else if (typeof window.totals === 'function') { window.totals(); }
}catch(e){}

return;
      }

      // Compute raw and rounded yards
      const yRaw = computeYards(L, W, T, waste);
      const yRounded = Math.round(((step>0) ? roundTo(yRaw, step) : yRaw)*100)/100;

      // Display yards
      const yOut = byId('tm_yards_out');
      if (yOut) yOut.textContent = yRounded.toFixed(2);

      // Update bags display (from raw yards)
      const outB = byId('tm_bags_rows');
      if (outB) outB.style.display = 'none'; // hide the old computed box
      const cnt = bagCount80FromRawYards(yRaw);
      const man = byId('tm_bags_80_qty');
      if (man){
        // mirror computed → manual, but don't fight the user while typing
        if (document.activeElement !== man){
          man.value = (cnt > 0 ? String(cnt) : '');
          man.dispatchEvent(new Event('input', {bubbles:true}));
        }
      }

      // Route to source
      applyRouting(yRaw, yRounded);
    }

    // Wire events
    ['tm_len_ft','tm_wid_ft','tm_thk_in'].forEach(id=> byId(id)?.addEventListener('input', recalc));
    byId('tm_waste_on')?.addEventListener('change', recalc);
    byId('tm_round')?.addEventListener('change', recalc);

    // Init
    setTimeout(()=>{ tryFindTargets(); recalc(); }, 150);
    // === Manual 80‑lb bags → Materials sync (Turcotte) ===
    function findConcreteBagRowExact(){
      return document.querySelector('#matTbody tr[data-id="mNHM_Concrete_80lb"]') || findConcreteBagRow();
    }
    function ensureConcrete80Defaults(tr){
      if (!tr) return;
      const setVal = (sel,val)=>{ const el=tr.querySelector(sel); if(el){ el.value=val; el.dispatchEvent(new Event('input',{bubbles:true})); } };
      setVal('.mat_item','Concrete 80lb Bag');
      setVal('.mat_sup','New Haven Masonry');
      setVal('.mat_units','bag');
      setVal('.mat_price','6.36');
      const useCb = tr.querySelector('.mat_use'); if(useCb && !useCb.checked){ useCb.click(); useCb.dispatchEvent(new Event('change', {bubbles:true})); }
    }
    function getOrCreateConcrete80Row(){
      let tr = findConcreteBagRowExact();
      if (!tr) {
        const addBtn = document.getElementById('addMatBtn');
        if (addBtn) { addBtn.click(); }
        const rows = document.querySelectorAll('#matTbody tr');
        tr = rows[rows.length-1] || null;
      }
      if (tr) ensureConcrete80Defaults(tr);
      return tr;
    }
    function syncBagsToMaterials(){
      const inp = byId('tm_bags_80_qty'); if (!inp) return;
      const qty = Math.max(0, Math.floor(num(inp.value||0)));
      // Allow clearing to zero without forcing a material line
      const tr = (qty>0) ? getOrCreateConcrete80Row() : (typeof findConcreteBagRowExact==='function' ? findConcreteBagRowExact() : null);
      if (tr) {
        if (qty > 0) {
          matSetQtyAndUse(tr, qty);
        } else {
          // qty 0: clear qty and uncheck Use
          const qtyInp = tr.querySelector('.mat_qty');
          if (qtyInp){ qtyInp.value = ''; qtyInp.dispatchEvent(new Event('input',{bubbles:true})); }
          const useCb = tr.querySelector('.mat_use'); if(useCb && useCb.checked){ useCb.click(); }
        }
      }
    }
    // Build manual input UI once (placed next to the computed "Bags Equivalent" area)
    (function makeManualBagsUI(){
      const _br = byId('tm_bags_rows'); if (_br) { _br.style.display = 'none'; }
      const rowsWrap = byId('tm_bags_rows');
      const container = rowsWrap && rowsWrap.parentElement;
      if (container && !byId('tm_bags_80_qty')) {
        const row = document.createElement('div');
        row.className = 'row';
        row.style.gap='8px';
        row.style.marginTop = '6px';
        row.innerHTML = '<div class="pill">80 lb bags</div><div>=</div>' +
                        '<input id="tm_bags_80_qty" type="number" step="1" min="0" placeholder="0" style="width:100px">' +
                        '<span class="muted small">(syncs “Concrete 80lb Bag” in Materials)</span>';
        container.appendChild(row);
        byId('tm_bags_80_qty').addEventListener('input', function(){ syncBagsToMaterials(); });
      }
    })();

  });
})();
</script>
<!-- /Turcotte helper -->
<span class="pill">Concrete Connections (≤ 3 yd/trip)</span>
<span class="pill">Mohican Valley (10‑yd trucks)</span>
<span class="spacer"></span>
</div>
<div class="subcard" style="border:1px dashed #ccc; padding:10px; margin:10px 0;">
<div class="row" style="margin-top:6px"><b>Concrete Connections — small loads</b></div>
<div class="row">
<label>Yards <input id="ct_yards" placeholder="0" step="0.25" type="number"/></label>
<label>Price/yd ($) <input id="ct_price" step="1" type="number" value="185"/></label>
<label>Delivery fee / trip ($) <input id="ct_delivery" step="1" type="number" value="285"/></label>
<span class="pill">Trips (auto): <span class="mono" id="ct_trips_read">0</span></span> <label class="pill"><input id="ct_out_of_area" type="checkbox"/> Out of Area (+$75)</label>
</div>
<div class="row">
<span class="pill">Material: <span class="mono" id="ct_mat">$0.00</span></span>
<span class="pill">Delivery: <span class="mono" id="ct_deliv">$0.00</span></span>
<span class="pill">CC Subtotal: <span class="mono" id="ct_sub">$0.00</span></span>
</div>
<!-- CC small loads Diagnostics -->
<div class="row" style="margin-top:8px;">
<details id="cc_small_diag">
<summary>Diagnostics</summary>
<pre id="cc_small_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
</div>
<div class="subcard" style="border:1px dashed #ccc; padding:10px; margin:10px 0;">
<div class="subcard">
<div class="row" style="margin-top:12px"><b>Mohican Valley — big trucks</b> <span class="muted">(enter quoted price/yd; 10‑yd trucks)</span></div>
<div class="row">
<label>Yards <input id="mv_yards" placeholder="0" step="0.5" type="number"/></label>
<label>Price/yd ($) <input id="mv_price" placeholder="0" step="1" type="number"/></label>
<label>Other/Manual Mohican fee ($) <input id="mv_short" placeholder="0" step="1" type="number"/></label>
<div class="row" style="margin-top:8px">
<label>Job date <input id="job_date" type="date"/></label>
<label>Winter service ($/yd) <input id="mv_winter" step="0.5" type="number" value="11"/></label>
<label class="pill"><input checked="" id="mv_winter_auto" type="checkbox"/> Auto winter by date (Nov 15–Apr 15)</label>
<label class="pill"><input id="mv_winter_on" type="checkbox"/> Apply winter now</label>
</div>
<div class="row">
<label>Truck capacity (yd) <input id="mv_cap" step="1" type="number" value="10"/></label>
<label>Min-load threshold (yd) <input id="mv_min" step="0.5" type="number" value="5"/></label>
<label>Short‑load fee ($/yd if load &lt; threshold) <input id="mv_short_per_yd" step="1" type="number" value="200"/></label>
<label>Fuel surcharge / load ($) <input id="mv_fuel" step="0.5" type="number" value="30"/></label>
<label>Environmental fee / load ($) <input id="mv_env" step="0.1" type="number" value="3.5"/></label>
</div>
<div class="row">
<label class="pill"><input id="mv_ex_38" type="checkbox"/> 1/2" Aggregate (+$/yd)</label>
<label>$/yd <input id="mv_ex_38_ppy" step="0.5" type="number" value="5"/></label>
</div>
<!-- DUP PUMP UI REMOVED (was here)
<div class="row">
  <label class="pill"><input id="pump_use" type="checkbox"> Use pump truck</label>
  <label>Size
    <select id="pump_size">
      <option value="32@290">32 m — $290/hr (4 hr min)</option>
      <option value="40@310">40 m — $310/hr (4 hr min)</option>
    </select>
  </label>
  <label>Hours <input id="pump_hours" type="number" step="0.5" placeholder="0"></label>
</div>
-->
<div class="row">
<span class="pill">Trucks (auto): <span class="mono" id="mv_trucks">0</span></span>
<span class="pill">Per‑load fees: <span class="mono" id="mv_loadfees">$0.00</span></span>
<span class="pill">Short‑load surcharges: <span class="mono" id="mv_shortfees">$0.00</span></span>
<span class="pill">Material: <span class="mono" id="mv_mat">$0.00</span></span>
<span class="pill">Extras: <span class="mono" id="mv_extras">$0.00</span></span>
<span class="pill">Pump: <span class="mono" id="mv_pump">$0.00</span></span>
</div>
<div class="row">
<span class="pill">MV Subtotal: <span class="mono" id="mv_sub">$0.00</span></span>
</div>
</div>
<!-- MV big trucks Diagnostics -->
<div class="row" style="margin-top:8px;">
<details id="mv_diag">
<summary>Diagnostics</summary>
<pre id="mv_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
</div>
</div>
<!-- FUEL -->
</div><!-- /concrete-shell -->
<div class="card" data-cat="fuel" id="fuelCard">
<div class="row">
<h3 style="margin:0">Vehicle Fuel</h3>
<span class="pill">PPG = AAA CT peak Regular $4.984 (6/14/22)</span>
</div>
<div class="row">
<label>Price per gallon ($) <input id="fuel_ppg" step="0.001" type="number" value="4.984"/></label>
<label>Gallons for this job <input id="fuel_gal" placeholder="0" step="0.5" type="number"/></label>
</div>
<div class="row">
<span class="pill">Fuel Subtotal: <span class="mono" id="fuel_sub">$0.00</span></span>
</div>
<div class="row" style="margin-top:8px;">
<details id="fuel_diag">
<summary>Diagnostics</summary>
<pre id="fuel_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
</div>
<!-- WASTE -->
<div class="card" data-card-waste="" data-cat="waste">
<div class="row"><h3 style="margin:0">Waste / Disposal</h3><span class="spacer"></span><button class="ghost" id="wasteAdd">+ Add Disposal item</button></div>
<table>
<thead><tr><th>Use</th><th>Material</th><th>Facility</th><th>Units</th><th>Rate</th><th>Qty</th><th>Ext.</th><th></th></tr></thead>
<tbody id="wasteTbody"></tbody>
<tfoot><tr><td class="right" colspan="6">Disposal Subtotal</td><td class="right mono" id="wasteSubtotal">$0.00</td><td></td></tr></tfoot>
</table>
<div class="row" style="margin-top:8px;">
<details id="waste_diag">
<summary>Diagnostics</summary>
<pre id="waste_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
</div>
<!-- SILICA CONTROLS -->
<div class="card" data-cat="silica" id="silicaCard">
<div class="row">
<h3 style="margin:0" id="silica-controls">Silica Controls</h3><div class="small muted">OSHA 29 CFR 1926.1153 Table 1</div>
</div>
<div class="row small muted">
    Tuckpointing &amp; handheld grinder controls. Use these toggles to add ECP notes and auto‑include DWV9402 HEPA fleece bags.
  </div>
<div class="row" style="gap:1rem; flex-wrap:wrap">
<label class="pill"><input id="sil_task_tuck" type="checkbox"/> Tuckpointing (mortar removal)</label>
<label class="pill"><input id="sil_task_grind" type="checkbox"/> Handheld grinder (non‑mortar)</label>
<label class="pill"><input id="sil_enclosed" type="checkbox"/> Indoors / enclosed</label>
</div>
<div class="row" style="gap:.75rem; flex-wrap:wrap">
<button class="ghost" id="sil_copy_notes" type="button">Copy ECP Notes</button>
<textarea id="sil_ecp_notes" placeholder="Silica ECP notes will appear here when you toggle tasks." rows="6" style="width:100%"></textarea>
</div>
<div class="row" style="margin-top:8px;">
<details id="silica_diag">
<summary>Diagnostics</summary>
<pre id="silica_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
</div>
<!-- TOOLS -->
<div class="card" data-cat="tools" id="toolsCard">
<div class="row"><h3 style="margin:0">Tools Depreciation Reserve</h3><span class="spacer"></span><button class="ghost" id="addToolBtn">+ Add Tool</button></div>
<table>
<thead><tr><th>Use</th><th>Tool</th><th>Replace Cost ($)</th><th>Lifetime (hrs)</th><th>Reserve frac (0–1)</th><th>Use (hrs)</th><th>Ext.</th><th></th></tr></thead>
<tbody id="toolTbody"></tbody>
<tfoot><tr><td class="right" colspan="6">Tools Reserve Subtotal</td><td class="right mono" id="toolSubtotal">$0.00</td><td></td></tr></tfoot>
</table>
<div class="row" style="margin-top:8px;">
<details id="tools_diag">
<summary>Diagnostics</summary>
<pre id="tools_diag_pre" style="white-space:pre-wrap;font-family:monospace;font-size:12px"></pre>
</details>
</div>
</div>
<!-- TOTALS -->
<div class="card" data-cat="totals" id="totalsCard"><div class="row"><span class="pill">Directs (excl. Company): <span class="mono" id="directs">$0.00</span></span>
<span class="pill">Overhead: <span class="mono" id="ohAmt">$0.00</span></span>
<span class="pill">Profit (incl. Company): <span class="mono" id="profitAmt">$0.00</span></span>
<span class="pill"><span id="taxLabel">Tax Reimbursement</span>: <span class="mono" id="taxAmt2">$0.00</span></span>
<span class="pill" style="background:#153251; border-color:#2c5a8c; color:#d9ecff"> Total: <span class="mono" id="grand">$0.00</span></span>
<span class="spacer"></span>
<div class="group">
<label>OH % <input id="ohPct" step="1" type="number" value="0"/></label>
<label>Profit % <input id="profitPct" step="1" type="number" value="0"/></label>
</div>
</div>
<div class="muted small" style="margin-top:6px">
      Calc: Directs = Crew (excl. Co.) + Materials + Concrete + Fuel + Tools + Disposal. Overhead = Directs × OH%. Profit = Company + (Directs + Overhead) × Profit%. Total = Directs + Overhead + Profit + Tax/Reimb.
    </div>
</div>
<!-- sticky -->
<div class="sticky">
<div class="sticky-inner">
<span class="pill" id="stickyGrandPill" style="background:#153251; border-color:#2c5a8c; color:#d9ecff">Total: <span class="mono" id="stickyGrand">$0.00</span></span>
</div>
</div>
<!-- hidden sticky spans to satisfy totals() updates -->
<div style="display:none">
<span id="stickyCrew"></span>
<span id="stickyCompanyToProfit"></span>
<span id="stickyMat"></span>
<span id="stickyConc"></span>
<span id="stickyFuel"></span>
<span id="stickyTools"></span>
<span id="stickyWaste"></span>
<span id="stickyOH"></span>
<span id="stickyProfit"></span>
<span id="stickyTax"></span>
<span id="stickyTaxLabel"></span>
</div>
<div class="warn" id="err" style="display:none"></div>
</div>
<script>
(function(){
  const byId = id => document.getElementById(id);
  const fmt = n => '$' + (Number.isFinite(n)?n:0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const num = v => { if(v===null||v===undefined) return 0; const s=String(v).trim(); if(s==='') return 0; const n=parseFloat(s); return Number.isFinite(n)?n:0; };

  const jsStatus = byId('jsStatus'); jsStatus.textContent='✅ '; jsStatus.classList.remove('bad'); jsStatus.classList.add('ok');

  // ===== Crew =====
  let crew = [
    {id:'owner', name:'Owner (Rob)', role:'owner', rate:50, use:true, hrs:0},
    {id:'company', name:'Company (Overhead → Profit)', role:'company', rate:50, use:true, hrs:0},
    {id:'dave', name:'Uncle Dave (Foreman)', role:'foreman', rate:43.75, use:true, hrs:0},
    {id:'jorge', name:'Jorge (Mason)', role:'mason', rate:30, use:true, hrs:0},
    {id:'labor', name:'Laborer', role:'laborer', rate:25, use:true, hrs:0},
  ];
  // === Auto-rate mapping (role -> $/hr) ===
  const ROLE_RATES = { owner:50, company:50, foreman:43.75, mason:30, laborer:25 };

  let crewWideOn = true, crewDaysMode = true;
  const HOURS_PER_DAY = 8;

  function renderCrew(){
    const tb = byId('crewTbody'); tb.innerHTML='';
    crew.forEach(w=>{
      const tr = document.createElement('tr'); tr.dataset.id=w.id; tr.classList.toggle('fade', crewWideOn);
      tr.innerHTML = `
        <td><input type="checkbox" class="crew_use" ${w.use?'checked':''}></td>
        <td><input class="crew_name" value="${w.name}"></td>
        <td>
          <select class="crew_role">
            <option value="owner" ${w.role==='owner'?'selected':''}>Owner</option>
            <option value="company" ${w.role==='company'?'selected':''}>Company</option>
            <option value="foreman" ${w.role==='foreman'?'selected':''}>Foreman</option>
            <option value="mason" ${w.role==='mason'?'selected':''}>Mason</option>
            <option value="laborer" ${w.role==='laborer'?'selected':''}>Laborer</option>
            <option value="other" ${w.role==='other'?'selected':''}>Other</option>
          </select>
        </td>
        <td><input type="number" class="crew_rate" step="0.25" value="${w.rate}"></td>
        <td><input type="number" class="crew_hrs" step="1" placeholder="0" ${crewWideOn?'disabled':''} value="${crewWideOn?'':(w.hrs||'')}"></td>
        <td class="right mono crew_cost">$0.00</td>
        <td><button class="ghost crew_del">✕</button></td>`;
      tb.appendChild(tr);
    });
    bindCrewRowEvents(); updateAll();
  }
  function bindCrewRowEvents(){
    document.querySelectorAll('#crewTbody tr').forEach(tr=>{
      const id = tr.dataset.id; const idx = crew.findIndex(c=>c.id===id);
      tr.querySelector('.crew_use').addEventListener('change', e=>{ crew[idx].use=e.target.checked; updateAll(); });
      tr.querySelector('.crew_name').addEventListener('input', e=>{ crew[idx].name=e.target.value; });
      
      tr.querySelector('.crew_role').addEventListener('change', e=>{
        const newRole = e.target.value;
        crew[idx].role = newRole;
        // Auto-sync rate to role, if mapping exists
        if (Object.prototype.hasOwnProperty.call(ROLE_RATES, newRole)) {
          crew[idx].rate = ROLE_RATES[newRole];
          const rateInp = tr.querySelector('.crew_rate');
          if (rateInp) {
            rateInp.value = ROLE_RATES[newRole];
            // Fire input event so any downstream listeners recalc immediately
            rateInp.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }
        updateAll();
      });

      tr.querySelector('.crew_rate').addEventListener('input', e=>{ crew[idx].rate=num(e.target.value); updateAll(); });
      const hrs=tr.querySelector('.crew_hrs'); if(hrs){ hrs.addEventListener('input', e=>{ crew[idx].hrs=num(e.target.value); updateAll(); }); }
      tr.querySelector('.crew_del').addEventListener('click', ()=>{ crew.splice(idx,1); renderCrew(); });
    });
  }
  byId('addWorkerBtn').addEventListener('click', ()=>{ const id='w_'+Math.random().toString(36).slice(2,7); crew.push({id,name:'Worker',role:'mason',rate:30,use:true,hrs:0}); renderCrew(); });
  byId('crewWideToggle').addEventListener('change', ()=>{ crewWideOn = byId('crewWideToggle').checked; renderCrew(); });
  byId('timeUnitsDays').addEventListener('change', ()=>{ crewDaysMode = byId('timeUnitsDays').checked; updateAll(); });
  byId('crewWideQty').addEventListener('input', updateAll);

  function crewCalc(){
    const q = num(byId('crewWideQty').value);
    const baseHours = crewDaysMode ? q*HOURS_PER_DAY : q;
    let subtotalExclCompany=0, companyCost=0;
    document.querySelectorAll('#crewTbody tr').forEach(tr=>{
      const idx = crew.findIndex(c=>c.id===tr.dataset.id); const w = crew[idx];
      const hrs = crewWideOn ? (w.use ? baseHours : 0) : (w.use ? (w.hrs||0) : 0);
      const cost = w.use ? hrs * (w.rate||0) : 0;
      tr.querySelector('.crew_cost').textContent = fmt(cost);
      if(w.role==='company'){ companyCost+=cost; } else { subtotalExclCompany+=cost; }
    });
    byId('crewSubtotal').textContent = fmt(subtotalExclCompany);
    try{
      var pre=document.getElementById('crew_diag_pre');
      if(pre){
        var lines=[];
        lines.push('crewWideOn='+(typeof crewWideOn!=='undefined'?crewWideOn:false));
        lines.push('crewDaysMode='+(typeof crewDaysMode!=='undefined'?crewDaysMode:false));
        lines.push('baseHours='+(typeof baseHours!=='undefined'?baseHours:0));
        lines.push('subtotalExclCompany=$'+fmt(subtotalExclCompany));
        lines.push('companyCost=$'+fmt(companyCost));
        pre.textContent = lines.join('\n');
      }
    }catch(e){}
    return {subtotalExclCompany, companyCost};
  }

  // ===== Materials =====
  
  
let materials = [
  {id:"mDW8", use:false, item:"8\" Durawall — 10'", supplier:"New Haven Masonry", units:"each", price:7.85, qty:0, cats:["masonry"]},
  {id:"mDW10", use:false, item:"10\" Durawall — 10'", supplier:"New Haven Masonry", units:"each", price:7.85, qty:0, cats:["masonry"]},

  {id:'mCT_DC_FLAT',   use:false, item:"Desert Creek Mosaic ThinStone — flats",   supplier:"Connecticut Stone", units:"sf",  price:11.87, qty:0, cats:["masonry","stone veneer"]},
  {id:'mCT_DC_CORNER', use:false, item:"Desert Creek Mosaic Corner ThinStone",    supplier:"Connecticut Stone", units:"lf",  price:17.57, qty:0, cats:["masonry","stone veneer"]},
  {id:'mCT_PMAVM',     use:false, item:"SPEC MIX Polymer-Modified Adhered Veneer Mortar — 80 lb (Gray)", supplier:"Connecticut Stone", units:"bag", price:21.75, qty:0, cats:["masonry","stone veneer","stucco"]},
  {id:'mLOW_S_TypeS60',use:false, item:"Sakrete Type S Mortar Mix — 60 lb",       supplier:"Lowe's",           units:"bag", price:8.28,  qty:0, cats:["masonry","stucco"]},
  {id:'mLOW_SV_50',    use:false, item:"Sakrete Stone Veneer Mortar — 50 lb",     supplier:"Lowe's",           units:"bag", price:9.88,  qty:0, cats:["masonry","stone veneer","stucco"]},
  {id:'mCOL_DWV9402',  use:false, item:"DeWALT Fleece Dust Bags (DWV9402) — 5-pack", supplier:"Colony Hardware", units:"pack",price:45.00, qty:0, cats:["stucco","masonry","concrete","tools"]},
  {id:'mHD_3M_8511', use:false, item:"3M 8511 N95 respirator — 1 pack", supplier:'Home Depot', units:'each', price:2.35, qty:0, cats:['tools','safety','masonry','stucco','concrete']},

  {id:'m1',  use:false, item:"8' Plastic paver edging",            supplier:'New Haven Masonry', units:'each',  price:12, qty:0, step:1,    roundUp:true, cats:['pavers']},
  {id:'m2',  use:false, item:"8' Aluminum paver edging",           supplier:'New Haven Masonry', units:'each',  price:18, qty:0, step:1,    roundUp:true, cats:['pavers']},
  {id:'m3',  use:false, item:"12\" paver spikes — 150/box",        supplier:'New Haven Masonry', units:'box',   price:72, qty:0, step:1,    roundUp:true, cats:["pavers"]},
  {id:'m4',  use:false, item:"SPEC MIX Type S — 80 lb",            supplier:'New Haven Masonry', units:'bag',   price:11, qty:0, cats:['stucco', 'masonry']},
  {id:'m5',  use:false, item:"SPEC MIX Stone Veneer — 80 lb",      supplier:'New Haven Masonry', units:'bag',   price:18, qty:0, cats:["masonry","stone veneer","bluestone"]},
  {id:'m6',  use:false, item:"Concrete wire mesh 5'×10'",          supplier:'New Haven Masonry', units:'sheet', price:11, qty:0, cats:["concrete"]},
  {id:'m7',  use:false, item:"6\"×10' expansion joint",            supplier:'New Haven Masonry', units:'each',  price:8,  qty:0, cats:["concrete"]},
  {id:'m8',  use:false, item:"SPEC MIX Core Fill Grout 3k — 80 lb",supplier:'Homer C. Godfrey', units:'bag',    price:11, qty:0, cats:["masonry"]},
  {id:'m10', use:false, item:"Bulk crushed rock 3/4\"",            supplier:'SiteOne',          units:'yard',  price:44, qty:0, step:0.25, roundUp:false, cats:['concrete', 'pavers']},
  {id:"mNH1", use:false, item:"12\" hollow concrete block", supplier:"New Haven Masonry", units:"each", price:4.8, qty:0, cats:["masonry"]},
  {id:"mDW6", use:false, item:"6\" Durawall — 10'", supplier:"New Haven Masonry", units:"each", price:7.85, qty:0, cats:["masonry"]},

  {id:"mNH2", use:false, item:"12\" Durawall — 10'", supplier:"New Haven Masonry", units:"each", price:7.85, qty:0, cats:["masonry"]},
  {id:"mNH3", use:false, item:"#5 rebar (5/8\") — 20'", supplier:"New Haven Masonry", units:"each", price:14.95, qty:0, cats:["masonry","concrete"]},
  {id:"mNH5", use:false, item:"QUIKRETE 5000 — 80 lb", supplier:"New Haven Masonry", units:"bag", price:8.95, qty:0, cats:["concrete", "masonry"]},
  {id:"mNH6", use:false, item:"5/8\" × 10\" anchor bolt set (bolt+nuts+washer)", supplier:"New Haven Masonry", units:"each", price:2.7, qty:0, cats:["concrete", "masonry"]},
  {id:"mNH7", use:false, item:"Bluestone 1\" — price per sf", supplier:"New Haven Masonry", units:"sf", price:10.95, qty:0, cats:["masonry","bluestone"]},
  {id:"mNH8", use:false, item:"Bluestone 1.5\" — price per sf", supplier:"New Haven Masonry", units:"sf", price:12.5, qty:0, cats:["masonry","bluestone"]},

  {id:'m2001',use:false,item:"Stucco Depot PRO BASE — 50 lb basecoat adhesive",supplier:'Stucco Depot',units:'bag',price:19.50,qty:0,step:10,roundUp:false,cats:["stucco"],coverageSqft:90},
  {id:'m2002',use:false,item:"Standard EIFS Fiberglass Mesh — 38\"×150' roll",supplier:'Stucco Depot',units:'roll',price:60,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:475},
  {id:'m2003',use:false,item:"Parex DPR Sand Coarse — 5 gal",supplier:'Parex',units:'pail',price:75,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:90},
  {id:'m2004',use:false,item:"Parex DPR Sand Fine — 5 gal",supplier:'Parex',units:'pail',price:75,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:150},
  {id:'m2005',use:false,item:"Parex DPR Swirl Fine — 5 gal",supplier:'Parex',units:'pail',price:75,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:120},
  {id:'m2006',use:false,item:"Parex DPR Sand Smooth — 5 gal",supplier:'Parex',units:'pail',price:75,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:280},
  {id:'m2007',use:false,item:"MP Roll‑Tex Coating — 5 gal",supplier:'MP Architectural Coatings',units:'pail',price:90,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:300},
  {id:'m2008',use:false,item:"GREEN MAKER Decoplast Premium Basecoat — 50 lb",supplier:'RMC Stucco Supply',units:'bag',price:31,qty:0,step:10,roundUp:false,cats:["stucco"],coverageSqft:55},
  {id:'m2009',use:false,item:"EPS EIFS Foam — 2\" (2'×4', 9 sheets) per bundle",supplier:'RMC Stucco Supply',units:'bundle',price:45,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:72},
  {id:'m2010',use:false,item:"EPS EIFS Foam — 1.5\" (2'×4', 13 sheets) per bundle",supplier:'Local EIFS supplier',units:'bundle',price:45,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:104},
  {id:'m2011',use:false,item:"EPS EIFS Foam — 1\" (2'×4', 18 sheets) per bundle",supplier:'Local EIFS supplier',units:'bundle',price:45,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:144},
  {id:'m2012',use:false,item:"EPS EIFS Foam — 3/4\" (2'×4', 30 sheets) per bundle",supplier:'Local EIFS supplier',units:'bundle',price:45,qty:0,step:50,roundUp:false,cats:["stucco"],coverageSqft:240},
  {id:'m2013',use:false,item:"Red Baron stucco masking tape — 2\" × 180' roll",supplier:'RMC Stucco Supply',units:'roll',price:7.50,qty:0,step:1,roundUp:true,cats:['stucco', 'concrete']},
  {id:'m2014',use:false,item:"Stucco knife",supplier:'Stucco Depot',units:'each',price:15,qty:0,step:1,roundUp:true,cats:["stucco"]},
  {id:'mCT_BBS_TREAD', use:false, item:"Bluestone Blue Select Tread", supplier:"Connecticut Stone", units:"sf", price:20.20, qty:0, cats:["masonry","stone veneer"]},
  {id:'mCT_HB_STRIP', use:false, item:"Hampton Blend Strip Cut Thinstone", supplier:"Connecticut Stone", units:"sf", price:8.00, qty:0, cats:["masonry","stone veneer"]},
  {id:'mCT_HB_STRIP_CORNER', use:false, item:"Hampton Blend Strip Cut Thinstone Corners", supplier:"Connecticut Stone", units:"lf", price:17.57, qty:0, cats:["masonry","stone veneer"]},
  {id:'mTIL_DrivewayMix', use:false, item:"Driveway Mix Asphalt", supplier:"Tilcon", units:"ton", price:108.10, qty:0, cats:["concrete"]},
  {id:'mBLS_DeepRiver34', use:false, item:"Deep River 3/4\" Stone", supplier:"Branford Landscape Supply", units:"yard", price:65.00, qty:0, cats:["pavers","concrete"]},
  {id:'mCOL_ScaffoldTag', use:false, item:"Scaffold Tag (All 3 Colors)", supplier:"Colony Hardware", units:"each", price:13.59, qty:0, cats:["tools"]},
  {id:'mCOL_ScaffoldTagHolder', use:false, item:"Scaffold Tag Holder", supplier:"Colony Hardware", units:"each", price:21.02, qty:0, cats:["tools"]},
  {id:'mSO_KY_Bluegrass_Sod', use:false, item:"Kentucky Bluegrass Sod", supplier:"SiteOne", units:"sf", price:0.85, qty:0, cats:["pavers"]},
  {id:'mSO_TopSoil_Bulk', use:false, item:"Top Soil Bulk", supplier:"SiteOne", units:"yard", price:45.00, qty:0, cats:["pavers"]},
  {id:'mNHM_Concrete_80lb', use:false, item:"Concrete 80lb Bag", supplier:"New Haven Masonry", units:"bag", price:6.36, qty:0, cats:["concrete"]},
  {id:'mLOW_ColdPatchAsphalt_50lb', use:false, item:"Cold Patch Asphalt 50 lb Bag", supplier:"Lowes", units:"bag", price:22.38, qty:0, cats:["concrete"]},
  {id:'mLOW_Sakrete_Play_Sand_50lb', use:false, item:"Sakrete Play Sand 50lb Bag", supplier:"Lowes", units:"bag", price:8.28, qty:0, cats:["pavers","concrete"]},
  { id:'mHDX_TerryTowels_20pk', item:"HDX TERRY TOWELS 20PK", units:'pack', price:12.98, supplier:'Home Depot', cats:['cleanup'] }
,
  { id:'mWindex32oz_308534', item:"Windex 32 oz Commercial Line Trigger Bottle Original Glass Cleaner", units:'bottle', supplier:'Home Depot', price:4.78, cats:['cleanup'] }
,
  { id:'mQuikreteBondingAdhesive_1gal_990201', item:"Quikrete 1 Gal. Concrete Bonding Adhesive", units:'gal', supplier:'Home Depot', price:20.84, cats:['masonry','stone veneer'] }
,
  { id:'mGripRite_3in_DrywallScrews_1lb_3CDWS1', item:"#8 x 3 in. #2 Phillips Bugle Head Coarse Thread Drywall Screws (1 lb Box)", units:'box (1 lb)', supplier:'Home Depot', price:7.06, cats:['concrete'] }
,
  { id:"mDewalt_Chalk_Red_8oz_DWHT47048L", item:"DEWALT 8 oz. Chalk Reel in Red (DWHT47048L)", units:"bottle (8 oz)", supplier:"Home Depot", price:3.47, cats:["masonry"] }
,
  { id:"mMilwaukee_SDSPlus_5_8x18in_4C_48_20_8306", item:"Milwaukee 5/8 in. x 18 in. 4-Cutter SDS-PLUS Carbide Drill Bit (48-20-8306)", units:"each", supplier:"Home Depot", price:37.77, cats:["concrete"] },
  {id:'mCOL_DT5_TP_4_5', use:false, item:'4 1/2" Tuckpoint Diamond Blade', supplier:'Colony Hardware', units:'each', price:54, qty:0, cats:['masonry','tools']}
,
  { id:'mROB_BRICK_762x362x214', use:false, item:"Brick 7 5/8\" \u00d7 3 5/8\" \u00d7 2 1/4\"", supplier:"New Haven Masonry", units:"each", price:1, qty:0, cats:["masonry"] }
,
  { id:'mROB_FLU_12x12', use:false, item:"Flu 12x12", supplier:"New Haven Masonry", units:"each", price:33, qty:0, cats:["masonry"] }
,
  { id:'mROB_COPPER_3x8', use:false, item:"Copper Sheet 3x8", supplier:"ABC Supply", units:"each", price:300, qty:0, cats:["masonry"] }
,
  {id:'mUSR_Brick_7_5_8_2_3_4_2_3_4_each', use:false, item:'Brick 7 5/8" × 2 3/4" × 2 3/4"', supplier:'New Haven Masonry', units:'each', price:1.00, qty:0, cats:['masonry']},
  {id:'mUSR_Brick_11_5_8_3_5_8_2_1_4_each', use:false, item:'Brick  11 5/8" × 3 5/8" × 2 1/4"', supplier:'New Haven Masonry', units:'each', price:1.00, qty:0, cats:['masonry']},
  {id:'mUSR_Flu_8x8_each', use:false, item:'Flu 8x8', supplier:'New Haven Masonry', units:'each', price:33.00, qty:0, cats:['masonry']},
  {id:'mUSR_Flu_8x12_each', use:false, item:'Flu 8x12', supplier:'New Haven Masonry', units:'each', price:33.00, qty:0, cats:['masonry']},
  {id:'mUSR_Flu_13x18_each', use:false, item:'Flu 13x18', supplier:'New Haven Masonry', units:'each', price:33.00, qty:0, cats:['masonry']},
  {id:'mUSR_6_hollow_concrete_block_each', use:false, item:'6" hollow concrete block', supplier:'New Haven Masonry', units:'each', price:4.80, qty:0, cats:['masonry']},
  {id:'mUSR_8_hollow_concrete_block_each', use:false, item:'8" hollow concrete block', supplier:'New Haven Masonry', units:'each', price:4.80, qty:0, cats:['masonry']},
  {id:'mUSR_10_hollow_concrete_block_each', use:false, item:'10" hollow concrete block', supplier:'New Haven Masonry', units:'each', price:4.80, qty:0, cats:['masonry']},
];


  function renderMaterials(){
    // HTML-escape for attribute values to avoid breaking inputs when labels contain quotes (e.g., 6"×10')
    const esc = s => String(s).replaceAll('&','&amp;').replaceAll('"','&quot;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    const tb=byId('matTbody'); tb.innerHTML='';
    // Optional category filter: show only materials matching window.__matCats if defined
    var cats = (window.__matCats && Array.isArray(window.__matCats) && window.__matCats.length) ? window.__matCats : null;
    /* ROBUST TAB->CATS MAPPING */
    try{
      const t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
      const g = t ? t.getAttribute('data-group') : null;
      // Only force cats if a real group is active (not "all")
      if (g && g !== 'all') {
        // Known categories present in data: stucco, masonry, concrete, bluestone, stone veneer
        // Map group->cats focus; for Stucco we only want stucco
        if (g === 'stucco') cats = ['stucco'];
      }
    } catch(e){}
    // If Stucco tab is active, force a stucco-only category filter
    try{
      const activeTab = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
      const activeGroup = activeTab ? activeTab.getAttribute('data-group') : null;
      if(activeGroup==='stucco'){ cats = ['stucco']; }
    } catch(e){}
    

    const __list = materials.filter(m=> !cats || (m.cats && m.cats.some(c=>cats.includes(c))));
    const __render = (m)=>{

      const tr=document.createElement('tr'); tr.dataset.id=m.id; tr.classList.toggle('fade', !m.use);
      tr.innerHTML = `
        <td><input type="checkbox" class="mat_use" ${m.use?'checked':''}></td>
        <td><input class="mat_item" value="${esc(m.item)}"></td>
        <td><input class="mat_sup" value="${esc(m.supplier)}"></td>
        <td><input class="mat_units" value="${esc(m.units)}"></td>
        <td><input type="number" class="mat_price" step="0.01" value="${m.price}"></td>
        <td><input type="number" class="mat_qty" step="${m.step||1}" placeholder="${m.coverageSqft?'Area (sf)':'0'}" value="${m.qty||''}"></td>
        <td class="right mono mat_ext">$0.00</td>
        <td><button class="ghost mat_del">✕</button></td>`;
      tr.setAttribute('data-cats', (m.cats||[]).join(','));
      tb.appendChild(tr);
    };
    if (__list.length===0) { materials.forEach(__render); } else { __list.forEach(__render); }

    bindMatEvents(); updateAll();
  }
  function bindMatEvents(){
    document.querySelectorAll('#matTbody tr').forEach(tr=>{
      const idx = materials.findIndex(x=>x.id===tr.dataset.id);
      tr.querySelector('.mat_use').addEventListener('change', e=>{ materials[idx].use=e.target.checked; tr.classList.toggle('fade', !materials[idx].use); updateAll(); });
      tr.querySelector('.mat_item').addEventListener('input', e=>{ materials[idx].item=e.target.value; });
      tr.querySelector('.mat_sup').addEventListener('input', e=>{ materials[idx].supplier=e.target.value; });
      tr.querySelector('.mat_units').addEventListener('input', e=>{ materials[idx].units=e.target.value; });
      tr.querySelector('.mat_price').addEventListener('input', e=>{ materials[idx].price=num(e.target.value); updateAll(); });
      tr.querySelector('.mat_qty').addEventListener('input', e=>{ const v=num(e.target.value); materials[idx].qty=v; if(v>0 && !materials[idx].use){ materials[idx].use=true; tr.querySelector('.mat_use').checked=true; tr.classList.remove('fade'); } updateAll(); });
      tr.querySelector('.mat_del').addEventListener('click', ()=>{ materials.splice(idx,1); renderMaterials(); });
    });
  }
  function materialsSubtotal(){
    let sub=0; let dbg=[]; let used=0;

    document.querySelectorAll('#matTbody tr').forEach(tr=>{
      const idx = materials.findIndex(x=>x.id===tr.dataset.id); const m = materials[idx];
      const areaOrQty = num(m.qty);
      const price = num(m.price);
      let units = areaOrQty;
      if (m.coverageSqft && m.coverageSqft>0) {
        // Treat qty as AREA in square feet; buy whole units (ceil)
        units = Math.ceil((areaOrQty||0) / m.coverageSqft);
        // annotate UI for clarity
        const extCell = tr.querySelector('.mat_ext');
        if (extCell) extCell.setAttribute('title', `${units} ${m.units||'unit'}(s) @ ${fmt(price)} each (coverage ${m.coverageSqft} sf/${m.units||'unit'})`);
      } else if (m.roundUp) {
        units = Math.ceil(areaOrQty||0);
      }
      const ext = m.use ? price * (units||0) : 0;
      sub += ext; tr.querySelector('.mat_ext').textContent = fmt(ext);
      if (m.use && (units||0)>0){ dbg.push((m.item||m.id)+': '+(units||0)+' '+(m.units||'unit')+' × $'+fmt(price)+' = $'+fmt(ext)); used++; }
    });
    byId('matSubtotal').textContent = fmt(sub); 
    try{ var pre=document.getElementById('mat_diag_pre'); if(pre){ pre.textContent = 'items_used='+used+'\n' + dbg.join('\n'); } }catch(e){} return sub;
  }

  // ===== Concrete =====
  function concreTecTS(){
    const y = num(byId('ct_yards').value);
    const p = num(byId('ct_price').value);
    const d = num(byId('ct_delivery').value);
    const trips = Math.ceil((y||0)/3);
    byId('ct_trips_read').textContent = isFinite(trips)?trips:0;
    const mat = y*p; const del = trips*d; const oof = (byId('ct_out_of_area') && byId('ct_out_of_area').checked) ? 75 : 0; const sub = mat+del+oof;
    byId('ct_mat').textContent = fmt(mat);
    byId('ct_deliv').textContent = fmt(del);
    byId('ct_sub').textContent = fmt(sub);
    return sub;
  }
  
function mohicanValley(){
    // Inputs
    const yRaw = num(byId('mv_yards').value);
    const totalY = (yRaw>0 && yRaw<2) ? 2 : yRaw;
    const price = num(byId('mv_price').value);
    const cap = Math.max(1, num(byId('mv_cap')?.value || 10));
    const minY = num(byId('mv_min')?.value || 5);
    const shortPerYd = num(byId('mv_short_per_yd')?.value || 200);
    const fuelPerLoad = num(byId('mv_fuel')?.value || 30);
    const envPerLoad  = num(byId('mv_env')?.value  || 3.5);
    const manualOther = num(byId('mv_short')?.value || 0); // legacy manual field

    // Winter logic
    const winterRate = num(byId('mv_winter')?.value || 0);
    let winterOn = !!(byId('mv_winter_on') && byId('mv_winter_on').checked);
    const auto = byId('mv_winter_auto')?.checked;
    const jd = byId('job_date')?.value;
    if(auto && jd){
      const d = new Date(jd+'T00:00:00');
      const mm = d.getMonth()+1, dd = d.getDate();
      // Nov 15 - Dec 31 OR Jan 1 - Apr 15
      winterOn = ( (mm>10 && (mm<12 || (mm===11 && dd>=15) || (mm===12))) || (mm<5 || (mm===4 && dd<=15)) );
      if(byId('mv_winter_on')) byId('mv_winter_on').checked = winterOn;
    }
    const winterPerYd = winterOn ? winterRate : 0;

    // Extras per-yd
    const ex_air = (byId('mv_ex_air')?.checked ? num(byId('mv_ex_air_ppy').value) : 0);
    const ex_38  = (byId('mv_ex_38')?.checked ? num(byId('mv_ex_38_ppy').value) : 0);
    const ex_fib = (byId('mv_ex_fiber')?.checked ? num(byId('mv_ex_fiber_ppy').value) : 0);
    const ex_col = (byId('mv_ex_color')?.checked ? num(byId('mv_ex_color_ppy').value) : 0);
    const extrasPerYd = ex_air + ex_38 + ex_fib + ex_col;

    // Trucking math
    const trucks = Math.ceil((totalY||0)/cap);
    let remaining = totalY, mvMat=0, shortFees=0, loadFees=0;
    for(let t=0; t<trucks; t++){
      const loadY = Math.min(cap, remaining);
      remaining -= loadY;
      mvMat += loadY * (price + winterPerYd + extrasPerYd);
      loadFees += fuelPerLoad + envPerLoad;
      if(loadY>0 && loadY < minY){ shortFees += loadY * shortPerYd; }
    }

    // Pump
    let pump=0;
    const pumpApply = !!(byId('mv_apply_pump') && byId('mv_apply_pump').checked);
    const pumpOn = byId('pump_use')?.checked;
    if(pumpOn){
      const val = (byId('pump_size')?.value || '32@290');
      const rate = val.includes('@') ? parseFloat(val.split('@')[1]) : 290;
      const hrsRaw = num(byId('pump_hours')?.value || 0);
      const hrs = Math.max(hrsRaw, 4); /// 4 hr minimum
      pump = rate * hrs;
    }


    // Time overage (6 min/yd allowed) — $300/hr if exceeded
    let timeOver = 0;
    const applyTime = !!(byId('mv_apply_time') && byId('mv_apply_time').checked);
    const avgDischarge = num(byId('mv_discharge')?.value || 0); // minutes per truck
    if(avgDischarge>0){
      const allowed = 6 * (totalY||0);               // minutes allowed
      const actual  = (trucks||0) * avgDischarge;    // minutes used
      if(actual > allowed){
        const overMin = actual - allowed;
        const overHrs = overMin / 60;
        timeOver = overHrs * 300; // $300/hr
      }
    }
    const extras = (totalY||0)*extrasPerYd; // separate display for clarity
    const sub = mvMat + shortFees + loadFees + (pumpApply ? pump : 0) + (applyTime ? timeOver : 0) + manualOther;

    // Display
    byId('mv_trucks') && (byId('mv_trucks').textContent = trucks||0);
    byId('mv_mat')    && (byId('mv_mat').textContent = fmt(mvMat));
    byId('mv_shortfees') && (byId('mv_shortfees').textContent = fmt(shortFees));
    byId('mv_loadfees')  && (byId('mv_loadfees').textContent  = fmt(loadFees));
    byId('mv_extras') && (byId('mv_extras').textContent = fmt(extras));
    byId('mv_pump')   && (byId('mv_pump').textContent   = fmt(pump));
    byId('mv_pump_fee') && (byId('mv_pump_fee').textContent = fmt(pump));
    byId('mv_time_overage') && (byId('mv_time_overage').textContent = fmt(timeOver));
    byId('mv_sub').textContent = fmt(sub);
    return sub;
  }

  // ===== Fuel =====
  function fuelSubtotal(){
    const ppg=num(byId('fuel_ppg').value), gal=num(byId('fuel_gal').value);
    const sub = ppg*gal; byId('fuel_sub').textContent = fmt(sub); return sub;
  }

  // ===== Waste =====
  let waste=[{id:'w1', use:false, item:'Clean asphalt (disposal)', facility:'Modern Materials', units:'ton', rate:9, qty:0}];
  function renderWaste(){
    const tb=byId('wasteTbody'); tb.innerHTML='';
    waste.forEach(w=>{
      const tr=document.createElement('tr'); tr.dataset.id=w.id; tr.classList.toggle('fade', !w.use);
      tr.innerHTML = `
        <td><input type="checkbox" class="w_use" ${w.use?'checked':''}></td>
        <td><input class="w_item" value="${w.item}"></td>
        <td><input class="w_fac" value="${w.facility}"></td>
        <td><input class="w_units" value="${w.units}"></td>
        <td><input type="number" class="w_rate" step="0.01" value="${w.rate}"></td>
        <td><input type="number" class="w_qty" step="0.25" placeholder="0" value="${w.qty||''}"></td>
        <td class="right mono w_ext">$0.00</td>
        <td><button class="ghost w_del">✕</button></td>`;
      tb.appendChild(tr);
    });
    bindWasteEvents(); updateAll();
  }
  function bindWasteEvents(){
    document.querySelectorAll('#wasteTbody tr').forEach(tr=>{
      const idx=waste.findIndex(x=>x.id===tr.dataset.id);
      tr.querySelector('.w_use').addEventListener('change', e=>{ waste[idx].use=e.target.checked; tr.classList.toggle('fade', !waste[idx].use); updateAll(); });
      tr.querySelector('.w_item').addEventListener('input', e=>{ waste[idx].item=e.target.value; });
      tr.querySelector('.w_fac').addEventListener('input', e=>{ waste[idx].facility=e.target.value; });
      tr.querySelector('.w_units').addEventListener('input', e=>{ waste[idx].units=e.target.value; });
      tr.querySelector('.w_rate').addEventListener('input', e=>{ waste[idx].rate=num(e.target.value); updateAll(); });
      tr.querySelector('.w_qty').addEventListener('input', e=>{ const v=num(e.target.value); waste[idx].qty=v; if(v>0 && !waste[idx].use){ waste[idx].use=true; tr.querySelector('.w_use').checked=true; tr.classList.remove('fade'); } updateAll(); });
    });
  }
  function wasteSubtotal(){
    let sub=0;
    document.querySelectorAll('#wasteTbody tr').forEach(tr=>{
      const idx=waste.findIndex(x=>x.id===tr.dataset.id); const w=waste[idx];
      const ext = w.use ? num(w.rate)*num(w.qty) : 0;
      sub += ext; tr.querySelector('.w_ext').textContent = fmt(ext);
    });
    byId('wasteSubtotal').textContent = fmt(sub); return sub;
  }

  // ===== Tools =====
  let tools=[
{id:'t1', use:false, name:'DEWALT 4400 PSI 4.0 GPM Pressure Washer (DXPW61377)', cost:949, life:475, frac:1.0, useHrs:0},
  {id:'t2', use:false, name:'Bosch 11335K 35-lb Breaker Hammer Kit (1-1/8" Hex)', cost:1099, life:550, frac:1.0, useHrs:0},
  {id:'t3', use:false, name:'STIHL TS 420 14\" Cut-Off Saw', cost:1399.99, life:700, frac:1.0, useHrs:0},
  {id:'t4', use:false, name:'Bosch 11255VSR Bulldog Xtreme 1" SDS-Plus Rotary Hammer', cost:219.00, life:110, frac:1.0, useHrs:0},
  {id:'t5', use:false, name:'Bosch 11316EVS SDS-max Demolition Hammer (14A, 12.4 ft-lb)', cost:729.00, life:365, frac:1.0, useHrs:0},
  {id:'t6', use:false, name:'Bosch RH540M 1-9/16" SDS-max Combination Rotary Hammer', cost:469.00, life:235, frac:1.0, useHrs:0},
  {id:'t7', use:false, name:'DEWALT 20V MAX XR Impact Driver (DCF860B) — Tool Only', cost:179.00, life:90, frac:1.0, useHrs:0},
  {id:'t8', use:false, name:'DEWALT FLEXVOLT 20V/60V MAX 12.0Ah Battery (DCB612)', cost:319.00, life:160, frac:1.0, useHrs:0},
  {id:'t9', use:false, name:'DEWALT 20V MAX XR Compact Reciprocating Saw (DCS367B) — Tool Only', cost:179.00, life:90, frac:1.0, useHrs:0},
  {id:'t10', use:false, name:'DEWALT Tuckpointing Grinder (DWE46202)', cost:420.99, life:210, frac:1.0, useHrs:0},
  {id:'t11', use:false, name:'DEWALT 8 Gallon HEPA/RRP Dust Extractor (DWV010)', cost:469.00, life:235, frac:1.0, useHrs:0}
];

  
  // Default Tools item tweaked: DEWALT DXPW61377 @ $949, life 475 hrs, frac 1.0 ⇒ ~$2.00/hour reserve

  // Added: Bosch 11335K breaker @ $1,099, life 550 hrs (≈$2.00/hr reserve)
// Added: STIHL TS 420 @ $1,399.99, life 700 hrs (≈$2.00/hr reserve)
// Added: Bosch 11255VSR @ $219.00, life 110 hrs (≈$2.00/hr reserve)
// Added: Bosch 11316EVS @ $729.00, life 365 hrs (≈$2.00/hr reserve)
// Added: Bosch RH540M @ $469.00, life 235 hrs (≈$2.00/hr reserve)
// Added: DEWALT DCF860B @ $179.00, life 90 hrs (≈$2.00/hr reserve). Tool-only; battery/charger sold separately.
// Added: DEWALT DCB612 @ $319.00, life 160 hrs (≈$2.00/hr reserve). Battery-pack depreciation only.
// Added: DEWALT DCS367B @ $179.00, life 90 hrs (≈$2.00/hr reserve). Tool-only; blades & batteries separate.
// Added: DEWALT DWE46202 @ $420.99, life 211 hrs (≈$2.00/hr reserve). Includes tuckpoint shroud & blade per kit.
// Added: DEWALT DWV010 @ $469.00, life 235 hrs (≈$2.00/hr reserve). HEPA/RRP dust extractor.
function renderTools(){
    const tb=byId('toolTbody'); tb.innerHTML='';
    tools.forEach(t=>{
      const tr=document.createElement('tr'); tr.dataset.id=t.id; tr.classList.toggle('fade', !t.use);
      tr.innerHTML = `
        <td><input type="checkbox" class="t_use" ${t.use?'checked':''}></td>
        <td><input class="t_name" value="${t.name}"></td>
        <td><input type="number" class="t_cost" step="1" value="${t.cost}"></td>
        <td><input type="number" class="t_life" step="100" value="${t.life}"></td>
        <td><input type="number" class="t_frac" step="0.05" value="${t.frac}"></td>
        <td><input type="number" class="t_usehrs" step="1" placeholder="0" value="${t.useHrs||''}"></td>
        <td class="right mono t_ext">$0.00</td>
        <td><button class="ghost t_del">✕</button></td>`;
      tb.appendChild(tr);
    });
    bindToolEvents(); updateAll();
  }
  function bindToolEvents(){
    document.querySelectorAll('#toolTbody tr').forEach(tr=>{
      const idx=tools.findIndex(x=>x.id===tr.dataset.id);
      tr.querySelector('.t_use').addEventListener('change', e=>{ tools[idx].use=e.target.checked; tr.classList.toggle('fade', !tools[idx].use); updateAll(); });
      tr.querySelector('.t_name').addEventListener('input', e=>{ tools[idx].name=e.target.value; });
      tr.querySelector('.t_cost').addEventListener('input', e=>{ tools[idx].cost=num(e.target.value); updateAll(); });
      tr.querySelector('.t_life').addEventListener('input', e=>{ tools[idx].life=Math.max(1,num(e.target.value)); updateAll(); });
      tr.querySelector('.t_frac').addEventListener('input', e=>{ tools[idx].frac=num(e.target.value); updateAll(); });
      tr.querySelector('.t_usehrs').addEventListener('input', e=>{ const v=num(e.target.value); tools[idx].useHrs=v; if(v>0 && !tools[idx].use){ tools[idx].use=true; tr.querySelector('.t_use').checked=true; tr.classList.remove('fade'); } updateAll(); });
      const del=tr.querySelector('.t_del'); if(del){ del.addEventListener('click', ()=>{ tools.splice(idx,1); renderTools(); }); }
    });
  }

  // ===== Assemblies (same as v0.13) omitted for brevity =====

  // ===== OH / Profit / Tax =====
  byId('ohPct').addEventListener('input', updateAll);
  byId('profitPct').addEventListener('input', updateAll);
  byId('taxPct').addEventListener('input', updateAll); // NEW

  const taxBoxes=['tax_on_materials','tax_on_concrete','tax_on_fuel','tax_on_disposal','tax_on_labor','tax_on_tools','tax_on_oh','tax_on_profit'];
  function setTaxLabels(res){ byId('taxLabel').textContent = res ? 'Tax Reimbursement' : 'Customer Sales Tax'; byId('stickyTaxLabel').textContent = res ? 'Reimb.' : 'Tax'; }
  function setTaxMode(res){ setTaxLabels(res); if(res){ byId('tax_on_materials').checked=true; byId('tax_on_concrete').checked=true; byId('tax_on_disposal').checked=true; byId('tax_on_fuel').checked=false; byId('tax_on_disposal').checked=false; byId('tax_on_labor').checked=false; byId('tax_on_tools').checked=false; byId('tax_on_oh').checked=false; byId('tax_on_profit').checked=false;
    } else { taxBoxes.forEach(id=>byId(id).checked=true); }
    taxBoxes.forEach(id=>byId(id).disabled=true);
    updateAll();
  }
  byId('tax_res').addEventListener('change', ()=>setTaxMode(true));
  byId('tax_com').addEventListener('change', ()=>setTaxMode(false));
  byId('unlockTax').addEventListener('click', ()=>{ taxBoxes.forEach(id=>byId(id).disabled=false); });

  // ===== Totals =====
  function ohProfit(directs, companyCost){
    const ohPct = num(byId('ohPct').value)/100;
    const profitPct = num(byId('profitPct').value)/100;
    const oh = directs*ohPct;
    const profit = companyCost + (directs+oh)*profitPct;
    return {oh, profit};
  }
  function customerTaxBase(parts){
    let base=0;
    if(byId('tax_on_materials').checked) base+=parts.mat;
    if(byId('tax_on_concrete').checked) base+=parts.conc;
    if(byId('tax_on_fuel').checked) base+=parts.fuel;
    if(byId('tax_on_disposal').checked) base+=parts.waste;
    if(byId('tax_on_labor').checked) base+=parts.crew;
    if(byId('tax_on_tools').checked) base+=parts.tools;
    if(byId('tax_on_oh').checked) base+=parts.oh;
    if(byId('tax_on_profit').checked) base+=parts.profit;
    return base;
  }
  function totals(){
    try{
      const {subtotalExclCompany, companyCost} = crewCalc();
      const matsub = materialsSubtotal();
      const cc = concreTecTS();
      const mv = mohicanValley();
      const concTotal = cc + mv;
      const fuel = fuelSubtotal();
      const toolsSub = toolsSubtotal();
      const wasteSub = wasteSubtotal();
      const directs = subtotalExclCompany + matsub + concTotal + fuel + toolsSub + wasteSub;
      const {oh, profit} = ohProfit(directs, companyCost);
      const taxPct = num(byId('taxPct').value)/100;
      const taxBase = customerTaxBase({mat:matsub, conc:concTotal, fuel, waste:wasteSub, crew:subtotalExclCompany, tools:toolsSub, oh, profit});
      const tax = taxBase * taxPct;
      const grand = directs + oh + profit + tax;

      byId('directs').textContent = fmt(directs);
      byId('ohAmt').textContent = fmt(oh);
      byId('profitAmt').textContent = fmt(profit);
      byId('taxAmt2').textContent = fmt(tax);
      byId('grand').textContent = fmt(grand);

      byId('stickyCrew').textContent = fmt(subtotalExclCompany);
      byId('stickyCompanyToProfit').textContent = fmt(companyCost);
      byId('stickyMat').textContent = fmt(matsub);
      byId('stickyConc').textContent = fmt(concTotal);
      byId('stickyFuel').textContent = fmt(fuel);
      byId('stickyTools').textContent = fmt(toolsSub);
      byId('stickyWaste').textContent = fmt(wasteSub);
      byId('stickyOH').textContent = fmt(oh);
      byId('stickyProfit').textContent = fmt(profit);
      byId('stickyTax').textContent = fmt(tax);
      byId('stickyGrand').textContent = fmt(grand);
    }catch(e){ const err=byId('err'); err.style.display='block'; err.textContent=e.message; console.error(e); }
  }
  function updateAll(){ totals(); }
  // --- Turcotte PUMP→GRAND patch (v14+): expose functions + delegated listeners ---
  try {
    window.updateAll = updateAll;
    window.totals = totals;
    window.mohicanValley = mohicanValley;
  } catch (e) { console && console.warn && console.warn('Export patch warn:', e); }

  // When pump-related controls (inserted later) change, force a full recalc so GRAND updates.
  (function(){
    const pumpIds = new Set(['pump_use','pump_size','pump_hours','mv_apply_pump','mv_apply_time','mv_discharge']);
    document.addEventListener('input', (ev) => { if (pumpIds.has(ev.target && ev.target.id)) { try{ updateAll(); } catch(e){} } }, true);
    document.addEventListener('change', (ev) => { if (pumpIds.has(ev.target && ev.target.id)) { try{ updateAll(); } catch(e){} } }, true);
  })();
  // --- end patch ---


  // Wire up missing listeners — THIS FIX
  ['ct_yards','ct_price','ct_delivery','mv_yards','mv_price','mv_short','mv_ex_38','mv_ex_38_ppy','pump_use','pump_size','pump_hours','mv_apply_pump','mv_discharge','mv_apply_time','fuel_ppg','fuel_gal','taxPct','job_date','ct_out_of_area']
    .forEach(id=>{ const el=byId(id); if(el) el.addEventListener('input', updateAll); });

  // Waste & Tools renders
  function toolsSubtotal(){ let sub=0; document.querySelectorAll('#toolTbody tr').forEach(tr=>{ const idx=tools.findIndex(x=>x.id===tr.dataset.id); const t=tools[idx]; const ext = t.use ? (num(t.cost)*num(t.frac)/Math.max(1,num(t.life))) * num(t.useHrs) : 0; sub+=ext; tr.querySelector('.t_ext').textContent = fmt(ext); }); byId('toolSubtotal').textContent = fmt(sub); return sub; }

  // Reset
  function resetBlank(){
    byId('taxPct').value = 6.35; byId('tax_res').checked = true; byId('tax_com').checked = false; setTaxMode(true);
    crewWideOn = true; byId('crewWideToggle').checked = true; crewDaysMode = true; byId('timeUnitsDays').checked = true; byId('crewWideQty').value='';
    crew.forEach(w=>{ w.use=true; w.hrs=0; }); renderCrew();
    materials.forEach(m=>{ m.use=false; m.qty=0; }); renderMaterials();
    byId('ct_yards').value=''; byId('ct_trips_read').textContent='0';
    byId('fuel_gal').value='';
    waste.forEach(w=>{ w.use=false; w.qty=0; }); renderWaste();
    tools.forEach(t=>{ t.use=false; t.useHrs=0; }); renderTools();
    byId('ohPct').value=0; byId('profitPct').value=0; totals();
  }
  document.getElementById('addToolBtn').addEventListener('click', ()=>{ const id='t_'+Math.random().toString(36).slice(2,7); tools.push({id, use:true, name:'Tool', cost:0, life:100000, frac:0.8, useHrs:0}); renderTools(); });
  document.getElementById('resetBtn') && document.getElementById('resetBtn').addEventListener('click', resetBlank);

  // Initial render
  renderCrew(); renderMaterials(); renderWaste(); renderTools(); setTaxMode(true); totals();
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var jd = document.getElementById('job_date');
  if(jd && !jd.value){
    const today = new Date();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    jd.value = today.getFullYear() + '-' + mm + '-' + dd;
    // Trigger initial auto-winter calc
    jd.dispatchEvent(new Event('input', {bubbles:true}));
  }
});
</script>
<!-- Turcotte patch v14+: Mohican PSI mix selector and mv_price default -->
<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function ready(fn){ if(document.readyState!=='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var priceInput = $('mv_price') || document.querySelector('input#mv_price');
    if(!priceInput){ return; } // layout unknown; bail quietly

    // Build selector
    var mixes=[
      {psi:3000, label:'3000 PSI (3/4")', price:161},
      {psi:3500, label:'3500 PSI (3/4")', price:166},
      {psi:4000, label:'4000 PSI (3/4")', price:171},
      {psi:4500, label:'4500 PSI (3/4")', price:176},
    ];
    var wrap=document.createElement('span'); wrap.className='mv-mix-wrap';
    var tag=document.createElement('span'); tag.className='mv-tag'; tag.textContent='MV Mix';
    var sel=document.createElement('select'); sel.id='mv_mix_sel';
    mixes.forEach(function(m){
      var o=document.createElement('option');
      o.value=String(m.price);
      o.textContent=m.label+' — $'+m.price.toFixed(2)+'/yd';
      sel.appendChild(o);
    });
    var manualChk=document.createElement('input'); manualChk.type='checkbox'; manualChk.id='mv_manual_override';
    var manualLbl=document.createElement('span'); manualLbl.textContent='Manual price';
    wrap.appendChild(tag); wrap.appendChild(sel); wrap.appendChild(manualChk); wrap.appendChild(manualLbl);

    // Insert after price input
    priceInput.parentNode.insertBefore(wrap, priceInput.nextSibling);

    // Init: if blank or <=0, set to 3000 PSI
    var current=parseFloat((priceInput.value||'').trim());
    if(!isFinite(current) || current<=0){ current = mixes[0].price; priceInput.value = String(current); }
    // Select the matching option
    var found = mixes.find(function(m){ return Math.abs(m.price - current) < 0.001; });
    sel.value = String(found ? found.price : mixes[0].price);

    function fireInput(el){ try{ el.dispatchEvent(new Event('input',{bubbles:true})); } catch(e){} }
    // Keep price in sync unless Manual is checked
    sel.addEventListener('change', function(){
      if(!manualChk.checked){ priceInput.value=this.value; fireInput(priceInput); }
    });
    priceInput.addEventListener('input', function(){ manualChk.checked=true; });

    // Also, if user unchecks manual, snap back to selected
    manualChk.addEventListener('change', function(){ if(!this.checked){ priceInput.value=sel.value; fireInput(priceInput);} });
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var price = document.getElementById('mv_price');
  var manual = document.getElementById('mv_manual_override');
  if (!price || !manual) return;
  function sync() {
    price.style.display = manual.checked ? 'inline-block' : 'none';
  }
  sync();
  manual.addEventListener('change', sync);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var yards = document.getElementById('mv_yards');
  if (!yards) return;
  // Create banner once
  var warn = document.getElementById('mv_min_batch_warn');
  if (!warn) {
    warn = document.createElement('div');
    warn.id = 'mv_min_batch_warn';
    warn.textContent = 'Mohican minimum allowable batch size is 2 yd (consider CC for very small loads).';
    warn.style.cssText = 'display:none;margin-top:6px;background:#2a1313;color:#ffd2d2;border:1px solid #5a2a2a;border-radius:10px;padding:6px 10px;font-size:12px';
    var mvSub = document.getElementById('mv_sub');
    if (mvSub && mvSub.parentNode && mvSub.parentNode.parentNode) {
      mvSub.parentNode.parentNode.parentNode.appendChild(warn);
    } else {
      document.body.appendChild(warn);
    }
  }
  function toggle(){
    var v = parseFloat(yards.value || '0');
    warn.style.display = (v>0 && v<2) ? 'block' : 'none';
  }
  yards.addEventListener('input', toggle);
  toggle();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const wrap = document.querySelector('.wrap');
  if(!wrap) return;
  // Build Job Info card at top
  \1
  card.setAttribute('data-card-jobinfo','1');
  card.innerHTML = `<div class="row">
    <h3 style="margin:0">Job Info</h3>
    <span class="spacer"></span>
    <label>Job date <input id="job_date_header" type="date"></label>
  </div>`;
  wrap.insertBefore(card, wrap.firstChild);

  // If there is an existing #job_date in Concrete section, move its value; else create canonical #job_date
  let old = document.getElementById('job_date');
  const headerInput = document.getElementById('job_date_header');

  function setToday(el){
    const today = new Date();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    el.value = today.getFullYear() + '-' + mm + '-' + dd;
  }

  if(old){
    // Bring over value
    headerInput.value = old.value || '';
  }
  if(!headerInput.value){
    setToday(headerInput);
  }

  // Create a single canonical #job_date that all logic uses (rename/mirror header to #job_date)
  // Approach: if an element with id=job_date exists, reuse it (hidden), else create one.
  let canonical = document.getElementById('job_date');
  if(!canonical){
    canonical = document.createElement('input');
    canonical.type = 'date';
    canonical.id = 'job_date';
    canonical.style.display = 'none';
    document.body.appendChild(canonical);
  }
  // Sync header -> canonical
  function syncToCanonical(){
    canonical.value = headerInput.value;
    canonical.dispatchEvent(new Event('input', {bubbles:true}));
    canonical.dispatchEvent(new Event('change', {bubbles:true}));
  }
  headerInput.addEventListener('input', syncToCanonical);
  headerInput.addEventListener('change', syncToCanonical);
  // Initial sync
  syncToCanonical();

  // Hide the old job_date control if present
  if(old){
    old.closest('label') ? old.closest('label').style.setProperty('display','none') : old.style.setProperty('display','none');
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Find the Mohican subtotal pill row (mv_sub exists)
  var mvSub = document.getElementById('mv_sub');
  if(!mvSub) return;
  var row = mvSub.closest('.row');
  var host = row && row.parentElement ? row.parentElement : null;
  if(!host) return;

  // Build UI rows if not already present
  if(!document.getElementById('mv_overage_row')){
    var r1 = document.createElement('div');
    r1.className = 'row';
    r1.id = 'mv_overage_row';
    r1.innerHTML = `
      <label>Avg discharge time per truck (min) <input id="mv_discharge" type="number" step="1" placeholder="e.g., 45"></label>
      <span class="pill">Time Overage: <span id="mv_time_overage" class="mono">$0.00</span></span>
      <label class="pill"><input id="mv_apply_time" type="checkbox" checked> Apply to Mohican fees</label>
    `;
    host.insertBefore(r1, row);
  }

  if(!document.getElementById('mv_pump_row')){
    var r2 = document.createElement('div');
    r2.className = 'row';
    r2.id = 'mv_pump_row';
    r2.innerHTML = `
      <label class="pill"><input id="pump_use" type="checkbox"> Use pump truck</label>
      <label>Size
        <select id="pump_size">
          <option value="32@290">32 m — $290/hr (4 hr min)</option>
          <option value="40@310">40 m — $310/hr (4 hr min)</option>
        </select>
      </label>
      <label>Hours <input id="pump_hours" type="number" step="0.5" placeholder="0"></label>
      <span class="pill">Pump Fee: <span id="mv_pump_fee" class="mono">$0.00</span></span>
      <label class="pill"><input id="mv_apply_pump" type="checkbox" checked> Apply to Mohican fees</label>
    `;
    host.insertBefore(r2, row);
    // Wire pump controls to recalc
    ['pump_use','pump_size','pump_hours','mv_apply_pump'].forEach(function(id){
      var el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', function(){
        if (window.mohicanValley) try{ mohicanValley(); } catch(e){}
        if (window.totals) try{ totals(); } catch(e){}
        if (window.updateAll) updateAll();
      });
      el.addEventListener('change', function(){
        if (window.mohicanValley) try{ mohicanValley(); } catch(e){}
        if (window.totals) try{ totals(); } catch(e){}
        if (window.updateAll) updateAll();
      });
    });
    
  }

  // Helper
  function num(v){ if(v===null||v===undefined) return 0; const s=String(v).trim(); if(s==='') return 0; const n=parseFloat(s); return Number.isFinite(n)?n:0; }
  function fmt(n){ return '$' + (Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function byId(id){ return document.getElementById(id); }

  function trucksCalc(){
    var totalY = num(byId('mv_yards')?.value || 0);
    var cap = Math.max(1, num(byId('mv_cap')?.value || 10));
    return Math.ceil((totalY||0)/cap);
  }
  function allowedMinutes(){
    var totalY = num(byId('mv_yards')?.value || 0);
    return (totalY||0) * 6; // 6 min/yd total across all trucks
  }
  function timeOverage(){
    var t = trucksCalc();
    var avg = num(byId('mv_discharge')?.value || 0);
    if(t<=0 || avg<=0) return 0;
    var actual = avg * t;
    var overMin = Math.max(0, actual - allowedMinutes());
    return (overMin/60) * 300; // $300/hr
  }
  function pumpFee(){
    if(!byId('pump_use')?.checked) return 0;
    var val = byId('pump_size')?.value || '32@290';
    var rate = val.includes('@') ? parseFloat(val.split('@')[1]) : 290;
    var hrs = Math.max( num(byId('pump_hours')?.value || 0), 4 ); // 4 hr min
    return rate * hrs;
  }
  function updateExtrasIntoManual(){
    var total = 0;
    if(byId('mv_apply_time')?.checked) total += timeOverage();
    if(byId('mv_apply_pump')?.checked) total += pumpFee();
    var dst = byId('mv_short'); // existing manual Mohican field (already included by calc)
    if(!dst) return;
    // Only auto-write if user hasn't touched it recently; use an "auto" flag
    var lock = byId('mv_short_manual_lock');
    if(lock && lock.checked) return;
    if (typeof updateAll==='function'){ try{ updateAll(); } catch(e){} }}

  // Add a small "Auto calc" toggle near mv_short if possible
  var mvShort = byId('mv_short');
  if(mvShort && !byId('mv_short_manual_lock')){
    var lbl = mvShort.closest('label');
    var holder = lbl ? lbl.parentElement : mvShort.parentElement;
    var auto = document.createElement('label');
    auto.className = 'pill';
    auto.style.marginLeft = '8px';
    auto.innerHTML = `<input id="mv_short_manual_lock" type="checkbox"> Manual override for Mohican fees`;
    holder && holder.appendChild(auto);
    mvShort.addEventListener('input', function(){ byId('mv_short_manual_lock').checked = true; });
  }

  // Wire events
  ['mv_discharge','mv_yards','mv_cap','pump_use','pump_size','pump_hours','mv_apply_time','mv_apply_pump','mv_short_manual_lock']
    .forEach(function(id){ var el = byId(id); if(el){ el.addEventListener('input', function(){ byId('mv_time_overage').textContent = fmt(timeOverage()); byId('mv_pump_fee').textContent = fmt(pumpFee()); updateExtrasIntoManual(); }); el.addEventListener('change', function(){ byId('mv_time_overage').textContent = fmt(timeOverage()); byId('mv_pump_fee').textContent = fmt(pumpFee()); updateExtrasIntoManual(); }); }});

  // Initial paint
  byId('mv_time_overage').textContent = fmt(timeOverage());
  byId('mv_pump_fee').textContent = fmt(pumpFee());
  updateExtrasIntoManual();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var taxRes = document.getElementById('tax_res');
  var taxDisposal = document.getElementById('tax_on_disposal');
  function enforce(){
    if(!taxRes || !taxDisposal) return;
    if(taxRes.checked){
      taxDisposal.checked = true;
      if (!taxDisposal.disabled) { /* leave disabled state as-is */ }
      if (typeof updateAll==='function'){ try{ updateAll(); } catch(e){} }
    }
  }
  if(taxRes){
    taxRes.addEventListener('change', enforce);
    // Initial enforce
    enforce();
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var pumpUse = document.getElementById('pump_use');
  var pumpHours = document.getElementById('pump_hours');
  function ensureMinHours(){
    if (!pumpUse || !pumpHours) return;
    if (pumpUse.checked){
      var v = parseFloat(pumpHours.value||'0')||0;
      if (v <= 0){ pumpHours.value = '4'; }
    }
  }
  if (pumpUse){
    pumpUse.addEventListener('change', function(){ ensureMinHours(); });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const wrap = document.querySelector('.wrap');
  if(!wrap) return;

  // Try to place below the Job Info card (if exists); else at top.
  const jobCard = Array.from(document.querySelectorAll('.card')).find(c => c.textContent.includes('Job Info'));
  /* removed Quick Groups placeholder card */

  } else {
    wrap.insertBefore(holder, wrap.firstChild);
  }

  // Define simple group rules by card heading text to avoid touching any calc code.
  // "Concrete" group shows cards with headings containing "Concrete", "Materials", or "Waste / Disposal".
  function headingText(card){
    const h = card.querySelector('h3,h2,h4');
    return (h ? h.textContent : '').toLowerCase();
  }
  function isCardForGroup(card, group){
  const h = headingText(card);
  if(group==='all') return true;
  if(group==='concrete') return /(concrete|materials|waste|disposal)/i.test(h);
  if(group==='masonry' || group==='pavers' || group==='bluestone' || group==='veneer' || group==='stucco') return /materials/i.test(h);
  if(group==='disposal') return /(waste|disposal)/i.test(h);
  if(group==='crew') return /(crew|time|overhead|profit)/i.test(h);
  if(group==='blockwall') return /(block\s*wall)/i.test(h);
  if(group==='fuel') return /(fuel|vehicle|gas)/i.test(h);
  return true;
}


    

  const cards = Array.from(document.querySelectorAll('.wrap > .card'));

  function applyGroup(group){
  try{
    if(group==='masonry') window.__matCats=['masonry'];
    else if(group==='pavers') window.__matCats=['pavers'];
    else if(group==='bluestone') window.__matCats=['bluestone'];
    else if(group==='veneer') window.__matCats=['stone veneer'];
    else if(group==='stucco') window.__matCats=['stucco'];
    else if(group==='blockwall') window.__matCats=['masonry','concrete'];
    else window.__matCats=null;
    if(typeof renderMaterials==='function') renderMaterials();
  } catch(e){}
const cards = Array.from(document.querySelectorAll('.wrap > .card'));
  // Filter
  cards.forEach(card => {
    if(card.contains(holder)) return; // do not hide the group card itself
    // Keep Materials card visible; its rows are filtered elsewhere
    if(card.querySelector('#matTbody')){ card.classList.remove('group-hidden'); return; }
    if(isCardForGroup(card, group)) card.classList.remove('group-hidden');
    else card.classList.add('group-hidden');
  });
  // Scroll to first visible card after the group bar.
const first = cards.find(c => !c.contains(holder) && !c.classList.contains('group-hidden'));
    if(first){
      first.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }

  holder.querySelectorAll('.tag').forEach(btn => {
    btn.addEventListener('click', () => applyGroup(btn.dataset.group));
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  function clampToMin(el){
    var min = (el.getAttribute('min')!==null) ? parseFloat(el.getAttribute('min')) : 0;
    if(!isFinite(min)) min = 0;
    var v = parseFloat(el.value || '0');
    if(!isFinite(v)) return;
    if(v < min){
      el.value = String(min);
      try { el.dispatchEvent(new Event('input',{bubbles:true})); } catch(e){}
      try { el.dispatchEvent(new Event('change',{bubbles:true})); } catch(e){}
    }
  }
  document.querySelectorAll('input[type="number"]:not([data-allow-negative])').forEach(function(el){
    if(!el.hasAttribute('min')) el.setAttribute('min','0');
    el.addEventListener('input', function(){ clampToMin(el); });
    el.addEventListener('change', function(){ clampToMin(el); });
    // Initial clamp for any prefilled negatives (just in case)
    clampToMin(el);
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const wrap = document.querySelector('.wrap');
  if(!wrap) return;

  // Ensure the main content is a tabpanel
  wrap.id = wrap.id || 'main_content_wrap';
  wrap.setAttribute('role','tabpanel');
  wrap.setAttribute('tabindex','0'); // allow focus into panel
  // active tab will update aria-labelledby to itself
  wrap.setAttribute('aria-labelledby','tab-all');

  // Build the tabs card
  const tabsCard = document.createElement('div');
  tabsCard.className = 'card a11y-tabs';
  tabsCard.innerHTML = `
    <div class="row">
      <h3 id="sections-label" style="margin:0">Sections</h3>
    </div>
    <div class="row">
      <div id="sections-tablist" role="tablist" aria-labelledby="sections-label">
        <button role="tab" id="tab-all" aria-selected="true" aria-controls="main_content_wrap" tabindex="0" data-group="all">All</button>
<button role="tab" id="tab-cleanup" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="cleanup">Cleanup</button>

        <button role="tab" id="tab-concrete" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="concrete">Concrete</button>
        <button role="tab" id="tab-masonry" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="masonry">Masonry</button>
<button role="tab" id="tab-blockwall" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="blockwall">Block Wall</button>
  <button role="tab" id="tab-veneer" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="veneer">Stone Veneer</button>
        <button role="tab" id="tab-pavers" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="pavers">Pavers</button>
<button role="tab" id="tab-stucco" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="stucco">Stucco</button>

        <button role="tab" id="tab-disposal" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="disposal">Waste / Disposal</button>
        <button role="tab" id="tab-crew" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="crew">Crew &amp; Time</button>
        <button role="tab" id="tab-fuel" aria-selected="false" aria-controls="main_content_wrap" tabindex="-1" data-group="fuel">Fuel</button>
      </div>
    </div>
  `;

  // Put tabs before the wrap container
  wrap.parentNode.insertBefore(tabsCard, wrap);

  // Helper for filter logic (same as the old, but scoped here)
  function headingText(card){
    const h = card.querySelector('h3,h2,h4'); 
    return (h ? h.textContent : '').toLowerCase();
  }
  function isCardForGroup(card, group){
  const h = headingText(card);
  if(group==='all') return true;
  if(group==='concrete') return /(concrete|materials|waste|disposal)/i.test(h);
  if(group==='masonry' || group==='pavers' || group==='bluestone' || group==='veneer' || group==='stucco') return /materials/i.test(h);
  if(group==='disposal') return /(waste|disposal)/i.test(h);
  if(group==='crew') return /(crew|time|overhead|profit)/i.test(h);
  if(group==='blockwall') return /(block\s*wall)/i.test(h);
  if(group==='fuel') return /(fuel|vehicle|gas)/i.test(h);
  return true;
}


    

  const cards = Array.from(document.querySelectorAll('.wrap > .card'));

  function applyGroup(group){
  try{
    if(group==='masonry') window.__matCats=['masonry'];
    else if(group==='pavers') window.__matCats=['pavers'];
    else if(group==='bluestone') window.__matCats=['bluestone'];
    else if(group==='veneer') window.__matCats=['stone veneer'];
    else if(group==='stucco') window.__matCats=['stucco'];
    else if(group==='blockwall') window.__matCats=['masonry','concrete'];
    else window.__matCats=null;
    if(typeof renderMaterials==='function') renderMaterials();
  } catch(e){}
cards.forEach(card => {
      if(card.querySelector('#matTbody')){ card.classList.remove('group-hidden'); return;
}
      if(isCardForGroup(card, group)) card.classList.remove('group-hidden');
      else card.classList.add('group-hidden');
    });
  }

  // Tabs behavior: manual activation (APG pattern)
  const tablist = document.getElementById('sections-tablist');
  const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));

  function setActiveTab(newTab){
    tabs.forEach(tab => {
      const selected = (tab === newTab);
      tab.setAttribute('aria-selected', String(selected));
      tab.tabIndex = selected ? 0 : -1;
    });
    // Filter content
    const group = newTab.getAttribute('data-group');
    applyGroup(group);
    // Update label reference for the panel
    wrap.setAttribute('aria-labelledby', newTab.id);
  }

  // Click = activate
  tabs.forEach(tab => {
    tab.addEventListener('click', () => { setActiveTab(tab); tab.focus(); });
  });

  // Keyboard roving tabindex + manual activation
  tablist.addEventListener('keydown', (e) => {
    const currentIndex = tabs.findIndex(t => t === document.activeElement);
    if(currentIndex === -1) return;
    let nextIndex = currentIndex;
    switch(e.key){
      case 'ArrowRight':
      case 'ArrowDown':
        nextIndex = (currentIndex + 1) % tabs.length; 
        e.preventDefault(); tabs[nextIndex].focus(); break;
      case 'ArrowLeft':
      case 'ArrowUp':
        nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
        e.preventDefault(); tabs[nextIndex].focus(); break;
      case 'Home':
        e.preventDefault(); tabs[0].focus(); break;
      case 'End':
        e.preventDefault(); tabs[tabs.length - 1].focus(); break;
      case 'Enter':
      case ' ':
        e.preventDefault(); setActiveTab(document.activeElement); break;
    }
  });

  // Initial apply
  applyGroup('all');
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  /* 1) Insert a clean spacer between the two concrete suppliers */
  (function(){
    const heading = Array.from(document.querySelectorAll('.card h3, .card h4, label'))
      .find(el => /Mohican\s+Valley/i.test(el.textContent||''));
    if (heading && heading.closest('.row')){
      const row = document.createElement('div');
      row.className = 'row';
      const hr = document.createElement('hr');
      hr.style.cssText = 'border:0;border-top:1px dashed #334155;margin:12px 0 16px;opacity:.9';
      row.appendChild(hr);
      heading.closest('.row').insertAdjacentElement('beforebegin', row);
    }
  })();

  /* 2) Make "+ Add Material" work: append to materials[], re-render, and focus new row */
  (function(){
    var btn = document.getElementById('addMatBtn');
    if (!btn) return;
    btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
        if (typeof renderMaterials === 'function') renderMaterials();
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (!rows.length) return;
          var last = rows[rows.length - 1];
          var input = last.querySelector('.mat_item');
          if (input) input.focus();
        }, 0);
      }catch(e){
        console.error('Add Material failed', e);
      }
});
        if (typeof renderMaterials === 'function') renderMaterials();
        // Focus the newly added item's name field
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (!rows.length) return;
          var last = rows[rows.length - 1];
          var input = last.querySelector('.mat_item');
          if (input) input.focus();
        }, 0);
      } catch(e){ console.error('Add Material failed', e); }
    });
  })();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('addMatBtn');
  if(!btn) return;

  function getMaterialsRef(){
    try { return (typeof materials !== 'undefined') ? materials : (window.materials||null); }
    catch(e){ return window.materials || null; }
  }

  btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
      if (typeof renderMaterials === 'function') { renderMaterials(); }
      setTimeout(function(){
        var rows = document.querySelectorAll('#matTbody tr');
        if (rows.length){
          var last = rows[rows.length-1];
          var input = last.querySelector('.mat_item');
          if (input) input.focus();
        }
      }, 0);
      if (typeof updateAll === 'function') { updateAll(); }
      return;
    }
    // Fallback: append a DOM-only row (in case data structure is unavailable)
    var tb = document.getElementById('matTbody'); if(!tb) return;
    var tr = document.createElement('tr');
    tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                   '<td><input class="mat_item" placeholder="Item"></td>' +
                   '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                   '<td><input class="mat_units" value="each"></td>' +
                   '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                   '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                   '<td class="right mono mat_ext">$0.00</td>' +
                   '<td><button class="ghost mat_del">✕</button></td>';
    tb.appendChild(tr);
    tr.querySelectorAll('input').forEach(function(el){
      el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
    });
    setTimeout(function(){ tr.querySelector('.mat_item') && tr.querySelector('.mat_item').focus(); }, 0);
    if (typeof updateAll === 'function') { updateAll(); }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var tablist = document.getElementById('sections-tablist');
  var tbody = document.getElementById('matTbody');
  if(!tbody) return;
  
  var SECTION = {
    all:       { cats: null,                   pins: null },
    concrete:  { cats: ['concrete'],           pins: new Set(['m6','m7','m10','mNH3','m2013','mTIL_DrivewayMix','mSO_KY_Bluegrass_Sod','mSO_TopSoil_Bulk','mNHM_Concrete_80lb','mLOW_ColdPatchAsphalt_50lb']) },
    masonry:   { cats: ['masonry'],            pins: new Set(['m4','m8','m9','m11']) },
    pavers:    { cats: ['pavers'],             pins: new Set(['m1','m2','m3']) },
    bluestone: { cats: ['bluestone'],          pins: new Set([]) },
    veneer:    { cats: ['stone veneer','bluestone'], pins: new Set([]) },
    stucco:    { cats: ['stucco'],             pins: new Set([]) }
  };
  function currentGroup(){
    var active = tablist && tablist.querySelector('[role="tab"][aria-selected="true"]');
    return active ? (active.getAttribute('data-group')||'all') : 'all';
  }
  function applyDim(){
    var g = currentGroup();
    var allow = (SECTION[g]||{}).pins || null;
    tbody.querySelectorAll('tr').forEach(function(tr){
      var id = tr.dataset.id || '';
      var dim = ((allow && id && !allow.has(id)));
      tr.classList.toggle('dim', dim);
    });
  }
  if (tablist){
    tablist.addEventListener('click', function(){ setTimeout(applyDim, 0); });
    tablist.addEventListener('keydown', function(e){
      if(e.key==='Enter' || e.key===' ') setTimeout(applyDim, 0);
    });
  }
  // Re-apply after Materials re-render/add
  var mo = new MutationObserver(function(){ applyDim(); });
  mo.observe(tbody, {childList:true});
  applyDim();
});
</script>
<script>
(function(){
  function ready(cb){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded', cb, {once:true});} else { cb(); } }
  ready(function(){
    try{
      var tablist = document.getElementById('sections-tablist');
      var tbody = document.getElementById('matTbody');
      if(!tbody) return;

      // Map *existing* tabs to materials row IDs (dataset.id set by renderMaterials)
      // m1: 8' Plastic paver edging
      // m2: 8' Aluminum paver edging
      // m3: 12" paver spikes — 150/box
      // m4: SPEC MIX Type S — 80 lb
      // m5: SPEC MIX Stone Veneer — 80 lb   (kept visible in all tabs since no 'Veneer' tab yet)
      // m6: Bulk crushed rock 3/4"
      // m7: Concrete wire mesh 5'×10'
      // m8: SPEC MIX Core Fill Grout 3k — 80 lb
      // m9: 12" hollow concrete block
      // m10: 6"×10' expansion joint
      /* legacy groups removed */

      function activeGroup(){
      var tablist = document.getElementById('sections-tablist');
      var active = tablist && tablist.querySelector('[role="tab"][aria-selected="true"]');
      var g = active ? (active.getAttribute('data-group')||'all') : 'all';
      if(!(window.SECTION && Object.prototype.hasOwnProperty.call(SECTION, g))) g = 'all';
      return g;
    }

      function applyHide(){
        var g = activeGroup();
        var allow = (SECTION[g]||{}).pins || null;
        tbody.querySelectorAll('tr').forEach(function(tr){
          var id = tr.dataset.id || '';
          var show = (!allow) || !id || allow.has(id); // unknown/new rows always show
          tr.style.display = show ? '' : 'none';
        });
      }

      if (tablist){
        tablist.addEventListener('click', function(){ setTimeout(applyHide, 0); });
        tablist.addEventListener('keydown', function(e){
          if(e.key==='Enter' || e.key===' ') setTimeout(applyHide, 0);
        });
      }

      // Re-apply when materials re-render or rows added
      var mo = new MutationObserver(function(){ applyHide(); });
      mo.observe(tbody, {childList:true});

      // Initial pass
      applyHide();
    }catch(e){
      console.warn('Row-hide filter disabled:', e);
    }
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var mvY = document.getElementById('mv_yards');
  if(mvY){
    mvY.setAttribute('min','0');
    mvY.setAttribute('step','0.5'); // allow halves if needed
    function clamp2(){
      var v = parseFloat(mvY.value||'0');
      if (v>0 && v<2) { mvY.value = 2; }
      if (v<0 || isNaN(v)) { mvY.value = 0; }
      if (typeof updateAll === 'function') updateAll();
    }
    mvY.addEventListener('change', clamp2);
    mvY.addEventListener('blur', clamp2);
    mvY.addEventListener('input', function(){ /* don't force during typing */ });
  }
});
</script>
<script ){="" <="" console.warn('currency="" currency:'usd',="" document.addeventlistener('domcontentloaded',="" e);="" formatter="" function(){="" if(!window.$$){="" if(!window.usd){="" if(typeof="" intl.numberformat('en-us',="" maximumfractiondigits:2});="" patch:',="" return="" script="" try{="" window.$$="function(n){" window.$$((number(n)||0));="" window.fmt="function(n){" window.usd="new" window.usd.format((number(n)||0));="" {style:'currency',="" }="" });="" };="" }catch(e){="">
<script 
document.addEventListener('DOMContentLoaded', function(){
  try{
    if(typeof window.updateAll === 'function' && !window.__updateAllWrapped){
      const raw = window.updateAll;
      let raf = 0;
      window.updateAll = function(){
        if(raf) return;
        raf = requestAnimationFrame(function(){ raf = 0; try{ raw(); }catch(e){ console.warn('updateAll error', e); } });
      };
      window.__updateAllWrapped = true;
    }
  }catch(e){ console.warn('updateAll raf patch:', e); }
});
</script>
<script !window.__updateallpost){="" &&="" (function(){="" <="" arguments),="" catch(e){}="" console.warn('updateall="" document.addeventlistener('domcontentloaded',="" e);="" error',="" function(){="" if(typeof="" if(window.totals)="" orig.apply(this,="" posthook="" raw="window.updateAll;" return="" script="" totals();="" try{="" var="" window.__updateallpost="true;" window.updateall="(function(orig){" }="" })();="" })(raw);="" });="" };="" }catch(e){="">
<script 
document.addEventListener('DOMContentLoaded', function(){
  function recalcMV(){
    try{ if(window.mohicanValley) mohicanValley(); } catch(e){}
    try{ if(window.totals) totals(); } catch(e){}
    try{ if(window.updateAll) updateAll(); } catch(e){}
  }
  ['input','change'].forEach(function(type){
    document.addEventListener(type, function(e){
      var id = e.target && e.target.id || '';
      if(/^mv_/.test(id) || /^pump_/.test(id)){
        recalcMV();
      }
    }, true); // capture to catch dynamically inserted controls
  });
});
</script>
<script !e.target)="" '';="" .test(id)="" .test(id);="" <="" ['input','change'].foreach(function(type){="" ^fuel_="" ^mv_="" ^pump_="" capture="" catch="" catch(e){}="" document.addeventlistener('domcontentloaded',="" document.addeventlistener(type,="" dynamic="" function="" function(){="" function(e){="" id="e.target.id" if(!e="" if(needstotals(id))="" if(window.totals)="" inserts="" needstotals(id){="" phase="" recalc();="" recalc(){="" return="" return;="" script="" to="" totals();="" true);="" try{="" var="" ||="" }="" });="" },="">
<script 
document.addEventListener('DOMContentLoaded', function(){
  function recalc(){
    try{ updateAll(); } catch(e){}
  }
  ['input','change'].forEach(function(type){
    document.addEventListener(type, function(e){
      var id = e && e.target && e.target.id || '';
      if(/^mv_/.test(id) || /^pump_/.test(id) || /^fuel_/.test(id)){
        recalc();
      }
    }, true);
  });
});
</script>
<script &&="" <="" ap="document.getElementById('mv_apply_pump');" ap){="" ap.checked="!!use.checked;" catch(e){}="" document.addeventlistener('domcontentloaded',="" function="" function(){="" if(use="" script="" sync(){="" sync);="" try{="" updateall();="" use="document.getElementById('pump_use');" use.addeventlistener('change',="" use.addeventlistener('input',="" var="" }="" });="">
<!-- Global live-totals delegate: keeps every input/select/checkbox in sync -->
<script 
document.addEventListener('DOMContentLoaded', function(){
  function recalc(){ try{ if (typeof updateAll==='function') updateAll(); } catch(e){} }
  // Recalc on any input/change across the app (capture = catches dynamic rows too)
  document.addEventListener('input',  function(e){
    try{
      var t = e && e.target;
      if(!t) return;
      // Auto-check a nearby "Use" checkbox if a numeric qty > 0 is entered (materials/waste rows)
      if(t.matches && t.matches('input[type="number"]')){
        var v = parseFloat(t.value);
        if(!isNaN(v) && v>0){
          var row = t.closest && (t.closest('tr') || t.closest('.row') || t.parentElement);
          if(row){
            var chk = row.querySelector && row.querySelector('input[type="checkbox"]');
            if(chk && !chk.checked){ chk.checked = true; }
          }
        }
      }
    }catch(err){}
    recalc();
  }, true);
  document.addEventListener('change', function(){ recalc(); }, true);
});
</script>
<script (typeof="" )="" document.addeventlistener('domcontentloaded',="" else="" function="" function(){="" h3'));="" h3s="Array.from(document.querySelectorAll('.card" if="" if(group="veneer" matcard="h3s.find(h=" pick(group){="" rendermaterials="function" rendermaterials();="" setcats(['bluestone','masonry','stone="" setcats(['stone="" setcats(c){="" setcats(null);="" var="" veneer','masonry','bluestone']);="" veneer']);="" window.__matcats="c;" }="">/Materials/i.test(h.textContent));
    if(matCard){ matCard.scrollIntoView({behavior:'smooth', block:'start'}); }
  }
  document.querySelectorAll('.groupbar .tag[data-group="bluestone"]').forEach(btn=>{
    btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
  });
  document.querySelectorAll('.groupbar .tag[data-group="veneer"]').forEach(btn=>{
    btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
  });
});
</script>
<script &&="" '').trim();="" (="" (!m.coveragesqft="" (function(){="" (sf)="" (sf,="" (typeof="" (window.__autocovsq)="" (window.materials||[]).foreach(function(m){="" )="" )){="" *="" 1="" :="" <="" ?="" and="" appears="" area="" catch(e){}="" coverage="" default="" document.addeventlistener('domcontentloaded',="" explicit="" feet="" feet,="" foot="" for="" ft,="" ft²),="" function="" function(){="" if="" items,="" like="" look="" m.coveragesqft="1;" m.units="" marksqcoverage();="" marksqcoverage(){="" no="" no-op="" norm="ft2" norm.includes('squarefeet')="" norm.includes('squarefoot')="" norm.startswith('sf')="" norm.startswith('sq')="" norm.startswith('sqft')="" norm.startswith('sqft.')="" norm.startswith('sqft2')="" placeholder="" re-render="" recompute="" rendermaterials="function" rendermaterials();="" return;="" script="" set,="" sf="" so="" sq="" sqft,="" square="" string(m.units).tolowercase()="" then="" these="" to="" totals="" try{="" u="(m" unit="" units="" updateall="function" updateall();="" var="" window.__autocovsq="true;" ||="" }="" })();="" });="" }catch(e){="">
<script 
(function(){
  if (window.__stuccoHardFilter) return; window.__stuccoHardFilter = true;
  function hardHideWasteForStucco(group){
    try{
      if(group!=='stucco') return;
      // Make sure materials are filtered to Stucco
      window.__matCats = ['stucco'];
      if (typeof renderMaterials==='function') renderMaterials();
      // Hide Waste / Disposal card explicitly
      document.querySelectorAll('.wrap > .card').forEach(function(card){
        var h = (card.querySelector('h3')||{}).textContent||'';
        if (/waste\s*\/\s*disposal/i.test(h)) card.classList.add('group-hidden');
      });
    }catch(e){/* no-op */}
  }
  // Monkey-patch setActiveTab to run our hard filter after applyGroup
  const tablist = document.getElementById('sections-tablist');
  if (!tablist) return;
  const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
  // Find existing setActiveTab in window scope (bound in closure); re-bind click handlers instead
  tabs.forEach(function(tab){
    tab.addEventListener('click', function(){
      const group = tab.getAttribute('data-group');
      // run shortly after built-in handler
      setTimeout(function(){ hardHideWasteForStucco(group); }, 0);
    });
  });
  // Also run on load in case Stucco is initially selected
  document.addEventListener('DOMContentLoaded', function(){
    const selected = tablist.querySelector('[role="tab"][aria-selected="true"]');
    if (selected) hardHideWasteForStucco(selected.getAttribute('data-group'));
  });
})();
</script>
<script (function(){="" (window.__stuccohidewasteapplied)="" active="" and="" card,="" css="" disposal="" do="" document.queryselectorall('.wrap="" function="" hiding.="" if="" label="" labelcards(){="" let="" minimal,="" return;="" robust:="" tab,="" the="" track="" try{="" waste="" window.__stuccohidewasteapplied="true;"> .card').forEach(function(card){
        var h = (card.querySelector('h3')||{}).textContent||'';
        if (/^\s*Waste\s*\/\s*Disposal\s*$/i.test(h)) card.dataset.card = 'waste';
      });
    }catch(e){/* no-op */}
  }

  function readActiveGroup(){
    var tablist = document.getElementById('sections-tablist');
    if (!tablist) return null;
    var sel = tablist.querySelector('[role="tab"][aria-selected="true"]');
    return sel ? sel.getAttribute('data-group') : null;
  }

  function updateBodyData(){
    try{
      var g = readActiveGroup();
      if (g) document.body.dataset.activeGroup = g;
    }catch(e){/* no-op */}
  }

  function setupListeners(){
    var tablist = document.getElementById('sections-tablist');
    if (!tablist) return;
    // Click handler ensures body dataset stays in sync
    tablist.addEventListener('click', function(ev){
      var t = ev.target.closest('[role="tab"]');
      if (!t) return;
      // allow original handler to run first (which toggles aria-selected)
      setTimeout(updateBodyData, 0);
    });

    // Keyboard handler (Enter/Space activation) — mirror approach
    tablist.addEventListener('keydown', function(ev){
      if (ev.key==='Enter' || ev.key===' ') {
        setTimeout(updateBodyData, 0);
      }
    });

    // As a fallback, observe aria-selected changes with MutationObserver
    try{
      var obs = new MutationObserver(function(){
        updateBodyData();
      });
      obs.observe(tablist, { subtree:true, attributes:true, attributeFilter:['aria-selected'] });
    }catch(e){/* MutationObserver support assumed modern; ignore if blocked */}
  }

  function init(){
    labelCards();
    setupListeners();
    // Run once on load
    updateBodyData();
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  } else {
    init();
  }
})();
</script>
<!-- FIX: Ensure Materials re-filters when the Stucco tab is active; also sync data-active-group for CSS -->
<script &&="" '+tablist_sel+'="" 'all';="" ((ev.key="Enter" (btn){="" (document.readystate="loading" (function(){="" (list){="" (t.getattribute('data-group')="" (typeof="" )="" ){="" .active,[data-active="true" 0);="" :="" ;="" <="" =="stucco" ?="" ['stucco']="" [data-group]');="" [role="tab" ]')){="" ]');="" ],="" ][aria-selected="true" aria-selected="" attributefilter:['aria-selected']="" attributes:true,="" btn="ev.target.closest(TABLIST_SEL+'" changes="" clear="" code="" computeactivegroup(){="" defer="" document.activeelement="" document.activeelement.matches(tablist_sel+'="" document.addeventlistener('click',="" document.addeventlistener('domcontentloaded',="" document.addeventlistener('keydown',="" document.body.dataset.activegroup="g" else="" ev.key=" " filter="" for="" force="" forced="" function="" function(){="" function(ev){="" getgroupfromactiveclass()="" getgroupfromactiveclass(){="" getgroupfromaria()="" getgroupfromaria(){="" if="" initial="" it="" lastclickedgroup="document.activeElement.getAttribute('data-group')" let="" list="document.querySelector(TABLIST_SEL);" mo="new" mo.observe(list,="" mutationobserver="" mutationobserver(ontabsmutation);="" non-stucco;="" null)="" null;="" only="" onpossibletabclick(ev){="" onpossibletabclick,="" ontabsmutation(){="" rendermaterials="function" rendermaterials();="" return="" script="" setactivegroup(computeactivegroup());="" setactivegroup(g){="" sets="" settimeout(ontabsmutation,="" stucco="" subtree:true,="" sync="" t="" tablist_sel="#sections-tablist" their="" to="" true);="" update="" updateall="function" updateall();="" var="" window.__matcats="(g" {="" {once:true});="" ||="" }="" })();="" });="" },="">
<script 
document.addEventListener('DOMContentLoaded', function(){
  var o = document.getElementById('ct_out_of_area');
  if(o){ o.checked = false; try{ updateAll(); } catch(e){} }
}, true);
</script>
<script !="null){" !rateinp)="" "")="" "";="" &&="" (="" (function(){="" (idx="" (nameel.value="" (rate="" (role="laborer" (tr)="" (var="" (window.crew="" )="" .name,="" :="" ?="" ]");="" a="" array.isarray(window.crew)){="" c="" c.id="(tr.dataset" cell="" else="" fallback:="" find="" findownerrow(){="" for="" function="" i="0;i&lt;rows.length;i++){" i.test(name)="" i.test(name))="" idx="crew.findIndex(function(c){" if="" if(!rolesel="" if(!tr)="" includes="" input[type="text" model="" name="nameEl" nameel='rows[i].querySelector(".crew_name,' nameel.textcontent="" null;="" or="" owner="" present="" rate="25;" rateinp='tr.querySelector(".crew_rate");' rateinp.value="String(rate);" return="" return;="" rob="" role='String(roleSel.value||"").toLowerCase();' rolesel='tr.querySelector(".crew_role");' row="" rows='document.querySelectorAll("#crewTbody' rows[i];="" syncownerrate(tr){="" to="" tr='document.querySelector("#crewTbody' tr");="" tr.dataset.id);="" tr;="" tr[data-id="owner" try="" try{="" update="" var="" whose="" ||="" }="" });="">= 0 && crew[idx]){
            crew[idx].rate = rate*1;
            crew[idx].role = role;
          }
        }
        if (typeof updateAll === "function") { try{ updateAll(); } catch(e){} }
      }
    }catch(e){/* noop */}
  }
  function attach(){
    var tr = findOwnerRow();
    if(!tr) return false;
    var roleSel = tr.querySelector(".crew_role");
    if(!roleSel) return false;
    if(!roleSel.__robAutorate){
      roleSel.addEventListener("change", function(){ syncOwnerRate(tr); }, true);
      roleSel.__robAutorate = true;
    }
    // Enforce once on attach (handles initial state)
    syncOwnerRate(tr);
    return true;
  }
  // Try on DOM ready, and a few retries in case UI renders late
  function onReady(fn){ if(document.readyState!=="loading") fn(); else document.addEventListener("DOMContentLoaded", fn, {once:true}); }
  onReady(function(){
    var ok = attach();
    var tries = 0;
    var t = setInterval(function(){
      if (ok || tries>10){ clearInterval(t); return; }
      ok = attach(); tries++;
    }, 200);
  });
})();
</script>
<script "").tolowercase();="" &&="" (extend="" (function(){="" 25,="" 30="" 30,="" 43.75,="" 50,="" adjust="" array.from(document.queryselectorall("#crewtbody="" array.isarray(window.crew)){="" backing="" by="" company:="" const="" default="" foreman:="" function="" getrole(tr){="" getrows(){="" here="" hourly="" id="tr.dataset" idx="crew.findIndex(c=" if="" if(!inp)="" if(window.crew="" inp="tr" inp.value="String(val);" laborer:="" mason:="" model="" needed)="" other:="" owner:="" present="" rates="" return="" return;="" role="" sel="tr" sel.value="" setrate(tr,="" string(sel="" tm_default_rates="{" tr"));="" tr.dataset.id;="" tr.queryselector(".crew_rate");="" tr.queryselector(".crew_role");="" try{="" update="" val){="" var="" ||="" }="" };="">c && c.id===id);
        if(idx>=0 && crew[idx]){
          crew[idx].rate = Number(val)||0;
        }
      }
    } catch(e){}
  }
  function isOwnerRow(tr){
    if(!tr) return false;
    if(tr.dataset && tr.dataset.id === "owner") return true;
    try{
      var nameEl = tr.querySelector(".crew_name, .name, input[type='text']");
      var name = nameEl ? (nameEl.value || nameEl.textContent || "") : "";
      return /\bowner\b/i.test(name) || /\brob\b/i.test(name);
    }catch(e){ return false; }
  }
  function currentRate(tr){
    var inp = tr && tr.querySelector(".crew_rate");
    return inp ? Number(inp.value||0) : 0;
  }
  function anyDefaultValue(val){
    return Object.values(TM_DEFAULT_RATES).some(v => Math.abs((Number(val)||0) - v) < 1e-9);
  }
  function markManual(tr){
    if(!tr) return;
    tr.dataset.manualRate = "true";
    try{
      if(window.crew && Array.isArray(window.crew)){
        var id = tr.dataset && tr.dataset.id;
        var idx = crew.findIndex(c=>c && c.id===id);
        if(idx>=0 && crew[idx]) crew[idx].manualRate = true;
      }
    } catch(e){}
  }
  function applyDefaultForRow(tr){
    if(!tr) return;
    var role = getRole(tr);
    var def = TM_DEFAULT_RATES[role];
    if(def==null) return;
    var isOwner = isOwnerRow(tr);
    var manual = tr.dataset.manualRate === "true";
    var cur = currentRate(tr);
    // Rule: always enforce defaults for the Owner row on role change.
    // For other rows: set default if user hasn't manually overridden OR current equals some other default (i.e., still baseline).
    if(isOwner || !manual || anyDefaultValue(cur)){
      setRate(tr, def);
      // If we just applied a default due to role change, keep manual flag as-is (do not set).
      try{ if(typeof updateAll==="function") updateAll(); } catch(e){}
    }
  }
  function bindRow(tr){
    if(!tr || tr.__tmBound) return;
    var roleSel = tr.querySelector(".crew_role");
    var rateInp = tr.querySelector(".crew_rate");
    if(roleSel){
      roleSel.addEventListener("change", function(){
        applyDefaultForRow(tr);
      }, true);
    }
    if(rateInp){
      rateInp.addEventListener("input", function(){
        markManual(tr);
      }, true);
    }
    tr.__tmBound = true;
  }
  function attachAll(){
    getRows().forEach(bindRow);
    // On first attach, enforce Owner row mapping once (in case initial load has wrong value)
    try{
      var ownerRow = getRows().find(isOwnerRow);
      if(ownerRow){
        var def = TM_DEFAULT_RATES[getRole(ownerRow)];
        if(def!=null && currentRate(ownerRow)!==def){
          setRate(ownerRow, def);
          if(typeof updateAll==="function") updateAll();
        }
      }
    } catch(e){}
  }
  function onReady(fn){ if(document.readyState!=="loading") fn(); else document.addEventListener("DOMContentLoaded", fn, {once:true}); }
  onReady(function(){
    // Initial attach
    attachAll();
    // Retry a few times in case crew table renders late
    var tries = 0, t = setInterval(function(){
      attachAll();
      if(++tries>10) clearInterval(t);
    }, 250);
    // Also re-attach after any global updateAll if available
    try{
      if(typeof window.updateAll === "function" && !window.updateAll.__tmWrapped){
        var _u = window.updateAll;
        window.updateAll = function(){ var r = _u.apply(this, arguments); try{ attachAll(); } catch(e){} return r; };
        window.updateAll.__tmWrapped = true;
      }
    } catch(e){}
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  function updatePanels(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var panels = document.querySelectorAll('.wrap .panel');
    panels.forEach(function(p){
      var hasMat = !!p.querySelector('#matTbody');
      var hasTabs = !!p.querySelector('#sections-tablist');
      p.style.display = isCleanup ? ((hasMat||hasTabs)?'':'none') : '';
    });
    function hideCardBy(sel){
      var el = document.querySelector(sel);
      if (!el) return;
      var card = el.closest('.card');
      if (card) card.style.display = isCleanup ? 'none' : '';
    }
    hideCardBy('#taxPct');
    hideCardBy('#crewCount'); hideCardBy('#crewHours'); hideCardBy('#crewRate');
    if (isCleanup){
      var headers = document.querySelectorAll('.wrap .card h2, .wrap .card h3, .wrap .card .card-title');
      headers.forEach(function(h){
        var t = (h.textContent||'').toLowerCase();
        if (t.includes('crew') && t.includes('time')){
          var c = h.closest('.card'); if (c) c.style.display = 'none';
        }
      });
    }
  }
  var tablist = document.getElementById('sections-tablist');
  if (tablist){
    tablist.addEventListener('click', function(){ setTimeout(updatePanels, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(updatePanels, 0); });
  }
  var mo = new MutationObserver(updatePanels);
  mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  updatePanels();
});
</script>
<script>
(function(){
  function hideJobInfoOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var el = document.getElementById('job_date_header');
    if (!el) return; // job info card not created yet
    var card = el.closest('.card');
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideJobInfoOnCleanup();
    // run again after Job Info builder runs; and when active-group changes
    setTimeout(hideJobInfoOnCleanup, 100);
    var mo = new MutationObserver(hideJobInfoOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>
<script>
(function(){
  function hideQuickGroupsOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var gb = document.querySelector('.wrap .card .groupbar');
    if (!gb) return;
    var card = gb.closest('.card');
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideQuickGroupsOnCleanup();
    var mo = new MutationObserver(hideQuickGroupsOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>
<script>
(function(){
  // Remove the Concrete tab from the Sections list when Cleanup is active; restore it otherwise.
  var removedConcreteBtn = null; /* disabled */
  function toggleConcreteInCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var tablist = document.getElementById('sections-tablist');
    if (!tablist) return;
    var concreteBtn = tablist.querySelector('[role="tab"][data-group="concrete"]');
    if (isCleanup){
      if (concreteBtn){
        // cache and remove
        removedConcreteBtn = concreteBtn;
        concreteBtn.parentNode/* .removeChild(concreteBtn) -- disabled */;
      }
    } else {
      // restore if missing and we have a cached copy
      var exists = tablist.querySelector('[role="tab"][data-group="concrete"]');
      if (!exists && removedConcreteBtn){
        // Insert back to its original general position: before Masonry if present; else append at start
        var masonryBtn = tablist.querySelector('[role="tab"][data-group="masonry"]');
        if (masonryBtn && masonryBtn.parentNode){
          masonryBtn.parentNode.insertBefore(removedConcreteBtn, masonryBtn);
        } else {
          tablist.insertBefore(removedConcreteBtn, tablist.firstChild);
        }
        removedConcreteBtn = null;
      }
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    toggleConcreteInCleanup();
    var mo = new MutationObserver(toggleConcreteInCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>
<script>
(function(){
  function hideVehicleFuelOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var card = null;
    // Try to locate by common IDs inside the card
    var probeIds = ['vehicle_fuel','vehicleFuel','fuelCost','fuelQty','vehFuel','fuel_cost'];
    for (var i=0;i<probeIds.length && !card;i++){
      var el = document.getElementById(probeIds[i]);
      if (el){ card = el.closest('.card'); }
    }
    // Fallback: find a card whose header contains "Vehicle Fuel"
    if (!card){
      var headers = document.querySelectorAll('.wrap .card h2, .wrap .card h3, .wrap .card .card-title');
      headers.forEach(function(h){
        var t = (h.textContent||'').toLowerCase();
        if (!card && t.includes('vehicle') && t.includes('fuel')){
          var c = h.closest('.card'); if (c) card = c;
        }
      });
    }
    if (card){ card.style.display = isCleanup ? 'none' : ''; }
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideVehicleFuelOnCleanup();
    var mo = new MutationObserver(hideVehicleFuelOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>
<script>
(function(){
  function hideWasteDisposalOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var card = null;
    var ids = ["wasteCost", "wasteQty", "disposalCost", "disposalQty", "dumpsterCost", "dumpsterQty", "waste_fee", "disposal_fee", "dump_fee", "dumpster", "wasteDisposal", "waste_disposal"];
    for (var i=0;i<ids.length && !card;i++){
      var el = document.getElementById(ids[i]);
      if (el) card = el.closest('.card');
    }
    if (!card){
      var headers = document.querySelectorAll('.wrap .card h2, .wrap .card h3, .wrap .card .card-title');
      headers.forEach(function(h){
        var t = (h.textContent||'').toLowerCase();
        if (!card && t.includes('waste') && t.includes('disposal')){
          var c = h.closest('.card'); if (c) card = c;
        }
      });
    }
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideWasteDisposalOnCleanup();
    var mo = new MutationObserver(hideWasteDisposalOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>
<script>
(function(){
  function hideToolsDeprOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var card = null;
    var ids = ["toolsDepreciation", "toolDepreciation", "depreciationReserve", "toolsReserve", "deprReserve", "tools_depreciation", "tool_depreciation", "depreciation_reserve", "tools_reserve", "deprRate", "deprCost", "deprAmount", "toolsDepr", "deprReservePct"];
    for (var i=0;i<ids.length && !card;i++){ 
      var el = document.getElementById(ids[i]); 
      if (el) card = el.closest('.card'); 
    }
    if (!card){ 
      var headers = document.querySelectorAll('.wrap .card h2, .wrap .card h3, .wrap .card .card-title');
      headers.forEach(function(h){ 
        var t = (h.textContent||'').toLowerCase();
        if (!card && t.includes('tools') && (t.includes('depreciation') || t.includes('depreciation reserve'))){
          var c = h.closest('.card'); if (c) card = c; 
        }
      });
    }
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  document.addEventListener('DOMContentLoaded', function(){ 
    hideToolsDeprOnCleanup();
    var mo = new MutationObserver(hideToolsDeprOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
  });
})();
</script>
<script>
(function(){
  function hideTotalsOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var cards = document.querySelectorAll('.wrap .card');
    var needles = ['directs','overhead','profit','tax reimbursement','grand'];
    cards.forEach(function(card){
      var t = (card.textContent || '').toLowerCase();
      var isTotals = needles.every(function(k){ return t.includes(k); });
      if (isTotals){
        card.style.display = isCleanup ? 'none' : '';
      }
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideTotalsOnCleanup();
    // run again if DOM mutates or tab changes
    var mo = new MutationObserver(hideTotalsOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    // also observe main content area for dynamic build
    var main = document.querySelector('.wrap') || document.body;
    var mo2 = new MutationObserver(function(){ hideTotalsOnCleanup(); });
    mo2.observe(main, { childList:true, subtree:true });
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  function hideConcreteOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var el = document.getElementById('ct_yards') || document.getElementById('mv_yards');
    if (!el) return;
    var card = el.closest('.card');
    if (card) card.style.display = isCleanup ? 'none' : '';
  }
  hideConcreteOnCleanup();
  var mo = new MutationObserver(hideConcreteOnCleanup);
  mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
});
</script>
<script>
(function(){
  function hideWasteDisposalOnCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var cards = document.querySelectorAll('.wrap .card');
    cards.forEach(function(card){
      var txt = (card.textContent || '').toLowerCase();
      // Header-focused match (stricter)
      var header = card.querySelector('h1,h2,h3,.card-title');
      var htxt = header ? (header.textContent||'').toLowerCase() : '';
      var headerLooksRight = (htxt.includes('waste') && (htxt.includes('disposal') || htxt.includes('dump') || htxt.includes('dumpster')));
      // Content token match (more tolerant)
      var tokens = ['waste','disposal','dump','dumpster'];
      var tokenHits = tokens.filter(t => txt.includes(t)).length;
      var looksLikeWaste = headerLooksRight || tokenHits >= 2;
      if (looksLikeWaste){
        card.style.display = isCleanup ? 'none' : '';
      }
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    hideWasteDisposalOnCleanup();
    // re-run when tab changes or DOM mutates
    var mo = new MutationObserver(hideWasteDisposalOnCleanup);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    var main = document.querySelector('.wrap') || document.body;
    var mo2 = new MutationObserver(function(){ hideWasteDisposalOnCleanup(); });
    mo2.observe(main, { childList:true, subtree:true });
  });
})();
</script>
<script>
(function(){
  // Robust, sticky hide for "Waste / Disposal" while Cleanup is active.
  function findWasteCard(){
    // Try common IDs first
    var ids = ['waste','disposal','dumpster','wasteCost','disposalCost','dumpsterCost','wasteDisposal','waste_disposal'];
    for (var i=0;i<ids.length;i++){
      var el = document.getElementById(ids[i]);
      if (el){ var card = el.closest('.card'); if (card) return card; }
    }
    // Fallback: header text contains tokens
    var tokens = ['waste','disposal','dump','dumpster'];
    var cards = document.querySelectorAll('.wrap .card');
    for (var j=0;j<cards.length;j++){
      var c = cards[j];
      var hdr = c.querySelector('h1,h2,h3,.card-title');
      var htxt = hdr ? (hdr.textContent||'').toLowerCase() : '';
      var txt  = (c.textContent||'').toLowerCase();
      var tokenHits = tokens.filter(t => txt.includes(t)).length;
      if ((htxt.includes('waste') && (htxt.includes('disposal') || htxt.includes('dump') || htxt.includes('dumpster'))) || tokenHits >= 2){
        return c;
      }
    }
    return null;
  }
  function hideWasteIfCleanup(){
    var isCleanup = document.body.getAttribute('data-active-group') === 'cleanup';
    var card = findWasteCard();
    if (!card) return;
    card.style.display = isCleanup ? 'none' : '';
  }
  function scheduleHideWaste(){
    // Run now, then again on the next animation frame and a short timeout
    try { hideWasteIfCleanup(); } catch(e){}
    if (window.requestAnimationFrame){
      requestAnimationFrame(function(){ try { hideWasteIfCleanup(); } catch(e){} });
    }
    setTimeout(function(){ try { hideWasteIfCleanup(); } catch(e){} }, 30);
    setTimeout(function(){ try { hideWasteIfCleanup(); } catch(e){} }, 120);
  }

  document.addEventListener('DOMContentLoaded', function(){
    scheduleHideWaste();
    // Re-run when Cleanup is toggled or DOM is rebuilt
    var bodyObs = new MutationObserver(scheduleHideWaste);
    bodyObs.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    // Observe the main content region for rebuilds (cards added/removed)
    var main = document.querySelector('.wrap') || document.body;
    var treeObs = new MutationObserver(function(muts){
      // Only bother if we're currently in Cleanup
      if (document.body.getAttribute('data-active-group') === 'cleanup'){
        scheduleHideWaste();
      }
    });
    treeObs.observe(main, { childList:true, subtree:true });

    // Also hook the sections tablist interactions
    var tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', function(){ scheduleHideWaste(); }, true);
      tabs.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' ') scheduleHideWaste();
      }, true);
    }
  });
})();
</script>
<script>
(function(){
  // Also hide "Waste / Disposal" for the Stone Veneer tab (active group 'veneer').
  const HIDE_GROUPS = new Set(['cleanup','veneer']);
  function findWasteCard_v2(){
    // IDs first
    var ids = ['waste','disposal','dumpster','wasteCost','disposalCost','dumpsterCost','wasteDisposal','waste_disposal'];
    for (var i=0;i<ids.length;i++){
      var el = document.getElementById(ids[i]);
      if (el){ var card = el.closest('.card'); if (card) return card; }
    }
    // Fallback by header/text tokens
    var tokens = ['waste','disposal','dump','dumpster'];
    var cards = document.querySelectorAll('.wrap .card');
    for (var j=0;j<cards.length;j++){
      var c = cards[j];
      var hdr = c.querySelector('h1,h2,h3,.card-title');
      var htxt = hdr ? (hdr.textContent||'').toLowerCase() : '';
      var txt  = (c.textContent||'').toLowerCase();
      var tokenHits = tokens.filter(t => txt.includes(t)).length;
      if ((htxt.includes('waste') && (htxt.includes('disposal') || htxt.includes('dump') || htxt.includes('dumpster'))) || tokenHits >= 2){
        return c;
      }
    }
    return null;
  }
  function hideWasteIfInGroups(){
    var grp = document.body.getAttribute('data-active-group');
    var isHide = HIDE_GROUPS.has(grp);
    var card = findWasteCard_v2();
    if (!card) return;
    card.style.display = isHide ? 'none' : '';
  }
  function schedule(){
    try { hideWasteIfInGroups(); } catch(e){}
    if (window.requestAnimationFrame){
      requestAnimationFrame(function(){ try { hideWasteIfInGroups(); } catch(e){} });
    }
    setTimeout(function(){ try { hideWasteIfInGroups(); } catch(e){} }, 30);
    setTimeout(function(){ try { hideWasteIfInGroups(); } catch(e){} }, 120);
  }
  document.addEventListener('DOMContentLoaded', function(){
    schedule();
    var bodyObs = new MutationObserver(schedule);
    bodyObs.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    var main = document.querySelector('.wrap') || document.body;
    var treeObs = new MutationObserver(function(){
      if (HIDE_GROUPS.has(document.body.getAttribute('data-active-group'))) schedule();
    });
    treeObs.observe(main, { childList:true, subtree:true });
    var tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', schedule, true);
      tabs.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' ') schedule();
      }, true);
    }
  });
})();
</script>
<script>
(function(){
  const HIDE_GROUPS = new Set(['cleanup','veneer']);
  const TOKENS = ['waste','disposal','dump','dumpster'];

  function markWasteCards(root){
    root = root || document;
    const cards = root.querySelectorAll('.wrap .card');
    cards.forEach((c)=>{
      if (c.hasAttribute('data-card-waste')) return; // already marked
      const hdr = c.querySelector('h1,h2,h3,.card-title');
      const htxt = (hdr ? hdr.textContent : '').toLowerCase();
      const txt  = (c.textContent || '').toLowerCase();
      const tokenHits = TOKENS.filter(t => txt.includes(t)).length;
      const headerLooksRight = (htxt.includes('waste') && (htxt.includes('disposal') || htxt.includes('dump') || htxt.includes('dumpster')));
      if (headerLooksRight || tokenHits >= 2){
        c.setAttribute('data-card-waste','1');
      }
    });
  }

  function applyWasteHide(){
    const grp = document.body.getAttribute('data-active-group');
    const shouldHide = HIDE_GROUPS.has(grp);
    document.querySelectorAll('.wrap .card[data-card-waste]').forEach((c)=>{
      c.style.display = shouldHide ? 'none' : '';
    });
  }

  function schedule(){
    try { markWasteCards(); applyWasteHide(); } catch(e){}
    if (window.requestAnimationFrame){
      requestAnimationFrame(()=>{ try { markWasteCards(); applyWasteHide(); } catch(e){} });
    }
    setTimeout(()=>{ try { markWasteCards(); applyWasteHide(); } catch(e){} }, 30);
    setTimeout(()=>{ try { markWasteCards(); applyWasteHide(); } catch(e){} }, 120);
  }

  document.addEventListener('DOMContentLoaded', function(){
    schedule();
    const main = document.querySelector('.wrap') || document.body;
    // Observe subtree changes (cards rebuilt) and re-tag/re-hide
    const treeObs = new MutationObserver((muts)=>{
      let needs = false;
      for (const m of muts){
        if (m.addedNodes && m.addedNodes.length){
          needs = true; break;
        }
      }
      if (needs) schedule();
    });
    treeObs.observe(main, { childList:true, subtree:true });

    // Observe tab (active-group) changes
    const attrObs = new MutationObserver(schedule);
    attrObs.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });

    // Run on tab clicks/keys as well
    const tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', schedule, true);
      tabs.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') schedule(); }, true);
    }
  });
})();
</script>
<script>
(function(){
  function forceShowCrewOnCrewTab(){
    var grp = document.body.getAttribute('data-active-group');
    var isCrewTab = (grp === 'crew');
    var ids = ['crewCount','crewHours','crewRate'];
    var card = null;
    for (var i=0;i<ids.length && !card;i++){
      var el = document.getElementById(ids[i]);
      if (el) card = el.closest('.card');
    }
    if (card){
      card.style.display = isCrewTab ? '' : card.style.display;
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    forceShowCrewOnCrewTab();
    var mo = new MutationObserver(forceShowCrewOnCrewTab);
    mo.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    var tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', forceShowCrewOnCrewTab, true);
      tabs.addEventListener('keydown', function(e){ if (e.key==='Enter' || e.key===' ') forceShowCrewOnCrewTab(); }, true);
    }
  });
})();
</script>
<script>
(function(){
  // Make the Crew & Time card resilient to tab hops and DOM rebuilds.
  const CREW_IDS = ['crewCount','crewHours','crewRate'];

  function findCrewCard(){
    // Prefer known inputs
    for (const id of CREW_IDS){
      const el = document.getElementById(id);
      if (el){
        const card = el.closest('.card');
        if (card) return card;
      }
    }
    // Fallback by header text
    const cards = document.querySelectorAll('.wrap .card');
    for (const c of cards){
      const hdr = c.querySelector('h1,h2,h3,.card-title');
      const t = (hdr ? hdr.textContent : c.textContent || '').toLowerCase();
      if (t.includes('crew') && t.includes('time')) return c;
    }
    return null;
  }

  function ensureCrewCardVisible(){
    const grp = document.body.getAttribute('data-active-group');
    const isCrewTab = (grp === 'crew');
    const card = findCrewCard();
    if (!card) return;

    // Mark it for CSS overrides too
    card.setAttribute('data-card-crew','1');

    if (isCrewTab){
      // Remove inline and attribute-based hides on card and ancestors
      const chain = [card, card.parentElement, card.parentElement && card.parentElement.parentElement].filter(Boolean);
      for (const el of chain){
        if (!el) continue;
        // Clear inline display/visibility/opacity
        if (el.style){
          el.style.removeProperty('display');
          el.style.removeProperty('visibility');
          el.style.removeProperty('opacity');
        }
        // Remove 'hidden' attribute if present
        if (el.hasAttribute && el.hasAttribute('hidden')) el.removeAttribute('hidden');
      }
    }
  }

  function scheduleCrewFix(){
    try { ensureCrewCardVisible(); } catch(e){}
    if (window.requestAnimationFrame){
      requestAnimationFrame(()=>{ try { ensureCrewCardVisible(); } catch(e){} });
    }
    setTimeout(()=>{ try { ensureCrewCardVisible(); } catch(e){} }, 30);
    setTimeout(()=>{ try { ensureCrewCardVisible(); } catch(e){} }, 120);
  }

  document.addEventListener('DOMContentLoaded', function(){
    scheduleCrewFix();
    // Watch for active-group changes and subtree rebuilds
    const attrObs = new MutationObserver(scheduleCrewFix);
    attrObs.observe(document.body, { attributes:true, attributeFilter:['data-active-group'] });
    const main = document.querySelector('.wrap') || document.body;
    const treeObs = new MutationObserver(()=>{
      if (document.body.getAttribute('data-active-group') === 'crew'){
        scheduleCrewFix();
      }
    });
    treeObs.observe(main, { childList:true, subtree:true });

    // Also respond to tab interactions
    const tabs = document.getElementById('sections-tablist');
    if (tabs){
      tabs.addEventListener('click', scheduleCrewFix, true);
      tabs.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') scheduleCrewFix(); }, true);
    }
  });
})();
</script>
<script>
// === Silica Controls logic (clean version) ===
(function(){
  function byId(id){ return document.getElementById(id); }

  // --- Helpers ---
  function ensureDWVInModel(){
    if(!byId('sil_task_tuck') || !byId('sil_task_tuck').checked) return;
    if(!Array.isArray(window.materials)) return;
    var bag = materials.find(function(m){ return m.id==='mCOL_DWV9402'; });
    if(!bag) return;
    bag.use = true;
    if(!(Number(bag.qty)>0)) bag.qty = 1;
  }
  function ensureDWVInUI(){
    var row = document.querySelector('#matTbody tr[data-id="mCOL_DWV9402"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qty = row.querySelector('.mat_qty');
    if(cb && !cb.checked){ cb.checked = true; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qty && (Number(qty.value)||0) <= 0){
      qty.value = '1';
      qty.dispatchEvent(new Event('input', {bubbles:true}));
      qty.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }
  function removeDWVFromModel(){
    if(!Array.isArray(window.materials)) return;
    var bag = materials.find(function(m){ return m.id==='mCOL_DWV9402'; });
    if(!bag) return;
    bag.use = false; bag.qty = 0;
  }
  function removeDWVFromUI(){
    var row = document.querySelector('#matTbody tr[data-id="mCOL_DWV9402"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qty = row.querySelector('.mat_qty');
    if(cb && cb.checked){ cb.checked = false; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qty && (Number(qty.value)||0) > 0){
      qty.value = '0';
      qty.dispatchEvent(new Event('input', {bubbles:true}));
      qty.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }

  function ensureBladeInModel(){
    if(!byId('sil_task_grind') || !byId('sil_task_grind').checked) return;
    if(!Array.isArray(window.materials)) return;
    var blade = materials.find(function(m){ return m.id==='mCOL_DT5_TP_4_5'; });
    if(!blade) return;
    blade.use = true;
    if(!(Number(blade.qty)>0)) blade.qty = 1;
  }
  function ensureBladeInUI(){
    var row = document.querySelector('#matTbody tr[data-id="mCOL_DT5_TP_4_5"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qty = row.querySelector('.mat_qty');
    if(cb && !cb.checked){ cb.checked = true; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qty && (Number(qty.value)||0) <= 0){
      qty.value = '1';
      qty.dispatchEvent(new Event('input', {bubbles:true}));
      qty.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }
  function removeBladeFromModel(){
    if(!Array.isArray(window.materials)) return;
    var blade = materials.find(function(m){ return m.id==='mCOL_DT5_TP_4_5'; });
    if(!blade) return;
    blade.use = false; blade.qty = 0;
  }
  function removeBladeFromUI(){
    var row = document.querySelector('#matTbody tr[data-id="mCOL_DT5_TP_4_5"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qty = row.querySelector('.mat_qty');
    if(cb && cb.checked){ cb.checked = false; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qty && (Number(qty.value)||0) > 0){
      qty.value = '0';
      qty.dispatchEvent(new Event('input', {bubbles:true}));
      qty.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }

  // Tools Depreciation toggles
  function ensureDWV010InModel(){ if(byId('sil_task_tuck') && byId('sil_task_tuck').checked && Array.isArray(window.tools)){ var t=tools.find(function(x){return x.id==='t11';}); if(t) t.use=true; } }
  function ensureDWV010InUI(){ var r=document.querySelector('#toolTbody tr[data-id="t11"]'); if(!r) return; var cb=r.querySelector('.t_use'); if(cb && !cb.checked){ cb.checked=true; cb.dispatchEvent(new Event('change',{bubbles:true})); } r.classList.remove('fade'); }
  function removeDWV010FromModel(){ if(Array.isArray(window.tools)){ var t=tools.find(function(x){return x.id==='t11';}); if(t) t.use=false; } }
  function removeDWV010FromUI(){ var r=document.querySelector('#toolTbody tr[data-id="t11"]'); if(!r) return; var cb=r.querySelector('.t_use'); if(cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); } r.classList.add('fade'); }

  function ensureDWE46202InModel(){ if(byId('sil_task_grind') && byId('sil_task_grind').checked && Array.isArray(window.tools)){ var t=tools.find(function(x){return x.id==='t10';}); if(t) t.use=true; } }
  function ensureDWE46202InUI(){ var r=document.querySelector('#toolTbody tr[data-id="t10"]'); if(!r) return; var cb=r.querySelector('.t_use'); if(cb && !cb.checked){ cb.checked=true; cb.dispatchEvent(new Event('change',{bubbles:true})); } r.classList.remove('fade'); }
  function removeDWE46202FromModel(){ if(Array.isArray(window.tools)){ var t=tools.find(function(x){return x.id==='t10';}); if(t) t.use=false; } }
  function removeDWE46202FromUI(){ var r=document.querySelector('#toolTbody tr[data-id="t10"]'); if(!r) return; var cb=r.querySelector('.t_use'); if(cb && cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); } r.classList.add('fade'); }

  // Masks (3M 8511)
  function silicaAnyOn(){ var t=byId('sil_task_tuck'), g=byId('sil_task_grind'); return !!((t&&t.checked)||(g&&g.checked)); }
  function calcMaskQty(){
    if(!silicaAnyOn()) return 0;
    var HOURS = (typeof HOURS_PER_DAY!=='undefined' && HOURS_PER_DAY) ? HOURS_PER_DAY : 8;
    var daysMode = (typeof crewDaysMode!=='undefined') ? crewDaysMode : !!(byId('timeUnitsDays') && byId('timeUnitsDays').checked);
    var crewWide = (typeof crewWideOn!=='undefined') ? crewWideOn : !!(byId('crewWideToggle') && byId('crewWideToggle').checked);
    var qEl = byId('crewWideQty'); var q = Number(qEl && qEl.value || 0) || 0;
    var used = Array.isArray(window.crew) ? crew.filter(function(w){ return w && w.use && w.role!=='company' && w.role!=='owner'; }) : [];
    if(crewWide){
      var hours = daysMode ? q*HOURS : q;
      var days = Math.ceil((Number(hours)||0)/HOURS);
      return (used.length||0) * (days||0);
    }else{
      var total=0;
      used.forEach(function(w){ var hours=Number(w.hrs)||0; var days=Math.ceil(hours/HOURS); total+=days; });
      return total;
    }
  }
  function ensureMaskInModel(){
    try{
      if(typeof materials==='undefined') return;
      var m = materials.find(function(x){ return x.id==='mHD_3M_8511'; });
      if(!m) return;
      var qty = calcMaskQty();
      if(!(qty>0)) qty = 1; // default to 1 like bags/blade
      m.use = true;
      m.qty = qty;
    }catch(e){}
  }
  function ensureMaskInUI(){
    try{
      var row = document.querySelector('#matTbody tr[data-id="mHD_3M_8511"]');
      if(!row) return;
      var cb = row.querySelector('.mat_use');
      var qtyEl = row.querySelector('.mat_qty');
      var qty = calcMaskQty();
      if(!(qty>0)) qty = 1; // default to 1 like bags/blade
      if(cb && !cb.checked){ cb.checked = true; try{ cb.dispatchEvent(new Event('change', {bubbles:true})); }catch(e){} }
      if(qtyEl){
        qtyEl.value = String(qty);
        try{ qtyEl.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
        try{ qtyEl.dispatchEvent(new Event('change', {bubbles:true})); }catch(e){}
      }
    }catch(e){}
  }
  function removeMaskFromModel(){
    if(!Array.isArray(window.materials)) return;
    var m = materials.find(function(x){ return x.id==='mHD_3M_8511'; });
    if(!m) return;
    m.use = false; m.qty = 0;
  }
  function removeMaskFromUI(){
    var row = document.querySelector('#matTbody tr[data-id="mHD_3M_8511"]');
    if(!row) return;
    var cb = row.querySelector('.mat_use');
    var qtyEl = row.querySelector('.mat_qty');
    if(cb && cb.checked){ cb.checked = false; cb.dispatchEvent(new Event('change', {bubbles:true})); }
    if(qtyEl && (Number(qtyEl.value)||0) > 0){
      qtyEl.value = '0';
      qtyEl.dispatchEvent(new Event('input', {bubbles:true}));
      qtyEl.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }

  function applySilicaLinks(){
    var tuckOn = byId('sil_task_tuck') && byId('sil_task_tuck').checked;
    var grindOn = byId('sil_task_grind') && byId('sil_task_grind').checked;

    // Model
    if(tuckOn){ ensureDWVInModel(); ensureDWV010InModel(); } else { removeDWVFromModel(); removeDWV010FromModel(); }
    if(grindOn){ ensureBladeInModel(); ensureDWE46202InModel(); } else { removeBladeFromModel(); removeDWE46202FromModel(); }
    if(!tuckOn && !grindOn){ removeMaskFromModel(); } else { ensureMaskInModel(); }

    if(typeof renderMaterials==='function'){ renderMaterials(); }
    requestAnimationFrame(function(){
      if(tuckOn){ ensureDWVInUI(); ensureDWV010InUI(); } else { removeDWVFromUI(); removeDWV010FromUI(); }
      if(grindOn){ ensureBladeInUI(); ensureDWE46202InUI(); } else { removeBladeFromUI(); removeDWE46202FromUI(); }
      if(!tuckOn && !grindOn){ removeMaskFromUI(); } else { ensureMaskInUI(); }
      if(typeof totals==='function'){ totals(); }
    });
  }

  // Listeners
  document.addEventListener('change', function(ev){
    var id = ev && ev.target && ev.target.id;
    if(id==='sil_task_tuck' || id==='sil_task_grind' || id==='crewWideToggle' || id==='timeUnitsDays'){ applySilicaLinks(); }
  }, true);
  document.addEventListener('input', function(ev){
    if(ev.target && (ev.target.closest && ev.target.closest('#crewTbody'))) applySilicaLinks();
    if(ev.target && ev.target.id==='crewWideQty') applySilicaLinks();
  }, true);

  // Initial
  applySilicaLinks();
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('wasteAdd');
  if(!btn) return;
  btn.addEventListener('click', function(){
      // Clean add-material handler without try/catch
      var mat = (typeof getMaterialsRef==='function') ? getMaterialsRef() : (Array.isArray(window.materials) ? window.materials : null);
      if (Array.isArray(mat)) {
        var id = 'u' + Date.now();
        mat.push({ id:id, use:true, item:'', supplier:'', units:'each', price:0, qty:1, step:1, roundUp:false });
        if (typeof renderMaterials === 'function') { renderMaterials(); }
        setTimeout(function(){
          var rows = document.querySelectorAll('#matTbody tr');
          if (rows.length){
            var last = rows[rows.length-1];
            var input = last.querySelector('.mat_item');
            if (input) input.focus();
          }
        }, 0);
        if (typeof updateAll === 'function') { updateAll(); }
        return;
      }
      // Fallback: append a DOM-only row (in case data structure is unavailable)
      var tb = document.getElementById('matTbody'); if(!tb) return;
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="mat_use" checked></td>' +
                     '<td><input class="mat_item" placeholder="Item"></td>' +
                     '<td><input class="mat_sup" placeholder="Supplier"></td>' +
                     '<td><input class="mat_units" value="each"></td>' +
                     '<td><input type="number" class="mat_price" min="0" step="0.01" value="0"></td>' +
                     '<td><input type="number" class="mat_qty" min="0" step="1" value="1"></td>' +
                     '<td class="right mono mat_ext">$0.00</td>' +
                     '<td><button class="ghost mat_del">✕</button></td>';
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(function(el){
        el.addEventListener('input', function(){ if (typeof updateAll === 'function') updateAll(); });
      });
});
      if (typeof renderWaste === 'function') renderWaste();
      else if (typeof updateAll === 'function') updateAll();
    }catch(e){ console.warn(e); }
  });
});
</script><script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    var tbody = document.getElementById('matTbody');
    var tablist = document.getElementById('sections-tablist');
    if(!tbody || !tablist) return;
    /* legacy groups removed */
    function activeGroup(){
      var tablist = document.getElementById('sections-tablist');
      var active = tablist && tablist.querySelector('[role="tab"][aria-selected="true"]');
      var g = active ? (active.getAttribute('data-group')||'all') : 'all';
      if(!(window.SECTION && Object.prototype.hasOwnProperty.call(SECTION, g))) g = 'all';
      return g;
    }
    
    function applyMaterialsFilter(){
      var g = activeGroup();
      var cfg = SECTION[g] || {};
      var cats = cfg.cats || null;
      var pins = cfg.pins || null;
      tbody.querySelectorAll('tr').forEach(function(tr){
        var id = tr.dataset.id || '';
        var rowCats = (tr.getAttribute('data-cats')||'').split(',').map(function(s){return s.trim();});
        var matchCats = !cats || rowCats.some(function(c){ return cats.indexOf(c) !== -1; });
        var matchPins = !!(pins && pins.has(id));
        tr.style.display = (matchCats || matchPins) ? '' : 'none';
      });
    }
    tablist.addEventListener('click', function(){ setTimeout(applyMaterialsFilter, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(applyMaterialsFilter,0); });
    new MutationObserver(function(){ applyMaterialsFilter(); }).observe(tbody, {childList:true});
    applyMaterialsFilter();
  }catch(e){ console.warn('materials filter disabled:', e); }
});
</script><script>
// Hide Waste / Disposal ONLY when Concrete tab is active (safe, no math touched)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findWasteCard(){
    var cards = Array.from(document.querySelectorAll('.wrap > .card'));
    return cards.find(function(card){
      var h3 = card.querySelector('h3');
      return h3 && /waste\s*\/\s*disposal/i.test(h3.textContent);
    });
  }
  function enforceConcreteHidesWaste(){
    try{
      var g = activeGroup();
      var waste = findWasteCard();
      if(!waste) return;
      if(g === 'concrete'){
        waste.classList.add('group-hidden');
        waste.style.display = 'none';
      }else{
        waste.classList.remove('group-hidden');
        waste.style.display = '';
      }
    }catch(e){ console.warn('concrete->hide waste patch:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceConcreteHidesWaste, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceConcreteHidesWaste,0); });
  }
  // run once on load
  enforceConcreteHidesWaste();
});
</script><script>
// Hide Waste / Disposal when Crew & Time tab is active (safe, isolated)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findWasteCard(){
    var cards = Array.from(document.querySelectorAll('.wrap > .card'));
    return cards.find(function(card){
      var h3 = card.querySelector('h3');
      return h3 && /waste\s*\/\s*disposal/i.test(h3.textContent);
    });
  }
  function enforceCrewHidesWaste(){
    try{
      var g = activeGroup();
      var waste = findWasteCard();
      if(!waste) return;
      if(g === 'crew'){
        waste.classList.add('group-hidden');
        waste.style.display = 'none';
      }else{
        // do not change visibility for other groups here—other patches handle them
        if(g !== 'concrete'){ waste.classList.remove('group-hidden'); waste.style.display = ''; }
      }
    }catch(e){ console.warn('crew->hide waste patch:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceCrewHidesWaste, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceCrewHidesWaste,0); });
  }
  enforceCrewHidesWaste();
});
</script><script>
// Central controller: hide Waste / Disposal on Concrete, Crew & Time, and Masonry tabs only
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findWasteCard(){
    var cards = Array.from(document.querySelectorAll('.wrap > .card'));
    return cards.find(function(card){
      var h3 = card.querySelector('h3');
      return h3 && /waste\s*\/\s*disposal/i.test(h3.textContent);
    });
  }
  function enforceWasteVisibility(){
    try{
      var g = activeGroup();
      var waste = findWasteCard();
      if(!waste) return;
      var hideOn = new Set(['concrete','crew','masonry','pavers','fuel']);
      if(hideOn.has(g)){
        waste.classList.add('group-hidden');
        waste.style.display = 'none';
      }else{
        waste.classList.remove('group-hidden');
        waste.style.display = '';
      }
    }catch(e){ console.warn('waste visibility controller:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceWasteVisibility, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceWasteVisibility,0); });
  }
  // run on load
  enforceWasteVisibility();
});
</script><script>
// ID: fuel-hide-materials-v1 — Hide Materials only on the Fuel tab (safe & isolated)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findMaterialsCard(){
    var t = document.querySelector('.wrap > .card #matTbody');
    return t ? t.closest('.card') : null;
  }
  function enforceMaterialsOnFuel(){
    try{
      var g = activeGroup();
      var mat = findMaterialsCard();
      if(!mat) return;
      if(g === 'fuel'){
        mat.classList.add('group-hidden');
        mat.style.display = 'none';
      }else{
        mat.classList.remove('group-hidden');
        mat.style.display = '';
      }
    }catch(e){ console.warn('materials visibility on fuel tab:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceMaterialsOnFuel, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceMaterialsOnFuel,0); });
  }
  enforceMaterialsOnFuel();
});
</script><script>
// ID: waste-hide-materials-v1 — Hide Materials ONLY on the Waste / Disposal tab (safe & isolated)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findMaterialsCard(){
    var t = document.querySelector('.wrap > .card #matTbody');
    return t ? t.closest('.card') : null;
  }
  function enforceMaterialsOnWaste(){
    try{
      var g = activeGroup();
      var mat = findMaterialsCard();
      if(!mat) return;
      if(g === 'waste' || g === 'disposal'){
        mat.classList.add('group-hidden');
        mat.style.display = 'none';
      }else{
        mat.classList.remove('group-hidden');
        mat.style.display = '';
      }
    }catch(e){ console.warn('materials visibility on waste tab:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceMaterialsOnWaste, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceMaterialsOnWaste,0); });
  }
  enforceMaterialsOnWaste();
});
</script><script>
// ID: crew-hide-materials-v1 — Hide Materials ONLY on the Crew & Time tab (safe & isolated)
document.addEventListener('DOMContentLoaded', function(){
  function activeGroup(){
    var t = document.querySelector('#sections-tablist [role="tab"][aria-selected="true"]');
    return t ? (t.getAttribute('data-group') || 'all') : 'all';
  }
  function findMaterialsCard(){
    var t = document.querySelector('.wrap > .card #matTbody');
    return t ? t.closest('.card') : null;
  }
  function enforceMaterialsOnCrew(){
    try{
      var g = activeGroup();
      var mat = findMaterialsCard();
      if(!mat) return;
      if(g === 'crew'){
        mat.classList.add('group-hidden');
        mat.style.display = 'none';
      }else{
        mat.classList.remove('group-hidden');
        mat.style.display = '';
      }
    }catch(e){ console.warn('materials visibility on crew tab:', e); }
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforceMaterialsOnCrew, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforceMaterialsOnCrew,0); });
  }
  enforceMaterialsOnCrew();
});
</script><script &="" 'all')="" 'all';="" (t.getattribute('data-group')="" :="" ?="" [role="tab" ]');="" ][aria-selected="true" activegroup(){="" and="" crew="" disposal,="" document.addeventlistener('domcontentloaded',="" ensures="" findmaterialscard(){="" fuel="" function="" function(){="" hidden="" is="" materials="" on="" return="" t="document.querySelector('.wrap" tabs="" time,="" var="" waste="" ||="" }=""> .card #matTbody');
    return t ? t.closest('.card') : null;
  }
  function applyOnce(){
    try {
      var g = activeGroup();
      var mat = findMaterialsCard();
      if(!mat) return;
      var hideOn = new Set(['waste','disposal','crew','fuel']);
      if(hideOn.has(g)){
        mat.classList.add('group-hidden');
        mat.style.display = 'none';
      } else {
        mat.classList.remove('group-hidden');
        mat.style.display = '';
      }
    } catch(e){ console.warn('materials-hide-master error', e); }
  }
  function enforce(){
    // run a few times to win over any other late scripts
    applyOnce();
    setTimeout(applyOnce, 10);
    setTimeout(applyOnce, 60);
    requestAnimationFrame(applyOnce);
  }
  var tablist = document.getElementById('sections-tablist');
  if(tablist){
    tablist.addEventListener('click', function(){ setTimeout(enforce, 0); });
    tablist.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') setTimeout(enforce,0); });
  }
  enforce();
});
</script><script &&="" ){="" <="" ['change','input'].foreach(function(type){="" capture="" catch="" catch(e){}="" controls="" document.addeventlistener('domcontentloaded',="" document.addeventlistener(type,="" dynamically="" e.target.id;="" function="" function(){="" function(e){="" id="mv_apply_pump" if(id="pump_use" if(window.mohicanvalley)="" if(window.totals)="" if(window.updateall)="" inserted="" mohicanvalley();="" phase="" recalcpump();="" recalcpump(){="" script="" to="" too="" totals();="" true);="" try{="" updateall();="" var="" ||="" }="" });="" },="">

<script>
// Manual Crew & Days boxes: store simple numbers you type (no auto-counting)
(function(){
  function bindPersist(id, key, defVal){
    var el = document.getElementById(id);
    if(!el) return;
    try{
      var saved = sessionStorage.getItem(key);
      if(saved !== null && saved !== ''){
        el.value = saved;
      }else if(!el.value){
        el.value = String(defVal);
      }
    }catch(e){
      if(!el.value) el.value = String(defVal);
    }
    el.addEventListener('input', function(){
      try{ sessionStorage.setItem(key, el.value || ''); }catch(e){}
    }, false);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      bindPersist('crewManual','tm_manual_crew',3);
      bindPersist('daysManual','tm_manual_days',1);
    }, {once:true});
  } else {
    bindPersist('crewManual','tm_manual_crew',3);
    bindPersist('daysManual','tm_manual_days',1);
  }
})();
</script>
<script>
// === Turcotte: Crew × Days → 3M 8511 Qty (only when silica tasks are checked) ===
(function(){
  function byId(id){ return document.getElementById(id); }
  function silicaOn(){
    var t = byId('sil_task_tuck'), g = byId('sil_task_grind');
    return !!((t && t.checked) || (g && g.checked));
  }
  function getCrew(){ var v = Number(byId('crewManual')?.value || 0); return Math.max(0, Math.floor(v)); }
  function getDays(){ var v = Number(byId('daysManual')?.value || 0); return Math.max(0, Math.floor(v)); }

  function set8511Qty(qty){
    // Ensure materials are rendered (in case silica auto-add just ran)
    try{ if(typeof renderMaterials==='function') renderMaterials(); }catch(e){}
    var row = document.querySelector('#matTbody tr[data-id="mHD_3M_8511"]');
    if(!row){ return; } // bail if row truly doesn't exist
    var useEl = row.querySelector('.mat_use');
    if(useEl && !useEl.checked){ try{ useEl.checked = true; useEl.dispatchEvent(new Event('change',{bubbles:true})); }catch(e){} }
    var qtyEl = row.querySelector('.mat_qty');
    if(!qtyEl) return;
    qtyEl.value = String(qty);
    try{ qtyEl.setAttribute('title','Auto: Crew('+getCrew()+') × Days('+getDays()+') = '+qty); }catch(e){}
    try{ qtyEl.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
    try{ qtyEl.dispatchEvent(new Event('change', {bubbles:true})); }catch(e){}
    try{ if(typeof totals==='function') totals(); }catch(e){}
  }

  function updateMaskQty(){
    if(!silicaOn()) return; // only act when silica tasks are checked
    var crew = getCrew(), days = getDays();
    var qty = (crew||0) * (days||0);
    if(qty>0){
      // two rAF ticks to let silica auto-add finish, then set
      requestAnimationFrame(function(){ requestAnimationFrame(function(){ set8511Qty(qty); }); });
    }
  }

  // Wire events
  ['crewManual','daysManual','sil_task_tuck','sil_task_grind'].forEach(function(id){
    var el = byId(id);
    if(!el) return;
    var ev = (id==='crewManual' || id==='daysManual') ? 'input' : 'change';
    el.addEventListener(ev, updateMaskQty, false);
  });

  // Initial pass in case silica already on
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', updateMaskQty, {once:true});
  } else {
    updateMaskQty();
  }
})();
</script>
<script>
// Seed common Block Wall materials if missing (id check-safe)
(function(){
  try{
    if(!Array.isArray(materials)) return;
    const addIfMissing = (row)=>{
      if(!materials.some(m=>m.id===row.id)) materials.push(row);
    };
    // Core CMU sizes
    addIfMissing({id:'bw_cmu6_std', use:false, item:'CMU 6x8x16 (Std)', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu8_std', use:false, item:'CMU 8x8x16 (Std)', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu10_std',use:false, item:'CMU 10x8x16 (Std)', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu12_std',use:false, item:'CMU 12x8x16 (Std)', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    // Specials
    addIfMissing({id:'bw_cmu8_open', use:false, item:'CMU 8x8x16 Open-End', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu8_bond', use:false, item:'CMU 8x8x16 Bond Beam', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    addIfMissing({id:'bw_cmu4_half', use:false, item:'CMU 4x8x16 Half-High', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    // Brick cap option
    addIfMissing({id:'bw_brick_mod', use:false, item:'Brick (Modular) — cap/soldier', supplier:'', units:'each', price:0, qty:0, step:1, cats:['masonry']});
    // Mortar & grout
    addIfMissing({id:'bw_specmix_s_80', use:false, item:'SPEC MIX Type S — 80 lb', supplier:'', units:'bag', price:0, qty:0, cats:['masonry','stucco']});
    addIfMissing({id:'bw_grout_fine_80', use:false, item:'Core-Fill Grout Fine — 80 lb', supplier:'QUIKRETE', units:'bag', price:0, qty:0, cats:['masonry']});
    addIfMissing({id:'bw_grout_coarse_80', use:false, item:'Core-Fill Grout Coarse — 80 lb', supplier:'QUIKRETE', units:'bag', price:0, qty:0, cats:['masonry']});
    // Reinforcement & ties
    addIfMissing({id:'bw_durawall_9x10', use:false, item:'Dur-O-Wall 9" — 10\' (joint reinforcement)', supplier:'', units:'each', price:0, qty:0, cats:['masonry']});
    addIfMissing({id:'bw_wall_ties', use:false, item:'Wall ties (box)', supplier:'', units:'box', price:0, qty:0, cats:['masonry']});
    addIfMissing({id:'bw_rebar4_20', use:false, item:'# 5 rebar — 20\'', supplier:'', units:'each', price:0, qty:0, cats:['masonry','concrete']});
    addIfMissing({id:'bw_rebar5_20', use:false, item:'#5 rebar — 20\'', supplier:'', units:'each', price:0, qty:0, cats:['masonry','concrete']});
    // Concrete for footing
    addIfMissing({id:'bw_conc_yd', use:false, item:'Concrete (footing) — yd³', supplier:'', units:'yd³', price:0, qty:0, step:0.1, cats:['concrete']});
    // Cleanouts & misc
    addIfMissing({id:'bw_cleanout', use:false, item:'Cleanout ties/plugs (allowance)', supplier:'', units:'each', price:0, qty:0, cats:['masonry']});
    // Re-render to show newly seeded rows if Materials card is visible
    if(typeof renderMaterials==='function') renderMaterials();
  }catch(e){}
})();
</script>
<script id="__tm_hide_jobinfo_cleanup__">
(function(){
  function markQuickGroups(){
    // Tag likely Quick Groups containers so CSS can hide them reliably
    var tags = [];
    // 1) .groupbar containers
    document.querySelectorAll('.groupbar').forEach(function(el){ if (!el.hasAttribute('>



<script id="__tm_qg_shell_cleanup__">
document.addEventListener('DOMContentLoaded', function(){
  function killEmptyShells(){
    var selectors = [
      '.groupbar',
      '[data-quick-groups]',
      '.row',
      '.chip,.pill,.badge,.tag'
    ];
    var toCheck = [];
    selectors.forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){ toCheck.push(el); });
    });
    toCheck.forEach(function(el){
      try {
        if (el.querySelector('button, input, select, textarea, a, [role="button"], [role="tab"], [role="toolbar"]')) return;
        var txt = (el.textContent || '').replace(/\s+/g,'').trim();
        if (txt.length === 0) {
          if (el.children.length <= 1) {
            el.remove();
          }
        }
      } catch(e){}
    });
  }
  killEmptyShells();
  setTimeout(killEmptyShells, 250);
  var mo = new MutationObserver(function(){ killEmptyShells(); });
  mo.observe(document.body, { childList:true, subtree:true });
});
</script>
<script id="__tm_kill_empty_pills_strict__">
(function(){
  function isEmptyText(s){
    if (!s) return true;
    // Normalize whitespace including NBSP \u00A0 and zero-width
    s = s.replace(/[\s\u00A0\u200B\u200C\u200D\uFEFF]+/g,'').trim();
    return s.length === 0;
  }
  function killEmptyPills(){
    var selectors = [
      '.tag', '.pill', '.badge', '.chip',
      '[class*=" tag"]', '[class*="pill"]', '[class*="badge"]', '[class*="chip"]',
      '[class*="Group"]', '[class*="group"]'
    ];
    var seen = new Set();
    selectors.forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){
        if (seen.has(el)) return;
        var txt = (el.innerText||'') + (el.getAttribute('aria-label')||'');
        if (isEmptyText(txt)){
          var role = (el.getAttribute('role')||'').toLowerCase();
          if (role && (role==='tab' || role==='button' || role==='toolbar')) return;
          if (el.querySelector('button,input,select,textarea,a,[role="button"],[role="tab"],[role="toolbar"]')) return;
          el.remove();
          seen.add(el);
          var p = el.parentElement;
          if (p && isEmptyText(p.innerText) && p.children.length === 0){
            p.remove();
          }
        }
      });
    });
  }
  function boot(){
    killEmptyPills();
    setTimeout(killEmptyPills, 300);
    setTimeout(killEmptyPills, 1200);
    var mo = new MutationObserver(function(){ killEmptyPills(); });
    mo.observe(document.body, { childList:true, subtree:true });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>
<script id="__tm_kill_top_empty_bubble__">
(function(){
  function isControl(el){
    return !!el.querySelector('button,input,select,textarea,a,[role="button"],[role="tab"],[role="toolbar"]');
  }
  function emptyish(s){
    if (!s) return true;
    s = s.replace(/[\s\u00A0\u200B\u200C\u200D\uFEFF]+/g,'').trim();
    return s.length === 0;
  }
  function looksLikeBubble(el){
    if (!el || !el.classList) return false;
    var cls = Array.from(el.classList).join(' ').toLowerCase();
    // Typical "bubble" wrappers we use
    var hit = /(row|pill|chip|badge|tag|groupbar|bubble)/.test(cls);
    // Also check attributes
    if (!hit){
      var role = (el.getAttribute('role')||'').toLowerCase();
      if (role === 'toolbar' || role === 'tablist') hit = true;
    }
    return hit;
  }
  function killTopEmptyBubble(){
    var wrap = document.querySelector('.wrap');
    if (!wrap) return;
    // Find the main title (first H1/H2/H3)
    var title = wrap.querySelector('h1, h2, h3');
    if (!title) return;
    // Walk previous siblings from the title upward and remove empty bubble-like elements
    var node = title.previousElementSibling;
    var removed = false;
    while (node){
      if (looksLikeBubble(node)){
        var txt = node.textContent || '';
        if (emptyish(txt) && !isControl(node)){
          var prev = node.previousElementSibling;
          node.remove();
          node = prev;
          removed = true;
          continue;
        }
      }
      // Stop once we hit a non-bubble element
      break;
    }
    return removed;
  }
  function boot(){
    killTopEmptyBubble();
    // After layout stabilization
    setTimeout(killTopEmptyBubble, 200);
    setTimeout(killTopEmptyBubble, 800);
    // Watch for future DOM mutations
    var mo = new MutationObserver(function(){ killTopEmptyBubble(); });
    mo.observe(document.body, { childList:true, subtree:true });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  function reevaluate(){ try{ if(typeof window.stuccoCalc==='function') window.stuccoCalc(); else if(typeof calc==='function') calc(); } catch(e){} }
  document.getElementById('stu_finish_sel')?.addEventListener('change', reevaluate);
  document.getElementById('stu_finish_yield')?.addEventListener('input', function(){ const cb=document.getElementById('stu_finish_use_mat'); if(cb) cb.checked=false; reevaluate(); });
  document.getElementById('stu_finish_use_mat')?.addEventListener('change', reevaluate);
  document.getElementById('stu_foam_sel')?.addEventListener('change', reevaluate);
  reevaluate();
});
</script>
<script id="move-status-into-sticky">
(function(){
  function q(sel,root){ return (root||document).querySelector(sel); }
  var stickyInner = q('.sticky-inner');
  if(!stickyInner) return;
  // Find the top-of-body banner (sticky header div)
  var topBanner = document.body.querySelector(':scope > div[style*="position:sticky"][style*="top:0"]');
  if(!topBanner) return;
  // Clean inline styles and retag
  topBanner.removeAttribute('style');
  topBanner.id = 'stickyStatusPill';
  topBanner.className = 'pill ok'; // keep the green "ok" styling
  topBanner.style.fontSize = '12px';
  topBanner.style.opacity = '0.95';
  // Insert as first child => left edge (space-between pushes GRAND to right)
  stickyInner.insertBefore(topBanner, stickyInner.firstChild);
})();
</script>
<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const num = (v)=>{ const n = parseFloat(v); return isFinite(n)?n:0; };
  const feetIn = (ft,inches)=> num(ft)*12 + num(inches);
  const fmt = (n, d=2)=> (Math.round(n*Math.pow(10,d))/Math.pow(10,d)).toFixed(d);

  function getMode(){ return $('#mode_brick').checked ? 'brick' : 'inch'; }
  function wastePct(){ return getMode()==='inch' ? num($('#waste').value) : num($('#waste_b').value); }
  function heightIn(){ 
    if (getMode()==='inch') return feetIn($('#h_ft').value, $('#h_in').value);
    return feetIn($('#h_ft_b').value, $('#h_in_b').value);
  }

  function dimsFromBrick(){
    const A = Math.max(1, num($('#brixA').value));
    const B = Math.max(1, num($('#brixB').value));
    const len = num($('#b_len').value);
    const joint = num($('#joint').value);
    const nominal = len + joint;
    const width = A * nominal;
    const depth = B * nominal;
    return {width, depth, perCourse: 2*(A+B), courseH: (num($('#b_hgt').value) + joint)};
  }

  function dimsFromInches(){
    return {width: num($('#w_in').value), depth: num($('#d_in').value), perCourse: null, courseH: (2.25+0.375)};
  }

  function tilesPerFlue(){
    const auto = $('#auto_tiles').checked;
    const hIn = heightIn();
    const crown = $('#opt_crown').checked ? num($('#crown_thk').value) : 0;
    let proj = Math.max(0, num($('#proj_in').value));
    if ($('#no_cap').checked && proj < 4){ proj = 4; $('#proj_in').value = 4; }
    let tileLen = num($('#tile_len').value);
    if (auto){ tileLen = Math.max(12, tileLen||24); }
    const required = hIn + crown + proj;
    const per = tileLen>0 ? Math.ceil(required / tileLen) : 0;
    return {per, tileLen, proj, required};
  }

  function calc(){
    const mode = getMode();
    let width, depth, perCourse, courseH;
    if (mode==='brick'){
      const d = dimsFromBrick();
      width=d.width; depth=d.depth; perCourse=d.perCourse; courseH=d.courseH;
      $('#geomNote').textContent = 'Derived from brick count: width ≈ '+fmt(width,2)+'", depth ≈ '+fmt(depth,2)+'".';
    } else {
      const d = dimsFromInches();
      width=d.width; depth=d.depth; perCourse=d.perCourse; courseH=d.courseH;
      $('#geomNote').textContent = '';
    }

    const hIn = heightIn();
    const waste = wastePct()/100;

    // Courses & face area
    const courses = courseH>0 ? Math.ceil(hIn / courseH) : 0;
    const facePerimIn = 2*(width+depth);
    const faceAreaSF = (facePerimIn/12) * (hIn/12);

    // Brick count
    let bricks = 0;
    if (mode==='brick'){ bricks = perCourse * courses; }
    else { bricks = faceAreaSF * parseFloat($('#bpsf').value); }
    const bricksFinal = Math.ceil(bricks * (1 + waste));

    // Mortar bags (Type S 80 lb) based on ~37 modular brick per bag
    const mortarFinal = Math.ceil(bricksFinal / 37);

    // Flue tiles (total to purchase, includes #flues and waste)
    const {per: perFlue, tileLen, proj, required} = tilesPerFlue();
    const flues = 1;
    const flueTotal = perFlue; // exclude waste multiplier for flue tiles

    // Crown concrete volume & bags (80 lb ~0.60 ft³)
    let crownVolFt3 = 0, crownBags = 0;
    if ($('#opt_crown').checked){
      const oh = Math.max(0, num($('#crown_oh').value));
      const thk = Math.max(0, num($('#crown_thk').value));
      const planW = width + 2*oh;
      const planD = depth + 2*oh;
      crownVolFt3 = (planW/12) * (planD/12) * (thk/12);
      crownBags = Math.ceil(crownVolFt3 / 0.60);
    }

    // Flashing LF & copper sheet area
    let flashLF = 0, copperSF = 0;
    if ($('#opt_flash').checked){
      flashLF = (2*(width+depth))/12;
      const flashH = Math.max(0, num($('#flash_h').value));
      copperSF = ( (2*(width+depth)) * flashH ) / 144;
    }

    const cricketRequired = (width > 30);

    // KPI pills (single flue number)
    const k = $('#kpis'); k.innerHTML = '';
    const makePill = (txt)=>{ const s=document.createElement('div'); s.className='kpi'; s.textContent=txt; k.appendChild(s); };
    makePill('Bricks: ' + bricksFinal);
    makePill('Mortar 80‑lb bags: ' + mortarFinal);
    makePill('flue: ' + flueTotal);
    if ($('#opt_crown').checked) makePill('Crown 80‑lb bags: ' + crownBags);
    if ($('#opt_flash').checked) { makePill('Flashing LF: ' + flashLF.toFixed(1)); makePill('Copper est. ft²: ' + copperSF.toFixed(1)); }
    makePill('Courses: ' + courses);
    makePill('Chimney width: ' + width.toFixed(1) + ' in');
    // Defensive cleanup: if 10" block qty equals mortar or flash LF, clear it
(function(){
  try{
    var tbody = document.getElementById('matTbody'); if (!tbody) return;
    var r = tbody.querySelector('tr[data-id="mUSR_10_hollow_concrete_block_each"]');
    if (!r) return;
    var q = r.querySelector('.mat_qty'); var val = q ? parseFloat(q.value||'0') : 0;
    if ((typeof mortarFinal==='number' && val===Math.ceil(mortarFinal)) ||
        (typeof flashLF==='number' && Math.abs(val - flashLF) < 1e-6)){
      clearRow(r);
    }
  }catch(e){}
})();
makePill(cricketRequired ? 'Cricket required by code' : 'Cricket not required');

    // === Sync Chimney → Materials: Brick + Mortar + Flue + Crown + Flashing + Copper (by selections) — GUARDED & EVENTFUL ===
try{
  if (window.__chimneyMatSync) { /* prevent re-entrancy */ }
  else {
    window.__chimneyMatSync = 1;
    try{
      var tbody = document.getElementById('matTbody');
      if (!tbody) { /* materials not rendered yet; skip safely */ }
          else {
// ---------- helpers ----------
function byRowId(id){ return tbody.querySelector('tr[data-id="'+id+'"]'); }
function findByText(re){
  if (typeof matFindRow === 'function') return matFindRow(re);
  var rows = Array.from(tbody.querySelectorAll('tr'));
  return rows.find(function(tr){ return re.test((tr.textContent||'')); }) || null;
}
function ensureRowWithDefaults(opts){
  var tr = opts.id ? byRowId(opts.id) : null;
  if (!tr) tr = opts.re ? findByText(opts.re) : null;
  if (!tr) {
    var addBtn = document.getElementById('addMatBtn');
    if (addBtn) { addBtn.click(); }
    var rows = document.querySelectorAll('#matTbody tr');
    tr = rows[rows.length-1] || null;
  }
  if (tr){
    function setIfEmpty(sel,val){
      var el = tr.querySelector(sel);
      if (!el) return;
      if (!el.value){ el.value = String(val); el.dispatchEvent(new Event('input',{bubbles:true})); }
    }
    setIfEmpty('.mat_item',  opts.item||'');
    setIfEmpty('.mat_sup',   opts.sup||'');
    setIfEmpty('.mat_units', opts.units||'');
    var priceEl = tr.querySelector('.mat_price');
    if (priceEl && (priceEl.value==='' || Number(priceEl.value)===0) && (opts.price!==undefined)){
      priceEl.value = String(opts.price);
      priceEl.dispatchEvent(new Event('input',{bubbles:true}));
      priceEl.dispatchEvent(new Event('change',{bubbles:true}));
    }
    if (opts.id) tr.setAttribute('data-id', opts.id);
  }
  return tr;
}
function setQtyAndUse(tr, qty){
  if (!tr) return;
  if (typeof matSetQtyAndUse === 'function'){ matSetQtyAndUse(tr, qty); return; }
  var cb = tr.querySelector('.mat_use');
  var q  = tr.querySelector('.mat_qty');
  if (cb && !cb.checked){ cb.click(); cb.dispatchEvent(new Event('change', {bubbles:true})); }
  if (q){ q.value = String(qty); q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
}
function clearRow(tr){
  if (!tr) return;
  if (typeof matClearUse === 'function'){ matClearUse(tr); return; }
  var cb = tr.querySelector('.mat_use'); if (cb && cb.checked){ cb.click(); cb.dispatchEvent(new Event('change',{bubbles:true})); }
  var q  = tr.querySelector('.mat_qty'); if (q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
}

// ---------- READY GUARD ----------
var __ready = (typeof bricksFinal==='number' && bricksFinal>0);
if (!__ready){
  try{ ['mUSR_Flu_8x8_each','mUSR_Flu_8x12_each','mROB_FLU_12x12','mUSR_Flu_13x18_each'].forEach(function(id){ var r=byRowId(id); if(r) clearRow(r); }); }catch(e){}
  try{ var r = byRowId('mNHM_Concrete_80lb'); if(r) clearRow(r); }catch(e){}
  try{ var r = byRowId('bw_specmix_s_80'); if(r) clearRow(r); }catch(e){}
  try{ var r = byRowId('mROB_COPPER_3x8'); if(r) clearRow(r); }catch(e){}
  try{ var r = byRowId('mUSR_CopperFlashing_LF'); if(r) clearRow(r); }catch(e){}
  // Brick rows are already gated on bricksFinal below.
  return;
}
        function byRowId(id){ return tbody.querySelector('tr[data-id="'+id+'"]'); }
        function findByText(re){
          if (typeof matFindRow === 'function') return matFindRow(re);
          var rows = Array.from(tbody.querySelectorAll('tr'));
          return rows.find(function(tr){ return re.test((tr.textContent||'')); }) || null;
        }
        function ensureRowWithDefaults(opts){
          // opts: {id, re, item, sup, units, price}
          var tr = opts.id ? byRowId(opts.id) : null;
          if (!tr) tr = opts.re ? findByText(opts.re) : null;
          if (!tr) {
            var addBtn = document.getElementById('addMatBtn');
            if (addBtn) { addBtn.click(); }
            var rows = document.querySelectorAll('#matTbody tr');
            tr = rows[rows.length-1] || null;
          }
          if (tr){
            // Set defaults if empty
            function setIfEmpty(sel,val){
              var el = tr.querySelector(sel);
              if (!el) return;
              if (!el.value){ el.value = String(val); el.dispatchEvent(new Event('input',{bubbles:true})); }
            }
            setIfEmpty('.mat_item',  opts.item||'');
            setIfEmpty('.mat_sup',   opts.sup||'');
            setIfEmpty('.mat_units', opts.units||'');
            var priceEl = tr.querySelector('.mat_price');
            if (priceEl && (priceEl.value==='' || Number(priceEl.value)===0) && (opts.price!==undefined)){
              priceEl.value = String(opts.price);
              priceEl.dispatchEvent(new Event('input',{bubbles:true}));
              priceEl.dispatchEvent(new Event('change',{bubbles:true}));
            }
            if (opts.id) tr.setAttribute('data-id', opts.id);
          }
          return tr;
        }
        function setQtyAndUse(tr, qty){
          if (!tr) return;
          if (typeof matSetQtyAndUse === 'function'){ matSetQtyAndUse(tr, qty); return; }
          var cb = tr.querySelector('.mat_use');
          var q  = tr.querySelector('.mat_qty');
          if (cb && !cb.checked){ cb.click(); cb.dispatchEvent(new Event('change', {bubbles:true})); }
          if (q){ q.value = String(qty); q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
        }
        function clearRow(tr){
          if (!tr) return;
          if (typeof matClearUse === 'function'){ matClearUse(tr); return; }
          var cb = tr.querySelector('.mat_use'); if (cb && cb.checked){ cb.click(); cb.dispatchEvent(new Event('change',{bubbles:true})); }
          var q  = tr.querySelector('.mat_qty'); if (q){ q.value=''; q.dispatchEvent(new Event('input',{bubbles:true})); q.dispatchEvent(new Event('change',{bubbles:true})); }
        }

        // ---------- BRICK (existing) ----------
        (function(){
          var bpsfVal = (function(){ var el = document.getElementById('bpsf'); return el ? String(el.value).trim() : '7'; })();
          var BRICK_MAP = {
            '7':   { id: 'mROB_BRICK_762x362x214',    re: /Brick\s*7\s*5\/8\s*[×x]\s*3\s*5\/8\s*[×x]\s*2\s*1\/4/i },
            '6':   { id: 'mUSR_Brick_7_5_8_2_3_4_2_3_4_each', re: /Brick\s*7\s*5\/8\s*[×x]\s*2\s*3\/4\s*[×x]\s*2\s*3\/4/i },
            '5.3': { id: 'mUSR_Brick_11_5_8_3_5_8_2_1_4_each', re: /Brick\s*11\s*5\/8\s*[×x]\s*3\s*5\/8\s*[×x]\s*2\s*1\/4/i }
          };
          var sel = BRICK_MAP[bpsfVal] || BRICK_MAP['7'];
          var row = byRowId(sel.id) || findByText(sel.re);
          if (row){
            if (typeof bricksFinal === 'number' && bricksFinal > 0){
              setQtyAndUse(row, bricksFinal);
              // Clear the non-selected brick rows
              ['mROB_BRICK_762x362x214','mUSR_Brick_7_5_8_2_3_4_2_3_4_each','mUSR_Brick_11_5_8_3_5_8_2_1_4_each']
                .forEach(function(id){ if (id!==sel.id) clearRow(byRowId(id)); });
            } else {
              clearRow(row);
            }
          }
        })();

        // ---------- MORTAR: SPEC MIX Type S — 80 lb (hardened: no auto-create) ----------
(function(){
  var qty = (typeof mortarFinal==='number') ? Math.ceil(mortarFinal) : 0;
  var row = byRowId('bw_specmix_s_80') || byRowId('m4') || findByText(/SPEC\s*MIX\s*Type\s*S\s*—?\s*80\s*lb/i);
  if (qty>0 && row){
    var itemTxt = (row.querySelector('.mat_item')?.value||'');
    if (/Type\s*S/i.test(itemTxt)) { setQtyAndUse(row, qty); }
  } else if (row){
    clearRow(row);
  }
  // Defensive: never let 10" CMU block mirror mortar
  try{
    var blk = byRowId('mUSR_10_hollow_concrete_block_each');
    if (blk){
      var q = blk.querySelector('.mat_qty'); var v = q ? parseFloat(q.value||'0') : 0;
      if (v === qty){ clearRow(blk); }
    }
  }catch(e){}
})();
// ---------- FLUE TILES (size-driven) ----------
        (function(){
          var qty = (typeof flueTotal==='number') ? flueTotal : 0;
          var sizeSel = document.getElementById('flue_size');
          var size = sizeSel ? String(sizeSel.value) : '8x12';
          var MAP = {
            '8x8':  { id:'mUSR_Flu_8x8_each',  re:/Flu\s*8\s*[×x]\s*8/i },
            '8x12': { id:'mUSR_Flu_8x12_each', re:/Flu\s*8\s*[×x]\s*12/i },
            '12x12':{ id:'mROB_FLU_12x12',     re:/Flu\s*12\s*[×x]\s*12/i },
            '13x18':{ id:'mUSR_Flu_13x18_each',re:/Flu\s*13\s*[×x]\s*18/i }
          };
          var sel = MAP[size] || MAP['8x12'];
          var row = byRowId(sel.id) || findByText(sel.re);
          if (qty>0 && row){ setQtyAndUse(row, Math.ceil(qty)); }
          else if (row){ clearRow(row); }
          // Clear other flue sizes
          Object.keys(MAP).forEach(function(k){ if (k!==size){ var r=byRowId(MAP[k].id); if (r) clearRow(r); } });
        })();

        // ---------- CROWN: Concrete 80‑lb Bag (create if missing) ----------
        (function(){
          var qty = (typeof crownBags==='number') ? crownBags : 0;
          var useCrown = document.getElementById('opt_crown') ? document.getElementById('opt_crown').checked : false;
          var row = null;
          if (qty>0 && useCrown){
            if (typeof getOrCreateConcrete80Row === 'function') row = getOrCreateConcrete80Row();
            else {
              // Fallback create minimal row
              row = ensureRowWithDefaults({ id:'mNHM_Concrete_80lb', re:/Concrete\s*80\s*lb\s*Bag/i, item:'Concrete 80lb Bag', sup:'New Haven Masonry', units:'bag', price:'' });
            }
            if (row) setQtyAndUse(row, Math.ceil(qty));
          } else {
            // Try to clear if exists
            row = byRowId('mNHM_Concrete_80lb') || findByText(/Concrete\s*80\s*lb\s*Bag/i);
            if (row) clearRow(row);
          }
        })();

        // ---------- FLASHING LF (no material mapping; labor/visibility only) ----------
(function(){
  var useFlash = document.getElementById('opt_flash') ? document.getElementById('opt_flash').checked : false;
  var row = byRowId('mUSR_CopperFlashing_LF') || findByText(/flashing\s*—?\s*lf/i);
  if (row) { clearRow(row); } // always clear; we roll copper into sheets instead
  // Safety: if a 10" block row was incorrectly set to Flashing LF, clear it
  try{
    var blk = byRowId('mUSR_10_hollow_concrete_block_each');
    if (blk){
      var q = blk.querySelector('.mat_qty');
      if (q){
        var val = parseFloat(q.value||'0');
        if (useFlash && typeof flashLF==='number' && Math.abs(val - flashLF) < 0.001) { clearRow(blk); }
      }
    }
  }catch(e){}
})();

        // ---------- COPPER SHEET 3×8 (24 ft² per sheet) ----------
(function(){
  var useFlash = document.getElementById('opt_flash') ? document.getElementById('opt_flash').checked : false;
  // copperSF is already computed from perimeter × flashH; treat it as total copper area for flashing/counter/step
  var sf = (useFlash && typeof copperSF==='number') ? copperSF : 0;
  var row = byRowId('mROB_COPPER_3x8') || findByText(/Copper\s*Sheet\s*3\s*[×x]\s*8/i);
  if (row){
    var sheets = Math.ceil(sf / 24); // 3×8 = 24 ft²
    if (sheets>0){ setQtyAndUse(row, sheets); }
    else { clearRow(row); }
  }
})();

      }
    } finally {
      window.__chimneyMatSync = 0;
    }
  }
}catch(e){ /* non-fatal */ }
// Calc details
    $('#calcOut').innerHTML =
      '<div><b>Face area</b>: '+faceAreaSF.toFixed(2)+' sf</div>' +
      '<div><b>Perimeter</b>: '+(facePerimIn/12).toFixed(2)+' lf</div>' +
      '<div><b>Required flue height (in)</b>: '+required.toFixed(1)+' (rebuild '+hIn.toFixed(1)+' + crown '+( $('#opt_crown').checked ? num($('#crown_thk').value).toFixed(1) : 0 )+' + projection '+(Math.max(0, num($('#proj_in').value))).toFixed(1)+')</div>';
// Diagnostics (Chimney)
try{
  var pre = document.getElementById('chim_diag_pre');
  if (pre){
    var L=[];
    function push(label, v, d){ 
      if (v===undefined || v===null || (typeof v==='number' && !isFinite(v))) return; 
      if (typeof v==='number') { L.push(label+'='+v.toFixed(d!=null?d:2)); } else { L.push(label+'='+String(v)); }
    }
    push('mode', mode);
    push('width_in', width);
    push('depth_in', depth);
    push('perCourse', perCourse);
    push('courseH_in', courseH);
    push('height_in', hIn);
    push('courses', courses);
    push('facePerim_in', facePerimIn);
    push('faceArea_sf', faceAreaSF);
    push('tile_len', typeof tileLen!=='undefined'?tileLen:null, 0);
    push('proj_in', typeof proj!=='undefined'?proj:null, 0);
    push('required_in', typeof required!=='undefined'?required:null, 0);
    push('bricks_final', typeof bricksFinal!=='undefined'?bricksFinal:null, 0);
    push('mortar_bags_80lb', typeof mortarFinal!=='undefined'?mortarFinal:null, 0);
    push('flue_total', typeof flueTotal!=='undefined'?flueTotal:null, 0);
    if (document.getElementById('opt_crown') && document.getElementById('opt_crown').checked) push('crown_bags', typeof crownBags!=='undefined'?crownBags:null, 0);
    if (document.getElementById('opt_flash') && document.getElementById('opt_flash').checked){ push('flash_LF', typeof flashLF!=='undefined'?flashLF:null, 1); push('copper_SF', typeof copperSF!=='undefined'?copperSF:null, 1); }
    push('cricket_required', (width>30));
    pre.textContent = L.join('\\n');
    }
}catch(ex){ var pre2=document.getElementById('chim_diag_pre'); if(pre2){ pre2.textContent='JS Error: '+ex.message; } }


    // Scope text
    const flueLabel = $('#flue_size').value;
    const scope = [];
    scope.push('Rebuild chimney above roofline to ~' + (hIn/12).toFixed(2) + ' ft (running bond).');
    scope.push('Furnish & lay ≈ ' + bricksFinal + ' modular brick (includes ' + (waste*100).toFixed(1) + '% waste).');
    scope.push('Mortar: ≈ ' + mortarFinal + ' bags (80‑lb Type S).');
    if (flueTotal>0) scope.push('Flue liners: ' + flueTotal + ' pcs @ ' + flueLabel + ' × ' + num($('#tile_len').value).toFixed(0) + '" total (includes waste).');
    if ($('#opt_crown').checked) scope.push('Cast concrete crown, avg ' + num($('#crown_thk').value).toFixed(1) + '", with bond break at flue.');
    if ($('#opt_flash').checked) scope.push('Step & counter‑flash with 16‑oz copper (~' + flashLF.toFixed(1) + ' LF).');
    if (cricketRequired) scope.push('Provide & flash a metal cricket (chimney width > 30").');
    $('#scope').value = scope.join('\n');
  }

  function bind(){
    // Toggle modes
    $('#mode_inches').addEventListener('change', ()=>{
      $('#byInches').style.display = 'grid';
      $('#byBrick').style.display = 'none';
      calc();
    });
$('#mode_brick').addEventListener('change', ()=>{
      $('#byInches').style.display = 'none';
      $('#byBrick').style.display = 'grid';
      calc();
    });

    // Bind inputs (both modes) to recalc
    (['w_in','d_in','h_ft','h_in','waste','bpsf','opt_crown','crown_thk','crown_oh','opt_flash','flash_h',
      'tile_len','proj_in','auto_tiles','no_cap',
      'b_len','b_hgt','joint','brixA','brixB',
      'h_ft_b','h_in_b','w_ft_b','w_in_b','d_ft_b','d_in_b','waste_b']).forEach(function(id){
      var el = document.getElementById(id);
      if (!el) return;
      ['input','change'].forEach(function(ev){
        try{ el.addEventListener(ev, calc); }catch(_){}
      });
    });
    // Fallback delegated listeners on the whole card
    (function(card){ if(card){ 
      card.addEventListener('input', function(){ try{ calc(); }catch(_){}});
      card.addEventListener('change', function(){ try{ calc(); }catch(_){}});
    }})(document.getElementById('chimneyCard'));
// Brick preset
    $('#brickPreset') && $('#brickPreset').addEventListener('change', (e)=>{
      const v = e.target.value;
      if (v==='mod'){ $('#b_len').value = 7.625; $('#b_hgt').value = 2.25; }
      else if (v==='util'){ $('#b_len').value = 11.625; $('#b_hgt').value = 2.25; }
      document.getElementById('b_len').disabled = (v!=='custom');
      document.getElementById('b_hgt').disabled = (v!=='custom');
      calc();
    });
// Auto tiles & cap toggle
    $('#auto_tiles').addEventListener('change', calc);
    $('#no_cap').addEventListener('change', calc);
    $('#proj_in').addEventListener('input', calc);

    // Global listeners
    document.querySelectorAll('input,select,textarea').forEach(el=>{
      el.addEventListener('input', calc);
      el.addEventListener('change', calc);
    });

    // Copy scope
    (function(el){ if(el){ el.addEventListener('click', ()=>{
      const ta = $('#scope'); ta.select(); document.execCommand('copy');
    }); }})(document.querySelector('#copyScope'));

    // Reset
    (function(el){ if(el){ el.addEventListener('click', ()=>{
      document.querySelectorAll('input[type="number"]').forEach(i=>i.value = i.id.includes('waste') ? 10 : 0);
      $('#mode_inches').checked = true;
      $('#mode_inches').dispatchEvent(new Event('change'));
      $('#opt_round').checked = true;
      $('#opt_crown').checked = true;
      $('#opt_flash').checked = true;
      $('#bpsf').value = '7';
      $('#auto_tiles').checked = true;
      $('#tile_len').value = 24;
      $('#proj_in').value = 2;
      $('#no_cap').checked = false;
      $('#flue_size').value = '8x12';
      $('#crown_thk').value = 4;
      $('#crown_oh').value = 1.5;
      $('#flash_h').value = 8;
      calc();
      window.scrollTo({top:0, behavior:'smooth'});
    }); }})(document.querySelector('#resetBtn'));

    // Init
    calc();
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
  else { bind(); }
})();
</script>
<!-- Auto-injected: default 'Include end bars' to ON -->
<script id="forceEndBarsDefaultOn">
document.addEventListener('DOMContentLoaded', function() {
  try {
    var el = document.getElementById('bw_include_end_bars');
    if (el) el.checked = true;
  } catch(e) {}
});
</script>
<!-- Auto-injected: Stucco Finish Yield fix (per-product + materials fallback) -->
<script id="stucco-finish-yield-fix-v2a">
(function(){
  function $(id){ return document.getElementById(id); }
  // Per-product defaults and matchers
  var MAP = {
    'parex_coarse':  { name:'Parex DPR Sand Coarse — 5 gal',  default_sf:80,  regex:/Parex.*Coarse.*5\s*gal/i },
    'parex_fine':    { name:'Parex DPR Sand Fine — 5 gal',    default_sf:130, regex:/Parex.*Fine.*5\s*gal/i },
    'parex_swirl':   { name:'Parex DPR Swirl Fine — 5 gal',   default_sf:120, regex:/Parex.*Swirl.*5\s*gal/i },
    'parex_smooth':  { name:'Parex DPR Sand Smooth — 5 gal',  default_sf:160, regex:/Parex.*Smooth.*5\s*gal/i },
    'mp_rolltex':    { name:'MP Roll\-Tex Coating — 5 gal',  default_sf:150, regex:/Roll[\-\s]?Tex.*5\s*gal/i },
    'specmix_s':     { name:'SPEC MIX Type S — 80 lb',        default_sf:40,  regex:/SPEC\s*MIX\s*Type\s*S.*80/i }
  };

  function getMatYield(regex){
    try{
      var tbody = document.getElementById('matTbody');
      if (tbody){
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var row = rows.find(function(tr){ return regex.test((tr.textContent||'')); });
        if (row){
          var cov = row.getAttribute('data-coverage') || (row.dataset ? row.dataset.coverage : null);
          if (cov) { var n=parseFloat(cov); if(isFinite(n) && n>0) return n; }
          // fallback: parse something like "≈150 sf" in row text
          var m = (row.textContent||'').match(/(~|≈)?\s*(\d+)\s*sf/i);
          if (m){ var n2=parseFloat(m[2]); if(isFinite(n2) && n2>0) return n2; }
        }
      }
      // Last resort: in-memory materials[] (if present)
      if (window.materials && Array.isArray(window.materials)){
        var item = window.materials.find(function(m){ try{ return regex.test(String(m.item||'')); }catch(e){ return false; } });
        if (item && isFinite(parseFloat(item.coverageSqft))) return parseFloat(item.coverageSqft);
      }
    }catch(e){}
    return 0;
  }

  function syncYield(){
    var sel = $('stu_finish_sel'); var yEl=$('stu_finish_yield'); var useMat = $('stu_finish_use_mat') && $('stu_finish_use_mat').checked;
    if (!sel || !yEl) return;
    var choice = MAP[sel.value] || {default_sf:90, regex:/a^/};
    var val = 0;
    if (useMat) val = getMatYield(choice.regex);
    if (!(val>0)) val = choice.default_sf;
    yEl.value = (isFinite(val) && val>0) ? Math.round(val) : 90;
    try{ if (typeof window.stuccoCalc==='function') window.stuccoCalc(); else if (typeof calc==='function') calc(); }catch(e){}
  }

  function bind(){
    var sel = $('stu_finish_sel'), chk=$('stu_finish_use_mat');
    if (sel){ sel.addEventListener('change', syncYield); sel.addEventListener('input', syncYield); }
    if (chk){ chk.addEventListener('change', syncYield); }
    // Seed on load
    syncYield();
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true});
  else bind();
})();
</script>
<script id="stucco_diag_early_fix">
(function(){
  function $(id){ return document.getElementById(id); }
  function num(id){ var el=$(id); return el? (parseFloat(el.value||'0')||0) : 0; }
  function val(id){ var el=$(id); return el? (el.value||'') : ''; }
  function chk(id){ var el=$(id); return el? !!el.checked : false; }
  function writeEarly(){
    try{
      var pre = document.getElementById('stu_diag_pre') || document.getElementById('stucco_diag_pre');
      if (!pre) return;
      var L=[];
      function push(label, v, d){
        if (v===undefined || v===null || (typeof v==='number' && !isFinite(v))) return;
        if (typeof v==='number') L.push(label+'='+v.toFixed(d!=null?d:2));
        else L.push(label+'='+String(v));
      }
      var areaRaw = num('stu_area');
      var wastePct = num('stu_waste');
      var roundUp = chk('stu_round');
      var finUseMat = chk('stu_finish_use_mat');
      var finYield = num('stu_finish_yield');
      var finSel = val('stu_finish_sel');
      var foamOn = chk('stu_use_foam');
      var foamSel = val('stu_foam_sel');
      push('area_raw_sf', areaRaw, 2);
      push('waste_pct', wastePct, 2);
      push('round_up', roundUp?1:0, 0);
      push('finish_use_mat', finUseMat?1:0, 0);
      push('finish_yield', finYield, 2);
      push('finish_product', finSel);
      push('foam_on', foamOn?1:0, 0);
      push('foam_sel', foamSel);
      pre.textContent = L.join('\n');
      }catch(_){ /* no-op */ }
  }
  function bind(){
    var ids = ['stu_area','stu_waste','stu_round','stu_finish_use_mat','stu_finish_yield','stu_finish_sel','stu_use_foam','stu_foam_sel'];
    ids.forEach(function(id){
      var el = $(id); if(!el) return;
      ['input','change'].forEach(function(ev){
        try{ el.addEventListener(ev, writeEarly); }catch(_){}
      });
    });
    // First paint
    writeEarly();
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind, {once:true});
  else bind();
})();
</script>
<!-- Concrete Diagnostics Script -->
<script id="concrete_diag_script">
(function(){
  function $(id){ return document.getElementById(id); }
  function num(id){
    var el = $(id); if(!el) return 0;
    var s = String(el.value||'').replace(/[,$]/g,'');
    var v = parseFloat(s); return isFinite(v) ? v : 0;
  }
  function val(id){ var el=$(id); return el ? (el.value||'') : ''; }
  function chk(id){ var el=$(id); return el ? !!el.checked : false; }

  function writeDiag(){
    try{
      var L = num('tm_len_ft');
      var W = num('tm_wid_ft');
      var T = num('tm_thk_in');
      var waste = chk('tm_waste_on');
      var roundStep = parseFloat(val('tm_round')||'0')||0;

      var yards_raw = (L * W * (T/12)) / 27;
      var yards_waste = waste ? yards_raw * 1.05 : yards_raw;
      var yards_round = roundStep>0 ? Math.ceil(yards_waste/roundStep)*roundStep : yards_waste;

      var pre = $('concrete_diag_pre');
      if (pre){
        var lines = [];
        function push(k,v,d){
          if (v===undefined || v===null) return;
          if (typeof v==='number'){ lines.push(k+'='+(isFinite(v)? v.toFixed(d!=null?d:2) : String(v))); }
          else { lines.push(k+'='+String(v)); }
        }
        push('L_ft', L, 2);
        push('W_ft', W, 2);
        push('T_in', T, 2);
        push('waste_on', waste?1:0, 0);
        push('round_step', roundStep, 2);
        push('yards_raw', yards_raw, 2);
        push('yards_with_waste', yards_waste, 2);
        push('yards_rounded', yards_round, 2);
        pre.textContent = lines.join('\\n');
      }
    }catch(ex){
      var pre = $('concrete_diag_pre');
      if (pre) pre.textContent = 'JS Error: '+ex.message;
    }
  }

  function bind(){
    var ids = ['tm_len_ft','tm_wid_ft','tm_thk_in','tm_waste_on','tm_round'];
    ids.forEach(function(id){
      var el = $(id); if(!el) return;
      ['input','change'].forEach(function(ev){
        try{ el.addEventListener(ev, writeDiag); }catch(_){}
      });
    });
    var card = document.getElementById('concreteCard');
    if (card){
      card.addEventListener('input', writeDiag);
      card.addEventListener('change', writeDiag);
    }
    writeDiag();
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true});
  else bind();
})();
</script>
<script id="cc_small_diag_script">
(function(){
  function $(id){ return document.getElementById(id); }
  function toNum(val){
    if (val==null) return 0;
    var t = String(val).replace(/[$,]/g,'');
    var v = parseFloat(t);
    return isFinite(v) ? v : 0;
  }
  function write(){
    try{
      var yards = toNum( ( $('ct_yards') || {} ).value );
      var price = toNum( ( $('ct_price') || {} ).value );
      var deliv = toNum( ( $('ct_delivery') || {} ).value );
      var trips = toNum( ( $('ct_trips_read') || {} ).textContent );
      var outArea = ( ($('ct_out_of_area')||{}).checked ? 1 : 0 );

      var matTxt = ( ($('ct_mat')||{}).textContent || '' ).trim();
      var delTxt = ( ($('ct_deliv')||{}).textContent || '' ).trim();
      var subTxt = ( ($('ct_sub')||{}).textContent || '' ).trim();

      var lines = [];
      function push(k,v){ if(v!==undefined && v!==null) lines.push(k+'='+String(v)); }
      function pushNum(k,v,d){ lines.push(k+'='+ (isFinite(v)? Number(v).toFixed(d!=null?d:2) : String(v))); }

      pushNum('yards', yards, 2);
      pushNum('price_per_yd', price, 2);
      pushNum('delivery_fee_trip', deliv, 2);
      pushNum('trips_auto', trips, 0);
      push('out_of_area', outArea);
      push('material_out', matTxt);
      push('delivery_out', delTxt);
      push('cc_subtotal_out', subTxt);

      var pre = $('cc_small_diag_pre');
      if (pre) pre.textContent = lines.join('\n');
    }catch(ex){
      var pre = $('cc_small_diag_pre');
      if (pre) pre.textContent = 'JS Error: ' + ex.message;
    }
  }
  function bind(){
    ['ct_yards','ct_price','ct_delivery','ct_out_of_area'].forEach(function(id){
      var el = $(id); if(!el) return;
      ['input','change'].forEach(function(ev){ try{ el.addEventListener(ev, write); }catch(_){ } });
    });
    // Observe output pills
    ['ct_trips_read','ct_mat','ct_deliv','ct_sub'].forEach(function(id){
      var el = $(id); if(!el || !window.MutationObserver) return;
      var mo = new MutationObserver(function(){ write(); });
      mo.observe(el, {characterData:true, subtree:true, childList:true});
    });
    // Delegate within the small-loads subcard (closest .subcard to heading)
    var hdr = Array.from(document.querySelectorAll('.subcard .row b')).find(function(b){ return /Concrete Connections\s+—\s+small loads/.test(b.textContent||''); });
    var sub = hdr ? hdr.closest('.subcard') : null;
    if (sub){ sub.addEventListener('input', write); sub.addEventListener('change', write); }
    write();
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true}); else bind();
})();
</script>
<script id="mv_diag_script">
(function(){
  function $(id){ return document.getElementById(id); }
  function toNum(val){
    if (val==null) return 0;
    var t = String(val).replace(/[$,]/g,'');
    var v = parseFloat(t);
    return isFinite(v) ? v : 0;
  }
  function write(){
    try{
      var yards   = toNum( ( $('mv_yards')||{} ).value );
      var price   = toNum( ( $('mv_price')||{} ).value );
      var fee_man = toNum( ( $('mv_short')||{} ).value );
      var winter  = toNum( ( $('mv_winter')||{} ).value );
      var winter_auto = ( ($('mv_winter_auto')||{}).checked ? 1 : 0 );
      var winter_on   = ( ($('mv_winter_on')||{}).checked ? 1 : 0 );
      var cap     = toNum( ( $('mv_cap')||{} ).value );
      var min_ld  = toNum( ( $('mv_min')||{} ).value );
      var short_per_yd = toNum( ( $('mv_short_per_yd')||{} ).value );
      var fuel    = toNum( ( $('mv_fuel')||{} ).value );
      var env     = toNum( ( $('mv_env')||{} ).value );
      var halfAgg = ( ($('mv_ex_38')||{}).checked ? 1 : 0 );
      var halfAggRate = toNum( ( $('mv_ex_38_ppy')||{} ).value );

      var trucks  = toNum( ( ($('mv_trucks')||{}).textContent ) );
      var loadfees= ( ($('mv_loadfees')||{}).textContent || '' ).trim();
      var shortfees=( ($('mv_shortfees')||{}).textContent || '' ).trim();
      var matOut  = ( ($('mv_mat')||{}).textContent || '' ).trim();
      var extras  = ( ($('mv_extras')||{}).textContent || '' ).trim();
      var pumpOut = ( ($('mv_pump')||{}).textContent || '' ).trim();
      var subOut  = ( ($('mv_sub')||{}).textContent || '' ).trim();

      var L=[];
      function push(k,v){ if(v!==undefined && v!==null) L.push(k+'='+String(v)); }
      function pushNum(k,v,d){ L.push(k+'='+ (isFinite(v)? Number(v).toFixed(d!=null?d:2) : String(v))); }

      pushNum('yards', yards, 2);
      pushNum('price_per_yd', price, 2);
      pushNum('manual_fee', fee_man, 2);
      pushNum('winter_per_yd', winter, 2);
      push('winter_auto', winter_auto);
      push('winter_now', winter_on);
      pushNum('truck_capacity', cap, 0);
      pushNum('min_load_threshold', min_ld, 2);
      pushNum('short_fee_per_yd', short_per_yd, 2);
      pushNum('fuel_per_load', fuel, 2);
      pushNum('env_fee_per_load', env, 2);
      push('half_inch_agg', halfAgg);
      pushNum('half_agg_rate', halfAggRate, 2);
      pushNum('trucks_auto', trucks, 0);
      push('per_load_fees_out', loadfees);
      push('short_surcharges_out', shortfees);
      push('material_out', matOut);
      push('extras_out', extras);
      push('pump_out', pumpOut);
      push('mv_subtotal_out', subOut);

      var pre = $('mv_diag_pre');
      if (pre) pre.textContent = L.join('\n');
    }catch(ex){
      var pre2 = $('mv_diag_pre');
      if (pre2) pre2.textContent = 'JS Error: '+ex.message;
    }
  }
  function bind(){
    ['mv_yards','mv_price','mv_short','mv_winter','mv_winter_auto','mv_winter_on','mv_cap','mv_min','mv_short_per_yd','mv_fuel','mv_env','mv_ex_38','mv_ex_38_ppy']
      .forEach(function(id){
        var el = document.getElementById(id); if(!el) return;
        ['input','change'].forEach(function(ev){ try{ el.addEventListener(ev, write); }catch(_){ } });
      });
    // Observe output pills
    ['mv_trucks','mv_loadfees','mv_shortfees','mv_mat','mv_extras','mv_pump','mv_sub'].forEach(function(id){
      var el = document.getElementById(id); if(!el || !window.MutationObserver) return;
      var mo = new MutationObserver(function(){ write(); });
      mo.observe(el, {characterData:true, subtree:true, childList:true});
    });
    // Delegate inside the MV subcard
    var hdr = Array.from(document.querySelectorAll('.subcard .row b')).find(function(b){ return /Mohican Valley\s+—\s+big trucks/.test(b.textContent||''); });
    var mvCard = hdr ? hdr.closest('.subcard') : null;
    if (mvCard){ mvCard.addEventListener('input', write); mvCard.addEventListener('change', write); }
    write();
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true}); else bind();
})();
</script>
<script id="fuel_diag_script">
(function(){
  function $(id){ return document.getElementById(id); }
  function toNum(val){
    if (val==null) return 0;
    var t = String(val).replace(/[$,]/g,'');
    var v = parseFloat(t);
    return isFinite(v) ? v : 0;
  }
  function write(){
    try{
      var ppg = toNum( ( $('fuel_ppg')||{} ).value );
      var gal = toNum( ( $('fuel_gal')||{} ).value );
      var subTxt = ( ($('fuel_sub')||{}).textContent || '' ).trim();
      var subtotal_calc = ppg * gal;

      var L=[];
      function push(k,v){ if(v!==undefined && v!==null) L.push(k+'='+String(v)); }
      function pushNum(k,v,d){ L.push(k+'='+ (isFinite(v)? Number(v).toFixed(d!=null?d:2) : String(v))); }
      pushNum('ppg', ppg, 3);
      pushNum('gallons', gal, 2);
      pushNum('subtotal_calc', subtotal_calc, 2);
      push('subtotal_out', subTxt);

      var pre = $('fuel_diag_pre');
      if (pre) pre.textContent = L.join('\\n');
    }catch(ex){
      var pre2 = $('fuel_diag_pre');
      if (pre2) pre2.textContent = 'JS Error: '+ex.message;
    }
  }
  function bind(){
    ['fuel_ppg','fuel_gal'].forEach(function(id){
      var el = document.getElementById(id); if(!el) return;
      ['input','change'].forEach(function(ev){ try{ el.addEventListener(ev, write); }catch(_){ } });
    });
    // Observe output pill
    var out = document.getElementById('fuel_sub');
    if (out && window.MutationObserver){
      var mo = new MutationObserver(function(){ write(); });
      mo.observe(out, {characterData:true, subtree:true, childList:true});
    }
    // Delegate inside card
    var card = document.getElementById('fuelCard');
    if (card){ card.addEventListener('input', write); card.addEventListener('change', write); }
    write();
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true}); else bind();
})();
</script>
<script id="waste_diag_script">
(function(){
  function $(id){ return document.getElementById(id); }
  function toNum(val){
    if (val==null) return 0;
    var t = String(val).replace(/[$,]/g,'');
    var v = parseFloat(t);
    return isFinite(v) ? v : 0;
  }
  function write(){
    try{
      var rows = Array.from(document.querySelectorAll('#wasteTbody tr'));
      var L = [];
      L.push('rows='+rows.length);
      var sub = 0;
      rows.forEach(function(tr, i){
        var useEl = tr.querySelector('.w_use');
        var item = (tr.querySelector('.w_item')||{}).value || '';
        var fac  = (tr.querySelector('.w_fac')||{}).value || '';
        var units= (tr.querySelector('.w_units')||{}).value || '';
        var rate = toNum( (tr.querySelector('.w_rate')||{}).value );
        var qty  = toNum( (tr.querySelector('.w_qty')||{}).value );
        var use  = useEl && useEl.checked ? 1 : 0;
        var ext  = use ? rate * qty : 0;
        sub += ext;
        try{
          var line = 'r'+(i+1)+': use='+use+' item='+item+' fac='+fac+' units='+units+
                     ' rate='+ (isFinite(rate)? rate.toFixed(2):'0.00')+
                     ' qty='+ (isFinite(qty)? qty.toFixed(2):'0.00')+
                     ' ext='+ (isFinite(ext)? ext.toFixed(2):'0.00');
          L.push(line);
        }catch(_){}
      });
      var subTxt = (function(){ var el=$('wasteSubtotal'); return el ? (el.textContent||'').trim() : ''; })();
      L.push('subtotal_calc='+sub.toFixed(2));
      L.push('subtotal_out='+subTxt);
      var pre = $('waste_diag_pre');
      if (pre) pre.textContent = L.join('\\n');
    }catch(ex){
      var pre = $('waste_diag_pre');
      if (pre) pre.textContent = 'JS Error: '+ex.message;
    }
  }
  function bind(){
    // Listen for changes within the waste card
    var card = document.querySelector('[data-card-waste]');
    if (card){
      card.addEventListener('input', write);
      card.addEventListener('change', write);
    }
    // Observe tbody for dynamic row changes and updates
    var tb = document.getElementById('wasteTbody');
    if (tb && window.MutationObserver){
      var mo = new MutationObserver(function(){ write(); });
      mo.observe(tb, {childList:true, subtree:true, characterData:true});
    }
    // Also watch subtotal pill changes
    var pill = document.getElementById('wasteSubtotal');
    if (pill && window.MutationObserver){
      var mo2 = new MutationObserver(function(){ write(); });
      mo2.observe(pill, {childList:true, characterData:true, subtree:true});
    }
    // Watch for "Add Disposal item" clicks
    var btn = document.getElementById('wasteAdd');
    if (btn){ btn.addEventListener('click', function(){ setTimeout(write, 0); }); }
    write();
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true}); else bind();
})();
</script>
<script id="silica_diag_script">
(function(){
  function $(id){ return document.getElementById(id); }
  function containsDWVText(node){
    if (!node) return false;
    var txt = (node.textContent||'').toLowerCase();
    return txt.indexOf('dewalt')!==-1 || txt.indexOf('dwv9402')!==-1 || txt.indexOf('fleece dust bag')!==-1;
  }
  function toNum(v){
    if (v==null) return 0;
    var t = String(v).replace(/[$,]/g,'');
    var n = parseFloat(t);
    return isFinite(n) ? n : 0;
  }
  function findDWVRow(){
    var tb = document.getElementById('matTbody');
    if (!tb) return null;
    var rows = Array.from(tb.querySelectorAll('tr'));
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      var itemCell = r.querySelector('.mat_item');
      if (containsDWVText(itemCell)) return r;
    }
    return null;
  }
  function write(){
    try{
      var tuck = ( $('#sil_task_tuck')||{} ).checked ? 1 : 0;
      var grind = ( $('#sil_task_grind')||{} ).checked ? 1 : 0;
      var enclosed = ( $('#sil_enclosed')||{} ).checked ? 1 : 0;
      var notesEl = $('#sil_ecp_notes');
      var notesLen = notesEl ? (notesEl.value||'').length : 0;
      var notesPreview = notesEl ? (notesEl.value||'').slice(0,80) : '';

      var dwvRow = findDWVRow();
      var dwv_in = !!dwvRow;
      var dwv_use = 0, dwv_qty = 0, dwv_ext = 0;
      if (dwvRow){
        var u = dwvRow.querySelector('.mat_use'); dwv_use = u && u.checked ? 1 : 0;
        var q = dwvRow.querySelector('.mat_qty'); dwv_qty = q ? toNum(q.value) : 0;
        var extCell = dwvRow.querySelector('.mat_price'); // if ext shown elsewhere, fall back to row text
        var extTxt = extCell ? (extCell.textContent||'') : '';
        // Some tables have extension shown in a right cell; attempt more specific
        var extRight = dwvRow.querySelector('.right.mono');
        if (extRight && /[$]/.test(extRight.textContent||'')) extTxt = extRight.textContent;
        dwv_ext = toNum(extTxt);
      }
      var matSubTxt = (function(){ var el=document.getElementById('matSubtotal'); return el ? (el.textContent||'').trim() : ''; })();

      var lines = [];
      function push(k,v){ lines.push(k+'='+String(v)); }
      function pushNum(k,v,d){ lines.push(k+'='+ (isFinite(v)? Number(v).toFixed(d!=null?d:2) : String(v))); }
      push('task_tuck', tuck);
      push('task_grind', grind);
      push('enclosed', enclosed);
      push('notes_len', notesLen);
      push('notes_preview', notesPreview);
      push('dwv_in_materials', dwv_in?1:0);
      push('dwv_use', dwv_use);
      pushNum('dwv_qty', dwv_qty, 2);
      push('materials_subtotal', matSubTxt);

      var pre = document.getElementById('silica_diag_pre');
      if (pre) pre.textContent = lines.join('\\n');
    }catch(ex){
      var pre2 = document.getElementById('silica_diag_pre');
      if (pre2) pre2.textContent = 'JS Error: ' + ex.message;
    }
  }
  function bind(){
    ['sil_task_tuck','sil_task_grind','sil_enclosed','sil_ecp_notes'].forEach(function(id){
      var el = document.getElementById(id); if(!el) return;
      ['input','change','keyup'].forEach(function(ev){ try{ el.addEventListener(ev, write); }catch(_){ } });
    });
    // Observe Materials table & subtotal for auto-added bag rows
    var tb = document.getElementById('matTbody');
    if (tb && window.MutationObserver){
      var mo = new MutationObserver(function(){ write(); });
      mo.observe(tb, {childList:true, subtree:true, characterData:true});
    }
    var pill = document.getElementById('matSubtotal');
    if (pill && window.MutationObserver){
      var mo2 = new MutationObserver(function(){ write(); });
      mo2.observe(pill, {childList:true, subtree:true, characterData:true});
    }
    // Delegate inside silica card
    var card = document.getElementById('silicaCard');
    if (card){ card.addEventListener('input', write); card.addEventListener('change', write); }
    write();
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true}); else bind();
})();
</script>
<script id="tools_diag_script">
(function(){
  function toNum(v){
    if (v==null) return 0;
    var t=String(v).replace(/[$,]/g,'');
    var n=parseFloat(t);
    return isFinite(n)?n:0;
  }
  function write(){
    try{
      var tb = document.getElementById('toolTbody');
      var rows = tb ? Array.from(tb.querySelectorAll('tr')) : [];
      var subTxt = (function(){ var el=document.getElementById('toolSubtotal'); return el ? (el.textContent||'').trim() : ''; })();
      var L = [];
      L.push('rows='+rows.length);
      rows.forEach(function(tr,i){
        try{
          var use = (tr.querySelector('.t_use')||{}).checked ? 1 : 0;
          var name = (tr.querySelector('.t_name')||{}).value || '';
          var cost = toNum( (tr.querySelector('.t_cost')||{}).value );
          var life = toNum( (tr.querySelector('.t_life')||{}).value );
          var frac = toNum( (tr.querySelector('.t_frac')||{}).value );
          var hrs  = toNum( (tr.querySelector('.t_usehrs')||{}).value );
          var extTxt = (tr.querySelector('.t_ext')||{}).textContent || '';
          var ext = toNum(extTxt);
          L.push('r'+(i+1)+': use='+use+' name='+name+' cost='+cost.toFixed(2)+
                 ' life='+life.toFixed(1)+' frac='+frac.toFixed(2)+' hrs='+hrs.toFixed(1)+
                 ' ext='+ext.toFixed(2));
        }catch(_){}
      });
      L.push('subtotal_out='+subTxt);
      var pre = document.getElementById('tools_diag_pre');
      if (pre) pre.textContent = L.join('\\n');
    }catch(ex){
      var pre2 = document.getElementById('tools_diag_pre');
      if (pre2) pre2.textContent = 'JS Error: '+ex.message;
    }
  }
  function bind(){
    var card = document.getElementById('toolsCard');
    if (card){
      card.addEventListener('input', write);
      card.addEventListener('change', write);
    }
    var tb = document.getElementById('toolTbody');
    if (tb && window.MutationObserver){
      var mo = new MutationObserver(function(){ write(); });
      mo.observe(tb, {childList:true, subtree:true, characterData:true});
    }
    var sub = document.getElementById('toolSubtotal');
    if (sub && window.MutationObserver){
      var mo2 = new MutationObserver(function(){ write(); });
      mo2.observe(sub, {childList:true, subtree:true, characterData:true});
    }
    var btn = document.getElementById('addToolBtn');
    if (btn){ btn.addEventListener('click', function(){ setTimeout(write,0); }); }
    write();
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true}); else bind();
})();
</script>
</div></div><script id="BW_CMU_SCOPED_AUTO">
// == Scoped Auto-Linker ==
// Behavior: when Block Wall Helper updates and there is a valid 'Order' value,
// - Auto-selects only the matching CMU thickness row and sets Qty = Order
// - Auto-selects matching thickness Durawall with pcs (from Results if present; else computed)
// - Before selecting, it clears ONLY rows previously auto-set by this script
//   (marked with data-bw-auto="cmu" or "durawall").
// - User manual selections are never touched.
(function(){
  var tmr = null;
  function debounce(fn, ms){ clearTimeout(tmr); tmr=setTimeout(fn, ms||0); }
  function num(v){ var n=parseFloat(String(v||'').replace(/[^0-9.\-]/g,'')); return isFinite(n)?n:0; }
  function readyTable(){
    // Attach a manual-marking listener once the table exists
    try {
      var tb_el = document.getElementById('matTbody');
      if (tb_el && !tb_el.__bwManualBound){
        tb_el.addEventListener('change', function(e){
          if (e && e.target && e.target.classList && e.target.classList.contains('mat_use') && e.isTrusted){
            var tr = e.target.closest('tr'); if (tr) tr.setAttribute('data-bw-manual','1');
          }
        });
        tb_el.__bwManualBound = true;
      }
    } catch(e){}
    var tb = document.getElementById('matTbody');
    if (!tb) return null;
    if (!tb.querySelector('tr') && typeof renderMaterials==='function'){ try{ renderMaterials(); }catch(e){} }
    return document.getElementById('matTbody');
  }
  function getT(){ var s=document.getElementById('bw_thickness'); return s ? String(s.value||'').trim() : ''; }
  function course(){ var r=document.querySelector('input[name="bw_height"]:checked'); return r ? String(r.value||'') : '8'; }
  function orderFromResults(){
    var el=document.getElementById('bw_results'); if(!el) return 0;
    var txt=(el.textContent||'').replace(/\s+/g,' ');
    var m=/Order:\s*([0-9]+(?:\.[0-9]+)?)/i.exec(txt);
    return m ? Math.round(parseFloat(m[1]||'0')||0) : 0;
  }
  function haveArea(){
    var lf = num(document.getElementById('bw_len_ft')?.value) + num(document.getElementById('bw_len_in')?.value)/12;
    var hi = num(document.getElementById('bw_h_ft')?.value)*12 + num(document.getElementById('bw_h_in')?.value);
    return lf>0 && hi>0;
  }
  function dispatch(el){
    try{ el.dispatchEvent(new Event('input',{bubbles:true})); }catch(e){}
    try{ el.dispatchEvent(new Event('change',{bubbles:true})); }catch(e){}
  }
  function setUse(tr, on){
    var cb = tr && tr.querySelector('.mat_use'); if(!cb) return;
    cb.checked = !!on; dispatch(cb);
  }
  function setQty(tr, q){
    var inp = tr && tr.querySelector('.mat_qty'); if(!inp) return;
    inp.value = String(q||0); dispatch(inp);
    if (typeof window.setQty==='function'){ try{ window.setQty(tr, Number(q)||0); }catch(e){} }
  }
  function rows(tb, rx){ return Array.from(tb.querySelectorAll('tr')).filter(function(tr){ return rx.test((tr.textContent||'')); }); }
  function cmuRows(tb){ return rows(tb, /hollow\s*concrete\s*block/i); }
  function dwrRows(tb){ return rows(tb, /\bDurawall\b/i); }
  function clearAuto(tb, kind){
    var mark = kind==='cmu' ? 'cmu' : 'durawall';
    Array.from(tb.querySelectorAll('tr[data-bw-auto="'+mark+'"]')).forEach(function(tr){
      setUse(tr, false); setQty(tr, 0);
      tr.removeAttribute('data-bw-auto'); tr.removeAttribute('data-bw-auto-thk');
    });
  }
  function markAuto(tr, kind, thk){
    if (!tr) return;
    tr.setAttribute('data-bw-auto', kind);
    tr.setAttribute('data-bw-auto-thk', thk||'');
  }
  function targetCMU(tb, t){
    var id = 'mUSR_'+t+'_hollow_concrete_block_each';
    var byId = tb.querySelector('tr[data-id="'+id+'"]');
    if (byId) return byId;
    var rx = new RegExp(t+'\\\"\\s*hollow\\s*concrete\\s*block','i');
    return cmuRows(tb).find(function(tr){ return rx.test(tr.textContent||''); }) || null;
  }
  function targetDWR(tb, t){
  }

  function legacyCleanup(tb, t){
    if (!tb) return;
    if (String(t) === '12') return;
    // Clear legacy 12" CMU row if selected and not manually set
    var twelve = tb.querySelector('tr[data-id="mNH1"]');
    if (!twelve){
      // fallback by text match
      var rows = Array.from(tb.querySelectorAll('tr'));
      for (var i=0;i<rows.length;i++){
        var txt = (rows[i].textContent||'');
        if (/^\s*12\"\s*hollow\s*concrete\s*block/i.test(txt)){ twelve = rows[i]; break; }
      }
    }
    if (twelve){
      if (twelve.getAttribute('data-bw-manual') !== '1'){
        var cb = twelve.querySelector('.mat_use');
        if (cb && cb.checked){ setUse(twelve, false); setQty(twelve, 0); }
      }
    }
    // Also clear 12" Durawall if matched and not manual
    var rowsD = Array.from(tb.querySelectorAll('tr'));
    for (var j=0;j<rowsD.length;j++){
      var txtD = (rowsD[j].textContent||'');
      if (/\b12\"\s*Durawall\b/i.test(txtD)){
        if (rowsD[j].getAttribute('data-bw-manual') !== '1'){
          var cbD = rowsD[j].querySelector('.mat_use');
          if (cbD && cbD.checked){ setUse(rowsD[j], false); setQty(rowsD[j], 0); }
        }
      }
    }
  }

  function targetDWR(tb, t){
    // match "6" Durawall — 10'" (tolerant to punctuation/spacing)
    var rx = new RegExp('\\b'+t+'\\\"\\s*Durawall\\b','i');
    return dwrRows(tb).find(function(tr){ return rx.test(tr.textContent||''); }) || null;
  }
  function pcsDurawall(){
    var txt=(document.getElementById('bw_results')?.textContent||'').replace(/\s+/g,' ');
    var m=/Durawall[^:]*:\s*([0-9]+)\s*pcs/i.exec(txt);
    if (m) return Math.max(0, parseInt(m[1],10));
    // fallback every-other-course / 10' sticks
    var lf = num(document.getElementById('bw_len_ft')?.value) + num(document.getElementById('bw_len_in')?.value)/12;
    var hi = num(document.getElementById('bw_h_ft')?.value)*12 + num(document.getElementById('bw_h_in')?.value);
    var ch = course()==='4' ? 4 : 8;
    var courses = Math.ceil(hi / ch);
    var runs = Math.ceil(courses / 2);
    return Math.ceil((lf/10) * runs);
  }
  function run(){
    var tb = readyTable(); if (!tb) return;
    var ord = orderFromResults();
    if (!(haveArea() && ord>0 && course()==='8')) return;
    var t = getT(); if(!t) return;
    // Clear legacy 12\" selection if present (not marked manual)
    legacyCleanup(tb, t);
    // CMU: clear only prior auto rows, then set the new auto row
    clearAuto(tb, 'cmu');
    var cmu = targetCMU(tb, t);
    if (cmu){ setUse(cmu, true); setQty(cmu, ord); markAuto(cmu, 'cmu', t); }
    // Durawall: clear only prior auto rows, then set the new
    clearAuto(tb, 'durawall');
    var pcs = pcsDurawall();
    if (pcs>0){
      var dwr = targetDWR(tb, t);
      if (dwr){ setUse(dwr, true); setQty(dwr, pcs); markAuto(dwr, 'durawall', t); }
    }
  }
  function bind(){
    var ids=['bw_len_ft','bw_len_in','bw_h_ft','bw_h_in','bw_waste','groutPattern'];
    ids.forEach(function(id){ var el=document.getElementById(id); if(el){ ['input','change'].forEach(function(ev){ el.addEventListener(ev,function(){ debounce(run,0); }); }); } });
    var thick=document.getElementById('bw_thickness'); if(thick){ ['input','change'].forEach(function(ev){ thick.addEventListener(ev,function(){ debounce(run,0); }); }); }
    document.querySelectorAll('input[name="bw_height"]').forEach(function(el){ el.addEventListener('change', function(){ debounce(run,0); }); });
    var pane=document.getElementById('bw_results');
    if (pane && window.MutationObserver){ try{ new MutationObserver(function(){ debounce(run,0); }).observe(pane,{childList:true,subtree:true}); }catch(e){} }
    debounce(run,0);
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>
&lt;!-- Scoped auto-linker appended on 2025-09-23T04:08:46 --&gt;
<script>
/* === TM: Crew role → default rate mapping (hardened) === */
(function(){
  'use strict';
  function rows(){ var tb=document.getElementById('crewTbody'); return tb ? Array.from(tb.getElementsByTagName('tr')) : []; }
  function getRole(tr){ var els = tr ? tr.getElementsByClassName('crew_role') : null; var sel = (els && els[0]) || null; return sel ? (sel.value||'') : ''; }
  function currentRate(tr){ var els = tr ? tr.getElementsByClassName('crew_rate') : null; var inp = (els && els[0]) || null; return inp ? Number(inp.value||0) : 0; }
  function defaultRate(role){ var map = (typeof window.TM_DEFAULT_RATES==='object' && window.TM_DEFAULT_RATES) ? window.TM_DEFAULT_RATES : null; if(map && Object.prototype.hasOwnProperty.call(map, role)) return map[role]; return null; }
  function isOwnerRow(tr){ return !!(tr && tr.dataset && tr.dataset.id === 'owner'); }
  function setRate(tr, val){ var els = tr ? tr.getElementsByClassName('crew_rate') : null; var inp = (els && els[0]) || null; if(!inp) return; inp.value = String(val); try{ if(typeof window.updateAll==='function') window.updateAll(); }catch(e){} }
  function markManual(tr){ if(tr) tr.dataset.manualRate = 'true'; }
  function bindRow(tr){
    if(!tr || tr.__tmBound) return;
    var roleSel = (tr.getElementsByClassName('crew_role')[0]) || null;
    var rateInp = (tr.getElementsByClassName('crew_rate')[0]) || null;
    if(rateInp){ rateInp.addEventListener('input', function(){ markManual(tr); }, true); }
    if(roleSel){
      roleSel.addEventListener('change', function(){
        var def = defaultRate(getRole(tr));
        if(def==null) return;
        if(isOwnerRow(tr) || tr.dataset.manualRate!=='true' || def===currentRate(tr)){ setRate(tr, def); }
      }, true);
    }
    if(isOwnerRow(tr)){ var def0=defaultRate(getRole(tr)); if(def0!=null && currentRate(tr)!==def0){ setRate(tr, def0); } }
    tr.__tmBound = true;
  }
  function attachAll(){ rows().forEach(bindRow); }
  function init(){
    attachAll();
    var tb=document.getElementById('crewTbody');
    if(tb){
      try{
        var mo=new MutationObserver(function(muts){
          for(var i=0;i<muts.length;i++){
            var nodes=muts[i].addedNodes||[];
            for(var j=0;j<nodes.length;j++){ var n=nodes[j]; if(n&&n.nodeType===1&&n.tagName==='TR'){ bindRow(n); } }
          }
        });
        mo.observe(tb,{childList:true});
      }catch(e){}
    }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); } else { init(); }
})();
</script>

<!-- ===== Turcotte non-tray upgrades (safe, no body edits) ===== -->
<style>
  /* Sticky Total pill (bottom-left) */
  #tm-total-pill{
    position: fixed; left: 14px; bottom: 14px; z-index: 2147482000;
    display: inline-flex; align-items: center; gap: 8px;
    background: rgba(8,12,18,.9); color: #e7f0ff;
    border: 1px solid #1f2937; border-radius: 999px; padding: 8px 12px;
    font: 600 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    box-shadow: 0 10px 24px rgba(0,0,0,.25); backdrop-filter: blur(6px);
  }
  #tm-total-pill[hidden]{ display:none !important; }
  #tm-total-pill .val{ font-weight: 700; }
  #tm-total-pill button{
    border:0; border-radius: 999px; background: #0b1017; color:#cfe4ff;
    padding:6px 8px; cursor:pointer; font-weight:700;
    border:1px solid #1f2937;
  }
  #tm-total-pill .hide-btn{ background:#2a3342; color:#e6eeff; }
  #tm-total-pill .reveal{ position: fixed; left: 14px; bottom: 14px; padding:8px 10px;
    background:#0b1017; color:#d6e6ff; border:1px solid #1f2937; border-radius:999px; display:none; z-index:2147482001; }

  /* Print footer (company info) */
  #tm-print-footer{ display:none; border-top:1px solid #cbd5e1; padding-top:8px; margin-top:14px;
    font: 12px/1.3 system-ui, Segoe UI, Roboto, Arial, sans-serif; color:#334155; }
  @media print{ #tm-print-footer{ display:block; } }

  /* Optional Quick Nav UI */
  #tm-quicknav{ position: fixed; left: 14px; top: 60px; z-index: 9999;
    background: rgba(8,12,18,.9); border:1px solid #1f2937; border-radius: 12px; padding: 8px;
    color:#e7f0ff; max-width: 220px; display:none; }
  #tm-quicknav a{ display:block; color:#cfe4ff; text-decoration:none; padding:4px 6px; border-radius:8px; }
  #tm-quicknav a:hover{ background:#1b2432; }
  #tm-quicknav .title{ font-weight:800; margin-bottom:6px; }
  #tm-quicknav .close{ float:right; background:#0b1017; border:1px solid #1f2937; border-radius:8px; padding:2px 6px; cursor:pointer; color:#cfe4ff; }
  #tm-quicknav-toggle{ position: fixed; left: 14px; top: 14px; z-index: 10000;
    background:#0b1017; color:#d6e6ff; border:1px solid #1f2937; border-radius:999px; padding:6px 10px; cursor:pointer; }

  /* Focus outline and prevention of accidental wheel changes */
  input[type=number]:focus{ outline: 2px solid rgba(77,163,255,.35); outline-offset: 2px; }
</style>

<!-- Sticky Total pill + reveal button -->
<div id="tm-total-pill" hidden aria-live="polite" aria-label="Running total">
  <span>Total:</span> <span class="val">$0</span>
  <button class="hide-btn" type="button" title="Hide total pill">Hide</button>
</div>
<button id="tm-total-pill-reveal" class="reveal" type="button" title="Show total" style="display:none">Show Total</button>

<!-- Quick Nav -->
<button id="tm-quicknav-toggle" type="button" title="Quick Nav to headings" aria-expanded="false" aria-controls="tm-quicknav">Sections</button>
<nav id="tm-quicknav" aria-label="On‑page sections">
  <div class="title">Sections <button class="close" type="button" aria-label="Close">×</button></div>
  <div class="links"></div>
</nav>

<!-- Print footer -->
<div id="tm-print-footer">
  <strong>TURCOTTE MASONRY STUCCO &amp; CONCRETE, LLC</strong><br/>
  276 Totoket Road, North Branford, CT 06471 • (203) 937‑0787 • turcottemasonry@gmail.com • www.turcottemasonry.com<br/>
  CT HIC #0605454 • ALEI #1231202 • Founded 1984
</div>

<script>
(function(){
  'use strict';
  // --- Diagnostics banner ---
  function banner(msg, ok){
    try{
      let b = document.getElementById('js-error-banner');
      if(!b){
        b = document.createElement('div');
        b.id = 'js-error-banner';
        b.setAttribute('role','status');
        b.style.position = 'sticky'; b.style.top = '0'; b.style.left='0'; b.style.right='0';
        b.style.padding='8px 12px'; b.style.borderBottom='1px solid #1f2937';
        b.style.background = ok===false ? '#3b0d0d' : '#0b1017';
        b.style.color = ok===false ? '#ffd6d6' : '#d6e6ff';
        document.body.prepend(b);
      }
      b.textContent = (ok===false ? '❌ ' : '✅ ') + msg;
      clearTimeout(b._hide);
      b._hide = setTimeout(()=>{ try{ b.remove(); }catch(_){} }, 1800);
    }catch(_){}
  }
  window.addEventListener('error', function(e){
    banner('JS error at ' + (e.filename||'') + ':' + (e.lineno||'') + ' — ' + (e.message||'Error'), false);
  });

  // --- Polyfill CSS.escape if missing (MDN: CSS.escape) ---
  if(!window.CSS){ window.CSS = {}; }
  if(!CSS.escape){
    CSS.escape = function(sel){
      return String(sel).replace(/[^a-zA-Z0-9_-]/g, function(ch){ return '\\' + ch; });
    };
  }

  document.addEventListener('DOMContentLoaded', function(){
    try{
      // Sticky Total pill
      var pill = document.getElementById('tm-total-pill');
      var valEl = pill && pill.querySelector('.val');
      var revealBtn = document.getElementById('tm-total-pill-reveal');
      function dollarsInText(t){
        var m = (t||'').match(/\\$\\s*[\\d,]+(?:\\.\\d{2})?/g);
        if(!m) return [];
        var out = [];
        for(var i=0;i<m.length;i++){
          var s = m[i];
          var num = Number(s.replace(/[^0-9.]/g,''));
          if(!isNaN(num)) out.push({s:s, n:num});
        }
        return out;
      }
      function findBestAmount(){
        var cand = Array.prototype.slice.call(document.querySelectorAll('[id*="total" i], [class*="total" i], [id*="grand" i], [class*="grand" i]'));
        var best = null;
        cand.forEach(function(el){
          var arr = dollarsInText(el.textContent||'');
          arr.forEach(function(a){ if(!best || a.n >= best.n){ best = a; } });
        });
        if(!best){
          var arr2 = dollarsInText(document.body.innerText||'');
          arr2.forEach(function(a){ if(!best || a.n >= best.n){ best = a; } });
        }
        return best ? best.s : null;
      }
      function updatePill(){
        if(!pill || !valEl) return;
        var s = findBestAmount();
        if(s){
          valEl.textContent = s.replace(/\\s+/g,'');
          pill.hidden = false;
        }else{
          pill.hidden = true;
        }
      }
      if(pill){
        var hideBtn = pill.querySelector('.hide-btn');
        if(hideBtn) hideBtn.addEventListener('click', function(){
          pill.style.display = 'none';
          if(revealBtn) revealBtn.style.display = 'inline-flex';
        });
        if(revealBtn) revealBtn.addEventListener('click', function(){
          pill.style.display = 'inline-flex';
          revealBtn.style.display = 'none';
        });
        if('MutationObserver' in window){
          var mo = new MutationObserver(function(){ updatePill(); });
          mo.observe(document.body, {subtree:true, childList:true, characterData:true});
        }
        window.addEventListener('load', updatePill);
        setTimeout(updatePill, 120);
      }

      // Prevent accidental number changes via wheel (MDN: wheel event)
      document.addEventListener('wheel', function(e){
        var el = document.activeElement;
        if(el && el.tagName === 'INPUT' && el.type === 'number'){
          el.blur();
        }
      }, {passive:true});

      // Prevent Enter from submitting when in inputs
      document.addEventListener('keydown', function(e){
        if(e.key === 'Enter'){
          var el = e.target;
          if(el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')){
            if(el.tagName === 'TEXTAREA' && e.shiftKey) return;
            e.preventDefault();
          }
        }
      }, true);

      // Quick Nav
      var toggle = document.getElementById('tm-quicknav-toggle');
      var qnav = document.getElementById('tm-quicknav');
      var links = qnav ? qnav.querySelector('.links') : null;
      function slugify(s){ return String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-'); }
      function buildNav(){
        if(!links) return;
        links.innerHTML='';
        var hs = Array.prototype.slice.call(document.querySelectorAll('.wrap .card h2, .wrap .card h3'));
        if(hs.length === 0){ if(toggle) toggle.style.display='none'; return; }
        hs.forEach(function(h,i){
          if(!h.id){ h.id = 'sec-' + slugify(h.textContent||('section-'+i)); }
          var a = document.createElement('a');
          a.href = '#' + h.id; a.textContent = h.textContent||('Section '+(i+1));
          links.appendChild(a);
        });
      }
      if(toggle && qnav){
        toggle.addEventListener('click', function(){
          var vis = qnav.style.display === 'block';
          qnav.style.display = vis ? 'none' : 'block';
          toggle.setAttribute('aria-expanded', String(!vis));
          if(!vis) buildNav();
        });
        var cls = qnav.querySelector('.close');
        if(cls) cls.addEventListener('click', function(){
          qnav.style.display = 'none'; toggle.setAttribute('aria-expanded','false');
        });
      }
      buildNav();
    }catch(err){
      banner('Init error: ' + err, false);
    }
  });
})();
</script>
<!-- ===== End Turcotte upgrades ===== -->

<style>
  /* Top-right Save tray (restored) */
  #tm-tray {
#tm-tray {
  position: absolute; /* pinned to page top-right; scrolls away with content */
  top: 10px;
  right: 10px;
  z-index: 10;
  font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
#tm-tray .card { background:#000000; border:1px solid #1f2937; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.28); padding:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  #tm-tray button{ background:#4da3ff; color:#041425; border:0; padding:8px 10px; border-radius:10px; font-weight:600; cursor:pointer; }
  #tm-tray button.ghost{ background:#111826; color:#e6eeff; border:1px solid #1f2937; }
  #tm-tray input[type="file"]{ display:none; }
  @media (prefers-color-scheme: light){ /* keep tray dark in light mode */ }
    #tm-tray button.ghost{ background:#111826; color:#e6eeff; border:1px solid #1f2937; }
  }
  @media print{  }
</style>

<div id="tm-tray" aria-label="Estimator tools">
  <div class="card">
    <button id="tm-save">Save</button>
    <button id="tm-load" class="ghost">Load</button>
    <button id="tm-export" class="ghost">Export JSON</button>
    <button id="tm-import" class="ghost">Import JSON</button>
    <button id="tm-reset" class="ghost">Reset</button>
    <button id="tm-print" class="ghost">Print</button>
    <input id="tm-import-file" type="file" accept="application/json"/>
  </div>
</div>

<script>
(function(){
  'use strict';
  const KEY_PRIMARY = 'tm_estimator_state_v1';
  const KEY_COMPAT  = 'tm_estimator_state_v2';

  function banner(msg, ok){
    try{
      let b = document.getElementById('js-error-banner');
      if(!b){
        b = document.createElement('div');
        b.id = 'js-error-banner';
        b.setAttribute('role','status');
        b.style.position = 'sticky'; b.style.top = '0'; b.style.left='0'; b.style.right='0';
        b.style.padding='8px 12px'; b.style.borderBottom='1px solid #1f2937';
        b.style.background = ok===false ? '#3b0d0d' : '#0b1017';
        b.style.color = ok===false ? '#ffd6d6' : '#d6e6ff';
        document.body.prepend(b);
      }
      b.textContent = (ok===false ? '❌ ' : '✅ ') + msg;
      clearTimeout(b._hide);
      b._hide = setTimeout(()=>{ try{ b.remove(); }catch(_){ b.style.display='none'; } }, 1400);
    }catch(_){}
  }

  function qsAll(sel){ return Array.from(document.querySelectorAll(sel)); }
  function stableKey(el){ return el.id || el.name || ''; }

  function serialize(){
    const data = {};
    const fields = qsAll('input, select, textarea');
    for(const el of fields){
      const k = stableKey(el);
      if(!k) continue;
      if(!el.offsetParent && el.type !== 'hidden') continue;
      if(el.type === 'checkbox') data[k] = !!el.checked;
      else if(el.type === 'radio'){ if(el.checked) data[k] = el.value; }
      else data[k] = el.value;
    }
    const tbody = document.getElementById('matTbody');
    if(tbody){
      data.__materials = Array.from(tbody.querySelectorAll('tr')).map(tr=>{
        const id = tr.getAttribute('data-id') || null;
        const useCb = tr.querySelector('.mat_use');
        const qtyInp = tr.querySelector('.mat_qty');
        const priceEl = tr.querySelector('[data-price]');
        const price = priceEl ? priceEl.getAttribute('data-price') : null;
        return { id, use: !!(useCb && useCb.checked), qty: qtyInp ? qtyInp.value : '', price };
      });
    }
    return data;
  }

  function applySilent(data){
    const notHidden = el => (el.offsetParent || el.type === 'hidden');
    for(const [k, v] of Object.entries(data)){
      if(k === '__materials') continue;
      const elById = document.getElementById(k);
      const els = elById ? [elById] : Array.from(document.querySelectorAll('[name="'+CSS.escape(k)+'"]'));
      for(const el of els){
        if(!notHidden(el)) continue;
        if(el.type === 'radio') el.checked = (String(el.value) === String(v));
        else if(el.type === 'checkbox') el.checked = !!v;
        else el.value = String(v);
      }
    }
    if(Array.isArray(data.__materials)){
      const tbody = document.getElementById('matTbody');
      if(tbody){
        data.__materials.forEach(row=>{
          const tr = row.id ? tbody.querySelector('tr[data-id="'+row.id+'"]') : null;
          if(!tr) return;
          const use = tr.querySelector('.mat_use');
          const qty = tr.querySelector('.mat_qty');
          if(use) use.checked = !!row.use;
          if(qty) qty.value = String(row.qty||'');
        });
      }
    }
  }

  function dispatchBatched(data){

  try{
    // Apply __materials silently (no events)
    if (data && Array.isArray(data.__materials)){
      var tbody = document.getElementById('matTbody');
      if (tbody){
        for (var i=0; i<data.__materials.length; i++){
          var row = data.__materials[i];
          if (!row || !row.id) continue;
          var tr = tbody.querySelector('tr[data-id="'+row.id+'"]');
          if (!tr) continue;
          var use = tr.querySelector('.mat_use');
          var qty = tr.querySelector('.mat_qty');
          if (use) use.checked = !!row.use;
          if (qty) qty.value = (row.qty==null ? '' : String(row.qty));
          var priceEl = tr.querySelector('[data-price]');
          if (priceEl && row.price != null) priceEl.setAttribute('data-price', String(row.price));
        }
      }
    }
  }catch(e){ /* ignore */ }
  // Single final calc on next frame
  try {
    if (typeof window.calc === 'function'){
      requestAnimationFrame(function(){ try{ window.calc(); }catch(_){} });
    }
  } catch(_){}

}


  document.addEventListener('DOMContentLoaded', function(){
    // Wire Save/Load/Export/Import/Reset/Print
    const $ = s => document.querySelector(s);

    $('#tm-save')?.addEventListener('click', ()=>{
      try{
        const json = JSON.stringify(serialize());
        localStorage.setItem(KEY_PRIMARY, json);
        localStorage.setItem(KEY_COMPAT, json);
        banner('Saved', true);
      }catch(e){ banner('Save failed: storage unavailable', false); }
    });

    $('#tm-load')?.addEventListener('click', ()=>{
      let raw = null;
      try{ raw = localStorage.getItem(KEY_PRIMARY) || localStorage.getItem(KEY_COMPAT); }catch(_){}
      if(!raw){ banner('No saved state found', false); return; }
      let data = null;
      try{ data = JSON.parse(raw); }catch(e){ banner('Saved state is corrupted', false); return; }
      applySilent(data);
      requestAnimationFrame(()=> dispatchBatched(data));
      banner('Loaded', true);
    });

    $('#tm-export')?.addEventListener('click', ()=>{
      try{
        const blob = new Blob([JSON.stringify(serialize(), null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'turcotte_estimator_' + new Date().toISOString().slice(0,10) + '.json';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 500);
        banner('Exported', true);
      }catch(e){ banner('Export failed', false); }
    });

    $('#tm-import')?.addEventListener('click', ()=> $('#tm-import-file')?.click());
    $('#tm-import-file')?.addEventListener('change', function(ev){
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(){
        try{
          const data = JSON.parse(String(reader.result||'{}'));
          localStorage.setItem(KEY_PRIMARY, JSON.stringify(data));
          localStorage.setItem(KEY_COMPAT, JSON.stringify(data));
          applySilent(data);
          requestAnimationFrame(()=> dispatchBatched(data));
          banner('Imported & applied', true);
        }catch(e){ banner('Import failed: invalid JSON', false); }
      };
      reader.readAsText(f);
    });

    $('#tm-reset')?.addEventListener('click', ()=>{
      if(!confirm('Reset all controls and clear saved state?')) return;
      try{ localStorage.removeItem(KEY_PRIMARY); localStorage.removeItem(KEY_COMPAT); }catch(_){}
      location.reload();
    });

    $('#tm-print')?.addEventListener('click', ()=> window.print());

    // Remove legacy top-of-page "Sections" area (but keep the new Sections button)
    (function removeLegacySections(){
      const candidates = Array.from(document.querySelectorAll('#sections, .sections, [data-sections], nav[aria-label*="sections" i]'));
      for(const el of candidates){
        const rect = el.getBoundingClientRect();
        if(rect.top < 180){ el.style.display = 'none'; return; }
      }
      // Heuristic: hide an early block that says "Sections" and contains multiple links
      const firstBlocks = Array.from(document.body.children).slice(0, 6);
      for(const el of firstBlocks){
        if(/sections/i.test(el.textContent||'') && el.querySelectorAll('a').length >= 3){
          el.style.display = 'none'; break;
        }
      }
    })();
  }, {once:true});
})();
</script>

<script>
(function(){
  'use strict';
  // Hide the old "Sections" strip near the top (chips like All, Cleanup, Concrete, Masonry...)
  function hideLegacySections(){
    try{
      const topLimit = 250; // px from top
      const textsToMatch = ['All','Cleanup','Concrete','Masonry','Block Wall','Stone Veneer','Pavers','Stucco','Waste','Crew','Fuel'];
      const isNearTop = el => el && el.getBoundingClientRect().top < topLimit;
      const containsMany = (el)=>{
        const t = (el.textContent || '').replace(/\s+/g,' ').trim();
        let hits = 0;
        for(const w of textsToMatch){ if (new RegExp('\\b'+w.replace(/\s+/g,'\\s+')+'\\b','i').test(t)) hits++; }
        return hits >= 4; // at least 4 category labels present
      };
      // 1) Obvious id/class names
      const cands = Array.from(document.querySelectorAll('[id*="sections" i], [class*="sections" i], [id*="section-nav" i], [class*="section-nav" i], nav[aria-label*="sections" i]'));
      for(const el of cands){
        if(el.id === 'tm-quicknav' || el.id === 'tm-quicknav-toggle') continue; // keep our new button/nav
        if(isNearTop(el)){ el.style.display = 'none'; return true; }
      }
      // 2) Heuristic: large container near top that contains many of our keyword chips
      const topBlocks = Array.from(document.body.querySelectorAll('body > *'));
      for(const el of topBlocks.slice(0, 10)){
        if(el.id === 'tm-quicknav' || el.id === 'tm-quicknav-toggle') continue;
        if(isNearTop(el) && containsMany(el)){
          el.style.display = 'none';
          return true;
        }
      }
      // 3) A lone heading "Sections" near top
      const heads = Array.from(document.querySelectorAll('h1,h2,h3,h4'));
      for(const h of heads){
        if(isNearTop(h) && /^\s*sections\s*$/i.test(h.textContent||'')){
          const parent = h.closest('section,div,nav') || h;
          if(parent && isNearTop(parent)){ parent.style.display = 'none'; return true; }
        }
      }
    }catch(_){}
    return false;
  }
  function tryHide(){ hideLegacySections(); }
  document.addEventListener('DOMContentLoaded', tryHide, {once:true});
  window.addEventListener('load', tryHide, {once:true});
  // Late re-check in case the old sections area is rendered asynchronously
  setTimeout(tryHide, 800);
})();
</script>

<script>
(function(){
  'use strict';
  function hideChipsBar(){
    try{
      const labels = [
        'All','Cleanup','Concrete','Masonry','Block Wall','Stone Veneer',
        'Pavers','Stucco','Waste / Disposal','Crew & Time','Fuel'
      ];
      const topLimit = 260; // px from top of viewport
      const isNearTop = el => el && el.getBoundingClientRect && el.getBoundingClientRect().top < topLimit;
      const getScore = el => {
        const t = (el.textContent || '').toLowerCase();
        let hits = 0;
        for(const w of labels){
          if(t.indexOf(w.toLowerCase()) !== -1) hits++;
        }
        return hits;
      };
      // Consider only large blocks near the top
      const blocks = Array.from(document.body.querySelectorAll('body > *'));
      let best = null, bestScore = 0;
      for(const el of blocks.slice(0, 15)){
        if(!isNearTop(el)) continue;
        if(el.id === 'tm-quicknav' || el.id === 'tm-quicknav-toggle' || el.id === 'tm-tray') continue;
        const s = getScore(el);
        if(s > bestScore){
          best = el; bestScore = s;
        }
      }
      if(best && bestScore >= 4){
        best.style.display = 'none';
        return true;
      }
      // Fallback: search for a nav/list near the top that includes at least 4 labels
      const cands = Array.from(document.querySelectorAll('nav, .tabs, .chips, .pills, .filters, .sections, [id*="sections" i], [class*="sections" i]'));
      for(const el of cands){
        if(!isNearTop(el)) continue;
        if(el.id === 'tm-quicknav' || el.id === 'tm-quicknav-toggle' || el.id === 'tm-tray') continue;
        if(getScore(el) >= 4){
          el.style.display = 'none';
          return true;
        }
      }
    }catch(_){}
    return false;
  }
  function tryHide(){ hideChipsBar(); }
  document.addEventListener('DOMContentLoaded', tryHide, {once:true});
  window.addEventListener('load', tryHide, {once:true});
  setTimeout(tryHide, 400);
  setTimeout(tryHide, 1000);
})();
</script>

<script>
(function(){
  'use strict';
  const KEY_PRIMARY = 'tm_estimator_state_v1';
  const KEY_COMPAT  = 'tm_estimator_state_v2';

  function banner(msg, ok){
    try{
      let b = document.getElementById('js-error-banner');
      if(!b){
        b = document.createElement('div');
        b.id = 'js-error-banner';
        b.setAttribute('role','status');
        b.style.position = 'sticky'; b.style.top = '0'; b.style.left='0'; b.style.right='0';
        b.style.padding='8px 12px'; b.style.borderBottom='1px solid #1f2937';
        b.style.background = ok===false ? '#3b0d0d' : '#0b1017';
        b.style.color = ok===false ? '#ffd6d6' : '#d6e6ff';
        document.body.prepend(b);
      }
      b.textContent = (ok===false ? '❌ ' : '✅ ') + msg;
      clearTimeout(b._hide);
      b._hide = setTimeout(()=>{ try{ b.remove(); }catch(_){ b.style.display='none'; } }, 1600);
    }catch(_){}
  }

  function applySilent(data){
    const notHidden = el => (el.offsetParent || el.type === 'hidden');
    for(const k in data){
      if(!Object.prototype.hasOwnProperty.call(data,k)) continue;
      if(k === '__materials') continue;
      const v = data[k];
      const elById = document.getElementById(k);
      const els = elById ? [elById] : Array.from(document.querySelectorAll('[name="'+CSS.escape(k)+'"]'));
      for(const el of els){
        if(!notHidden(el)) continue;
        if(el.type === 'radio') el.checked = (String(el.value) === String(v));
        else if(el.type === 'checkbox') el.checked = !!v;
        else el.value = String(v);
      }
    }
    if(Array.isArray(data.__materials)){
      const tbody = document.getElementById('matTbody');
      if(tbody){
        data.__materials.forEach(row=>{
          const tr = row.id ? tbody.querySelector('tr[data-id="'+row.id+'"]') : null;
          if(!tr) return;
          const use = tr.querySelector('.mat_use');
          const qty = tr.querySelector('.mat_qty');
          if(use) use.checked = !!row.use;
          if(qty) qty.value = String(row.qty||'');
        });
      }
    }
  }

  function buildRecalcTasks(data){

  // Bypass building any tasks; import will trigger a single calc instead.
  return [];

}


  function /*shim:*/window.calc&&requestAnimationFrame(window.calc), /*orig:*/ runTasksThrottled(tasks, opts){

  try {
    if (typeof window.calc === 'function'){
      requestAnimationFrame(function(){ try{ window.calc(); }catch(_){} });
    }
  } catch(_){}

}


  function safeLoad(doRecalc=true){
    let raw = null;
    try{ raw = localStorage.getItem(KEY_PRIMARY) || localStorage.getItem(KEY_COMPAT); }catch(_){}
    if(!raw){ banner('No saved state found', false); return; }
    let data = null;
    try{ data = JSON.parse(raw); }catch(e){ banner('Saved state is corrupted', false); return; }
    applySilent(data);
    banner('Loaded (values applied)');
    if(!doRecalc) return;
    const tasks = buildRecalcTasks(data);
    // If the set is huge, default to safe mode and let the user opt-in
    if(tasks.length > 150){
      // Show a small button near tray to apply heavy recalc
      try{
        let btn = document.getElementById('tm-apply-recalc');
        if(!btn){
          btn = document.createElement('button');
          btn.id = 'tm-apply-recalc';
          btn.textContent = 'Apply Recalc';
          btn.title = 'Run a full recalculation (throttled)';
          btn.style.position = 'fixed'; btn.style.top = '70px'; btn.style.right = '14px';
          btn.style.zIndex = 2147483001; btn.style.background = '#111826'; btn.style.color = '#e6eeff';
          btn.style.border = '1px solid #1f2937'; btn.style.borderRadius = '10px'; btn.style.padding = '6px 10px';
          document.body.appendChild(btn);
          btn.addEventListener('click', function(){
            btn.disabled = true; btn.textContent = 'Recalculating…';
            /*shim:*/window.calc&&requestAnimationFrame(window.calc), /*orig:*/ runTasksThrottled(tasks, {batch:25, timeout:8000});
            setTimeout(()=>{ try{ btn.remove(); }catch(_){} }, 1500);
            banner('Recalc started (throttled)');
          });
        }
      }catch(_){}
      return;
    }
    // For manageable sets, do the throttled recalc immediately
    /*shim:*/window.calc&&requestAnimationFrame(window.calc), /*orig:*/ runTasksThrottled(tasks, {batch:25, timeout:6000});
  }

  // Override existing Load click with our safe loader
  document.addEventListener('DOMContentLoaded', function(){
    const loadBtn = document.getElementById('tm-load');
    if(loadBtn){
      const clone = loadBtn.cloneNode(true);
      loadBtn.parentNode.replaceChild(clone, loadBtn);
      clone.addEventListener('click', function(){ safeLoad(true); });
    }
  }, {once:true});
})();
</script>

<script id="tm-sections-button-boost-js">
(function(){
  try{
    var btn = document.getElementById('tm-quicknav-toggle');
    if(!btn) return;
    var KEY = 'tm_sections_btn_seen';
    if(!sessionStorage.getItem(KEY)){
      btn.classList.add('attn');
      setTimeout(function(){ btn.classList.remove('attn'); }, 4000);
      sessionStorage.setItem(KEY, '1');
    }
    // Also remove attention state when the drawer opens
    btn.addEventListener('click', function(){
      btn.classList.remove('attn');
    });
  }catch(_){}
})();
</script>


<script id="device-flag">
(function(){
  try{
    var isMobile = window.matchMedia("(max-width: 840px)").matches || /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    document.documentElement.setAttribute("data-device", isMobile ? "mobile" : "desktop");
    document.body && document.body.setAttribute("data-device", isMobile ? "mobile" : "desktop");
  }catch(e){ /* no-op */ }
})();
</script>

</body>
</html>